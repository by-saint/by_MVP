<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- preserved your styles (kept exactly) --- */
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px;
    }
    h1, h2, h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }
    .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 1001; background: #333; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; padding: 0; }
    .menu-toggle .bar { width: 24px; height: 3px; background-color: #fff; border-radius: 2px; transition: all 0.3s ease-in-out; }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
    .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: #1E1E1E; transition: left 0.3s ease-in-out; z-index: 1000; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: space-between; }
    .sidebar.open { left: 0; }
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a { display: block; padding: 15px 30px; text-decoration: none; font-size: 1.1em; font-weight: 700; border-left: 5px solid transparent; transition: background-color 0.2s, border-left 0.2s; }
    .sidebar nav a:hover { background-color: #2c2c2c; }
    .link-ia, .link-aulas, .link-percurso { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    .sidebar .link-ia:hover, .sidebar .link-ia.active { border-left-color: var(--color-ia-specialist); }
    .sidebar .link-aulas:hover, .sidebar .link-aulas.active { border-left-color: var(--color-video-lessons); }
    .sidebar .link-percurso:hover, .sidebar .link-percurso.active { border-left-color: var(--color-journey); }
    .sidebar-footer { padding: 20px 30px; text-align: center; }
    .sidebar-config-btn { width: 100%; background: transparent; border: 1px solid #444; color: #aaa; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95em; font-weight: 600; transition: all 0.2s ease-in-out; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .sidebar-config-btn:hover { background-color: #333; color: #fff; }
    .sidebar-action-btn { width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease-in-out; margin-top: 10px; }
    .sidebar-reset-btn { background-color: transparent; border: 1px solid var(--color-ia-specialist); color: var(--color-ia-specialist); }
    .sidebar-reset-btn:hover { background-color: var(--color-ia-specialist); color: #fff; }
    .sidebar-logout-btn { background-color: #be123c; border: 1px solid #be123c; color: #fff; }
    .sidebar-logout-btn:hover { background-color: #ff4757; border-color: #ff4757; }
    .hidden { display: none; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .overlay.show { opacity: 1; visibility: visible; }
    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }
    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .iframe-container { border-radius: 12px; overflow: hidden; height: auto; position: relative; }
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }
    .playlist-section { text-align: center; margin: 40px 0; }
    .playlist-btn { background-color: #007BFF; color: white; border: none; padding: 12px 24px; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 25px; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .percurso-forms { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
    .percurso-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border: 1px solid rgba(190,18,60,0.12); padding: 20px; border-radius: 12px; }
    .percurso-card h4 { margin-top: 0; color: white; }
    .small-note { font-size: 13px; color: #cfc; opacity: 0.7; margin-top: 6px; }
    /* mobile mask / dify etc kept as-is */
    #dify-container { position: relative; width: 100%; margin: 18px auto 0 auto; padding: 0; }
    .dify-frame { position: relative; border-radius: 16px; overflow: hidden; background: linear-gradient(180deg, #0b0b0b, #121212); border: 3px solid rgba(0,0,0,0.9); box-shadow: 0 30px 60px rgba(0,0,0,0.7), inset 0 2px 0 rgba(255,255,255,0.02); min-height: 780px; }
    .dify-frame iframe { display: block; width: 100%; height: 100%; border: 0; min-height: 740px; background: transparent; }
    .dify-top-strip { position: absolute; top: 14px; left: 14px; right: 14px; height: 64px; background: linear-gradient(180deg, rgba(0,0,0,0.995), rgba(18,18,18,0.98)); z-index: 200; display: flex; align-items: center; justify-content: space-between; padding: 0 18px; border-radius: 12px; box-shadow: 0 18px 36px rgba(0,0,0,0.55); backdrop-filter: blur(6px) saturate(140%); pointer-events: none; opacity: 0.995; border: 1px solid rgba(255,255,255,0.02); }
    .dify-top-strip .mvp-label { color: #fff; font-weight: 700; font-family: 'Poppins', sans-serif; font-size: 15px; letter-spacing: 0.2px; background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(255,255,255,0.85)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.6)); }
    .dify-top-badge { display: inline-flex; align-items: center; gap: 10px; height: 36px; padding: 6px 14px; border-radius: 999px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.02); color: #e6e6e6; font-size: 14px; font-weight: 700; pointer-events: none; z-index: 201; }
    .dify-frame .dify-bottom-mask { display: none; }
    @media (max-width: 900px) {
      /* preserved mobile styles (omitted here for brevity) */
    }
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Fale com a IA</h2>
      <div id="dify-container" class="iframe-container"></div>
      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>
      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
      </div>

      <div class="percurso-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>
        <div id="dieta-form-area">
          <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta</label><textarea id="objetivo_dieta" placeholder="Ex: déficit calórico para secar..."></textarea></div>
          <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>
          <div class="form-group"><label for="restricoes_dieta">Restrições / preferências alimentares</label><input id="restricoes_dieta" type="text" placeholder="Ex: sem lactose, vegetariano"></div>
          <div style="display:flex;gap:10px;"><button id="gerar-dieta-btn" style="flex:1;padding:10px;border-radius:8px;background:#0b84ff;border:none;color:white;cursor:pointer">Gerar Dieta</button><button id="salvar-dieta-btn" style="flex:1;padding:10px;border-radius:8px;background:#22c55e;border:none;color:white;cursor:pointer">Salvar Plano</button></div>
          <div id="dieta-result" style="margin-top:12px;color:#ddd;font-size:14px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

</div> 

<!-- Supabase client -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ========== CONFIGURATION (kept your values) ==========
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  // ---------- Minimal initial foods sample (if DB empty we'll insert these).
  // NOTE: to import the full list use the supabase_import.sql provided in the canvas or
  // run a batch insert script — I provided that earlier.
  const INITIAL_FOODS_SAMPLE = [
    "Arroz, integral cozido",
    "Frango, peito, sem pele, grelhado",
    "Ovo, inteiro cozido",
    "Batata, inglesa cozida",
    "Banana, nanica crua",
    "Maçã, Fuji, com casca crua",
    "Abacate cru",
    "Brócolis cozido",
    "Feijão, carioca cozido",
    "Aveia, flocos crua",
    "Azeite, de oliva, extra virgem",
    "Queijo, minas, frescal",
    "Pão, trigo, forma, integral",
    "Salmão, sem pele, fresco grelhado"
  ];

  // Utility: shows short messages in diet result area
  function showDietaMessage(text, isError=false) {
    const el = document.getElementById('dieta-result');
    el.style.color = isError ? '#ff6b6b' : '#cbe7ff';
    el.innerText = text;
  }

  // ========== NUTRITION HEURISTICS ==========
  // Heuristic category guess + estimated nutrients per 100g (kcal, prot, carbs, fat)
  function guessCategory(name) {
    const n = name.toLowerCase();
    if (/(frango|carne|picanha|peito|atum|salmão|sardinha|camarão|abadejo|merluza|pescada|bacalhau)/.test(n)) return 'protein';
    if (/(arroz|pão|macarr|massa|batata|mandioca|nhoque|milho|polenta|tapioca|cereal)/.test(n)) return 'grain';
    if (/(feijão|lentilha|soja|ervilha|grão|amendoim|tofu)/.test(n)) return 'legume';
    if (/(azeite|óleo|manteiga|margarina|noz|castanha|amêndoa|linhaça|gergelim)/.test(n)) return 'fat';
    if (/(iogurte|leite|queijo|ovo)/.test(n)) return 'dairy';
    if (/(bolo|biscoito|chocolate|salgado|pastel|pizza|processado|refrigerante|achocolatado|doces)/.test(n)) return 'processed';
    if (/(suco|agua|cerveja|chá|café)/.test(n)) return 'beverage';
    return 'vegfruit';
  }
  function estimateNutrientsByCategory(cat) {
    // values per 100g (approx)
    switch(cat) {
      case 'protein': return {k:200, p:26, c:0, f:8};
      case 'grain': return {k:130, p:3.5, c:28, f:1.5};
      case 'legume': return {k:110, p:8, c:17, f:1.5};
      case 'fat': return {k:900, p:0, c:0, f:100};
      case 'dairy': return {k:150, p:8, c:6, f:8};
      case 'processed': return {k:400, p:6, c:45, f:20};
      case 'beverage': return {k:50, p:0, c:12, f:0};
      default: return {k:50, p:1.2, c:8, f:0.2};
    }
  }

  // ========== ALGORITHM: TMB / TDEE / MACROS / MEALS ==========
  function calcTMB(sex, weightKg, heightM, age) {
    // Mifflin-St Jeor
    const s = (String(sex||'').toLowerCase().startsWith('f')) ? -161 : 5;
    const heightCm = heightM * 100;
    return 10 * weightKg + 6.25 * heightCm - 5 * age + s;
  }
  function activityFactorByLevel(level, days) {
    if (!level) return (days>=4?1.55:1.375);
    level = level.toLowerCase();
    if (level.includes('iniciante') || level.includes('sedent')) return 1.2;
    if (level.includes('intermediario') || level.includes('leve')) return 1.375;
    if (level.includes('avancado') || level.includes('moderado')) return 1.55;
    return 1.55;
  }

  function generateDietPlan(formInputs, foodsList) {
    // formInputs: { peso, altura, idade, disponibilidade (dias), nivel, objetivo, restricoes, orcamento }
    // foodsList: array of { name } or simple names
    const weight = Number(formInputs.peso);
    const height = Number(formInputs.altura);
    const age = Number(formInputs.idade);
    const sex = formInputs.sexo;
    const days = Number(formInputs.disponibilidade)||0;
    const level = formInputs.nivel;
    const goal = (formInputs.objetivo || '').toLowerCase();

    // 1) TMB -> TDEE
    const tmb = calcTMB(sex, weight, height, age);
    const factor = activityFactorByLevel(level, days);
    const tdee = Math.round(tmb * factor);

    // 2) adjust for goal
    let targetCalories = tdee;
    if (goal.includes('perder') || goal.includes('emagrecer') || goal.includes('secar')) targetCalories = Math.round(tdee - 500);
    else if (goal.includes('ganhar') || goal.includes('hipertrofia') || goal.includes('massa')) targetCalories = Math.round(tdee + 300);

    // floor/ceil safe
    if (targetCalories < 1000) targetCalories = Math.max(1000, targetCalories);

    // 3) macros
    const proteinPerKg = (days >= 3) ? 1.8 : 1.2; // g/kg
    const proteinG = Math.round(weight * proteinPerKg * 10) / 10;
    const proteinCals = proteinG * 4;
    const fatCals = targetCalories * 0.25;
    const fatG = Math.round((fatCals / 9) * 10) / 10;
    const carbsCals = targetCalories - proteinCals - fatCals;
    const carbsG = Math.round((carbsCals / 4) * 10) / 10;

    // 4) choose meal count and distribute
    const mealsCount = (days >= 3) ? 5 : 4;
    const baseSplit = [0.22,0.12,0.28,0.18,0.12,0.08].slice(0, mealsCount);
    let sum = baseSplit.reduce((a,b)=>a+b,0);
    const split = baseSplit.map(x => x/sum);

    // 5) prepare foods with heuristics
    const foods = foodsList.map(f => {
      const name = (typeof f === 'string') ? f : (f.name || f);
      const cat = guessCategory(name);
      const est = estimateNutrientsByCategory(cat);
      return { name, category: cat, kcal100g: est.k, prot100g: est.p, carb100g: est.c, fat100g: est.f };
    });

    // helper: pick a random candidate by category preference
    function pickCandidateFor(type) {
      let candidates;
      if (type === 'protein') candidates = foods.filter(x => x.category==='protein' || x.category==='dairy' || x.category==='legume');
      else if (type === 'carb') candidates = foods.filter(x => x.category==='grain' || x.category==='processed' || x.category==='vegfruit');
      else candidates = foods.filter(x => x.category==='vegfruit' || x.category==='fat' || x.category==='legume');
      if (!candidates || candidates.length===0) candidates = foods;
      return candidates[Math.floor(Math.random()*candidates.length)];
    }

    // 6) Build meal objects with portion grams to reach macro slice (heuristic)
    const meals = [];
    for (let i=0;i<mealsCount;i++){
      const mCal = Math.round(targetCalories * split[i]);
      const protShare = proteinG * split[i];
      const carbShare = carbsG * split[i];
      // choose foods
      const protFood = pickCandidateFor('protein');
      const carbFood = pickCandidateFor('carb');
      const vegFood = pickCandidateFor('veg');
      const portions = [];

      // compute grams based on macronutrient density
      function gramsForMacro(food, macroTargetGram, macroKey) {
        const per100 = food[macroKey+'100g'] || 0.1;
        const grams = Math.max(15, Math.round((macroTargetGram / per100) * 100 / 10) * 10);
        return grams;
      }
      // protein portion
      let protGrams = gramsForMacro(protFood, protShare, 'prot');
      // carb portion
      let carbGrams = gramsForMacro(carbFood, carbShare, 'carb');
      // veg grams just a serving
      let vegGrams = Math.max(50, Math.round(120 * split[i]));

      function kcalFrom(food, g) { return Math.round(food.kcal100g * g / 100); }

      portions.push({ food: protFood.name, grams: protGrams, kcal: kcalFrom(protFood, protGrams) });
      portions.push({ food: carbFood.name, grams: carbGrams, kcal: kcalFrom(carbFood, carbGrams) });
      portions.push({ food: vegFood.name, grams: vegGrams, kcal: kcalFrom(vegFood, vegGrams) });

      const mealKcal = portions.reduce((a,b)=>a+b.kcal,0);
      meals.push({ name: `Refeição ${i+1}`, kcal: mealKcal, portions });
    }

    // 7) build final plan
    const plan = {
      generated_at: new Date().toISOString(),
      tmb, tdee, targetCalories,
      macros: { protein_g: proteinG, fat_g: fatG, carbs_g: carbsG },
      meals,
      notes: "Estimativa gerada automaticamente. Valores aproximados; para produção, carregue base nutricional detalhada (TACO/USDA)."
    };
    return plan;
  }

  // ========== SUPABASE HELPERS ==========
  async function ensureFoodsTableHasData() {
    // check foods table
    try {
      const { data, error } = await supabase.from('foods').select('id,name').limit(1);
      if (error && error.message && error.message.includes('relation "foods"')) {
        // table missing
        return { ok: false, reason: 'missing_table' };
      }
      if (!data || data.length === 0) {
        // insert sample items in batches
        const rows = INITIAL_FOODS_SAMPLE.map(n => ({ name: n }));
        const { error: insertErr } = await supabase.from('foods').insert(rows);
        if (insertErr) {
          console.warn('Erro ao inserir sample foods:', insertErr);
          return { ok: false, reason: 'insert_error', error: insertErr };
        }
        return { ok: true, inserted: rows.length };
      }
      return { ok: true, present: true };
    } catch(err) {
      console.error('ensureFoodsTableHasData error', err);
      return { ok: false, reason: 'unknown', error: err };
    }
  }

  async function fetchAllFoodsFromDB() {
    try {
      const { data, error } = await supabase.from('foods').select('name').order('id', {ascending:true});
      if (error) {
        if (error.message && error.message.includes('relation "foods"')) throw new Error('missing_table');
        throw error;
      }
      return data.map(r => r.name);
    } catch(e) {
      throw e;
    }
  }

  async function saveDietToDB(userId, planObject, meta) {
    // meta: { objective, budget, restrictions }
    try {
      // try to insert into 'diets' table
      const payload = {
        user_id: userId,
        created_at: new Date().toISOString(),
        plan_json: planObject,
        objective: meta.objective || null,
        budget: meta.budget || null,
        restrictions: meta.restrictions || null
      };
      const { data, error } = await supabase.from('diets').insert([payload]).select();
      if (error) {
        if (error.message && error.message.includes('relation "diets"')) {
          // missing table -> return helpful message with SQL
          return { ok: false, reason: 'missing_table' };
        }
        return { ok: false, reason: 'insert_error', error };
      }
      return { ok: true, data };
    } catch (e) {
      console.error('saveDietToDB error', e);
      return { ok: false, reason: 'exception', error: e };
    }
  }

  // SQL for user if diets table missing (we'll surface it)
  const DIETS_TABLE_SQL = `-- SQL para criar tabela 'diets' no Supabase (Postgres)
CREATE TABLE IF NOT EXISTS diets (
  id serial PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  objective text,
  budget text,
  restrictions text,
  plan_json jsonb
);`;

  // ========== UI & EVENTS ==========
  document.addEventListener('DOMContentLoaded', async () => {
    // preserve menu logic
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const navLinks = document.querySelectorAll('.nav-link');
    const configBtn = document.getElementById('config-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const resetBtn = document.getElementById('reset-btn');

    const switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      navLinks.forEach(link => link.classList.remove('active'));
      const l = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
      if (l) l.classList.add('active');
    };
    const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
    menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
    overlay.addEventListener('click', closeMenu);
    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
    configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
    logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });

    // Auth check & profile fetch
    const { data: authData } = await supabase.auth.getUser();
    if (!authData || !authData.user) {
      // not logged in -> redirect to login (consistent with original)
      window.location.replace('/login.html');
      return;
    }
    const user = authData.user;
    document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;

    // ensure foods presence (insert sample if empty)
    const ensure = await ensureFoodsTableHasData();
    if (!ensure.ok && ensure.reason === 'missing_table') {
      // show gentle message in diet result area
      showDietaMessage("A tabela 'foods' não existe no Supabase. Execute o SQL `supabase_import.sql` no SQL Editor para criá-la. (Ver canvas/README para o SQL completo.)", true);
    }

    // load profile as earlier (keeps your original logic)
    const { data: profile, error: profileErr } = await supabase.from('profiles').select('*').eq('id', user.id).single();
    if (profileErr || !profile) {
      console.error('Erro ao buscar perfil:', profileErr);
      // allow user to continue but warn
      showDietaMessage('Perfil não encontrado no Supabase. Algumas funcionalidades podem não funcionar.', true);
    }

    // keep dify chat load as before
    (function loadFreshDifyChat(){
      const difyContainer = document.getElementById('dify-container');
      if (!difyContainer) return;
      difyContainer.innerHTML='';
      const frameWrap = document.createElement('div'); frameWrap.className='dify-frame';
      const iframe = document.createElement('iframe');
      const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
      iframe.src = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark`;
      iframe.allow='microphone';
      frameWrap.appendChild(iframe);
      const strip = document.createElement('div'); strip.className='dify-top-strip'; strip.setAttribute('aria-hidden','true');
      const badge = document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
      const label = document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
      strip.appendChild(badge); strip.appendChild(label);
      const bottomMask = document.createElement('div'); bottomMask.className='dify-bottom-mask'; bottomMask.setAttribute('aria-hidden','true');
      frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask); difyContainer.appendChild(frameWrap);
    })();

    // Hook buttons on dieta card
    const gerarBtn = document.getElementById('gerar-dieta-btn');
    const salvarBtn = document.getElementById('salvar-dieta-btn');
    let lastGeneratedPlan = null;
    gerarBtn.addEventListener('click', async () => {
      showDietaMessage('Gerando dieta — por favor aguarde...');
      // gather inputs from dieta-card
      const objetivo = document.getElementById('objetivo_dieta').value || '';
      const orcamento = document.getElementById('orcamento_dieta').value || '';
      const restricoes = document.getElementById('restricoes_dieta').value || '';
      // also pull some data from IA form if present (if user filled earlier)
      // we try to read the big ia form values (first area) for height/weight etc if present
      const altura = document.getElementById('altura') ? document.getElementById('altura').value : '';
      const peso = document.getElementById('peso') ? document.getElementById('peso').value : '';
      const idade = document.getElementById('idade') ? document.getElementById('idade').value : '';
      const dias = document.getElementById('disponibilidade') ? document.getElementById('disponibilidade').value : '';
      const sexo = document.getElementById('sexo') ? document.getElementById('sexo').value : '';
      const nivel = document.getElementById('nivel') ? document.getElementById('nivel').value : '';

      if (!peso || !altura || !idade || !sexo) {
        showDietaMessage('Preencha altura, peso, idade e sexo no formulário principal (IA Especialista) antes de gerar a dieta.', true);
        return;
      }

      // fetch foods from DB
      let foods = [];
      try {
        foods = await fetchAllFoodsFromDB();
      } catch(e){
        if (e.message === 'missing_table') {
          showDietaMessage("A tabela 'foods' não existe no Supabase. Importe os alimentos usando o SQL no canvas ('supabase_import.sql').", true);
          return;
        } else {
          console.error(e);
          showDietaMessage('Erro ao buscar alimentos do Supabase. Ver console.', true);
          return;
        }
      }

      // If foods is empty, try to use the initial sample
      if (!foods || foods.length === 0) {
        foods = INITIAL_FOODS_SAMPLE;
      }

      // build formInputs object expected by generator
      const formInputs = {
        sexo: sexo,
        altura: parseFloat(altura),
        peso: parseFloat(peso),
        idade: parseInt(idade,10),
        disponibilidade: parseInt(dias,10) || 0,
        nivel: nivel,
        objetivo: objetivo,
        restricoes: restricoes,
        orcamento: orcamento
      };

      const plan = generateDietPlan(formInputs, foods);
      lastGeneratedPlan = plan;
      // render plan in dieta-card (summary)
      const resultEl = document.getElementById('dieta-result');
      const html = [];
      html.push(`Meta calórica estimada: ${plan.targetCalories} kcal`);
      html.push(`Macros (g): Proteína ${plan.macros.protein_g}g • Gordura ${plan.macros.fat_g}g • Carboidrato ${plan.macros.carbs_g}g`);
      html.push('--- Refeições sugeridas ---');
      plan.meals.forEach(m => {
        html.push(`${m.name} — ${m.kcal} kcal`);
        m.portions.forEach(p => html.push(` • ${p.food} — ${p.grams} g (${p.kcal} kcal)`));
      });
      html.push('--- Observações ---');
      html.push(plan.notes);
      resultEl.style.whiteSpace='pre-wrap';
      resultEl.innerText = html.join('\n');
      showDietaMessage('Dieta gerada (visualização). Use "Salvar Plano" para persistir no Supabase.');
      // also switch to Percurso tab so user sees result (optional)
      // switchTab('percurso'); // not necessary, user is already there
    });

    salvarBtn.addEventListener('click', async () => {
      if (!lastGeneratedPlan) {
        showDietaMessage('Nenhuma dieta gerada — clique em "Gerar Dieta" primeiro.', true);
        return;
      }
      showDietaMessage('Salvando plano no Supabase...');
      const objective = document.getElementById('objetivo_dieta').value || '';
      const budget = document.getElementById('orcamento_dieta').value || '';
      const restrictions = document.getElementById('restricoes_dieta').value || '';
      const result = await saveDietToDB(user.id, lastGeneratedPlan, { objective, budget, restrictions });
      if (!result.ok) {
        if (result.reason === 'missing_table') {
          // show SQL to create diets table so the user can paste it in Supabase SQL editor
          showDietaMessage("A tabela 'diets' não existe no Supabase. Por favor execute o SQL abaixo no SQL Editor do Supabase para criá-la:\n\n" + DIETS_TABLE_SQL, true);
        } else {
          console.error('Erro ao salvar plano:', result);
          showDietaMessage('Erro ao salvar plano no Supabase. Veja console para detalhes.', true);
        }
        return;
      }
      showDietaMessage('Plano salvo com sucesso!');
    });

    // keep original IA form logic (submit to set goals)
    const iaFitForm = document.getElementById('ia-fit-form');
    if (iaFitForm) {
      iaFitForm.addEventListener('submit', async function(event){
        event.preventDefault();
        const formElements = event.target.elements;
        const prazoText = formElements.prazo.value;
        // try to compute a date using same helper logic (copied simply)
        function getEaster(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
        function calculateEndDate(prazoText) {
          if(!prazoText) return null;
          const now = new Date();
          const year = now.getFullYear();
          let prazoLower = prazoText.toLowerCase();
          if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); }
          let match = prazoLower.match(/(\\d+)\\s+mes(es)?/);
          if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; }
          match = prazoLower.match(/(\\d+)\\s+dia(s)?/);
          if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; }
          if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); }
          if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); }
          if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); }
          if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); }
          return null;
        }
        const endDate = calculateEndDate(prazoText);
        if (!endDate) {
          console.error("Prazo da meta inválido.");
          showDietaMessage('Prazo inválido — use um formato como "3 meses" ou "até o verão".', true);
          return;
        }
        const startDate = new Date(); startDate.setHours(0,0,0,0);
        const objetivoText = formElements.objetivo.value;
        function analyzeGoal(text) {
          const lower = (text||'').toLowerCase();
          const emagrecerKeywords = ['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento'];
          const musculoKeywords = ['ganhar musculo','hipertrofia','crescer','massa muscular','ficar forte','músculo'];
          const hasE = emagrecerKeywords.some(k=>lower.includes(k));
          const hasM = musculoKeywords.some(k=>lower.includes(k));
          if (hasE && !hasM) return 'emagrecer';
          if (hasM && !hasE) return 'musculo';
          return 'ambos';
        }
        const goalType = analyzeGoal(objetivoText);
        // update profiles table
        const { error } = await supabase.from('profiles').update({
          goal_start_date: startDate.toISOString(),
          goal_end_date: endDate.toISOString(),
          goal_prompt: objetivoText,
          goal_type: goalType
        }).eq('id', user.id);
        if (error) {
          console.error("Erro ao salvar a meta: " + error.message);
          showDietaMessage('Erro ao salvar sua meta no perfil.', true);
        } else {
          // show progress area
          function displayProgress(startDate, endDate) {
            const now = new Date(); now.setHours(0,0,0,0);
            const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
            const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
            const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime();
            const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24));
            let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100;
            document.getElementById('progress-bar').style.width=`${progressPercentage}%`;
            document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR');
            document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR');
            document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0;
            document.getElementById('form-wrapper').style.display='none';
            document.getElementById('results-wrapper').style.display='block';
          }
          displayProgress(startDate, endDate);
          document.getElementById('playlist-section').style.display = 'block';
          showDietaMessage('Meta salva! Agora você pode gerar e salvar um plano de dieta na aba Percurso.', false);
        }
      });
    }

  }); // DOMContentLoaded end
</script>

</body>
</html>
