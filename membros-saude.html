<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* (orig. CSS omitted for brevity in this preview) */
    :root{--color-ia-specialist:#007BFF;--color-video-lessons:#8A2BE2;--color-journey:#DC143C;--journey-red-1:#ff2646;--journey-red-2:#be123c;--journey-dark:#2a0a12}html{scroll-behavior:smooth}body{font-family:'Poppins',sans-serif;background-color:#121212;color:#E0E0E0;margin:0;padding:40px 20px}/* full CSS same as original - keep exact when deploying */
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Fale com a IA</h2>
      <div id="dify-container" class="iframe-container"></div>
      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>
      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
      </div>

      <div class="percurso-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>
        <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta</label><textarea id="objetivo_dieta" placeholder="Ex: déficit calórico para secar..."></textarea></div>
        <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>
        <div class="form-group"><label for="calorias_dieta">Calorias diárias sugeridas</label><input id="calorias_dieta" type="number" placeholder="Ex: 2000"></div>
        <div class="form-group"><label for="refeicoes_dieta">Número de refeições / dia</label><input id="refeicoes_dieta" type="number" min="1" max="8" value="3"></div>
        <div class="form-group"><label>Plano de Refeições Sugerido</label><div id="meal-plan" style="background:#1b1b1b;padding:12px;border-radius:8px;min-height:80px;color:#ddd;white-space:pre-wrap;"></div></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"><button id="save-diet-btn" class="playlist-btn">Salvar Dieta</button></div>
      </div>
    </div>
  </div>
</div>

</div> 
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // ====== CONFIGURAÇÃO ======
    const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

    // -------------------------------
    // CATALOGO DE COMIDAS (string grande) - será usada para seed no banco
    // -------------------------------
    const FOODS_CATALOG_RAW = `Abóbora, cabotián cozida
Abóbora, moranga refogada
Abobrinha, italiana cozida
Abobrinha, italiana crua
Abobrinha, italiana refogada
Abobrinha, paulista crua
Acelga crua
Agrião cru
Aipo cru
Alface, americana crua
Alface, crespa crua
Alface, lisa crua
Alface, roxa crua
Alfavaca crua
Alho cru
Alho-poró cru
Almeirão cru
Almeirão refogado
Batata, baroa cozida
Batata, doce cozida
Batata frita, tipo chips industrializada
Batata, inglesa cozida
Batata, inglesa frita
Batata, inglesa sauté
Berinjela cozida
Beterraba cozida
Beterraba crua
Brócolis cozido
Brócolis cru
Cará cozido
... (lista completa incluída no deploy)
`; // <-- ao implantar, substitua '...(lista completa incluída no deploy)' por a lista completa provida

    // função que transforma o catálogo em array limpo
    function parseFoodsCatalog(raw) {
      return raw.split('\n').map(s => s.trim()).filter(Boolean).map(name => ({ name }));
    }

    // seed foods em tabela 'foods' se estiver vazia
    async function seedFoodsIfNeeded() {
      try {
        const { data: existing, error: selErr } = await supabase.from('foods').select('id').limit(1);
        if (selErr) {
          // se a tabela não existir, não interrompe — loga e retorna
          console.warn('Não foi possível checar tabela foods (talvez não exista):', selErr.message);
          return;
        }
        if (existing && existing.length > 0) return; // já tem dados
        const foods = parseFoodsCatalog(FOODS_CATALOG_RAW);
        // inserir em batches de 200 para evitar payloads gigantes
        const batchSize = 200;
        for (let i = 0; i < foods.length; i += batchSize) {
          const chunk = foods.slice(i, i + batchSize);
          const { error } = await supabase.from('foods').insert(chunk);
          if (error) console.error('Erro ao inserir chunk foods:', error.message);
        }
        console.log('Seed de foods executada (se tabela existia e estava vazia).');
      } catch (e) { console.error('Erro seedFoodsIfNeeded', e); }
    }

    // --- FUNÇÕES DE LÓGICA (mantidas/atualizadas) ---
    function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
    function calculateEndDate(prazoText) { if(!prazoText) return null; const now = new Date(); const year = now.getFullYear(); let prazoLower = prazoText.toLowerCase(); if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); } let match = prazoLower.match(/(\d+)\s+mes(es)?/); if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; } match = prazoLower.match(/(\d+)\s+dia(s)?/); if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; } if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); } if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); } if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); } if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); } return null; }
    function displayProgress(startDate, endDate) { const now = new Date(); now.setHours(0,0,0,0); const sDate = new Date(startDate); sDate.setHours(0,0,0,0); const eDate = new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; document.getElementById('progress-bar').style.width=`${progressPercentage}%`; document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR'); document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR'); document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0; document.getElementById('form-wrapper').style.display='none'; document.getElementById('results-wrapper').style.display='block'; }
    function analyzeGoal(text) { const lowerText = (text||'').toLowerCase(); const emagrecerKeywords = ['emagrecer', 'perder peso', 'secar', 'definir', 'perder gordura', 'definição', 'emagrecimento']; const musculoKeywords = ['ganhar musculo', 'hipertrofia', 'sheipado', 'crescer', 'massa muscular', 'ficar forte', 'músculo']; const hasEmagrecer = emagrecerKeywords.some(keyword => lowerText.includes(keyword)); const hasMusculo = musculoKeywords.some(keyword => lowerText.includes(keyword)); if (hasEmagrecer && !hasMusculo) return 'emagrecer'; if (hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; }
    function reorderVideos(order) { const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

    // -------------------------------
    // GERAÇÃO DO PLANO DE DIETA SIMPLIFICADO
    // -------------------------------
    // heurística: calcula TMB (Mifflin-St Jeor) e TDEE por disponibilidade; aplica déficit/superávit conforme objetivo
    function calculateBMR({sexo, peso, altura, idade}){
      // altura em m -> cm
      const hCm = parseFloat(altura) * 100;
      const w = parseFloat(peso);
      const age = parseInt(idade,10);
      if (sexo === 'feminino') {
        return Math.round(10*w + 6.25*hCm - 5*age - 161);
      } else {
        return Math.round(10*w + 6.25*hCm - 5*age + 5);
      }
    }
    function activityFactor(disponibilidade){
      // aproximação: mais dias -> maior TDEE
      const d = Number(disponibilidade)||3;
      if (d<=1) return 1.2;
      if (d===2) return 1.3;
      if (d===3) return 1.4;
      if (d===4) return 1.5;
      if (d===5) return 1.6;
      return 1.65;
    }

    async function pickFoodsSample() {
      // tenta buscar alimentos da tabela 'foods' com palavras-chave úteis
      try{
        const { data } = await supabase.from('foods').select('name').limit(300);
        if (!data) return ['Arroz integral','Frango grelhado','Brócolis cozido','Ovo cozido','Banana'];
        // priorizar fontes de proteína, carbo, veg
        const names = data.map(r=>r.name);
        const proteins = names.filter(n=>/frango|peito|bife|ovo|salm(o|ão)|atum|sardinha|peixe|carne|tofu/i.test(n)).slice(0,6);
        const carbs = names.filter(n=>/arroz|macarr|pão|batata|massa|milho|aveia|farinha|polenta|massa/i.test(n)).slice(0,6);
        const veggies = names.filter(n=>/alface|tomate|brócolis|cenoura|espinafre|abobrinha|berinjela|couve|repolho|vagem|abacate|pepino/i.test(n)).slice(0,8);
        const fruits = names.filter(n=>/banana|maçã|laranja|manga|morango|pera|uva|melancia|mamão|abacaxi/i.test(n)).slice(0,6);
        // fallback se arrays vazios
        return [
          ...(proteins.length?proteins:['Frango grelhado']),
          ...(carbs.length?carbs:['Arroz integral']),
          ...(veggies.length?veggies:['Brócolis cozido']),
          ...(fruits.length?fruits:['Banana'])
        ].slice(0,12);
      }catch(e){ console.warn('pickFoodsSample erro', e); return ['Arroz integral','Frango grelhado','Brócolis cozido','Ovo cozido','Banana']; }
    }

    async function generateDietPlan(profile, formData){
      // profile: user profile from DB; formData: dados do formulario (objetivo, orcamento, etc)
      const bmr = calculateBMR(profile);
      const factor = activityFactor(formData.disponibilidade);
      const tdee = Math.round(bmr * factor);
      let targetCalories = tdee;
      if (formData.goal_type === 'emagrecer') targetCalories = Math.max(1100, tdee - 500);
      else if (formData.goal_type === 'musculo') targetCalories = tdee + 300;
      else targetCalories = Math.max(1300, tdee - 250);

      const mealsPerDay = (formData.nivel === 'avancado' || Number(formData.disponibilidade) >=5) ? 4 : 3;
      const perMeal = Math.round(targetCalories / mealsPerDay);

      const foods = await pickFoodsSample();
      // montar plano de refeições simples
      const mealPlanLines = [];
      for (let m = 1; m <= mealsPerDay; m++){
        const protein = foods[(m-1)%foods.length] || 'Frango grelhado';
        const carb = foods[(m+1)%foods.length] || 'Arroz integral';
        const veg = foods[(m+2)%foods.length] || 'Salada verde';
        mealPlanLines.push(`Refeição ${m}: ~${perMeal} kcal — ${protein} + ${carb} + ${veg}`);
      }

      const mealPlanText = `Calorias alvo: ${targetCalories} kcal/dia\nRefeições por dia: ${mealsPerDay}\n\n${mealPlanLines.join('\n')}`;

      return { targetCalories, mealsPerDay, mealPlanText };
    }

    // -------------------------------
    // FUNÇÕES DE SALVAMENTO / CARREGAMENTO DE DIET
    // -------------------------------
    async function saveDietForUser(userId, dietObj){
      try{
        const payload = {
          user_id: userId,
          goal_type: dietObj.goal_type || null,
          calories: dietObj.targetCalories || null,
          meals_per_day: dietObj.mealsPerDay || null,
          budget: dietObj.budget || null,
          diet_json: dietObj, // JSON completo
          created_at: new Date().toISOString()
        };
        const { error } = await supabase.from('diets').insert([payload]);
        if (error) console.error('Erro ao salvar dieta:', error.message);
        return !error;
      }catch(e){ console.error('saveDietForUser error', e); return false; }
    }

    async function loadLatestDietForUser(userId){
      try{
        const { data, error } = await supabase.from('diets').select('*').eq('user_id', userId).order('created_at',{ascending:false}).limit(1).single();
        if (error) return null; return data;
      }catch(e){ console.warn('loadLatestDietForUser', e); return null; }
    }

    // -------------------------------
    // INICIALIZAÇÃO E LÓGICA DE UI
    // -------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        let user = null;
        let currentProfile = null;
        const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navLinks = document.querySelectorAll('.nav-link'); const configBtn = document.getElementById('config-btn'); const logoutBtn = document.getElementById('logout-btn'); const resetBtn = document.getElementById('reset-btn');
        const switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.getElementById(tabId).classList.add('active'); navLinks.forEach(link => link.classList.remove('active')); document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active'); };
        const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
        menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
        overlay.addEventListener('click', closeMenu);
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
        configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
        logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
        resetBtn.addEventListener('click', async () => { if (!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null, }).eq('id', user.id); if (resetError) { console.error('Erro ao resetar a meta: ' + resetError.message); } else { window.location.reload(); } });

        async function initializePageData() {
            const { data } = await supabase.auth.getUser();
            if (!data.user) { window.location.replace('/login.html'); return; }
            user = data.user;
            document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
            const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (error || !profile) { console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }
            currentProfile = profile;

            // seed foods quietly (se tabela existir e estiver vazia)
            seedFoodsIfNeeded();

            if (profile.goal_end_date) { 
                displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); 
                if (profile.goal_type) document.getElementById('playlist-section').style.display = 'block'; 
            } else { 
                document.getElementById('form-wrapper').style.display = 'block'; 
            }

            // carregar dieta existente e popular formulário da aba percurso
            const latestDiet = await loadLatestDietForUser(user.id);
            if (latestDiet) {
              document.getElementById('objetivo_dieta').value = latestDiet.diet_json?.mealPlanText || '';
              document.getElementById('orcamento_dieta').value = latestDiet.budget || '';
              if (latestDiet.calories) document.getElementById('calorias_dieta').value = latestDiet.calories;
              if (latestDiet.meals_per_day) document.getElementById('refeicoes_dieta').value = latestDiet.meals_per_day;
              document.getElementById('meal-plan').textContent = latestDiet.diet_json?.mealPlanText || '';
            }

            // =========================================================================
            // IMPLEMENTAÇÃO DO CHAT: injeta iframe, moldura, faixa superior e máscara inferior
            // =========================================================================
            function loadFreshDifyChat() {
                const difyContainer = document.getElementById('dify-container');
                if (!difyContainer) return;

                difyContainer.innerHTML = '';

                const frameWrap = document.createElement('div');
                frameWrap.className = 'dify-frame';

                const iframe = document.createElement('iframe');
                const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
                const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;

                iframe.src = difyUrl;
                iframe.allow = 'microphone';
                frameWrap.appendChild(iframe);

                // faixa superior
                const strip = document.createElement('div');
                strip.className = 'dify-top-strip';
                strip.setAttribute('aria-hidden', 'true');
                const badge = document.createElement('div');
                badge.className = 'dify-top-badge';
                badge.textContent = 'Fale com a IA';
                const label = document.createElement('span');
                label.className = 'mvp-label';
                label.textContent = 'MVPia';
                strip.appendChild(badge);
                strip.appendChild(label);

                // máscara inferior (cobre o credit dentro da moldura)
                const bottomMask = document.createElement('div');
                bottomMask.className = 'dify-bottom-mask';
                bottomMask.setAttribute('aria-hidden', 'true');

                frameWrap.appendChild(strip);
                frameWrap.appendChild(bottomMask);
                difyContainer.appendChild(frameWrap);
            }

            loadFreshDifyChat();
            // =========================================================================

            // restante da lógica (sem alterações)
            const objetivoInput = document.getElementById('objetivo'); if (objetivoInput) { objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; }); }
            const usoSuplementoSelect = document.getElementById('uso_suplemento'); if (usoSuplementoSelect) { usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim')document.getElementById('quais_suplementos').value=''; }); }

            const iaFitForm = document.getElementById('ia-fit-form'); if(iaFitForm) { iaFitForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formElements = event.target.elements;
                const prazoText = formElements.prazo.value;
                const endDate = calculateEndDate(prazoText);
                if (!endDate) { console.error("Prazo da meta inválido."); return; }
                const startDate = new Date(); startDate.setHours(0,0,0,0);
                const objetivoText = formElements.objetivo.value;
                const goalType = analyzeGoal(objetivoText);

                // atualizar perfil
                const { error: updateError } = await supabase.from('profiles').update({ 
                    goal_start_date: startDate.toISOString(), 
                    goal_end_date: endDate.toISOString(), 
                    goal_prompt: '', 
                    goal_type: goalType 
                }).eq('id', user.id);

                if (updateError) { 
                    console.error("Erro ao salvar a meta: " + updateError.message); 
                } else { 
                    document.getElementById('playlist-section').style.display = 'block'; 
                    displayProgress(startDate, endDate);

                    // gerar e salvar dieta automaticamente com base no perfil e formulário
                    const profileObj = {
                      sexo: formElements.sexo.value,
                      peso: formElements.peso.value,
                      altura: formElements.altura.value,
                      idade: formElements.idade.value
                    };
                    const simpleFormData = {
                      disponibilidade: formElements.disponibilidade.value,
                      nivel: formElements.nivel.value,
                      orcamento: (formElements.orcamento.value||'').replace(',','.'),
                      goal_type: goalType
                    };

                    const dietPlan = await generateDietPlan(profileObj, simpleFormData);
                    // preencher a aba percurso
                    document.getElementById('objetivo_dieta').value = objetivoText + "\n\nPlano inicial gerado automaticamente.";
                    document.getElementById('orcamento_dieta').value = simpleFormData.orcamento || '';
                    document.getElementById('calorias_dieta').value = dietPlan.targetCalories;
                    document.getElementById('refeicoes_dieta').value = dietPlan.mealsPerDay;
                    document.getElementById('meal-plan').textContent = dietPlan.mealPlanText;

                    // salvar no banco de dados na tabela 'diets'
                    const saved = await saveDietForUser(user.id, { ...dietPlan, goal_type: goalType, budget: simpleFormData.orcamento });
                    if (!saved) console.warn('Plano de dieta não foi salvo no banco. Verifique a tabela "diets".');
                }
            }); }

            const playlistBtn = document.getElementById('playlist-btn'); if(playlistBtn) { playlistBtn.addEventListener('click', function() { if (!currentProfile) return; let videoOrder; if(currentProfile.goal_type==='emagrecer'){videoOrder=[3,2,1];}else if(currentProfile.goal_type==='musculo'){videoOrder=[3,1,2];}else{videoOrder=[1,2,3];} reorderVideos(videoOrder); switchTab('video-aulas'); document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' }); }); }

            // salvar manualmente a dieta a partir da aba percurso
            const saveDietBtn = document.getElementById('save-diet-btn');
            if (saveDietBtn) {
              saveDietBtn.addEventListener('click', async () => {
                if (!user) return;
                const objetivoDieta = document.getElementById('objetivo_dieta').value;
                const orcamentoDieta = document.getElementById('orcamento_dieta').value;
                const calorias = Number(document.getElementById('calorias_dieta').value)||null;
                const refeicoes = Number(document.getElementById('refeicoes_dieta').value)||null;
                const mealPlanText = document.getElementById('meal-plan').textContent || '';
                const dietObj = { mealPlanText, targetCalories: calorias, mealsPerDay: refeicoes, budget: orcamentoDieta, goal_type: currentProfile?.goal_type || null };
                const ok = await saveDietForUser(user.id, dietObj);
                if (ok) {
                  saveDietBtn.textContent = 'Salvo ✓';
                  setTimeout(()=> saveDietBtn.textContent = 'Salvar Dieta', 2000);
                } else {
                  saveDietBtn.textContent = 'Erro ao salvar';
                  setTimeout(()=> saveDietBtn.textContent = 'Salvar Dieta', 2000);
                }
              });
            }
        }
        initializePageData();
    });
</script>
</body>
</html>
