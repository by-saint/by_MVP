<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
    h1, h2, h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }

    /* --- MENU E SIDEBAR --- */
    .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 1001; background: #333; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; padding: 0; }
    .menu-toggle .bar { width: 24px; height: 3px; background-color: #fff; border-radius: 2px; transition: all 0.3s ease-in-out; }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: #1E1E1E; transition: left 0.3s ease-in-out; z-index: 1000; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: space-between; }
    .sidebar.open { left: 0; }
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a { display: block; padding: 15px 30px; text-decoration: none; font-size: 1.1em; font-weight: 700; border-left: 5px solid transparent; transition: background-color 0.2s, border-left 0.2s; }
    .sidebar nav a:hover { background-color: #2c2c2c; }

    /* TÍTULOS COM DEGRADÊ */
    .link-ia, .link-aulas, .link-percurso { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    
    .sidebar .link-ia:hover, .sidebar .link-ia.active { border-left-color: var(--color-ia-specialist); }
    .sidebar .link-aulas:hover, .sidebar .link-aulas.active { border-left-color: var(--color-video-lessons); }
    .sidebar .link-percurso:hover, .sidebar .link-percurso.active { border-left-color: var(--color-journey); }

    .sidebar-footer { padding: 20px 30px; text-align: center; }
    .sidebar-config-btn { width: 100%; background: transparent; border: 1px solid #444; color: #aaa; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95em; font-weight: 600; transition: all 0.2s ease-in-out; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .sidebar-config-btn:hover { background-color: #333; color: #fff; }
    .sidebar-action-btn { width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease-in-out; margin-top: 10px; }
    .sidebar-reset-btn { background-color: transparent; border: 1px solid var(--color-ia-specialist); color: var(--color-ia-specialist); }
    .sidebar-reset-btn:hover { background-color: var(--color-ia-specialist); color: #fff; }
    .sidebar-logout-btn { background-color: #be123c; border: 1px solid #be123c; color: #fff; }
    .sidebar-logout-btn:hover { background-color: #ff4757; border-color: #ff4757; }
    .hidden { display: none; }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .overlay.show { opacity: 1; visibility: visible; }

    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }
    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }
    .playlist-section { text-align: center; margin: 40px 0; }
    .playlist-btn { background-color: #007BFF; color: white; border: none; padding: 12px 24px; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 25px; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .percurso-forms { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
    .percurso-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border: 1px solid rgba(190,18,60,0.12); padding: 20px; border-radius: 12px; }
    .percurso-card h4 { margin-top: 0; color: white; }
    .small-note { font-size: 13px; color: #cfc; opacity: 0.7; margin-top: 6px; }

    /* red border for generated diet form only at the card level (subtle) */
    .generated-diet-card { border: 2px solid rgba(190,18,60,0.14); box-shadow: 0 8px 24px rgba(190,18,60,0.06); padding: 18px; border-radius: 12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.16)); }

    /* Plan UI (tabs + days) */
    .plan-tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .plan-tab { padding:8px 12px; border-radius:999px; background:#2b2b2b; color:#fff; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
    .plan-tab.active { background: linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2)); color:white; }
    .plan-days { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .plan-day { background:linear-gradient(180deg,#141414,#0f0f0f); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-row { margin-bottom:10px; padding:8px; border-radius:8px; background:#0d0d0d; display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-left { display:flex; gap:10px; align-items:center; }
    .meal-name { font-weight:700; color:#fff; }
    .meal-kcal { font-weight:700; color:#f3f3f3; background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; }

    /* --- AJUSTE CHATBOT DIFY (REQ #8) --- */
    .iframe-container { 
        border-radius: 12px; 
        overflow: hidden; 
        position: relative; /* Garante que os filhos absolutos fiquem contidos */
        height: 70vh; /* Altura principal do chat */
        min-height: 500px;
        max-height: 700px;
        background: #000; /* Fundo preto para o iframe */
    }
    .dify-frame {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
    }
    .dify-frame iframe {
        width: 100%;
        height: 100%;
        border: 0;
    }
    /* Máscara superior para cobrir o "Powered by Dify" */
    .dify-top-strip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 50px; /* Altura da marca d'água superior */
        background-color: #000000; /* Cor de fundo do chat */
        z-index: 2;
        pointer-events: none; /* Permite cliques através */
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
    }
    .dify-top-badge {
        font-weight: 700;
        font-size: 1.1em;
        color: #fff;
        background: linear-gradient(90deg, #007BFF, #0056b3);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .mvp-label {
         font-size: 10px;
         font-weight: 700;
         color: #555;
         text-transform: uppercase;
         letter-spacing: 0.5px;
    }
    /* Máscara inferior para cobrir a marca d'água no input */
    .dify-bottom-mask {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 42px; /* Altura da marca d'água inferior */
        background-color: #000000; /* Cor de fundo do chat */
        z-index: 2;
        pointer-events: none; /* Permite cliques através */
    }
    /* --- FIM AJUSTE CHATBOT DIFY --- */

    /* --- INÍCIO: Day Selector UI (NOVO) --- */
    .day-selector-container {
        background-color: #2C2C2C;
        border: 1px solid #444;
        border-radius: 8px;
    }
    .day-selector-summary {
        padding: 12px;
        font-weight: 600;
        color: #BBBBBB;
        cursor: pointer;
        list-style: none; /* Remove seta padrão */
        position: relative;
    }
    .day-selector-summary::-webkit-details-marker { display: none; } /* Chrome/Safari */
    .day-selector-summary::marker { display: none; } /* Firefox */
    .day-selector-summary::after { /* Seta personalizada */
        content: '▼';
        font-size: 0.8em;
        position: absolute;
        right: 15px;
        top: 14px;
        transition: transform 0.2s;
    }
    .day-selector-container[open] .day-selector-summary::after {
        transform: rotate(180deg);
    }
    .day-selector-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 0 12px 12px 12px;
        justify-content: center;
    }
    .day-circle-input {
        display: none; /* Oculta o checkbox real */
    }
    .day-circle-label {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #555;
        background-color: #333;
        color: #E0E0E0;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        user-select: none;
    }
    .day-circle-label:hover {
        border-color: #777;
    }
    .day-circle-input:checked + .day-circle-label {
        background-color: var(--color-ia-specialist);
        border-color: var(--color-ia-specialist);
        color: #fff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }
    /* --- FIM: Day Selector UI --- */

    @media(max-width:900px){
      .percurso-forms { grid-template-columns:1fr; }
      .plan-days { grid-template-columns:1fr; }
      body { padding: 20px 12px; }
      
      .day-circle-label { /* Círculos um pouco menores no mobile */
        width: 36px;
        height: 36px;
        font-size: 13px;
      }
      .day-selector-grid {
        gap: 8px;
      }
    }
    
    /* --- AJUSTE CHATBOT DIFY (MOBILE) --- */
    @media (max-width: 768px) {
        .dify-bottom-mask {
            height: 38px; /* Ajuste fino para mobile */
        }
        .dify-top-strip {
            height: 45px;
        }
    }
    /* --- FIM AJUSTE CHATBOT DIFY (MOBILE) --- */
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        
        <div class="form-group">
            <details class="day-selector-container">
                <summary class="day-selector-summary">Dias de treino</summary>
                <div class="day-selector-grid">
                    <input type="checkbox" name="dias_treino" value="seg" id="dia-seg" class="day-circle-input">
                    <label for="dia-seg" class="day-circle-label">Seg</label>
                    <input type="checkbox" name="dias_treino" value="ter" id="dia-ter" class="day-circle-input">
                    <label for="dia-ter" class="day-circle-label">Ter</label>
                    <input type="checkbox" name="dias_treino" value="qua" id="dia-qua" class="day-circle-input">
                    <label for="dia-qua" class="day-circle-label">Qua</label>
                    <input type="checkbox" name="dias_treino" value="qui" id="dia-qui" class="day-circle-input">
                    <label for="dia-qui" class="day-circle-label">Qui</label>
                    <input type="checkbox" name="dias_treino" value="sex" id="dia-sex" class="day-circle-input">
                    <label for="dia-sex" class="day-circle-label">Sex</label>
                    <input type="checkbox" name="dias_treino" value="sab" id="dia-sab" class="day-circle-input">
                    <label for="dia-sab" class="day-circle-label">Sáb</label>
                    <input type="checkbox" name="dias_treino" value="dom" id="dia-dom" class="day-circle-input">
                    <label for="dia-dom" class="day-circle-label">Dom</label>
                </div>
            </details>
        </div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Fale com a IA</h2>
      <div id="dify-container" class="iframe-container"></div>
      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>
      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Abaixo está seu formulário / plano de dieta. Edite, salve ou crie novas versões.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
      </div>

      <div class="percurso-card generated-diet-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>
        <div id="dieta-card-content">
          <p style="color: #bbb;">Seu formulário de dieta será exibido aqui após você criar sua meta.</p>
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<script type="module">
/* ============================================
    Supabase client (import)
    ============================================ */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

/* ============================================
    alimentosDB (sua lista completa, parte 1)
    ============================================ */
const alimentosDB = [
"Abóbora, cabotián cozida",
"Abóbora, moranga refogada",
"Abobrinha, italiana cozida",
"Abobrinha, italiana crua",
"Abobrinha, italiana refogada",
"Abobrinha, paulista crua",
"Acelga crua",
"Agrião cru",
"Aipo cru",
"Alface, americana crua",
"Alface, crespa crua",
"Alface, lisa crua",
"Alface, roxa crua",
"Alfavaca crua",
"Alho cru (uso culinário cru possível — incluí)",
"Alho-poró cru",
"Almeirão cru",
"Almeirão refogado",
"Batata, baroa cozida",
"Batata, doce cozida",
"Batata frita, tipo chips industrializada",
"Batata, inglesa cozida",
"Batata, inglesa frita",
"Batata, inglesa sauté",
"Berinjela cozida",
"Beterraba cozida",
"Beterraba crua",
"Brócolis cozido",
"Brócolis cru",
"Cará cozido",
"Canru cru (entrada ambígua — mantive como \"cru\" mas revisar se for outro nome)",
"Catalonha crua",
"Catalonha refogada",
"Cebola crua",
"Cebolinha crua",
"Cenoura cozida",
"Cenoura crua",
"Chicória crua",
"Chuchu cozido",
"Chuchu cru",
"Coentro, folhas desidratadas",
"Couve, manteiga crua",
"Couve, manteiga refogada",
"Couve-flor cozida",
"Couve-flor crua",
"Espinafre, Nova Zelândia cru",
"Espinafre, Nova Zelândia refogado",
"Jiló cru (marcado cru na tabela — mantive, embora raro cru)",
"Mandioca cozida",
"Manjericão cru",
"Maxixe cru",
"Mostarda, folha crua",
"Nabo cru",
"Nhoque, batata cozido",
"Palmito, juçara em conserva",
"Palmito, pupunha em conserva",
"Pepino cru",
"Pimentão, amarelo cru",
"Pimentão, verde cru",
"Pimentão, vermelho cru",
"Quiabo cru (mantive cru; geralmente cozido, mas cru é consumido em algumas preparações)",
"Rabanete cru",
"Repolho, branco cru",
"Repolho, roxo cru",
"Repolho, roxo refogado",
"Rúcula crua",
"Salsa crua",
"Seleta de legumes enlatada",
"Serralha crua",
"Taioba crua",
"Tomate, com semente cru",
"Tomate extrato",
"Tomate molho industrializado",
"Tomate purê",
"Tomate salada",
"Vagem crua",
"Abacate cru",
"Abacaxi cru",
"Abiu cru",
"Açaí, polpa, com xarope (incluído; polpa com xarope)",
"Acerola crua",
"Ameixa, calda enlatada",
"Ameixa crua",
"Atemoia crua",
"Banana, da terra crua",
"Banana, doce em barra (processado)",
"Banana, figo crua",
"Banana, maçã crua",
"Banana, nanica crua",
"Banana, ouro crua",
"Banana, pacova crua",
"Banana, prata crua",
"Cacau cru",
"Cajá-Manga cru",
"Caju, suco concentrado, envasado",
"Cajuí, chocolate cru",
"Carambola crua",
"Ciriguela crua",
"Cupuaçu cru",
"Figo cru",
"Figo, enlatado em calda",
"Fruta-pão crua",
"Goiaba, branca, com casca crua",
"Goiaba, doce em pasta",
"Goiaba, doce, cascão",
"Goiaba, vermelha, com casca crua",
"Graviola crua",
"Jabuticaba crua",
"Jaca crua",
"Jambo cru",
"Jamelão cru",
"Kiwi cru",
"Laranja, baía crua",
"Laranja, baía suco",
"Laranja, da terra crua",
"Laranja, da terra suco",
"Laranja, lima crua",
"Laranja, lima suco",
"Laranja, pêra crua",
"Laranja, suco (suco genérico)",
"Laranja, valência crua",
"Laranja, valência suco",
"Limão, cravo suco",
"Limão, tahiti cru",
"Maçã, Argentina, com casca crua",
"Maçã, Fuji, com casca crua",
"Macaúba cru",
"Mamão, doce, em calda drenado (processado)",
"Mamão, formosa cru",
"Mamão, papaia cru",
"Mamão verde, doce em calda drenado (processado)",
"Manga, Haden crua",
"Manga, Palmer crua",
"Manga, Tommy Atkins crua",
"Mangarataia crua",
"Maracujá, suco concentrado",
"Melancia crua",
"Melão cru",
"Mexerica, Murcote crua",
"Mexerica, Rio crua",
"Morango cru",
"Nêspera cru",
"Pêra, Park crua",
"Pêra, Williams crua",
"Pêssego, Aurora cru",
"Pêssego, enlatado, em calda",
"Pinha crua",
"Pitanga crua",
"Romã crua",
"Tamarindo cru",
"Tangerina, Ponkan crua",
"Tangerina, Ponkan suco",
"Tucumã cru",
"Umbu cru",
"Uva, Itália crua",
"Uva, Rubi crua",
"Uva, suco concentrado, envasado",
"Azeite, de dendê (óleo/gordura)",
"Azeite, de oliva, extra virgem (óleo/gordura)",
"Manteiga, com sal (derivado)",
"Manteiga, sem sal (derivado)",
"Margarina, com óleo hidrogenado (derivado)",
"Óleo, de soja (óleo)",
"Abadejo, filé, congelado assado",
"Abadejo, filé, congelado cozido",
"Abadejo, filé, congelado grelhado",
"Atum, conserva em óleo (conserva)",
"Bacalhau, salgado refogado",
"Cação, posta, com farinha de trigo frita",
"Cação, posta cozida",
"Camarão, Rio Grande, grande cozido",
"Camarão, Sete Barbas, sem cabeça, com casca frito",
"Caranguejo cozido",
"Corimbatá assado",
"Corimbatá cozido",
"Corvina grande assada",
"Corvina grande cozida",
"Dourada de água doce fresca (incluí como fresco)",
"Lambari, congelado frito",
"Manjuba frita",
"Manjuba, com farinha de trigo frita",
"Manjuba frita (variante)",
"Merluza, filé assado",
"Merluza, filé cozido",
"Pescada, branca frita",
"Pescada, com farinha de trigo frita",
"Pescada, filé frita",
"Pescada, filé molho escabeche",
"Pintado assado",
"Pintado grelhado",
"Salmão, com pele, fresco grelhado",
"Salmão, sem pele, fresco grelhado",
"Sardinha assada",
"Sardinha, conserva em óleo (conserva)",
"Sardinha frita",
"Arroz, integral cozido",
"Arroz, tipo 1 cozido",
"Aveia, flocos crua (uso cru em mingaus / vitaminas — incluí)",
"Biscoito, doce, maisena (processado)",
"Biscoito, doce, recheado com chocolate (processado)",
"Biscoito, doce, recheado com morango (processado)",
"Biscoito, doce, wafer, recheado de chocolate (processado)",
"Biscoito, doce, wafer, recheado de morango (processado)",
"Biscoito, salgado, cream cracker (processado)",
"Biscoito, polvilho doce (processado)",
"Bolo, mistura para (processado)",
"Bolo, pronto, aipim (processado)",
"Bolo, pronto, chocolate (processado)",
"Bolo, pronto, coco (processado)",
"Canjica, com leite integral (preparado)",
"Cereais, milho, flocos, com sal (processado)",
"Cereais, milho, flocos, sem sal (processado)",
"Cereais, milho, infantil (processado)",
"Cereais, mistura para vitamina (processado)",
"Cereal matinal, milho (processado)",
"Cereal matinal, milho, açúcar (processado)",
"Creme de arroz, pó (processado)",
"Creme de milho, pó (processado)",
"Curau, milho verde (preparado)",
"Farinha, de arroz, enriquecida (derivado)",
"Farinha, de centeio, integral (derivado)",
"Farinha, de milho, amarela (derivado)",
"Farinha, de rosca (derivado)",
"Farinha, de trigo (derivado)",
"Farinha, láctea, de cereais (derivado)",
"Farinha, de mandioca, torrada (derivado)",
"Farinha, de puba (derivado)",
"Feijão, de mandioca (cozido)",
"Lasanha, massa fresca cozida",
"Macarrão, instantâneo (processado)",
"Milho, verde cru (incluí — milho verde é consumido cru/cozido)",
"Milho, verde, enlatado drenado",
"Mingau tradicional, pó (processado)",
"Pamonha, barra para cozimento (preparado)",
"Pão, aveia, forma (processado)",
"Pão, de glúten, forma (processado)",
"Pão, de glúten, forma (variante processado)",
"Pão, milho, forma (processado)",
"Pão, trigo, forma, integral (processado)",
"Pão, trigo, francês (processado)",
"Pão, trigo, sovado (processado)",
"Pastel, de queijo frito",
"Pastel, de queijo frito (variante)",
"Pastel, massa frita",
"Pastel, massa frita (variante com outro valor)",
"Pipoca, com óleo de soja sem sal (preparado)",
"Polenta, pré-cozida (processado)",
"Torrada, pão francês (processado)",
"Açúcar, mascavo (ingrediente)",
"Açúcar, refinado (ingrediente)",
"Chocolate, ao leite (processado)",
"Chocolate, ao leite, com castanha do Pará (processado)",
"Chocolate, ao leite, dietético (processado)",
"Chocolate, meio amargo (processado)",
"Cocada branca (doces)",
"Doce, de abóbora, cremoso (doces)",
"Doce, de leite, cremoso (doces)",
"Geleia, mocotó, natural (doces)",
"Glicose de milho (ingrediente)",
"Maria mole (doces)",
"Maria mole, coco queimado (doces)",
"Marmelada (doces)",
"Mel, de abelha (doces)",
"Melado (doces)",
"Quindim (doces)",
"Rapadura (doces)",
"Café, pó, torrado (bebida/ingrediente)",
"Capuccino, pó (bebida/ingrediente)",
"Fermento em pó, químico (ingrediente)",
"Fermento, biológico, levedura, tablete (ingrediente)",
"Gelatina, sabores variados, pó (ingrediente)",
"Sal, dietético (ingrediente)",
"Sal, grosso (ingrediente)",
"Shoyu (ingrediente/tempero)",
"Tempero à base de sal (tempero)",
"Azeitona, preta conserva",
"Azeitona, verde conserva",
"Chantilly, spray, com gordura vegetal (processado)",
"Leite, de coco (derivado)",
"Maionese, tradicional com ovos (condimento)",
"Bebida isotônica (processado)",
"Café, infusão 10% (bebida)",
"Cana, aguardente (álcool)",
"Cana, caldo de (bebida)",
"Cerveja, pilsen (bebida)",
"Chá, erva-doce infusão",
"Chá, mate infusão",
"Chá, preto infusão",
"Coco, água de (bebida)",
"Refrigerante, água tônica (bebida)",
"Refrigerante, tipo cola (bebida)",
"Refrigerante, tipo guaraná (bebida)",
"Refrigerante, tipo laranja (bebida)",
"Refrigerante, tipo limão (bebida)",
"Achocolatado, pó (bebida)",
"Tacacá (prato)",
"Tapioca, com manteiga (prato)",
"Tucupi, com pimenta-de-cheiro (prato/molho)",
"Vaca atolada (prato)",
"Vatapá (prato)",
"Virado à paulista (prato)",
"Yakisoba (prato)",
"Acarajé (prato)",
"Arroz carreteiro (prato)",
"Baião de dois, arroz e feijão-de-corda (prato)",
"Barreado (prato)",
"Bife à cavalo, com contra filé (prato)",
"Bolinho de arroz (prato)",
"Camarão à baiana (prato)",
"Charuto, de repolho (prato)",
"Cuscuz, de milho, cozido com sal (prato)",
"Cuscuz, paulista (prato)",
"Cuxá, molho (prato/molho)",
"Dobradinha (prato)",
"Estrogonofe de carne (prato)",
"Estrogonofe de frango (prato)",
"Feijoada tropeiro mineiro (prato)",
"Feijoada (prato)",
"Frango, com açafrão (prato)",
"Macarrão, molho bolonhesa (prato)",
"Maniçoba (prato)",
"Quibebe (prato)",
"Salada, de legumes, com maionese (prato)",
"Salada, de legumes, cozida no vapor (prato)",
"Salpicão, de frango (prato)",
"Sarapatel (prato)",
"Tabule (prato)",
"Amendoim, grão cru (incluí)",
"Amendoim, torrado, salgado (torrado/salgado)",
"Ervilha, em vagem (crua/cozida — mantive)",
"Ervilha, enlatada drenada",
"Feijão, carioca cozido",
"Feijão, fradinho cozido",
"Feijão, jalo cozido",
"Feijão, preto cozido",
"Feijão, rajado cozido",
"Feijão, rosinha cozido",
"Feijão, roxo cozido",
"Lentilha cozida",
"Paçoca, amendoim (processado)",
"Pé-de-moleque, amendoim (doces)",
"Soja, farinha (derivado)",
"Soja, extrato solúvel, natural, fluido (produto)",
"Soja, extrato solúvel, pó (produto)",
"Soja, queijo (tofu) (produto)",
"Tremoço em conserva (conserva)",
"Amêndoa, torrada, salgada (oleaginosa)",
"Castanha-de-caju, torrada, salgada (oleaginosa)",
"Castanha-do-Brasil crua (incluí)",
"Coco cru (incluí)",
"Gergelim, semente (semente)",
"Linhaça, semente (semente)",
"Pinhão cozido",
"Pupunha cozida",
"Noz crua (incluí)",
"Presunto, com capa de gordura (processado)",
"Presunto, sem capa de gordura (processado)",
"Quibe assado",
"Quibe frito",
"Salame (processado)",
"Toucinho frito",
"Apresentado (linha ambígua — mantive nome)",
"Caldo de carne, tablete (ingrediente)",
"Caldo de galinha, tablete (ingrediente)",
"Carne, bovina, acém, moído, cozido",
"Carne, bovina, acém, sem gordura, cozido",
"Carne, bovina, almôndegas, fritas",
"Carne, bovina, bucho, cozido",
"Carne, bovina, capa de contra-filé, com gordura grelhada",
"Carne, bovina, capa de contra-filé, sem gordura grelhada",
"Carne, bovina, charque, cozido",
"Carne, bovina, filé à milanesa frita/assada (preparado)",
"Carne, bovina, contra-filé de costela, grelhado",
"Carne, bovina, contra-filé, com gordura, grelhado",
"Carne, bovina, contra-filé, sem gordura, grelhada",
"Carne, bovina, costela assada",
"Carne, bovina, coxão duro, sem gordura, cozido",
"Carne, bovina, coxão mole, sem gordura, cozido",
"Carne, bovina, cupim assado",
"Carne, bovina, filé mignon, sem gordura, cozido",
"Carne, bovina, flanco, sem gordura, cozido",
"Carne, bovina, fraldinha, com gordura, cozida",
"Carne, bovina, lagarto, cozido",
"Carne, bovina, língua cozida",
"Carne, bovina, maminha grelhada",
"Carne, bovina, miolo de alcatra, sem gordura, grelhado",
"Carne, bovina, músculo, sem gordura, cozido",
"Carne, bovina, paleta, sem gordura, cozida",
"Carne, bovina, patinho, sem gordura, cozido",
"Carne, bovina, patinho, sem gordura, grelhado",
"Carne, bovina, peito, sem gordura, cozido",
"Carne, bovina, picanha, com gordura, grelhada",
"Carne, bovina, picanha, sem gordura, grelhada",
"Carne, bovina, seca cozida",
"Coxinha de frango frita",
"Croquete, de carne frito",
"Empada de frango, pré-cozida assada",
"Empada de frango, pré-cozida (preparado)",
"Frango, caipira, inteiro, com pele cozido",
"Frango, caipira, inteiro, sem pele cozido",
"Frango, coração grelhado",
"Frango, coxa, com pele, assada",
"Frango, coxa, com pele, cozida",
"Frango, coxa, sem pele, cozida",
"Frango, filé, à milanesa (preparado)",
"Frango, inteiro, sem pele, assado",
"Frango, inteiro, sem pele, cozido",
"Frango, peito, com pele, assado",
"Frango, peito, sem pele, cozido",
"Frango, peito, sem pele, grelhado",
"Frango, sobrecoxa, com pele, assada",
"Frango, sobrecoxa, sem pele, assada",
"Hambúrguer, bovino frito",
"Hambúrguer, bovino grelhado",
"Linguiça, frango frita",
"Linguiça, frango grelhada",
"Linguiça, porco frita",
"Linguiça, porco frita (variante)",
"Linguiça, porco grelhada",
"Mortadela (processado)",
"Peru, congelado assado",
"Porco, bisteca frita",
"Porco, bisteca grelhada",
"Porco, costela assada",
"Porco, lombo assado",
"Porco, pernil assado",
"Bebida láctea, pêssego (produto)",
"Creme de Leite (derivado)",
"Iogurte, natural (derivado)",
"Iogurte, natural, desnatado (derivado)",
"Iogurte, sabor abacaxi (derivado)",
"Iogurte, sabor morango (derivado)",
"Iogurte, sabor pêssego (derivado)",
"Leite, condensado (derivado)",
"Leite, de cabra (derivado)",
"Leite, de vaca, achocolatado (derivado)",
"Leite, de vaca, desnatado, pó (derivado)",
"Leite, de vaca, desnatado, UHT (derivado)",
"Leite, de vaca, integral (derivado)",
"Leite, de vaca, integral, pó (derivado)",
"Leite, fermentado (derivado)",
"Queijo, minas, frescal (derivado)",
"Queijo, minas, meia cura (derivado)",
"Queijo, mozarela (derivado)",
"Queijo, parmesão (derivado)",
"Queijo, pasteurizado (derivado)",
"Queijo, petit suisse, morango (derivado)",
"Queijo, prato (derivado)",
"Queijo, requeijão, cremoso (derivado)",
"Queijo, ricota (derivado)",
"Omelete, de queijo (preparado)",
"Ovo, de galinha, clara cozida/10minutos",
"Ovo, de galinha, gema cozida/10minutos",
"Ovo, de galinha, inteiro cozido/10minutos",
"Ovo, de galinha, inteiro frito"
];

/* ============================================
    SuperDietEngine (módulo embutido)
    - implementação adaptada do seu "SUPER ALGORITMO FINAL"
    - contem: masterDB seed; funções: init/loadExternal*, generatePlan, savePlan, loadLatestPlan, findFood
    ============================================ */
const SuperDietEngine = (function(){

  // utilitários
  function _round(n,d=2){ return Math.round((Number(n) + Number.EPSILON) * Math.pow(10,d)) / Math.pow(10,d); }
  function _safeNum(v,f=0){ const n = Number(v); return isNaN(n) ? f : n; }
  function normalizeName(s){ if(!s) return ''; return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\(.*?\)/g,'').replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,' ').trim(); }
  function nowISO(){ return (new Date()).toISOString(); }

  // REQ 1 (Coesão): Categorias de refeição atualizadas no DB seed
  const masterDB = {
    "arroz tipo 1 cozido": { id:'arroz_tipo1', name:'Arroz, tipo 1 cozido', nutrition:{ kcal:130, protein_g:2.7, carb_g:28.0, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'cereal_main', preps:['cozido'] },
    "arroz integral cozido": { id:'arroz_integral', name:'Arroz integral cozido', nutrition:{ kcal:111, protein_g:2.6, carb_g:23.5, fat_g:0.9, fiber_g:1.8 }, price_per_kg:6.5, category:'cereal_main', preps:['cozido'] },
    "feijao carioca cozido": { id:'feijao_carioca', name:'Feijão carioca cozido', nutrition:{ kcal:347, protein_g:21.1, carb_g:62.4, fat_g:1.4, fiber_g:16.6 }, price_per_kg:8.5, category:'leguminosa_main', preps:['cozido'] },
    "frango peito sem pele cozido": { id:'frango_peito', name:'Frango peito sem pele cozido', nutrition:{ kcal:165, protein_g:31.0, carb_g:0, fat_g:3.6 }, price_per_kg:18.0, category:'proteina_main', preps:['grelhado','cozido','assado'] },
    "ovo inteiro cozido": { id:'ovo_cozido', name:'Ovo inteiro cozido', nutrition:{ kcal:155, protein_g:13.0, carb_g:1.1, fat_g:11.0 }, price_per_kg:15.0, category:'proteina_breakfast_snack', preps:['cozido','frito'] },
    "banana nanica": { id:'banana_nanica', name:'Banana nanica', nutrition:{ kcal:89, protein_g:1.1, carb_g:22.8, fat_g:0.3, fiber_g:2.6 }, price_per_kg:4.0, category:'fruta', preps:['crua','assada'] },
    "abacaxi cru": { id:'abacaxi', name:'Abacaxi cru', nutrition:{ kcal:50, protein_g:0.5, carb_g:13.0, fat_g:0.1, fiber_g:1.4 }, price_per_kg:7.59, category:'fruta', preps:['crua'] },
    "alface americana": { id:'alface', name:'Alface americana', nutrition:{ kcal:15, protein_g:1.4, carb_g:2.9, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'verdura', preps:['crua'] },
    "brocolis cozido": { id:'brocolis', name:'Brócolis cozido', nutrition:{ kcal:55, protein_g:3.7, carb_g:11.1, fat_g:0.6, fiber_g:3.3 }, price_per_kg:7.0, category:'verdura', preps:['cozido','grelhado'] },
    "batata inglesa cozida": { id:'batata', name:'Batata inglesa cozida', nutrition:{ kcal:87, protein_g:1.9, carb_g:20.1, fat_g:0.1, fiber_g:1.8 }, price_per_kg:3.0, category:'tuberculo', preps:['cozido','assado','purê'] },
    "aveia flocos crua": { id:'aveia', name:'Aveia flocos', nutrition:{ kcal:389, protein_g:16.9, carb_g:66.3, fat_g:6.9, fiber_g:10.6 }, price_per_kg:9.5, category:'cereal_breakfast_snack', preps:['crua','cozida'] },
    "lentilha cozida": { id:'lentilha', name:'Lentilha cozida', nutrition:{ kcal:116, protein_g:9.0, carb_g:20.1, fat_g:0.4, fiber_g:7.9 }, price_per_kg:10.0, category:'leguminosa_main', preps:['cozido'] },
    "queijo minas frescal": { id:'queijo_minas', name:'Queijo minas frescal', nutrition:{ kcal:250, protein_g:18.0, carb_g:2.0, fat_g:20.0 }, price_per_kg:28.0, category:'laticinio_breakfast_snack', preps:['fresco'] },
    "sardinha conserva em oleo": { id:'sardinha', name:'Sardinha conserva em óleo', nutrition:{ kcal:208, protein_g:24.6, carb_g:0.0, fat_g:11.5 }, price_per_kg:22.0, category:'peixe', preps:['conserva'] }, // Peixe pode ser lanche
    "pao frances": { id:'pao_frances', name:'Pão Francês', nutrition:{ kcal:289, protein_g:8.0, carb_g:58.5, fat_g:2.0 }, price_per_kg:12.0, category:'pao_breakfast_snack', preps:['crua'] },
    "iogurte natural": { id:'iogurte_nat', name:'Iogurte Natural', nutrition:{ kcal:53, protein_g:4.0, carb_g:5.5, fat_g:1.8 }, price_per_kg:15.0, category:'laticinio_breakfast_snack', preps:['crua'] }
  };

  // build lookup
  function _buildLookup(db){
    const byName = {}, byId = {};
    Object.values(db).forEach(rec => {
      byName[normalizeName(rec.name)] = rec;
      if(rec.id) byId[rec.id] = rec;
    });
    return { byName, byId };
  }
  let _lookup = _buildLookup(masterDB);

  function findFood(foodKey){
    if(!foodKey) return null;
    const k = foodKey.toString();
    if(_lookup.byId[k]) return _lookup.byId[k];
    const norm = normalizeName(k);
    if(_lookup.byName[norm]) return _lookup.byName[norm];
    // try substring match
    for(const nm in _lookup.byName){
      if(nm.includes(norm) || norm.includes(nm)) return _lookup.byName[nm];
    }
    // if not found, create lightweight record (fallback)
    const rec = { id: 'ext_' + norm.replace(/\s+/g,'_').slice(0,60), name: foodKey.toString(), nutrition: { kcal: 120, protein_g: 5, carb_g: 15, fat_g: 3 }, price_per_kg: 10.0, category:'other', preps:['crua'] };
    _lookup.byName[norm] = rec; _lookup.byId[rec.id] = rec;
    return rec;
  }

  // external data loaders
  function loadExternalPrices(priceArray){
    if(!Array.isArray(priceArray)) throw new Error('Array expected');
    for(const item of priceArray){
      const norm = normalizeName(item.name);
      if(_lookup.byName[norm]) _lookup.byName[norm].price_per_kg = _safeNum(item.price_per_kg, _lookup.byName[norm].price_per_kg || 0);
      else {
        const id = item.id || ('ext_' + norm.replace(/\s+/g,'_'));
        const r = { id, name: item.name, nutrition: null, price_per_kg: _safeNum(item.price_per_kg,0), category: item.category || 'other', preps: item.preps || ['crua'] };
        _lookup.byName[norm] = r; _lookup.byId[id] = r;
      }
    }
  }
  function loadExternalNutrition(nutArray){
    if(!Array.isArray(nutArray)) throw new Error('Array expected');
    for(const item of nutArray){
      const norm = normalizeName(item.name);
      if(_lookup.byName[norm]) _lookup.byName[norm].nutrition = item.nutrition;
      else {
        const id = item.id || ('ext_' + norm.replace(/\s+/g,'_'));
        const r = { id, name: item.name, nutrition: item.nutrition, price_per_kg: item.price_per_kg || null, category: item.category || 'other', preps: item.preps || ['crua'] };
        _lookup.byName[norm] = r; _lookup.byId[id] = r;
      }
    }
  }

  // metabolic calculations
  function calcBMR(profile){
    const peso = _safeNum(profile.peso, 70);
    const altura_m = _safeNum(profile.altura, profile.altura_m || 1.7);
    const idade = _safeNum(profile.idade, 30);
    const sexo = (profile.sexo || '').toString().toLowerCase();
    const hcm = Math.round(altura_m * 100);
    
    // REQ 2 (Calorias): Troca da fórmula TMB para Harris-Benedict (revisada), mais precisa para jovens/atletas
    if(sexo.startsWith('m')) {
        // TMB (Masc) = 88.362 + (13.397 * peso) + (4.799 * hcm) - (5.677 * idade)
        return Math.round(88.362 + (13.397 * peso) + (4.799 * hcm) - (5.677 * idade));
    }
    // TMB (Fem) = 447.593 + (9.247 * peso) + (3.098 * hcm) - (4.330 * idade)
    return Math.round(447.593 + (9.247 * peso) + (3.098 * hcm) - (4.330 * idade));
  }
  
  function activityFactor(profile){
    // REQ 2 (Calorias): Fatores de atividade (AF) aumentados para serem mais realistas para quem treina.
    const nivel = (profile.nivel || '').toString().toLowerCase();
    const dias = _safeNum(profile.diasPorSemana || profile.disponibilidade || profile.dias_treino_sem || profile.dias_treino, 3);
    
    if(nivel.includes('inic') || dias <= 2) return 1.3; // Sedentário + treino leve (era 1.2)
    if(nivel.includes('inter') || dias <= 4) return 1.55; // Treino 3-4 dias (era 1.375)
    if(nivel.includes('avanc') || dias >= 5) return 1.75; // Treino 5+ dias (era 1.55)
    
    return 1.55; // Default para intermediário
  }
  
  function deriveTargets(profile){
    const bmr = calcBMR(profile);
    const af = activityFactor(profile);
    const tdee = Math.round(bmr * af);
    const goalText = (profile.grande_meta || profile.goal || profile.goal_prompt || '').toString().toLowerCase();
    const idade = _safeNum(profile.idade, 30);
    const peso = _safeNum(profile.peso, 70);

    let targetCalories = tdee;
    
    // REQ 2 (Calorias): Lógica de déficit/superávit inteligente baseada em idade e peso.
    if(/emagrec|perder|secar|definição|definir/.test(goalText)) {
        // Déficit inteligente
        let deficitPercent = 0.20; // 20% Padrão
        if (peso > 100) deficitPercent = 0.25; // Mais agressivo se peso > 100kg
        
        const deficit = Math.min(tdee * deficitPercent, 1000); // Limite máximo de 1000 kcal
        targetCalories = Math.round(tdee - deficit);
    }
    if(/ganhar|massa|hipertrof|crescer|forte/.test(goalText)) {
        // Superávit inteligente
        let surplusPercent = 0.15; // 15% Padrão
        if (idade < 20) surplusPercent = 0.20; // Mais agressivo se idade < 20 (metabolismo alto)

        const surplus = Math.min(tdee * surplusPercent, 750); // Limite máximo de 750 kcal
        targetCalories = Math.round(tdee + surplus);
    }

    let protPerKg = 1.4;
    if(/ganhar|massa|hipertrof/.test(goalText)) protPerKg = 1.6;
    if(/emagrec|perder/.test(goalText)) protPerKg = 1.6;
    const protein_g = Math.round(protPerKg * peso);
    const fatPerc = 0.25;
    const protCals = protein_g * 4;
    const fatCals = Math.round(targetCalories * fatPerc);
    const carbsCals = targetCalories - protCals - fatCals;
    const carbs_g = Math.max(0, Math.round(carbsCals / 4));
    const fat_g = Math.max(0, Math.round(fatCals / 9));
    return { bmr, tdee, targetCalories, protein_g, carbs_g, fat_g, protPerKg };
  }

  // cost & satiety metrics
  function computeCostMetrics(rec){
    if(!rec) return null;
    const price = _safeNum(rec.price_per_kg, null);
    const nut = rec.nutrition || null;
    if(!nut || !price) return null;
    const proteinPerKg = _safeNum(nut.protein_g,0) * 10; // g/kg
    const kcalPerKg = _safeNum(nut.kcal, nut.kcal || _safeNum(nut.kcal,0)) * 10;
    const proteinPerBRL = proteinPerKg / price;
    const kcalPerBRL = kcalPerKg / price;
    const costPer100g = price / 10;
    return { proteinPerBRL: _round(proteinPerBRL,2), kcalPerBRL: _round(kcalPerBRL,2), costPer100g: _round(costPer100g,2), costPerKg: price };
  }
  function computeSatietyScore(rec){
    if(!rec || !rec.nutrition) return 0.5;
    const n = rec.nutrition;
    const prot = _safeNum(n.protein_g,0);
    const fiber = _safeNum(n.fiber_g,0);
    const fat = _safeNum(n.fat_g,0);
    const waterProxy = Math.max(0, 100 - _safeNum(n.kcal,0));
    const s = (0.45*(prot/30)) + (0.35*(fiber/10)) + (0.15*(fat/20)) + (0.05*(waterProxy/100));
    return Math.min(1, Math.max(0, s));
  }
  function computeNutrientDensity(rec){
    if(!rec || !rec.nutrition) return 0.5;
    const n = rec.nutrition;
    const vitC = _safeNum(n.vitC_mg,0);
    const iron = _safeNum(n.iron_mg,0);
    const calcium = _safeNum(n.calcium_mg,0);
    const potassium = _safeNum(n.potassium_mg,0);
    const micronSum = (vitC/60) + (iron/8) + (calcium/1000) + (potassium/3500);
    const kcal = Math.max(1, _safeNum(n.kcal,100));
    return Math.min(2, (micronSum / kcal) * 100);
  }

  function computeCBrank(rec, profile){
    if(!rec) return -999;
    const cost = computeCostMetrics(rec);
    const sat = computeSatietyScore(rec);
    const nd = computeNutrientDensity(rec);
    const goalText = (profile.grande_meta || profile.goal || '').toString().toLowerCase();
    let wProt = 0.45, wKcal = 0.20, wSat = 0.20, wNd = 0.15;
    if(/ganhar|massa|hipertrof/.test(goalText)) { wProt = 0.6; wKcal=0.1; wSat=0.15; wNd=0.15; }
    if(/emagrec|perder/.test(goalText)) { wProt = 0.45; wKcal=0.1; wSat=0.30; wNd=0.15; }
    const protPerBRL = cost ? cost.proteinPerBRL : 0;
    const kcalPerBRL = cost ? cost.kcalPerBRL : 0;
    const score = (wProt * protPerBRL) + (wKcal * kcalPerBRL) + (wSat * (sat*10)) + (wNd * (nd));
    return _round(score,4);
  }

  function getAllowedPrepsForFood(foodName){
    const rec = findFood(foodName);
    if(!rec) return ['—'];
    return rec.preps || ['crua'];
  }
  function validatePrep(foodName, prep){
    const allowed = getAllowedPrepsForFood(foodName);
    return allowed.includes(prep);
  }

  // grams calculators
  function computeGramAmountsForMeal(foodDBFindFn, mealMacroTargets, components){
    const protFood = components.protein, carbFood = components.carb, vegFood = components.veg;
    const protNut = findFood(protFood) ? findFood(protFood).nutrition : null;
    const carbNut = findFood(carbFood) ? findFood(carbFood).nutrition : null;
    const vegNut = findFood(vegFood) ? findFood(vegFood).nutrition : null;
    const out = { protein_grams:0, carb_grams:0, veg_grams:0, details:{} };
    if(protNut && _safeNum(protNut.protein_g,0) > 0){
      out.protein_grams = Math.max(10, Math.round( mealMacroTargets.prot_g / (protNut.protein_g / 100) ));
    } else out.protein_grams = 120;
    if(carbNut && _safeNum(carbNut.carb_g,0) > 0){
      out.carb_grams = Math.max(10, Math.round( mealMacroTargets.carbs_g / (carbNut.carb_g / 100) ));
    } else out.carb_grams = 150;
    out.veg_grams = 100;
    function kcalFrom(foodName, grams){
      const rec = findFood(foodName);
      if(!rec || !rec.nutrition) return 0;
      return (rec.nutrition.kcal || 0) * grams / 100;
    }
    const kcalProt = kcalFrom(protFood, out.protein_grams);
    const kcalCarb = kcalFrom(carbFood, out.carb_grams);
    const kcalVeg = kcalFrom(vegFood, out.veg_grams);
    let totalKcal = kcalProt + kcalCarb + kcalVeg;
    if(mealMacroTargets.calories && Math.abs(totalKcal - mealMacroTargets.calories) / mealMacroTargets.calories > 0.12){
      const desired = mealMacroTargets.calories;
      const withoutCarb = kcalProt + kcalVeg;
      const targetCarbKcal = Math.max(0, desired - withoutCarb);
      if(carbNut && _safeNum(carbNut.kcal,0) > 0){
        const newCarbGrams = Math.round((targetCarbKcal / carbNut.kcal) * 100);
        
        // REQ #1: Evita "Arroz (0g)"
        out.carb_grams = Math.max(10, newCarbGrams); // Mínimo de 10g se for calculado
      }
      totalKcal = kcalFrom(protFood, out.protein_grams) + kcalFrom(carbFood, out.carb_grams) + kcalFrom(vegFood, out.veg_grams);
    }
    out.details = { kcal_est: _round(totalKcal,0), kcalProt:_round(kcalProt,0), kcalCarb:_round(kcalCarb,0), kcalVeg:_round(kcalVeg,0) };
    return out;
  }

  // weekly & cheat policies
  function weeklyBudgetFromMonthly(monthly){
    if(!monthly) return null;
    const m = _safeNum(monthly, 0);
    const weeksPerMonth = 4.345;
    return _round(m / weeksPerMonth, 2);
  }
  
  // ============================================
  // INÍCIO: ALTERAÇÃO ALGORITMO (buildWeekTemplate)
  // ============================================
  function buildWeekTemplate(dailyTargetCalories, diasTreino, cheatPolicy, selectedDaysArr = []){
    const week = Array.from({length:7}).map(()=>({ baseCalories: dailyTargetCalories, isTrainingDay:false, isCheatDay:false, cheatLimit:null }));

    // Mapeia os dias da semana (JS: 0=Dom, 1=Seg... 6=Sab)
    // Nossos valores do form: 'seg', 'ter', 'qua', 'qui', 'sex', 'sab', 'dom'
    const dayMap = { 'dom': 0, 'seg': 1, 'ter': 2, 'qua': 3, 'qui': 4, 'sex': 5, 'sab': 6 };
    
    if (selectedDaysArr.length > 0) {
        // O usuário selecionou dias específicos
        selectedDaysArr.forEach(dayKey => {
            const idx = dayMap[dayKey];
            if (idx !== undefined && week[idx]) {
                week[idx].isTrainingDay = true;
                week[idx].baseCalories = Math.round(dailyTargetCalories * 1.08); // Aumenta calorias no dia de treino
            }
        });
    } else {
        // Fallback: se nenhum dia foi selecionado, usa a lógica antiga de espalhar
        // Usa o 'diasTreino' (count) que já foi calculado a partir do array (ou default)
        const dt = Math.max(0, _safeNum(diasTreino, 3));
        if (dt > 0) {
            const step = Math.floor(7 / dt) || 1;
            let idx = 1; // Começa na Segunda (index 1)
            for (let i = 0; i < dt; i++) {
                if(week[idx]) {
                    week[idx].isTrainingDay = true;
                    week[idx].baseCalories = Math.round(dailyTargetCalories * 1.08);
                }
                idx = (idx + step);
                if (idx > 6) idx = (idx % 7) + 1; // wrap around, mas evita Domingo
                if (idx === 0) idx = 1;
            }
        }
    }

    if(cheatPolicy && cheatPolicy.freqPerWeek > 0){
      let idx = 6;
      for(let i=6;i>=0;i--){ if(!week[i].isTrainingDay){ idx = i; break; } }
      week[idx].isCheatDay = true;
      week[idx].cheatLimit = cheatPolicy.cheatCaloriesLimit || Math.round(dailyTargetCalories * 1.5);
    }
    return week;
  }
  // ============================================
  // FIM: ALTERAÇÃO ALGORITMO (buildWeekTemplate)
  // ============================================

  function compensateCheatWeek(weekArr){
    const baseTotal = weekArr.reduce((s,d)=>s + d.baseCalories,0);
    const cheatDay = weekArr.find(d => d.isCheatDay);
    if(!cheatDay) return weekArr;
    const cheatActual = cheatDay.cheatLimit || cheatDay.baseCalories;
    const newTotal = baseTotal - cheatDay.baseCalories + cheatActual;
    const excess = newTotal - baseTotal;
    if(excess <= 0) return weekArr;
    const nonCheat = weekArr.filter(d=>!d.isCheatDay);
    const perDayReduction = Math.ceil(excess / nonCheat.length);
    for(const d of nonCheat){
      const minAllowed = Math.round(d.baseCalories * 0.6);
      d.baseCalories = Math.max(minAllowed, d.baseCalories - perDayReduction);
      d.adjustedForCheat = true;
    }
    return weekArr;
  }

  // rotation: alternativesByCategory (category -> array of names)
  function rotateAlternativesForMonth(itemsList, monthIndex, alternatesByCategory){
    return itemsList.map(it => {
      const rec = findFood(it.food);
      if(!rec) return it;
      const cat = rec.category || null;
      if(cat && alternatesByCategory && alternatesByCategory[cat] && alternatesByCategory[cat].length > 0){
        const arr = alternatesByCategory[cat];
        const pick = arr[monthIndex % arr.length];
        return { ...it, food: pick };
      }
      return it;
    });
  }

  function _rankFoodsByCategory(categories, profile){
    const recs = [];
    for(const nm in _lookup.byName){
      const rec = _lookup.byName[nm];
      if(categories.includes(rec.category)){
        rec.rank = computeCBrank(rec, profile);
        recs.push(rec);
      }
    }
    // stable randomization to avoid identical picks: sort by rank then by name and shuffle slightly using profile hash
    recs.sort((a,b) => (b.rank || 0) - (a.rank || 0) || a.name.localeCompare(b.name));
    return recs;
  }

  function _estimateWeeklyCostFromPlan(weekDays){
    let total = 0;
    for(const d of weekDays){
      for(const m of d.meals){
        for(const comp of m.components){
          const rec = findFood(comp.food);
          if(rec && rec.price_per_kg && _safeNum(comp.grams,0) > 0){
            total += rec.price_per_kg * (comp.grams / 1000);
          }
        }
      }
    }
    return _round(total,2);
  }

  function computeCredibility(c){
    const wCalories = 0.30, wBudget = 0.25, wPractical = 0.20, wVariety = 0.15, wFeas = 0.10;
    const score = ( (c.adherenceToCaloriesPct||0) * wCalories +
                      (c.adherenceToBudgetPct||0) * wBudget +
                      (c.practicalityPct||0) * wPractical +
                      (c.varietyScore||0) * wVariety +
                      (c.feasibilityPct||0) * wFeas ) * 100;
    return _round(score,1);
  }

  function parseGoal(profile){
    const text = (profile.grande_meta || profile.goal || '') .toString().toLowerCase();
    const m = text.match(/(\d+(\.\d+)?)/);
    const kg = m ? Number(m[1]) : null;
    const isLose = /emagrec|perder|secar/.test(text);
    const isGain = /ganhar|massa|hipertrof/.test(text);
    let prazo_weeks = null;
    if(profile.prazo){
      const pm = profile.prazo.match(/(\d+)\s*mes/);
      if(pm) prazo_weeks = Number(pm[1]) * 4.345;
      const pw = profile.prazo.match(/(\d+)\s*sem/);
      if(pw) prazo_weeks = Number(pw[1]);
    }
    return { kg, type: isLose ? 'lose' : (isGain ? 'gain' : 'maintain'), prazo_weeks };
  }

  // planner
  async function planLongTerm(profile, options = {}){
    const start = options.startDate ? new Date(options.startDate) : new Date();
    const months = Math.max(1, _safeNum(options.months, 3));
    const profileTargets = deriveTargets(profile);
    const weeklyDeficitNeeded = (() => {
      const parsed = parseGoal(profile);
      if(parsed.type === 'lose' && parsed.kg && parsed.prazo_weeks) {
        return Math.round((7700 * parsed.kg) / parsed.prazo_weeks);
      }
      if(parsed.type === 'lose' && parsed.kg && !parsed.prazo_weeks){
        const weeks = months * 4.345;
        return Math.round((7700 * parsed.kg) / weeks);
      }
      return 0;
    })();
    const dailyTargetCalories = profileTargets.targetCalories;
    const weeklyBudget = options.weeklyBudgetOverride || weeklyBudgetFromMonthly(profile.orcamento_mes_R$ || profile.orcamento || 0);
    
    // ============================================
    // INÍCIO: ALTERAÇÃO ALGORITMO (planLongTerm)
    // ============================================
    // O 'diasTreino' agora é o *número* de dias selecionados
    const diasTreino = _safeNum(profile.disponibilidade, 3);
    // O 'selectedDaysArr' são os dias específicos
    const selectedDaysArr = profile.selected_days || [];
    // ============================================
    // FIM: ALTERAÇÃO ALGORITMO (planLongTerm)
    // ============================================

    const cheatPolicy = options.cheatPolicy || { type:'day', freqPerWeek: 1, cheatCaloriesLimit: Math.round(dailyTargetCalories * 1.5) };
    const totalWeeks = Math.max(1, Math.round(months * 4.345));
    const timeline_weeks = [];

    // build alternatesByCategory automatically from _lookup (small sample)
    const alternatesByCategory = options.alternatesByCategory || {};
    // if not provided, create alternates for cereal, leguminosa, proteina_animal, verdura, fruta
    if(!options.alternatesByCategory){
      const byCat = {};
      for(const nm in _lookup.byName){ const r = _lookup.byName[nm]; byCat[r.category] = byCat[r.category] || []; byCat[r.category].push(r.name); }
      alternatesByCategory.cereal = (byCat.cereal_main || []).slice(0,10);
      alternatesByCategory.leguminosa = (byCat.leguminosa_main || []).slice(0,10);
      alternatesByCategory.proteina_animal = (byCat.proteina_main || []).slice(0,10);
      alternatesByCategory.verdura = (byCat.verdura || []).slice(0,10);
      alternatesByCategory.fruta = (byCat.fruta || []).slice(0,10);
    }
    
    // REQ 1 (Coesão): Criar listas de candidatos específicas para o tipo de refeição (Top 7 de cada)
    const mainProteins = _rankFoodsByCategory(['proteina_main', 'peixe'], profile).slice(0, 7);
    const mainCarbs = _rankFoodsByCategory(['cereal_main', 'tuberculo'], profile).slice(0, 7);
    const mainLegumes = _rankFoodsByCategory(['leguminosa_main'], profile).slice(0, 7);
    const snackProteins = _rankFoodsByCategory(['proteina_breakfast_snack', 'laticinio_breakfast_snack', 'oleaginosa'], profile).slice(0, 7);
    const snackCarbs = _rankFoodsByCategory(['cereal_breakfast_snack', 'pao_breakfast_snack'], profile).slice(0, 7);
    const commonVeg = _rankFoodsByCategory(['verdura'], profile).slice(0, 7);
    const commonFruit = _rankFoodsByCategory(['fruta'], profile).slice(0, 7);

    // Fallbacks
    const get = (list, idx) => list[idx % list.length] || list[0];
    const fProt = [{ name: 'Frango peito sem pele cozido' }];
    const fCarb = [{ name: 'Arroz, tipo 1 cozido' }];
    const fLeg = [{ name: 'Feijão carioca cozido' }];
    const fSProt = [{ name: 'Ovo inteiro cozido' }];
    const fSCarb = [{ name: 'Aveia flocos crua' }];
    const fVeg = [{ name: 'Alface americana' }];
    const fFru = [{ name: 'Banana nanica' }];


    for(let w=0; w<totalWeeks; w++){
      // ============================================
      // INÍCIO: ALTERAÇÃO ALGORITMO (Chamada)
      // ============================================
      // Passa o 'selectedDaysArr' para a função
      let weekTemplate = buildWeekTemplate(dailyTargetCalories, diasTreino, cheatPolicy, selectedDaysArr);
      // ============================================
      // FIM: ALTERAÇÃO ALGORITMO (Chamada)
      // ============================================
      
      weekTemplate = compensateCheatWeek(weekTemplate);
      const days = [];
      for(let dIdx=0; dIdx<7; dIdx++){
        const daySpec = weekTemplate[dIdx];
        const isTraining = daySpec.isTrainingDay || false;
        const isCheat = daySpec.isCheatDay || false;
        const mealsCount = Math.min(6, Math.max(3, 3 + Math.floor(diasTreino / 2)));
        const mealNames = ["Café da manhã","Lanche manhã","Almoço","Lanche tarde","Jantar","Ceia"].slice(0, mealsCount);
        
        // REQ #2: Refeições pesadas em cafés/lanches (pesos ajustados)
        const mealWeights = mealNames.map(m => {
            if(/almoço|almoco|jantar/i.test(m)) return 1.8; // Refeições principais
            if(/café/i.test(m)) return 1.2; // Café da manhã
            return 0.6; // Lanches e Ceia
        });
        
        const totalW = mealWeights.reduce((a,b)=>a+b,0);
        const dayMeals = [];

        for(let m=0; m<mealsCount; m++){
          const mealName = mealNames[m];
          const weight = mealWeights[m];
          const mealCalories = Math.round((weight/totalW) * daySpec.baseCalories);
          const protForMeal = Math.round((profileTargets.protein_g / totalW) * weight);
          const carbsForMeal = Math.round((profileTargets.carbs_g / totalW) * weight);
          const fatForMeal = Math.round((profileTargets.fat_g / totalW) * weight);
          
          // REQ 1 (Coesão): Selecionar alimentos com base no nome da refeição
          let protPick, carbPick, vegPick;
          const mealType = mealName.toLowerCase();
          const pickIdx = (dIdx * 3 + m) % 7; // Rotação diária + intra-dia

          let componentsToCalc = {};
          let extraComponents = []; // Para saladas, etc.

          if (mealType.includes('almoço') || mealType.includes('jantar')) {
              // Refeição Principal (Almoço/Jantar)
              protPick = get(mainProteins, pickIdx) || fProt[0];
              carbPick = get(mainCarbs, pickIdx) || fCarb[0];
              vegPick = get(mainLegumes, pickIdx) || fLeg[0]; // 'veg' principal é a leguminosa
              componentsToCalc = { protein: protPick.name, carb: carbPick.name, veg: vegPick.name };
              
              const extraVeg = get(commonVeg, pickIdx) || fVeg[0];
              if(extraVeg.name !== vegPick.name) extraComponents.push({ food: extraVeg.name, grams: 75, role: 'veg' }); // 75g de salada

          } else {
              // Refeição Leve (Café/Lanche)
              protPick = get(snackProteins, pickIdx) || fSProt[0];
              carbPick = get(snackCarbs, pickIdx) || fSCarb[0];
              vegPick = get(commonFruit, pickIdx) || fFru[0]; // 'veg' principal é a fruta
              componentsToCalc = { protein: protPick.name, carb: carbPick.name, veg: vegPick.name };
          }
          
          const grams = computeGramAmountsForMeal(findFood, { prot_g: protForMeal, carbs_g: carbsForMeal, fat_g: fatForMeal, calories: mealCalories }, componentsToCalc);
          
          const group = [];
          group.push({ food: componentsToCalc.protein, grams: grams.protein_grams, role:'proteina' });
          group.push({ food: componentsToCalc.carb, grams: grams.carb_grams, role:'carbo' });
          group.push({ food: componentsToCalc.veg, grams: grams.veg_grams, role:'veg' });
          
          // Adicionar extras (ex: salada no almoço)
          extraComponents.forEach(comp => group.push(comp));

          // compute group kcal
          let groupKcal = 0;
          const groupDetailed = group.map(gItem => {
            const rec = findFood(gItem.food);
            const kcal = rec && rec.nutrition ? _round((rec.nutrition.kcal || 0) * gItem.grams / 100, 0) : null;
            if(kcal) groupKcal += kcal;
            return { ...gItem, kcal };
          });
          
          // Filtra componentes com 0g (ou menos de 10g)
          const finalComponents = groupDetailed.filter(comp => comp.grams >= 10);
          
          // Recalcula o Kcal total apenas com os componentes válidos
          groupKcal = finalComponents.reduce((acc, comp) => acc + (comp.kcal || 0), 0);

          dayMeals.push({
            mealIndex: m,
            mealName,
            mealCaloriesTarget: mealCalories,
            components: finalComponents, // Usa a lista filtrada
            isTrainingDay: isTraining,
            isCheatDay: isCheat,
            gramsComputed: grams.details || {},
            sanity: { protForMeal, carbsForMeal, fatForMeal },
            mealKcalTotal: groupKcal
          });
        } // meals
        days.push({
          dayIndex: dIdx+1, // 1-based index for display
          dayOfWeek: (new Date(0, 0, dIdx)).toLocaleString('pt-BR', { weekday: 'long' }), // Debug: 'domingo', 'segunda', etc.
          baseCalories: daySpec.baseCalories,
          isTrainingDay: isTraining,
          isCheatDay: isCheat,
          meals: dayMeals
        });
      } // days
      const estimatedWeeklyCost = _estimateWeeklyCostFromPlan(days);
      timeline_weeks.push({
        weekIndex: w+1,
        weekStartISO: new Date(start.getTime() + (w*7*24*3600*1000)).toISOString().slice(0,10),
        days,
        estimatedWeeklyCost
      });
    } // weeks

    // REQ #4: Aplica rotação mensal (Já estava implementado e é mantido)
    timeline_weeks.forEach((week,wIdx) => {
      const monthIndex = Math.floor(wIdx / 4.345);
      week.days.forEach(day => {
        day.meals.forEach(meal => {
          meal.components = rotateAlternativesForMonth(meal.components, monthIndex, alternatesByCategory);
        });
      });
    });

    const avgWeeklyCost = _round(timeline_weeks.reduce((s,w)=>s + (w.estimatedWeeklyCost || 0),0) / timeline_weeks.length, 2);
    const budgetAdherence = (() => {
      if(!weeklyBudget) return 0.9;
      const ratio = avgWeeklyCost / weeklyBudget;
      const val = ratio <= 1 ? 1 - (1 - ratio)*0.2 : Math.max(0, 1 - (ratio - 1));
      return _round(Math.min(1, val), 3);
    })();

    const meta = {
      adherenceToCaloriesPct: 0.95,
      adherenceToBudgetPct: budgetAdherence,
      practicalityPct: 0.92,
      varietyScore: Math.min(1, 0.2 + (Object.keys(masterDB).length / 200)),
      feasibilityPct: 0.9
    };
    const credibilityScore = computeCredibility(meta);

    const payload = {
      version: 'super-algo-v3-smart-surplus-days', // Versão atualizada
      created_at: nowISO(),
      profile_snapshot: profile,
      targets: profileTargets,
      timeline_weeks,
      estimates: { avgWeeklyCost, weeklyBudget, dailyTargetCalories, tdee: profileTargets.tdee, bmr: profileTargets.bmr },
      credibility: { score: credibilityScore, breakdown: meta },
      provenance: { food_db_version: 'seed-2-meals', built_with: 'super-diet-engine' }
    };
    if(options.debug) payload._internal = { lookup_snapshot: _lookup, weeklyDeficitNeeded, rawOptions: options };
    return payload;
  }

  // persistence (supabase client must be provided via init)
  let _supabase = null;
  function init({ supabase } = {}){ if(!supabase) throw new Error('supabase client required'); _supabase = supabase; }

  // REQ #6: Persistência com Supabase (Funções mantidas para compatibilidade)
  async function savePlan(userId, planPayload, options = {}){
    if(!_supabase) throw new Error('Supabase client not initialized.');
    const title = options.title || `Plano - ${planPayload.targets ? planPayload.targets.targetCalories + ' kCal' : nowISO()}`;
    const row = { user_id: userId, title, payload: planPayload };
    const { data, error } = await _supabase.from('user_diets').insert([row]);
    if(error) { console.error('Erro ao salvar plano:', error); throw error; }
    return data;
  }
  async function loadPlans(userId){
    if(!_supabase) throw new Error('Supabase client not initialized.');
    const { data, error } = await _supabase.from('user_diets').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    if(error) { console.error('Erro ao carregar planos:', error); throw error; }
    return data;
  }
  async function loadLatestPlan(userId){
    const plans = await loadPlans(userId);
    return plans && plans.length ? plans[0] : null;
  }

  return {
    init, loadExternalPrices, loadExternalNutrition, generatePlan: planLongTerm, savePlan, loadPlans, loadLatestPlan, findFood
  };
})(); // end SuperDietEngine

/* ============================================
    Helper functions reused in UI
    ============================================ */
function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
function calculateEndDate(prazoText) { if(!prazoText) return null; const now = new Date(); const year = now.getFullYear(); let prazoLower = prazoText.toLowerCase(); if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); } let match = prazoLower.match(/(\d+)\s+mes(es)?/); if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; } match = prazoLower.match(/(\d+)\s+dia(s)?/); if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; } if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); } if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); } if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); } if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); } return null; }
function displayProgress(startDate, endDate) { const now = new Date(); now.setHours(0,0,0,0); const sDate = new Date(startDate); sDate.setHours(0,0,0,0); const eDate = new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; document.getElementById('progress-bar').style.width=`${progressPercentage}%`; document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR'); document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR'); document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0; 
    // REQ #7: Garante que o formulário desapareça e os resultados apareçam
    document.getElementById('form-wrapper').style.display='none'; 
    document.getElementById('results-wrapper').style.display='block'; 
}

/* ============================================
    UI: render plan (percurso)
    - Render monthly tabs with days and meals
    ============================================ */
function renderPlanToContainer(container, planPayload, options = {}){
  container.innerHTML = '';
  const header = document.createElement('div');
  header.style.display = 'flex'; header.style.justifyContent = 'space-between'; header.style.alignItems = 'center'; header.style.gap = '12px';
  const title = document.createElement('h4'); title.textContent = 'Plano de Dieta — visão geral';
  const meta = document.createElement('div'); meta.style.color = '#bbb'; 
  
  // Exibe TDEE e BMR para debug/confiança
  const targetCals = planPayload.estimates.dailyTargetCalories || planPayload.targets?.targetCalories || '...';
  const tdee = planPayload.estimates.tdee || '...';
  meta.innerHTML = `Alvo: <b>${targetCals} kcal</b> <span style="font-size: 11px; color: #888;">(TDEE: ${tdee} kcal)</span>`;
  
  header.appendChild(title); header.appendChild(meta);
  container.appendChild(header);

  // tabs per month (we approximate months by grouping weeks)
  const months = {}; // monthIndex -> object
  planPayload.timeline_weeks.forEach(week => {
    const date = new Date(week.weekStartISO + 'T00:00:00');
    const monthKey = `${date.getFullYear()}-${('0'+(date.getMonth()+1)).slice(-2)}`;
    months[monthKey] = months[monthKey] || { monthIndex: date.getMonth(), label: date.toLocaleString('pt-BR',{ month:'long', year:'numeric' }), weeks: [] };
    months[monthKey].weeks.push(week);
  });

  const monthKeys = Object.keys(months);
  const tabsBar = document.createElement('div'); tabsBar.className = 'plan-tabs'; container.appendChild(tabsBar);
  const contentArea = document.createElement('div'); container.appendChild(contentArea);

  monthKeys.forEach((mk, idx) => {
    const pill = document.createElement('div'); pill.className = 'plan-tab' + (idx===0 ? ' active':''); pill.textContent = months[mk].label;
    pill.addEventListener('click', () => {
      document.querySelectorAll('.plan-tab').forEach(p=>p.classList.remove('active'));
      pill.classList.add('active');
      // render month content
      renderMonth(months[mk], contentArea);
    });
    tabsBar.appendChild(pill);
  });

  // render first month by default
  if(monthKeys.length) renderMonth(months[monthKeys[0]], contentArea);
}

function renderMonth(monthObj, contentArea){
  contentArea.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';
  // flatten days across weeks for the month
  const days = [];
  monthObj.weeks.forEach(w => {
    w.days.forEach(d => {
      const copy = JSON.parse(JSON.stringify(d));
      copy.weekIndex = w.weekIndex;
      copy.weekStartISO = w.weekStartISO;
      days.push(copy);
    });
  });
  const daysWrap = document.createElement('div'); daysWrap.className = 'plan-days';
  
  // ============================================
  // INÍCIO: ALTERAÇÃO UI (renderMonth)
  // ============================================
  // Mapeia os dias da semana (JS: 0=Dom, 1=Seg... 6=Sab)
  const dayNameMap = { 0: 'Dom', 1: 'Seg', 2: 'Ter', 3: 'Qua', 4: 'Qui', 5: 'Sex', 6: 'Sab' };
  
  days.forEach((d, dIdx_in_month) => {
    // O 'dayIndex' vindo do algoritmo é 1-7 (Dia 1 a Dia 7 da semana)
    // Precisamos do dia da semana real (0-6)
    const dayOfWeekIndex = (new Date(d.weekStartISO + 'T12:00:00Z').getUTCDay() + (d.dayIndex - 1)) % 7;
    const dayName = dayNameMap[dayOfWeekIndex] || 'Dia';

    const dayCard = document.createElement('div'); dayCard.className = 'plan-day';
    const dayTitle = document.createElement('div'); dayTitle.style.display='flex'; dayTitle.style.justifyContent='space-between'; dayTitle.style.alignItems='center';
    
    // Mostra o nome do dia (Seg, Ter, etc.)
    const left = document.createElement('div'); left.innerHTML = `<strong>${dayName}</strong><div style="color:${d.isTrainingDay ? 'var(--journey-red-1)' : '#aaa'};font-size:13px;font-weight:700;">${d.isTrainingDay ? 'DIA DE TREINO' : 'Dia de Descanso'}</div>`;
    // ============================================
    // FIM: ALTERAÇÃO UI (renderMonth)
    // ============================================

    const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML = `<div style="font-weight:700">${d.baseCalories} kcal</div>`;
    dayTitle.appendChild(left); dayTitle.appendChild(right);
    dayCard.appendChild(dayTitle);

    d.meals.forEach(m => {
      const mealRow = document.createElement('div'); mealRow.className='meal-row';
      const mealLeft = document.createElement('div'); mealLeft.className='meal-left';
      const name = document.createElement('div'); name.className='meal-name'; name.textContent = m.mealName;
      const listPreview = document.createElement('div'); listPreview.style.color='#bbb'; listPreview.style.fontSize='13px';
      
      // REQ #1: Garante que o preview não mostre "Arroz (0g)" pois já foi filtrado
      const items = m.components.map(c => `${c.food.split(',')[0]} (${c.grams}g)`).join(' • ');
      listPreview.textContent = items;
      
      mealLeft.appendChild(name); mealLeft.appendChild(listPreview);
      const mealRight = document.createElement('div'); mealRight.style.display='flex'; mealRight.style.flexDirection='column'; mealRight.style.alignItems='flex-end';
      const kcal = document.createElement('div'); kcal.className='meal-kcal'; kcal.textContent = `${m.mealKcalTotal || '—'} kcal`;
      const editBtn = document.createElement('button'); editBtn.textContent = 'Editar'; editBtn.style.marginTop='6px'; editBtn.style.padding='6px 8px'; editBtn.style.borderRadius='8px'; editBtn.style.border='none'; editBtn.style.cursor='pointer'; editBtn.style.background='transparent'; editBtn.style.color='#fff';
      editBtn.addEventListener('click', ()=> openMealEditModal(m)); // lightweight handler
      mealRight.appendChild(kcal); mealRight.appendChild(editBtn);
      mealRow.appendChild(mealLeft); mealRow.appendChild(mealRight);
      dayCard.appendChild(mealRow);
    });

    daysWrap.appendChild(dayCard);
  });

  wrapper.appendChild(daysWrap);
  contentArea.appendChild(wrapper);
}

// basic meal edit modal (in-page simple prompt editing)
function openMealEditModal(meal){
  // create a simple prompt flow to let user adjust grams for each component
  const edits = meal.components.map((c, i) => {
    const newG = prompt(`Editar ${c.food} (g) — atual: ${c.grams}`, c.grams);
    if(newG !== null){
      const val = parseInt(newG,10);
      if(!isNaN(val)) meal.components[i].grams = val;
    }
  });
  // after edits, re-render the plan area if it's visible
  const dietaContent = document.getElementById('dieta-card-content');
  if(dietaContent && dietaContent._lastPlan) renderPlanToContainer(dietaContent, dietaContent._lastPlan);
}

/* ============================================
    Supabase CRUD helpers (compat com seu fluxo)
    - usamos as funções internas do super engine para salvar/recuperar
    ============================================ */
async function getCurrentUser(){
  const { data } = await supabase.auth.getUser();
  return data && data.user ? data.user : null;
}
async function fetchLatestUserDiet(){
  const user = await getCurrentUser();
  if(!user) return null;
  const { data, error } = await supabase.from('user_diets').select('*').eq('user_id', user.id).order('created_at', { ascending: false }).limit(1).single();
  if(error) { console.error('Erro fetchLatestUserDiet', error); return null; }
  return data;
}

/* ============================================
    UI: renderFormObjectToContainer (salvar / atualizar)
    - uses SuperDietEngine.savePlan to persist
    ============================================ */
function clearDietaCardContent(){
  const dietaCard = document.getElementById('dieta-card');
  const content = dietaCard.querySelector('#dieta-card-content');
  if(content) content.remove();
}

function renderGeneratedPlanEditor(container, planPayload, existingId=null){
  container.innerHTML = '';
  const title = document.createElement('h4'); title.textContent = 'Formulário: Dieta — Plano gerado';
  const meta = document.createElement('p'); meta.style.color='#bbb'; 
  const targetCals = planPayload.targets.targetCalories || '...';
  const tdee = planPayload.estimates.tdee || '...';
  meta.innerHTML = `Meta: ${planPayload.profile_snapshot.grande_meta || ''} | Alvo: <b>${targetCals} kcal</b> <span style="font-size: 11px; color: #888;">(TDEE: ${tdee} kcal)</span>`;

  container.appendChild(title); container.appendChild(meta);

  const planView = document.createElement('div');
  planView.style.marginTop='12px';
  planView.id = 'plan-view';
  // keep reference for editing UI
  container._lastPlan = planPayload;
  renderPlanToContainer(planView, planPayload);
  container.appendChild(planView);

  // buttons area
  const btnWrap = document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='10px'; btnWrap.style.marginTop='12px';
  const saveBtn = document.createElement('button'); saveBtn.textContent = existingId ? 'Salvar alterações' : 'Salvar formulário'; saveBtn.style.background='linear-gradient(90deg,#007bff,#0056b3)'; saveBtn.style.color='#fff'; saveBtn.style.border='none'; saveBtn.style.padding='10px 14px'; saveBtn.style.borderRadius='8px'; saveBtn.style.cursor='pointer';
  const saveNewBtn = document.createElement('button'); saveNewBtn.textContent='Salvar como novo'; saveNewBtn.style.background='transparent'; saveNewBtn.style.border='1px solid #444'; saveNewBtn.style.color='#ddd'; saveNewBtn.style.padding='10px 14px'; saveNewBtn.style.borderRadius='8px'; saveNewBtn.style.cursor='pointer';
  const statusSpan = document.createElement('span'); statusSpan.style.color='#aaf'; statusSpan.style.marginLeft='6px';
  btnWrap.appendChild(saveBtn); btnWrap.appendChild(saveNewBtn); btnWrap.appendChild(statusSpan);
  container.appendChild(btnWrap);

  saveBtn.addEventListener('click', async ()=>{
    statusSpan.textContent = 'Salvando...';
    try{
      const user = await getCurrentUser();
      if(!user) { statusSpan.textContent='Usuário não autenticado.'; return; }
      // update payload metadata (modified)
      planPayload.modified_at = new Date().toISOString();
      // if existingId provided -> update row merging payload.form if desired
      if(existingId){
        // update row payload fully (we maintain entire payload)
        const merged = planPayload;
        const { data, error } = await supabase.from('user_diets').update({ payload: merged }).eq('id', existingId).select().limit(1);
        if(error) { console.error(error); statusSpan.textContent='Erro ao atualizar.'; return; }
        statusSpan.textContent = 'Salvo (atualizado).';
        enableAllNavLinks();
        return;
      } else {
        // save with SuperDietEngine
        SuperDietEngine.init({ supabase });
        await SuperDietEngine.savePlan(user.id, planPayload, { title: `Plano - ${planPayload.targets.targetCalories} kcal` });
        statusSpan.textContent = 'Salvo com sucesso.';
        enableAllNavLinks();
        // refresh percurso area
        await renderPercursoDietArea();
      }
    } catch (err){
      console.error(err);
      statusSpan.textContent = 'Erro: ' + (err.message || JSON.stringify(err));
    }
  });

  saveNewBtn.addEventListener('click', async ()=>{
    statusSpan.textContent = 'Salvando cópia...';
    try{
      const user = await getCurrentUser();
      if(!user) { statusSpan.textContent='Usuário não autenticado.'; return; }
      SuperDietEngine.init({ supabase });
      await SuperDietEngine.savePlan(user.id, planPayload, { title: `Plano cópia - ${planPayload.targets.targetCalories} kcal` });
      statusSpan.textContent = 'Cópia salva.';
      enableAllNavLinks();
    } catch(err){
      console.error(err);
      statusSpan.textContent = 'Erro: ' + (err.message || JSON.stringify(err));
    }
  });
}

/* ============================================
    Disable/enable navigation helpers
    ============================================ */
function disableNonPercursoNavLinks(){
  document.querySelectorAll('.nav-link').forEach(link => {
    if(link.dataset.tab !== 'percurso') link.classList.add('hidden');
  });
}
function enableAllNavLinks(){
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('hidden'));
}

/* ============================================
    Render percurso area (loads latest plan, if any)
    ============================================ */
async function renderPercursoDietArea(){
  const dietaCard = document.getElementById('dieta-card');
  clearDietaCardContent();
  const targetContainer = document.createElement('div'); targetContainer.id = 'dieta-card-content';
  dietaCard.appendChild(targetContainer);

  // fetch latest from supabase
  const latest = await fetchLatestUserDiet();
  if(latest && latest.payload){
    // if payload is our plan structure (super-algo), render full editor that allows save/update
    if(latest.payload.version && (latest.payload.version.startsWith('super-algo-v') || latest.payload.targets)){
      renderGeneratedPlanEditor(targetContainer, latest.payload, latest.id);
      enableAllNavLinks();
    } else if(latest.payload.form){
      // backward compatibility: older shape (form property)
      // convert to new payload shape minimally
      const converted = {
        version: 'super-algo-v1-compat',
        created_at: new Date().toISOString(),
        profile_snapshot: latest.payload.meta_inicial || {},
        targets: deriveTargets(latest.payload.meta_inicial || {}),
        timeline_weeks: [], estimates:{}, credibility:{ score: 0, breakdown:{} },
        payload: latest.payload
      };
      renderGeneratedPlanEditor(targetContainer, converted, latest.id);
      enableAllNavLinks();
    } else {
      // unknown payload, just display raw form
      const p = document.createElement('pre'); p.style.color='#bbb'; p.textContent = JSON.stringify(latest.payload, null, 2);
      targetContainer.appendChild(p);
      enableAllNavLinks();
    }
  } else {
    const p = document.createElement('p'); p.style.color='#bbb'; p.textContent = 'Ainda não há formulário de dieta salvo. Gere a sua meta no painel principal para criar o seu plano.';
    targetContainer.appendChild(p);
    // Não desabilitar mais a navegação
    // disableNonPercursoNavLinks();
  }
}

/* ============================================
    Dify chat loader (same pattern)
    ============================================ */
function loadFreshDifyChat(){
  const difyContainer = document.getElementById('dify-container');
  if(!difyContainer) return;
  difyContainer.innerHTML = '';
  const frameWrap = document.createElement('div'); frameWrap.className = 'dify-frame';
  const iframe = document.createElement('iframe');
  const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
  const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;
  iframe.src = difyUrl; iframe.allow='microphone';
  frameWrap.appendChild(iframe);
  const strip = document.createElement('div'); strip.className='dify-top-strip'; strip.setAttribute('aria-hidden','true');
  const badge = document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
  const label = document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
  strip.appendChild(badge); strip.appendChild(label);
  const bottomMask = document.createElement('div'); bottomMask.className='dify-bottom-mask'; bottomMask.setAttribute('aria-hidden','true');
  frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask); difyContainer.appendChild(frameWrap);
}

/* ============================================
    Initialization & event handlers
    ============================================ */
document.addEventListener('DOMContentLoaded', () => {
  // UI interactions (menu, nav)
  let user = null;
  let currentProfile = null;
  const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navLinks = document.querySelectorAll('.nav-link'); const configBtn = document.getElementById('config-btn'); const logoutBtn = document.getElementById('logout-btn'); const resetBtn = document.getElementById('reset-btn');
  const switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); const el = document.getElementById(tabId); if(el) el.classList.add('active'); navLinks.forEach(link => link.classList.remove('active')); const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`); if(activeLink) activeLink.classList.add('active'); };
  const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
  menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
  overlay.addEventListener('click', closeMenu);
  navLinks.forEach(link => { link.addEventListener('click', (e)=>{ e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
  configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
  logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
  resetBtn.addEventListener('click', async () => { if(!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null }).eq('id', user.id); if(resetError) console.error('Erro ao resetar a meta: '+resetError.message); else window.location.reload(); });

  async function initializePageData(){
    const { data } = await supabase.auth.getUser();
    if(!data.user) { window.location.replace('/login.html'); return; }
    user = data.user;
    document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
    const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
    if(error || !profile){ console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }
    currentProfile = profile;
    if(profile.goal_end_date){
      displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
      if(profile.goal_type) document.getElementById('playlist-section').style.display = 'block';
    } else {
      document.getElementById('form-wrapper').style.display = 'block';
    }
    loadFreshDifyChat();
    await renderPercursoDietArea();
  }

  const objetivoInput = document.getElementById('objetivo');
  if(objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; });

  const usoSuplementoSelect = document.getElementById('uso_suplemento');
  if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim') document.getElementById('quais_suplementos').value=''; });

  // form submit: use SuperDietEngine to generate plan and save
  const iaFitForm = document.getElementById('ia-fit-form');
  if(iaFitForm) iaFitForm.addEventListener('submit', async function(event){
    event.preventDefault();
    const submitButton = iaFitForm.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'A gerar o seu plano...';

    try{
      const formElements = event.target.elements;
      const prazoText = formElements.prazo.value;
      const endDate = calculateEndDate(prazoText);
      if(!endDate){ alert('Prazo inválido. Use algo como "3 meses" ou "até o verão".'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }
      const startDate = new Date(); startDate.setHours(0,0,0,0);
      const objetivoText = formElements.objetivo.value;
      const goalType = (function(text){ const lowerText = (text||'').toLowerCase(); const emagrecerKeywords = ['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento']; const musculoKeywords = ['ganhar musculo','hipertrofia','crescer','massa muscular','ficar forte','músculo']; const hasEmagrecer = emagrecerKeywords.some(keyword=>lowerText.includes(keyword)); const hasMusculo = musKewywords.some(keyword=>lowerText.includes(keyword)); if(hasEmagrecer && !hasMusculo) return 'emagrecer'; if(hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; })(objetivoText);

      // ============================================
      // INÍCIO: ALTERAÇÃO JS (Leitura do Formulário)
      // ============================================
      // Novo: Ler os dias de treino selecionados
      const selectedDaysCheckboxes = document.querySelectorAll('input[name="dias_treino"]:checked');
      const selectedDaysArray = Array.from(selectedDaysCheckboxes).map(cb => cb.value);

      if (selectedDaysArray.length === 0) {
          alert('Por favor, selecione pelo menos um dia de treino.');
          submitButton.disabled = false;
          submitButton.textContent = 'Crie seu próprio caminho';
          // Abre o seletor de dias se estiver fechado
          const details = document.querySelector('.day-selector-container');
          if (details && !details.open) {
              details.open = true;
          }
          return;
      }
      // ============================================
      // FIM: ALTERAÇÃO JS (Leitura do Formulário)
      // ============================================


      const { error: updateError } = await supabase.from('profiles').update({
        goal_start_date: startDate.toISOString(),
        goal_end_date: endDate.toISOString(),
        goal_prompt: objetivoText,
        goal_type: goalType
      }).eq('id', (await getCurrentUser()).id);
      if(updateError){ console.error("Erro ao salvar a meta:", updateError); alert('Erro ao salvar sua meta. Tente novamente.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }

      // REQ #7: O formulário desaparece após submit (chama displayProgress)
      displayProgress(startDate, endDate);
      if(goalType) document.getElementById('playlist-section').style.display = 'block';

      // prepare profile object for engine
      const inputs = {
        grande_meta: objetivoText,
        prazo: prazoText,
        sexo: formElements.sexo.value,
        altura: parseFloat(formElements.altura.value) || 1.7,
        peso: parseFloat(formElements.peso.value) || 70,
        idade: parseInt(formElements.idade.value, 10) || 30,
        // ============================================
        // INÍCIO: ALTERAÇÃO JS (Envio para Engine)
        // ============================================
        disponibilidade: selectedDaysArray.length, // O *número* de dias
        selected_days: selectedDaysArray, // O *array* de dias (ex: ['seg', 'qua', 'sex'])
        // ============================================
        // FIM: ALTERAÇÃO JS (Envio para Engine)
        // ============================================
        local_treino: formElements.local_treino.value,
        orcamento: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
        orcamento_mes_R$: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
        uso_suplemento: formElements.uso_suplemento.value,
        quais_suplementos: formElements.quais_suplementos.value || '',
        nivel: formElements.nivel.value
      };

      // init engine and generate plan
      SuperDietEngine.init({ supabase });
      // months: try to infer from prazo (e.g., '3 meses')
      const match = (inputs.prazo||'').match(/(\d+)\s*mes/);
      const months = match ? Math.max(1, parseInt(match[1],10)) : 3;
      
      // Geração do plano (pode demorar um pouco)
      const plan = await SuperDietEngine.generatePlan(inputs, { months, debug: false });

      // save plan using engine
      const currentUser = await getCurrentUser();
      if(!currentUser) { alert('Usuário não autenticado.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }
      await SuperDietEngine.savePlan(currentUser.id, plan, { title: `Plano - ${plan.targets.targetCalories} kcal` });

      // switch to percurso and render plan
      switchTab('percurso');
      await renderPercursoDietArea();
      
      // Libera a navegação
      enableAllNavLinks();
      submitButton.disabled = false;
      submitButton.textContent = 'Crie seu próprio caminho';

    } catch(err){
      console.error('Erro no fluxo de criação da meta:', err);
      alert('Erro interno: ' + (err.message || JSON.stringify(err)));
      submitButton.disabled = false;
      submitButton.textContent = 'Crie seu próprio caminho';
    }
  });

  const playlistBtn = document.getElementById('playlist-btn');
  if(playlistBtn) playlistBtn.addEventListener('click', async function(){
    const { data } = await supabase.auth.getUser();
    if(!data.user) return;
    const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', data.user.id).single();
    if(!profile) return;
    let videoOrder;
    if(profile.goal_type==='emagrecer'){videoOrder=[3,2,1];} else if(profile.goal_type==='musculo'){videoOrder=[3,1,2];} else {videoOrder=[1,2,3];}
    const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')};
    Object.values(v).forEach(b=>b.remove());
    videoOrder.forEach(i=>c.appendChild(v[i]));
    switchTab('video-aulas');
    document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' });
  });

  // start
  initializePageData().catch(err => { console.error('Erro inicial:', err); });
});
</script>
</body>
</html>
