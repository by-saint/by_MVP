<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
      --bg: #121212;
      --card: #1E1E1E;
      --muted: #bbb;
    }
    html { scroll-behavior: smooth; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: #E0E0E0; margin: 0; padding: 40px 20px; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
    h1,h2,h3{ color:#f0f0f0; text-align:center; margin-top:30px; margin-bottom:15px; }

    /* MENU / SIDEBAR */
    .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 1001; background: #333; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:5px; padding:0; }
    .menu-toggle .bar { width:24px; height:3px; background-color:#fff; border-radius:2px; transition: all 0.3s; }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--card); transition: left 0.28s ease; z-index:1000; border-right:1px solid #333; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar.open { left: 0; }
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul{ list-style:none; padding:0; margin:0; }
    /* Nav link style updated to show colored rectangle at left when active */
    .sidebar nav a{ display:block; padding:15px 30px; padding-left:44px; text-decoration:none; font-size:1.05em; font-weight:700; border-left:5px solid transparent; transition: background-color 0.2s, border-left 0.2s; color:var(--muted); position:relative; }
    .sidebar nav a::before { content: ''; position:absolute; left:12px; top:50%; transform:translateY(-50%); width:8px; height:60%; border-radius:4px; opacity:0; transition: opacity 0.18s, transform 0.18s; }
    .sidebar nav a:hover{ background-color:#2c2c2c; color:#fff; }
    .sidebar nav a.active{ background-color:rgba(255,255,255,0.02); color:#fff; }
    /* colored rectangle per tab */
    .link-ia.active::before { background: linear-gradient(180deg,var(--color-ia-specialist), #0056b3); opacity:1; }
    .link-aulas.active::before { background: linear-gradient(180deg,#c048f2,#6b21a8); opacity:1; }
    .link-percurso.active::before { background: linear-gradient(180deg,var(--journey-red-1),var(--journey-red-2)); opacity:1; }

    .sidebar-footer { padding:20px 30px; text-align:center; }
    .sidebar-config-btn { width:100%; background:transparent; border:1px solid #444; color:#aaa; padding:10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:600; }
    .sidebar-config-btn:hover{ background:#333; color:#fff; }
    .sidebar-action-btn{ width:100%; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.2s; margin-top:10px; }
    .sidebar-reset-btn{ background:transparent; border:1px solid var(--color-ia-specialist); color:var(--color-ia-specialist); }
    .sidebar-reset-btn:hover{ background:var(--color-ia-specialist); color:#fff; }
    .sidebar-logout-btn{ background:#be123c; border:1px solid #be123c; color:#fff; }
    .sidebar-logout-btn:hover{ background:#ff4757; border-color:#ff4757; }
    .hidden{ display:none; }

    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; opacity:0; visibility:hidden; transition:opacity 0.28s, visibility 0.28s; }
    .overlay.show{ opacity:1; visibility:visible; }

    .header { display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px; }
    #welcome-msg { color:#bbb; margin-right:20px; }

    .tab-content{ display:none; }
    .tab-content.active{ display:block; }
    .form-wrapper, .results-wrapper { width:100%; max-width:900px; margin:0 auto; }

    .form-container, .results-container, .percurso-container { background-color: var(--card); padding:40px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; color:#E0E0E0; }
    .form-group{ margin-bottom:20px; }
    label{ display:block; margin-bottom:8px; font-weight:600; color:#BBBBBB; }
    input, select, textarea { width:100%; padding:12px; background-color:#2C2C2C; border:1px solid #444; border-radius:8px; color:#E0E0E0; font-size:16px; box-sizing:border-box; }
    textarea{ resize:vertical; min-height:100px; }

    .goal-section{ background: linear-gradient(145deg,#2a2a2a,#1a1a1a); border:1px solid #444; padding:30px; margin-bottom:24px; border-radius:10px; text-align:center; }
    .goal-title{ font-size:28px; font-weight:700; background: linear-gradient(90deg,#007BFF,#00C6FF); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    button[type="submit"]{ width:100%; padding:15px; background:linear-gradient(90deg,#007BFF,#0056b3); border:none; border-radius:8px; color:#fff; font-size:18px; font-weight:600; cursor:pointer; }

    .progress-section{ margin-top:24px; padding:20px; background-color:#2C2C2C; border-radius:10px; }
    .progress-bar-container{ width:100%; background-color:#444; border-radius:10px; overflow:hidden; }
    .progress-bar{ width:0%; background-color:#007BFF; height:20px; transition: width 0.5s ease-in-out; }
    .progress-labels{ display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-top:5px; }
    .countdown-container{text-align:center; margin-top:20px; }
    .countdown-days{ font-size:4rem; font-weight:700; color:#fff; line-height:1; }
    .countdown-label{ font-size:1rem; color:#aaa; }

    .playlist-section{ text-align:center; margin:24px 0; }
    .playlist-btn{ background:#007BFF; color:white; border:none; padding:12px 24px; font-size:1.1em; cursor:pointer; border-radius:8px; }

    .percurso-forms{ display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:20px; }
    .percurso-card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border:1px solid rgba(190,18,60,0.06); padding:20px; border-radius:12px; }
    .generated-diet-card{ border:2px solid rgba(190,18,60,0.14); box-shadow:0 8px 24px rgba(190,18,60,0.06); padding:18px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.16)); color:#ddd; }

    /* Plan UI */
    .plan-tabs{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .plan-tab{ padding:8px 12px; border-radius:999px; background:#2b2b2b; color:#fff; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
    .plan-tab.active{ background: linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2)); color:white; }
    .plan-days{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .plan-day{ background: linear-gradient(180deg,#141414,#0f0f0f); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-row{ margin-bottom:10px; padding:8px; border-radius:8px; background:#0d0d0d; display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-left{ display:flex; gap:10px; align-items:center; }
    .meal-name{ font-weight:700; color:#fff; }
    .meal-kcal{ font-weight:700; color:#f3f3f3; background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; }

    /* dify */
    .iframe-container{ border-radius:12px; overflow:hidden; position:relative; height:70vh; min-height:340px; max-height:720px; background:#000; }
    .dify-top-strip{ position:absolute; top:0; left:0; width:100%; height:50px; background:#000000; z-index:2; pointer-events:none; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-sizing:border-box; }
    .dify-top-badge{ font-weight:700; font-size:1.1em; color:#fff; background: linear-gradient(90deg,#007BFF,#0056b3); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .mvp-label{ font-size:10px; font-weight:700; color:#555; text-transform:uppercase; letter-spacing:0.5px; }

    /* day selector */
    .day-selector-container { background-color: #2C2C2C; border:1px solid #444; border-radius:8px; }
    .day-selector-summary { padding:12px; font-weight:600; color:#BBBBBB; cursor:pointer; position:relative; }
    .day-selector-summary::after { content:'▼'; font-size:0.8em; position:absolute; right:15px; top:14px; transition:transform 0.2s; }
    .day-selector-container[open] .day-selector-summary::after { transform: rotate(180deg); }
    .day-selector-grid { display:flex; flex-wrap:wrap; gap:10px; padding:0 12px 12px 12px; justify-content:center; }
    .day-circle-input{ display:none; }
    .day-circle-label{ display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:50%; border:2px solid #555; background:#333; color:#E0E0E0; font-size:14px; font-weight:700; cursor:pointer; user-select:none; }
    .day-circle-input:checked + .day-circle-label{ background:var(--color-ia-specialist); border-color:var(--color-ia-specialist); color:#fff; box-shadow:0 0 10px rgba(0,123,255,0.5); }

    @media(max-width:900px){
      .percurso-forms{ grid-template-columns:1fr; }
      .plan-days{ grid-template-columns:1fr; }
      body{ padding:20px 12px; }
      .day-circle-label{ width:36px; height:36px; font-size:13px; }
      .iframe-container{ height:48vh; min-height:220px; }
    }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>

  <div class="sidebar" id="sidebar">
    <nav>
      <ul>
        <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
        <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
        <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button>
      <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
      <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="container">
    <div class="header">
      <p id="welcome-msg">A carregar...</p>
    </div>

    <!-- IA PLANEJAMENTO -->
    <div id="ia-planejamento" class="tab-content active">
      <div class="form-wrapper" id="form-wrapper" style="display:block;">
        <div class="form-container">
          <h1>Crie a sua Meta</h1>
          <form id="ia-fit-form">
            <div class="goal-section">
              <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
              <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo... (Ex: perder 10kg, ganhar massa muscular)" required></textarea>

              <div id="prazo-group" class="form-group" style="margin-top:20px; text-align:left; display:none;">
                <label for="prazo">Qual o prazo para esta meta?</label>
                <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, 1 ano, 1.5 anos..." required>
              </div>
            </div>

            <h3>Informações Básicas e Realidade Atual</h3>

            <div class="form-group"><label for="sexo">Sexo</label>
              <select id="sexo" name="sexo" required>
                <option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option>
              </select>
            </div>

            <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
            <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
            <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>

            <div class="form-group">
              <details class="day-selector-container">
                <summary class="day-selector-summary">Dias de treino</summary>
                <div class="day-selector-grid">
                  <input type="checkbox" name="dias_treino" value="seg" id="dia-seg" class="day-circle-input"><label for="dia-seg" class="day-circle-label">Seg</label>
                  <input type="checkbox" name="dias_treino" value="ter" id="dia-ter" class="day-circle-input"><label for="dia-ter" class="day-circle-label">Ter</label>
                  <input type="checkbox" name="dias_treino" value="qua" id="dia-qua" class="day-circle-input"><label for="dia-qua" class="day-circle-label">Qua</label>
                  <input type="checkbox" name="dias_treino" value="qui" id="dia-qui" class="day-circle-input"><label for="dia-qui" class="day-circle-label">Qui</label>
                  <input type="checkbox" name="dias_treino" value="sex" id="dia-sex" class="day-circle-input"><label for="dia-sex" class="day-circle-label">Sex</label>
                  <input type="checkbox" name="dias_treino" value="sab" id="dia-sab" class="day-circle-input"><label for="dia-sab" class="day-circle-label">Sáb</label>
                  <input type="checkbox" name="dias_treino" value="dom" id="dia-dom" class="day-circle-input"><label for="dia-dom" class="day-circle-label">Dom</label>
                </div>
              </details>
            </div>

            <div class="form-group"><label for="local_treino">Onde vai treinar?</label>
              <select id="local_treino" name="local_treino" required>
                <option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option>
              </select>
            </div>

            <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>

            <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label>
              <select id="uso_suplemento" name="uso_suplemento" required>
                <option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option>
              </select>
            </div>

            <div class="form-group" id="suplementos-detalhes-group" style="display:none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>

            <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label>
              <select id="nivel" name="nivel" required>
                <option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option>
              </select>
            </div>

            <button type="submit">Crie seu próprio caminho</button>
          </form>
        </div>
      </div>

      <div class="results-wrapper" id="results-wrapper" style="display:none;">
        <div class="results-container">
          <h2>Fale com a IA</h2>
          <div id="dify-container" class="iframe-container">
            <div class="dify-top-strip"><div class="dify-top-badge">Fale com a IA</div><div class="mvp-label">MVPia</div></div>
            <iframe id="dify-iframe" src="" frameborder="0" style="position:absolute; inset:0; width:100%; height:100%; border:0;"></iframe>
            <div class="dify-bottom-mask"></div>
          </div>

          <div class="playlist-section" id="playlist-section" style="display:none;">
            <h4>Roteiro de Aulas Sugerido</h4>
            <p style="color:#bbb; margin-top:-10px;">Com base na sua meta, preparamos um roteiro para acelerar os seus resultados.</p>
            <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
          </div>

          <div class="progress-section">
            <h3>Sua Jornada</h3>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
            <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIDEO AULAS -->
    <div id="video-aulas" class="tab-content">
      <h2>Nossas Aulas</h2>
      <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
      <div id="video-block-2" style="margin-top:18px;"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1G" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
      <div id="video-block-3" style="margin-top:18px;"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
    </div>

    <!-- PERCURSO -->
    <div id="percurso" class="tab-content">
      <div class="percurso-container">
        <h2>Meu Percurso</h2>
        <p style="text-align:center;color:#bbb;">Abaixo está seu formulário / plano de dieta. Edite, salve ou crie novas versões.</p>
        <div class="percurso-forms">
          <div class="percurso-card" id="treino-card">
            <h4>Formulário: Treino</h4>
            <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
            <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
          </div>

          <div class="percurso-card generated-diet-card" id="dieta-card">
            <h4>Formulário: Dieta</h4>
            <div id="dieta-card-content"><p style="color:#bbb;">Seu formulário de dieta será exibido aqui após você criar sua meta.</p></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- SCRIPT -->
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Supabase example (use your credentials)
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  /* ============================
     SuperDietEngine v6.1 -> v7.0 (porções + blueprints)
     ============================ */
  const SuperDietEngine = (function(){
    /* ========== FOOD DB (v5) with 'portion' added for each item ========== */
    const v5_FoodDatabase = {
      // Proteínas (principais)
      'frango_peito': { 
        name:'Frango, Peito sem pele cozido', 
        nutrition:{ kcal:165, protein_g:31, carb_g:0, fat_g:3.6, fiber_g:0 }, 
        price_per_kg: 22.0, category:'proteina_main', ig: 0,
        portion: { name: 'filé(s)', grams: 125 }
      },
      'frango_sobrecoxa': {
        name:'Frango, Sobrecoxa sem pele assada',
        nutrition:{ kcal:209, protein_g:26, carb_g:0, fat_g:11.2, fiber_g:0 },
        price_per_kg: 18.0, category:'proteina_main', ig: 0,
        portion: { name: 'porção(ões)', grams: 120 }
      },
      'carne_patinho_moido': { 
        name:'Carne, Patinho moído 90/10 cozido', 
        nutrition:{ kcal:185, protein_g:28, carb_g:0, fat_g:7.5, fiber_g:0 }, 
        price_per_kg: 40.0, category:'proteina_main', ig: 0,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'carne_alcatra_grelhada': {
        name:'Carne, Alcatra grelhada',
        nutrition:{ kcal:200, protein_g:30, carb_g:0, fat_g:8.5, fiber_g:0 },
        price_per_kg: 45.0, category:'proteina_main', ig: 0,
        portion: { name: 'bife(s)', grams: 120 }
      },
      'carne_coxao_mole_cozido': {
        name:'Carne, Coxão mole cozido',
        nutrition:{ kcal:219, protein_g:32, carb_g:0, fat_g:9.5, fiber_g:0 },
        price_per_kg: 42.0, category:'proteina_main', ig: 0,
        portion: { name: 'porção(ões)', grams: 120 }
      },
      'porco_lombo_grelhado': {
        name:'Porco, Lombo grelhado',
        nutrition:{ kcal:176, protein_g:29, carb_g:0, fat_g:6.2, fiber_g:0 },
        price_per_kg: 28.0, category:'proteina_main', ig: 0,
        portion: { name: 'porção(ões)', grams: 120 }
      },

      // peixes
      'peixe_tilapia_grelhada': { 
        name:'Peixe, Tilápia grelhada', 
        nutrition:{ kcal:128, protein_g:26, carb_g:0, fat_g:2.7, fiber_g:0 }, 
        price_per_kg: 40.0, category:'peixe', ig: 0,
        portion: { name: 'filé(s)', grams: 120 }
      },
      'peixe_salmao_grelhado': {
        name:'Peixe, Salmão grelhado',
        nutrition:{ kcal:208, protein_g:20, carb_g:0, fat_g:13, fiber_g:0 },
        price_per_kg: 75.0, category:'peixe', ig: 0,
        portion: { name: 'filé(s)', grams: 120 }
      },
      'atum_lata_agua': {
        name:'Atum, em lata (drenado)',
        nutrition:{ kcal:116, protein_g:26, carb_g:0, fat_g:0.9, fiber_g:0 },
        price_per_kg: 55.0, category:'peixe', ig: 0,
        portion: { name: 'lata(s)', grams: 120 }
      },
      'sardinha_lata_oleo': {
        name:'Sardinha, em lata óleo (drenada)',
        nutrition:{ kcal:208, protein_g:24.6, carb_g:0, fat_g:11.5, fiber_g:0 },
        price_per_kg: 30.0, category:'peixe', ig: 0,
        portion: { name: 'lata(s)', grams: 120 }
      },

      // snacks / laticinios
      'ovo_cozido': { 
        name:'Ovo, de galinha inteiro cozido', 
        nutrition:{ kcal:155, protein_g:13, carb_g:1.1, fat_g:11, fiber_g:0 }, 
        price_per_kg: 16.0, category:'proteina_snack', ig: 0,
        portion: { name: 'unidade(s)', grams: 50 }
      },
      'ovo_clara_cozida': {
        name:'Ovo, clara cozida',
        nutrition:{ kcal:52, protein_g:11, carb_g:0.7, fat_g:0.2, fiber_g:0 },
        price_per_kg: 20.0, category:'proteina_snack', ig: 0,
        portion: { name: 'unidade(s)', grams: 30 }
      },
      'queijo_cottage': {
        name:'Queijo, Cottage (ex: 4% gordura)',
        nutrition:{ kcal:98, protein_g:11, carb_g:3.4, fat_g:4.3, fiber_g:0 },
        price_per_kg: 45.0, category:'laticinio_snack', ig: 0,
        portion: { name: 'colher(es)', grams: 80 }
      },
      'queijo_minas_frescal': {
        name:'Queijo, Minas frescal',
        nutrition:{ kcal:264, protein_g:17, carb_g:3, fat_g:20, fiber_g:0 },
        price_per_kg: 38.0, category:'laticinio_snack', ig: 0,
        portion: { name: 'fatia(s)', grams: 50 }
      },
      'queijo_mussarela': {
        name:'Queijo, Mussarela',
        nutrition:{ kcal:300, protein_g:22, carb_g:2.2, fat_g:22, fiber_g:0 },
        price_per_kg: 48.0, category:'laticinio_snack', ig: 0,
        portion: { name: 'fatia(s)', grams: 30 }
      },
      'iogurte_nat_desnatado': {
        name:'Iogurte, Natural desnatado',
        nutrition:{ kcal:41, protein_g:5.7, carb_g:4.2, fat_g:0.1, fiber_g:0 },
        price_per_kg: 15.0, category:'laticinio_snack', ig: 35,
        portion: { name: 'potinho(s)', grams: 170 }
      },
      'leite_desnatado': {
        name:'Leite, Desnatado UHT',
        nutrition:{ kcal:35, protein_g:3.6, carb_g:5.1, fat_g:0.1, fiber_g:0 },
        price_per_kg: 5.50, category:'laticinio_snack', ig: 32,
        portion: { name: 'copo(s)', grams: 200 }
      },
      'requeijao_light': {
        name:'Requeijão, Light',
        nutrition:{ kcal:170, protein_g:10, carb_g:4.5, fat_g:12, fiber_g:0 },
        price_per_kg: 35.0, category:'laticinio_snack', ig: 0,
        portion: { name: 'colher(es)', grams: 20 }
      },

      // suplementos
      'whey_protein_concentrado': { 
        name:'Whey Protein (padrão 80%)', 
        nutrition:{ kcal:390, protein_g:80, carb_g:9, fat_g:3.5, fiber_g:1 }, 
        price_per_kg: 110.0, category:'suplemento', ig: 15,
        portion: { name: 'scoop(s)', grams: 30 }
      },

      // carbo principais
      'arroz_branco_cozido': { 
        name:'Arroz, Branco tipo 1 cozido', 
        nutrition:{ kcal:130, protein_g:2.7, carb_g:28, fat_g:0.2, fiber_g:0.4 }, 
        price_per_kg: 6.0, category:'cereal_main', ig: 73,
        portion: { name: 'colher(es) de servir', grams: 50 }
      },
      'arroz_integral_cozido': {
        name:'Arroz, Integral cozido',
        nutrition:{ kcal:111, protein_g:2.6, carb_g:23.5, fat_g:0.9, fiber_g:1.8 },
        price_per_kg: 8.0, category:'cereal_main', ig: 50,
        portion: { name: 'colher(es) de servir', grams: 50 }
      },
      'macarrao_comum_cozido': {
        name:'Macarrão, comum cozido',
        nutrition:{ kcal:158, protein_g:5.8, carb_g:31, fat_g:0.9, fiber_g:1.8 },
        price_per_kg: 10.0, category:'cereal_main', ig: 55,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'macarrao_integral_cozido': {
        name:'Macarrão, integral cozido',
        nutrition:{ kcal:141, protein_g:5.5, carb_g:27, fat_g:0.9, fiber_g:3.9 },
        price_per_kg: 16.0, category:'cereal_main', ig: 40,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'batata_doce_cozida': {
        name:'Batata doce, cozida',
        nutrition:{ kcal:90, protein_g:1.0, carb_g:21.0, fat_g:0.1, fiber_g:2.5 },
        price_per_kg: 5.0, category:'tuberculo', ig: 63,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'batata_inglesa_cozida': {
        name:'Batata inglesa, cozida',
        nutrition:{ kcal:87, protein_g:1.9, carb_g:20.1, fat_g:0.1, fiber_g:1.8 },
        price_per_kg: 4.5, category:'tuberculo', ig: 82,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'mandioca_cozida': {
        name:'Mandioca (Aipim), cozida',
        nutrition:{ kcal:160, protein_g:1.4, carb_g:38, fat_g:0.3, fiber_g:1.8 },
        price_per_kg: 6.0, category:'tuberculo', ig: 77,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'inhame_cozido': {
        name:'Inhame, cozido',
        nutrition:{ kcal:118, protein_g:1.5, carb_g:28, fat_g:0.2, fiber_g:4.1 },
        price_per_kg: 7.0, category:'tuberculo', ig: 51,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'cuscuz_milho_cozido': {
        name:'Cuscuz, de milho (flocão) cozido',
        nutrition:{ kcal:113, protein_g:2.2, carb_g:25.5, fat_g:0.3, fiber_g:1.9 },
        price_per_kg: 9.0, category:'cereal_main', ig: 65,
        portion: { name: 'porção(ões)', grams: 100 }
      },

      // snacks carbo
      'aveia_flocos': { 
        name:'Aveia, em flocos crus', 
        nutrition:{ kcal:389, protein_g:16.9, carb_g:66.3, fat_g:6.9, fiber_g:10.6 }, 
        price_per_kg: 12.0, category:'cereal_snack', ig: 55,
        portion: { name: 'colher(es)', grams: 30 }
      },
      'pao_integral_forma': {
        name:'Pão, de forma integral (1 fatia ≈ 25g)',
        nutrition:{ kcal:250, protein_g:9.5, carb_g:48, fat_g:2.5, fiber_g:6.0 },
        price_per_kg: 20.0, category:'pao_snack', ig: 45,
        portion: { name: 'fatia(s)', grams: 30 }
      },
      'pao_frances': {
        name:'Pão, Francês (unidade ≈ 50g)',
        nutrition:{ kcal:289, protein_g:8.0, carb_g:58.5, fat_g:2.0, fiber_g:2.3 },
        price_per_kg: 15.0, category:'pao_snack', ig: 70,
        portion: { name: 'unidade(s)', grams: 50 }
      },
      'tapioca_goma': {
        name:'Tapioca (goma hidratada)',
        nutrition:{ kcal:240, protein_g:0, carb_g:59, fat_g:0, fiber_g:0 },
        price_per_kg: 10.0, category:'cereal_snack', ig: 80,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'granola_tradicional': {
        name:'Granola, tradicional (com açúcar)',
        nutrition:{ kcal:420, protein_g:9.0, carb_g:70, fat_g:12, fiber_g:8.0 },
        price_per_kg: 25.0, category:'cereal_snack', ig: 65,
        portion: { name: 'colher(es)', grams: 40 }
      },
      'milho_pipoca_estourada': {
        name:'Pipoca (milho estourado, sem gordura)',
        nutrition:{ kcal:387, protein_g:12.9, carb_g:78, fat_g:4.5, fiber_g:15.1 },
        price_per_kg: 14.0, category:'cereal_snack', ig: 55,
        portion: { name: 'xícara(s)', grams: 30 }
      },
      'rap10_comum': {
        name:'Pão Folha (Rap10) comum',
        nutrition:{ kcal:306, protein_g:8.2, carb_g:55, fat_g:5.7, fiber_g:2.1 },
        price_per_kg: 28.0, category:'pao_snack', ig: 68,
        portion: { name: 'unidade(s)', grams: 60 }
      },

      // leguminosas
      'feijao_carioca_cozido': { 
        name:'Feijão, Carioca cozido (com caldo)', 
        nutrition:{ kcal:76, protein_g:4.8, carb_g:13.6, fat_g:0.5, fiber_g:5.5 }, 
        price_per_kg: 8.5, category:'leguminosa', ig: 29,
        portion: { name: 'concha(s)', grams: 60 }
      },
      'feijao_preto_cozido': {
        name:'Feijão, Preto cozido (com caldo)',
        nutrition:{ kcal:77, protein_g:4.5, carb_g:14, fat_g:0.5, fiber_g:5.8 },
        price_per_kg: 9.0, category:'leguminosa', ig: 30,
        portion: { name: 'concha(s)', grams: 60 }
      },
      'lentilha_cozida': {
        name:'Lentilha, cozida',
        nutrition:{ kcal:116, protein_g:9.0, carb_g:20.1, fat_g:0.4, fiber_g:7.9 },
        price_per_kg: 14.0, category:'leguminosa', ig: 32,
        portion: { name: 'concha(s)', grams: 80 }
      },
      'grao_de_bico_cozido': {
        name:'Grão-de-bico, cozido',
        nutrition:{ kcal:139, protein_g:7.2, carb_g:25.5, fat_g:1.1, fiber_g:6.4 },
        price_per_kg: 15.0, category:'leguminosa', ig: 28,
        portion: { name: 'concha(s)', grams: 80 }
      },

      // gorduras boas
      'azeite_oliva_extravirgem': { 
        name:'Azeite, de Oliva Extra Virgem', 
        nutrition:{ kcal:884, protein_g:0, carb_g:0, fat_g:100, fiber_g:0 }, 
        price_per_kg: 45.0, category:'gordura_boa', ig: 0,
        portion: { name: 'colher(es) de sopa', grams: 10 }
      },
      'abacate': {
        name:'Abacate, cru',
        nutrition:{ kcal:160, protein_g:2, carb_g:8.5, fat_g:14.7, fiber_g:6.7 },
        price_per_kg: 12.0, category:'gordura_boa', ig: 15,
        portion: { name: 'metade(s)', grams: 100 }
      },
      'castanha_de_caju_torrada': {
        name:'Castanha de Caju, torrada',
        nutrition:{ kcal:580, protein_g:17, carb_g:30, fat_g:46, fiber_g:3.3 },
        price_per_kg: 80.0, category:'gordura_boa', ig: 22,
        portion: { name: 'colher(es)', grams: 20 }
      },
      'amendoim_torrado_sem_sal': {
        name:'Amendoim, torrado sem sal',
        nutrition:{ kcal:567, protein_g:25.8, carb_g:16.1, fat_g:49.2, fiber_g:8.5 },
        price_per_kg: 25.0, category:'gordura_boa', ig: 14,
        portion: { name: 'colher(es)', grams: 15 }
      },
      'pasta_amendoim_integral': {
        name:'Pasta de Amendoim, integral',
        nutrition:{ kcal:588, protein_g:25, carb_g:20, fat_g:50, fiber_g:8 },
        price_per_kg: 40.0, category:'gordura_boa', ig: 14,
        portion: { name: 'colher(es)', grams: 15 }
      },
      'acai_puro_congelado': {
        name:'Açaí, polpa pura congelada (sem açúcar)',
        nutrition:{ kcal:58, protein_g:0.8, carb_g:6.2, fat_g:3.9, fiber_g:2.9 },
        price_per_kg: 20.0, category:'gordura_boa', ig: 10,
        portion: { name: 'porção(ões)', grams: 100 }
      },

      // frutas
      'banana_nanica_crua': { 
        name:'Banana, nanica crua', 
        nutrition:{ kcal:89, protein_g:1.1, carb_g:22.8, fat_g:0.3, fiber_g:2.6 }, 
        price_per_kg: 4.5, category:'fruta', ig: 51,
        portion: { name: 'unidade(s)', grams: 100 }
      },
      'maca_fuji_crua': {
        name:'Maçã, Fuji com casca crua',
        nutrition:{ kcal:56, protein_g:0.3, carb_g:15.2, fat_g:0, fiber_g:2.0 },
        price_per_kg: 8.0, category:'fruta', ig: 38,
        portion: { name: 'unidade(s)', grams: 120 }
      },
      'mamao_papaia_cru': {
        name:'Mamão, Papaia cru',
        nutrition:{ kcal:43, protein_g:0.5, carb_g:11, fat_g:0.3, fiber_g:1.7 },
        price_per_kg: 7.0, category:'fruta', ig: 60,
        portion: { name: 'porção(ões)', grams: 120 }
      },
      'laranja_pera_crua': {
        name:'Laranja, Pêra crua',
        nutrition:{ kcal:47, protein_g:0.9, carb_g:12, fat_g:0.1, fiber_g:2.4 },
        price_per_kg: 4.0, category:'fruta', ig: 43,
        portion: { name: 'unidade(s)', grams: 160 }
      },
      'uva_thompson_crua': {
        name:'Uva, Thompson (verde) crua',
        nutrition:{ kcal:69, protein_g:0.7, carb_g:18, fat_g:0.2, fiber_g:0.9 },
        price_per_kg: 15.0, category:'fruta', ig: 53,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'morango_cru': {
        name:'Morango, cru',
        nutrition:{ kcal:32, protein_g:0.7, carb_g:7.7, fat_g:0.3, fiber_g:2.0 },
        price_per_kg: 25.0, category:'fruta', ig: 40,
        portion: { name: 'porção(ões)', grams: 100 }
      },
      'melao_amarelo_cru': {
        name:'Melão, Amarelo cru',
        nutrition:{ kcal:29, protein_g:0.9, carb_g:7.5, fat_g:0, fiber_g:0.5 },
        price_per_kg: 6.0, category:'fruta', ig: 65,
        portion: { name: 'porção(ões)', grams: 120 }
      },
      'melancia_crua': {
        name:'Melancia, crua',
        nutrition:{ kcal:30, protein_g:0.6, carb_g:8, fat_g:0.2, fiber_g:0.4 },
        price_per_kg: 3.5, category:'fruta', ig: 72,
        portion: { name: 'fatia(s)', grams: 200 }
      },
      'manga_tommy_crua': {
        name:'Manga, Tommy crua',
        nutrition:{ kcal:60, protein_g:0.8, carb_g:15, fat_g:0.4, fiber_g:1.6 },
        price_per_kg: 7.5, category:'fruta', ig: 51,
        portion: { name: 'porção(ões)', grams: 150 }
      },
      'abacaxi_cru': {
        name:'Abacaxi, cru',
        nutrition:{ kcal:50, protein_g:0.5, carb_g:13, fat_g:0.1, fiber_g:1.4 },
        price_per_kg: 7.0, category:'fruta', ig: 59,
        portion: { name: 'fatia(s)', grams: 100 }
      },

      // verduras
      'alface_crespa_crua': { 
        name:'Alface, Crespa crua', 
        nutrition:{ kcal:15, protein_g:1.4, carb_g:2.9, fat_g:0.2, fiber_g:1.0 }, 
        price_per_kg: 8.0, category:'verdura', ig: 15,
        portion: { name: 'prato(s)', grams: 50 }
      },
      'tomate_salada_cru': {
        name:'Tomate, Salada cru',
        nutrition:{ kcal:18, protein_g:0.9, carb_g:3.9, fat_g:0.2, fiber_g:1.2 },
        price_per_kg: 9.0, category:'verdura', ig: 15,
        portion: { name: 'unidade(s)', grams: 80 }
      },
      'cenoura_crua': {
        name:'Cenoura, crua',
        nutrition:{ kcal:41, protein_g:0.9, carb_g:9.6, fat_g:0.2, fiber_g:2.8 },
        price_per_kg: 5.0, category:'verdura', ig: 39,
        portion: { name: 'unidade(s)', grams: 60 }
      },
      'brocolis_cozido': {
        name:'Brócolis, cozido',
        nutrition:{ kcal:35, protein_g:2.4, carb_g:7.2, fat_g:0.4, fiber_g:3.4 },
        price_per_kg: 12.0, category:'verdura', ig: 15,
        portion: { name: 'porção(ões)', grams: 80 }
      },
      'cebola_crua': {
        name:'Cebola, crua',
        nutrition:{ kcal:40, protein_g:1.1, carb_g:9.3, fat_g:0.1, fiber_g:1.7 },
        price_per_kg: 6.0, category:'verdura', ig: 15,
        portion: { name: 'fatia(s)', grams: 30 }
      },
      'abobrinha_refogada': {
        name:'Abobrinha, refogada',
        nutrition:{ kcal:20, protein_g:1.1, carb_g:4.0, fat_g:0.3, fiber_g:1.2 },
        price_per_kg: 7.0, category:'verdura', ig: 15,
        portion: { name: 'porção(ões)', grams: 80 }
      },
      'beterraba_cozida': {
        name:'Beterraba, cozida',
        nutrition:{ kcal:44, protein_g:1.7, carb_g:10, fat_g:0.2, fiber_g:2 },
        price_per_kg: 6.5, category:'verdura', ig: 64,
        portion: { name: 'porção(ões)', grams: 80 }
      },
      'couve_manteiga_refogada': {
        name:'Couve, Manteiga refogada',
        nutrition:{ kcal:38, protein_g:1.7, carb_g:7.9, fat_g:0.5, fiber_g:2.3 },
        price_per_kg: 9.0, category:'verdura', ig: 15,
        portion: { name: 'porção(ões)', grams: 80 }
      },
      'espinafre_cozido': {
        name:'Espinafre, cozido',
        nutrition:{ kcal:23, protein_g:3, carb_g:3.6, fat_g:0.3, fiber_g:2.2 },
        price_per_kg: 15.0, category:'verdura', ig: 15,
        portion: { name: 'porção(ões)', grams: 80 }
      },
      'pepino_cru': {
        name:'Pepino, comum cru',
        nutrition:{ kcal:15, protein_g:0.7, carb_g:3.6, fat_g:0.1, fiber_g:0.5 },
        price_per_kg: 6.0, category:'verdura', ig: 15,
        portion: { name: 'porção(ões)', grams: 80 }
      }
    }; // end v5_FoodDatabase

    // Add creatine and alias for whey
    v5_FoodDatabase['creatina_monohidratada'] = {
      name: 'Creatina monohidratada',
      nutrition: { kcal:0, protein_g:0, carb_g:0, fat_g:0, fiber_g:0 },
      price_per_kg: 300.0,
      category: 'suplemento',
      ig: 0,
      portion: { name: 'dose(s)', grams: 5 } // small scoop ~5g
    };
    if(v5_FoodDatabase['whey_protein_concentrado']){
      v5_FoodDatabase['whey_concentrado'] = { ...v5_FoodDatabase['whey_protein_concentrado'], name: 'Whey concentrado' };
    }

    /* ========== MASTER LOOKUP ========== */
    const masterDB = {};
    Object.keys(v5_FoodDatabase).forEach(k => {
      const s = v5_FoodDatabase[k];
      masterDB[k] = {
        id: k,
        name: s.name,
        nutrition: s.nutrition || {},
        price_per_kg: s.price_per_kg || 0,
        category: s.category || 'other',
        ig: (typeof s.ig !== 'undefined') ? s.ig : null,
        portion: s.portion || null
      };
    });

    function normalizeName(n){ return (n||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim(); }
    function stripParenthesis(name){ if(!name) return name; return name.replace(/\s*\(.*?\)\s*/g,'').trim(); }

    function buildLookup(db){
      const byName = {}, byId = {};
      Object.values(db).forEach(rec => {
        const norm = normalizeName(stripParenthesis(rec.name));
        byName[norm] = rec;
        byId[rec.id] = rec;
        byName[normalizeName(rec.id)] = rec;
      });
      return { byName, byId };
    }
    let _lookup = buildLookup(masterDB);

    function findFood(key){
      if(!key) return null;
      if(_lookup.byId[key]) return _lookup.byId[key];
      const norm = normalizeName(stripParenthesis(String(key)));
      if(_lookup.byName[norm]) return _lookup.byName[norm];
      for(const nm in _lookup.byName){
        if(nm.includes(norm) || norm.includes(nm)) return _lookup.byName[nm];
      }
      return null;
    }

    /* ========== UTILITIES ========== */
    function _safeNum(v, f=0){
      if(typeof v === 'number' && !Number.isNaN(v)) return v;
      if(v == null || v === '') return f;
      const n = parseFloat(String(v).replace(',','.'));
      return isNaN(n) ? f : n;
    }
    function _round(n,p=0){ const pow = 10**(p||0); return Math.round((n||0)*pow)/pow; }
    function nowISO(){ return (new Date()).toISOString(); }

    function _getGlycemicInfo(foodKey){
      if(!foodKey) return { ig:50, gl_100g:10 };
      const rec = findFood(foodKey);
      if(!rec) return { ig:50, gl_100g:10 };
      const ig = (typeof rec.ig !== 'undefined' && rec.ig !== null) ? rec.ig : 50;
      const carbs = _safeNum(rec.nutrition?.carb_g, 0);
      return { ig, gl_100g: Math.round((ig * carbs) / 100) };
    }

    /* BMR / activity */
    function calcBMR(profile){
      const peso = _safeNum(profile.peso,70);
      const altura_m = _safeNum(profile.altura,1.7);
      const idade = _safeNum(profile.idade,30);
      const sexo = (profile.sexo||'').toLowerCase();
      const hcm = Math.round(altura_m*100);
      if(sexo.startsWith('m')) return Math.round(88.362 + (13.397 * peso) + (4.799 * hcm) - (5.677 * idade));
      return Math.round(447.593 + (9.247 * peso) + (3.098 * hcm) - (4.330 * idade));
    }
    function activityFactor(profile){
      const nivel = (profile.nivel||'').toLowerCase();
      const dias = _safeNum(profile.disponibilidade,3);
      if(nivel.includes('inic') || dias<=2) return 1.3;
      if(nivel.includes('inter') || dias<=4) return 1.55;
      if(nivel.includes('avanc') || dias>=5) return 1.75;
      return 1.55;
    }

    /* Levenshtein & helpers */
    function levenshtein(a,b){
      if(!a||!b) return (a||'') === (b||'') ? 0 : Infinity;
      a = a.toString(); b = b.toString();
      const al=a.length, bl=b.length;
      const dp = Array.from({length:al+1},()=>new Array(bl+1).fill(0));
      for(let i=0;i<=al;i++) dp[i][0]=i;
      for(let j=0;j<=bl;j++) dp[0][j]=j;
      for(let i=1;i<=al;i++){
        for(let j=1;j<=bl;j++){
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[al][bl];
    }

    function detectGoalType(text){
      const s = (text||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

      const loseKeywords = ['emagrec','perder','secar','definicao','definir','perder gordura','emagrecer','magrecer'];
      const gainKeywords = ['ganhar','massa','hipertrof','musculo','crescer','engordar','ganho'];
      const words = s.split(/[\s,.;:!?()]+/).filter(Boolean);
      const checkList = (arr) => {
        for(const kw of arr){
          if(s.includes(kw)) return true;
          for(const w of words){
            if(w===kw) return true;
            if(levenshtein(w,kw) <= 1) return true;
          }
        }
        return false;
      };
      const foundLose = checkList(loseKeywords);
      const foundGain = checkList(gainKeywords);
      if(foundLose && !foundGain) return 'emagrecer';
      if(foundGain && !foundLose) return 'musculo';
      if(foundLose && foundGain) return 'ambos';
      return 'ambos';
    }

    function extractKgFromGoalText(text){
      const s = (text||'').toLowerCase().replace(',', '.');
      let match = s.match(/(-?\d+(?:[.,]\d+)?)\s*(kg|kilos|quilos|quilo|kilos?)/);
      if(match) return parseFloat(match[1].replace(',','.'));
      match = s.match(/(perder|ganhar)\s+(-?\d+(?:[.,]\d+)?)/);
      if(match) return parseFloat(match[2].replace(',','.')) * (match[1].startsWith('perder') ? -1 : 1);
      return null;
    }

    function computeAggressiveness(kgChange, months, goalType){
      if(kgChange === null || typeof kgChange === 'undefined') return 'moderado';
      const absKg = Math.abs(kgChange);
      const m = Math.max(1, months || 3);
      const kgPerMonth = absKg / m;
      if(goalType === 'musculo'){
        if(kgPerMonth <= 0.4) return 'baixo';
        if(kgPerMonth <= 0.8) return 'moderado';
        return 'agressivo';
      } else {
        if(kgPerMonth <= 0.5) return 'baixo';
        if(kgPerMonth <= 1.0) return 'moderado';
        return 'agressivo';
      }
    }

    /* deriveTargets */
    function deriveTargets(profile){
      const ABS_MAX_CALORIES = 4500, ABS_MIN_CALORIES = 1200;
      const peso = _safeNum(profile.peso,70);
      const bmr = calcBMR(profile);
      const af = activityFactor(profile);
      let tdee = Math.round(bmr * af);
      if(tdee > 6000) tdee = 3500;
      const goalText = (profile.grande_meta || profile.goal_prompt || '').toString().toLowerCase();
      const goalType = detectGoalType(goalText);
      const kgWanted = extractKgFromGoalText(goalText);
      let months = 3;
      try{
        if(profile.prazo){
          const ed = calculateEndDate(profile.prazo);
          if(ed){ months = Math.max(1, Math.round((ed.getTime() - Date.now())/(1000*60*60*24*30))); }
        }
      } catch(e){}
      if(profile.selected_months) months = Math.max(1, _safeNum(profile.selected_months, months));
      const aggressiveness = computeAggressiveness(kgWanted, months, goalType);
      let deficitPercent=0, surplusPercent=0;
      if(goalType === 'emagrecer'){
        if(aggressiveness === 'baixo') deficitPercent = 0.08;
        else if(aggressiveness === 'moderado') deficitPercent = 0.15;
        else deficitPercent = 0.22;
        deficitPercent = Math.min(deficitPercent, 0.28);
      } else if(goalType === 'musculo'){
        if(aggressiveness === 'baixo') surplusPercent = 0.08;
        else if(aggressiveness === 'moderado') surplusPercent = 0.13;
        else surplusPercent = 0.20;
      }
      let targetCalories = tdee;
      if(goalType === 'emagrecer'){
        const delta = Math.round(tdee * deficitPercent);
        targetCalories = Math.max(ABS_MIN_CALORIES, tdee - delta);
      } else if(goalType === 'musculo'){
        const delta = Math.round(tdee * surplusPercent);
        targetCalories = Math.min(ABS_MAX_CALORIES, tdee + delta);
      }

      let protPerKg = 1.4;
      if(goalType === 'musculo'){ protPerKg = (aggressiveness === 'agressivo' ? 2.0 : (aggressiveness === 'moderado' ? 1.8 : 1.6)); }
      else if(goalType === 'emagrecer') protPerKg = 1.8;
      const protein_g = Math.round(protPerKg * _safeNum(profile.peso,70));
      const fatPerc = 0.25;
      const fatCals = Math.round(targetCalories * fatPerc);
      const fat_g = Math.max(0, Math.round(fatCals / 9));
      const protCals = protein_g * 4;
      const carbsCals = Math.max(0, targetCalories - protCals - fatCals);
      const carbs_g = Math.max(0, Math.round(carbsCals / 4));
      return { bmr, tdee, targetCalories, protein_g, carbs_g, fat_g, protPerKg, aggressiveness, goalType, parsedGoalKg: kgWanted, monthsTarget: months };
    }

    /* Ranking helpers - deterministic (no Math.random) */
    function computeSatietyScore(rec){
      if(!rec?.nutrition) return 0.3;
      const prot = _safeNum(rec.nutrition.protein_g,0);
      const fiber = _safeNum(rec.nutrition.fiber_g,0);
      const kcal = _safeNum(rec.nutrition.kcal,150);
      const protScore = Math.min(1, prot / 30);
      const fiberScore = Math.min(1, fiber / 10);
      const densityScore = 1 - Math.min(1, kcal / 400);
      const score = (protScore*0.5) + (fiberScore*0.3) + (densityScore*0.2);
      return Math.max(0.1, Math.min(1, score));
    }
    function computeCostScore(rec){
      const cost = _safeNum(rec.price_per_kg, 20);
      return 1 - Math.min(1, (cost - 5) / 50);
    }

    function computeCBrank(rec, profile){
      if(!rec) return 0.5;
      const sat = computeSatietyScore(rec);
      const costS = computeCostScore(rec);
      const giInfo = (typeof rec.ig !== 'undefined' && rec.ig !== null) ? { ig: rec.ig } : _getGlycemicInfo(rec.name);
      const giScore = 1 - (_safeNum(giInfo.ig,50) / 100);
      const monthlyBudget = _safeNum(profile.orcamento_mes_R$ || profile.orcamento || profile.budget || 0, 0);

      let satW=0.4, giW=0.2, costW=0.4;
      if(monthlyBudget > 0 && monthlyBudget <= 400){ costW = 0.6; satW = 0.3; giW = 0.1; }
      else if(monthlyBudget > 400 && monthlyBudget <= 1000){ costW = 0.4; satW = 0.4; giW = 0.2; }
      else {
        const goal = profile.targets?.goalType || profile.goal_type || 'ambos';
        if(goal === 'emagrecer'){ satW = 0.5; giW = 0.3; costW = 0.2; }
        else if(goal === 'musculo'){ satW = 0.4; giW = 0.1; costW = 0.5; }
        else { satW = 0.45; giW = 0.15; costW = 0.4; }
      }

      const base = (sat * satW) + (giScore * giW) + (costS * costW);
      // deterministic: no randomness
      return Math.max(0, Math.min(1, base));
    }

    /* NEW: _rankFoodsByCategory with short and long term penalization */
    function _rankFoodsByCategory(categories, profile, shortTermAvoidList = [], longTermPenalizeList = []){
      const recs = [];
      for(const id in v5_FoodDatabase){
        const rec = v5_FoodDatabase[id];
        if(!rec) continue;
        if(categories.includes(rec.category)){
          const copy = { id, name: rec.name, nutrition: rec.nutrition || {}, price_per_kg: rec.price_per_kg || 0, ig: rec.ig };
          let rank = computeCBrank(copy, profile);

          // short-term penalize high (not today)
          if(Array.isArray(shortTermAvoidList) && shortTermAvoidList.includes(id)){
            rank = rank * 0.25;
          }

          // long-term penalize medium (less this month)
          if(Array.isArray(longTermPenalizeList) && longTermPenalizeList.includes(id)){
            if(!(Array.isArray(shortTermAvoidList) && shortTermAvoidList.includes(id))){
              rank = rank * 0.65;
            }
          }

          recs.push({ ...copy, rank });
        }
      }
      recs.sort((a,b) => (b.rank || 0) - (a.rank || 0) || a.name.localeCompare(b.name));
      return recs.map(r => r.id);
    }

    /* Utilities for weekly template, rotation */
    function weeklyBudgetFromMonthly(monthly){ return _safeNum(monthly,0) / 4.345; }

    function buildWeekTemplate(dailyTargetCalories, diasTreinoCount, cheatPolicy, selectedDaysArr = []){
      const week = Array.from({length:7}).map((_,i)=>({ dayOfWeekIndex:i, baseCalories: dailyTargetCalories, isTrainingDay:false, isCheatDay:false, cheatLimit:null }));
      const dayMap = { 'dom':0,'seg':1,'ter':2,'qua':3,'qui':4,'sex':5,'sab':6 };
      if(selectedDaysArr && selectedDaysArr.length>0){
        selectedDaysArr.forEach(k => { const idx = dayMap[k]; if(idx !== undefined) { week[idx].isTrainingDay = true; week[idx].baseCalories = Math.round(dailyTargetCalories * 1.08); }}); 
      } else {
        const dt = Math.max(0, _safeNum(diasTreinoCount,3));
        if(dt>0){
          const step = Math.floor(7 / dt) || 1;
          let cur = 1;
          for(let i=0;i<dt;i++){
            if(week[cur]) { week[cur].isTrainingDay = true; week[cur].baseCalories = Math.round(dailyTargetCalories * 1.08); }
            cur = (cur + step) % 7;
          }
        }
      }
      if(cheatPolicy?.freqPerWeek > 0){
        const candidate = week.find(d => !d.isTrainingDay) || week[6];
        candidate.isCheatDay = true; candidate.cheatLimit = cheatPolicy.cheatCaloriesLimit || Math.round(dailyTargetCalories * 1.5);
      }
      return week;
    }

    function compensateCheatWeek(weekArr){
      const baseTotal = weekArr.reduce((s,d)=>s + d.baseCalories,0);
      const cheatDay = weekArr.find(d=>d.isCheatDay);
      if(!cheatDay) return weekArr;
      const cheatActual = cheatDay.cheatLimit || cheatDay.baseCalories;
      const newTotal = baseTotal - cheatDay.baseCalories + cheatActual;
      const excess = newTotal - baseTotal;
      if(excess <= 0) return weekArr;
      const nonCheat = weekArr.filter(d=>!d.isCheatDay);
      if(nonCheat.length === 0) return weekArr;
      const perDayReduction = Math.ceil(excess / nonCheat.length);
      for(const d of nonCheat){ const minAllowed = Math.round(d.baseCalories * 0.6); d.baseCalories = Math.max(minAllowed, d.baseCalories - perDayReduction); d.adjustedForCheat = true; }
      return weekArr;
    }

    /* NEW v7.0: Calcula porções práticas, não gramas exatas */
    function computePortionAmountsForMeal(foodDBFindFn, mealMacroTargets, components){
      const protRec = findFood(components.protein);
      const carbRec = findFood(components.carb);
      const vegRec = findFood(components.veg);
      const out = { protein_grams:0, carb_grams:0, veg_grams:0, details:{} };

      // Pega o tamanho da porção do DB, ou usa um padrão de 100g
      const protPortGrams = _safeNum(protRec?.portion?.grams, 100);
      const carbPortGrams = _safeNum(carbRec?.portion?.grams, 100);

      // Pega os macros por 100g
      const protPer100 = _safeNum(protRec?.nutrition?.protein_g, 25);
      const carbPer100 = _safeNum(carbRec?.nutrition?.carb_g, 25);

      // Calcula quantos macros tem em UMA porção
      const protInOnePortion = protPer100 * (protPortGrams / 100);
      const carbInOnePortion = carbPer100 * (carbPortGrams / 100);

      // Calcula o NÚMERO DE PORÇÕES (arredondando em 0.5)
      let numProtPortions = (protInOnePortion > 0) ? (mealMacroTargets.prot_g / protInOnePortion) : 1;
      let numCarbPortions = (carbInOnePortion > 0) ? (mealMacroTargets.carbs_g / carbInOnePortion) : 1;

      // Arredonda para a 0.5 porção mais próxima (ex: 1.3 -> 1.5, 1.1 -> 1.0)
      numProtPortions = Math.max(0.5, Math.round(numProtPortions * 2) / 2);
      numCarbPortions = Math.max(0.5, Math.round(numCarbPortions * 2) / 2);

      // Calcula as gramas finais com base nas porções arredondadas
      out.protein_grams = Math.round(numProtPortions * protPortGrams);
      out.carb_grams = Math.round(numCarbPortions * carbPortGrams);
      out.veg_grams = vegRec ? 100 : 0; // Mantém vegetais/salada simples

      // Armazena os nomes das porções para a UI
      out.details = {
        prot_portions: numProtPortions,
        prot_portion_name: protRec?.portion?.name || 'gramas',
        carb_portions: numCarbPortions,
        carb_portion_name: carbRec?.portion?.name || 'gramas'
      };

      // ajuste simples de calorias (se fornecido)
      if(mealMacroTargets.calories){
        const kcalPerProt = _safeNum(protRec?.nutrition?.kcal, (protPer100 * 4));
        const kcalPerCarb = _safeNum(carbRec?.nutrition?.kcal, (carbPer100 * 4));
        const est = Math.round((out.protein_grams * (kcalPerProt/100)) + (out.carb_grams * (kcalPerCarb/100)) + (out.veg_grams * (_safeNum(vegRec?.nutrition?.kcal,20)/100)));
        out.details.kcal_est = est;
      }

      return out;
    }

    /* Utilities for weekly template continued... used by planLongTerm */

    function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }

    function calculateEndDate(prazoText){
      if(!prazoText) return null;
      const now = new Date();
      const text = prazoText.toString().toLowerCase().trim();
      const clean = text.replace(/[,]/g,'.').replace(/\s+/g,' ');
      let match;
      match = clean.match(/(\d+(?:[.,]\d+)?)\s*(anos|ano)/);
      if(match){ const value = parseFloat(match[1].replace(',', '.')); if(!isNaN(value)){ const monthsToAdd = Math.round(value*12); const d=new Date(); d.setMonth(d.getMonth() + monthsToAdd); return d; } }
      match = clean.match(/(\d+)\s*ano(?:s)?\s*e\s*meio/);
      if(match){ const d=new Date(); d.setMonth(d.getMonth() + (parseInt(match[1],10)*12) + 6); return d; }
      match = clean.match(/(\d+(?:[.,]\d+)?)\s*(meses|m[eê]s|mes)/);
      if(match){ const value = parseFloat(match[1].replace(',', '.')); if(!isNaN(value)){ const d=new Date(); d.setMonth(d.getMonth() + Math.round(value)); return d; } }
      match = clean.match(/(\d+(?:[.,]\d+)?)\s*(year|years)/);
      if(match){ const value = parseFloat(match[1].replace(',', '.')); const d=new Date(); d.setMonth(d.getMonth() + Math.round(value * 12)); return d; }
      match = clean.match(/^(\d{1,3})$/);
      if(match){ const n = parseInt(match[1],10); if(n <= 36){ const d=new Date(); d.setMonth(d.getMonth() + n); return d; } }
      if(clean.includes('meio ano') || clean.includes('1/2 ano')) { const d=new Date(); d.setMonth(d.getMonth()+6); return d; }
      const year = now.getFullYear();
      if(clean.includes('final do ano') || clean.includes('fim de ano')) return new Date(year,11,31);
      if(clean.includes('verao')||clean.includes('verão')){ const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); }
      if(clean.includes('natal')){ const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); }
      if(clean.includes('ano novo')) return new Date(year+1,0,1);
      if(clean.includes('pascoa')||clean.includes('páscoa')){ const e=getEaster(year); return now<e?e:getEaster(year+1); }
      return null;
    }

    function normalizeForSearch(s){ if(!s) return ''; return s.toString().toLowerCase().replace(/[_\-]+/g,' ').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    function userHasSupplement(profile, keyword){
      if(!profile) return false;
      if((profile.uso_suplemento||'').toString().toLowerCase() !== 'sim') return false;
      const q = normalizeForSearch(profile.quais_suplementos || '');
      if(!q) return false;
      return q.includes(keyword);
    }

    /* ========== planLongTerm (v7.0) with blueprints & portion logic ========== */
    async function planLongTerm(profile, options = {}){
      const start = options.startDate ? new Date(options.startDate) : new Date();
      const months = Math.max(1, _safeNum(options.months, 3));
      const targets = deriveTargets(profile);
      const profileWithTargets = {...profile, targets};
      const dailyTargetCalories = targets.targetCalories;
      const weeklyBudget = options.weeklyBudgetOverride || weeklyBudgetFromMonthly(profile.orcamento_mes_R$ || profile.orcamento || 0);
      const diasTreinoCount = _safeNum(profile.disponibilidade, 3);
      const selectedDaysArr = profile.selected_days || [];
      const cheatPolicy = options.cheatPolicy || { type:'day', freqPerWeek:1, cheatCaloriesLimit: Math.round(dailyTargetCalories * 1.5) };
      const totalWeeks = Math.max(1, Math.round(months * 4.345));
      const timeline_weeks = [];

      // BLUEPRINTS (v7.0)
      const BLUEPRINTS = {
        'café': [
          { name: 'Padrão', slots: ['snack_carb', 'snack_prot', 'fruta'] },
          { name: 'Shake', slots: ['suplemento', 'fruta', 'gordura_boa'] },
          { name: 'Reforçado', slots: ['proteina_main', 'tuberculo', null] }
        ],
        'almoço': [
          { name: 'Padrão BR', slots: ['proteina_main', 'cereal_main', 'leguminosa'] },
          { name: 'Fit', slots: ['peixe', 'tuberculo', 'verdura'] }
        ],
        'lanche': [
          { name: 'Padrão', slots: ['fruta', 'gordura_boa', null] },
          { name: 'Proteico', slots: ['laticinio_snack', 'cereal_snack', null] },
          { name: 'Rápido', slots: ['suplemento', null, null] }
        ],
        'jantar': [
          { name: 'Padrão', slots: ['proteina_main', 'tuberculo', 'verdura'] },
          { name: 'Low-Carb', slots: ['peixe', 'verdura', 'gordura_boa'] },
          { name: 'Repetir Almoço', slots: ['proteina_main', 'cereal_main', 'leguminosa'] }
        ],
        'ceia': [
          { name: 'Proteica', slots: ['laticinio_snack', null, null] },
          { name: 'Gordura', slots: ['gordura_boa', null, null] }
        ]
      };
      const SLOT_MAP = {
        'snack_carb': ['cereal_snack', 'pao_snack'],
        'snack_prot': ['proteina_snack', 'laticinio_snack'],
        'fruta': ['fruta'],
        'suplemento': ['suplemento'],
        'gordura_boa': ['gordura_boa'],
        'proteina_main': ['proteina_main'],
        'tuberculo': ['tuberculo'],
        'cereal_main': ['cereal_main'],
        'leguminosa': ['leguminosa'],
        'verdura': ['verdura'],
        'peixe': ['peixe'],
        'laticinio_snack': ['laticinio_snack'],
        'cereal_snack': ['cereal_snack'],
        'pao_snack': ['pao_snack']
      };

      // Build master rotations once (fullRotation lists)
      const cats = ['proteina_main','peixe','cereal_main','tuberculo','leguminosa','proteina_snack','laticinio_snack','cereal_snack','pao_snack','fruta','verdura','gordura_boa'];
      const fullRotation = {};
      cats.forEach(cat => { fullRotation[cat] = _rankFoodsByCategory([cat], profileWithTargets, [], []).slice(0, 40); });

      const fallbackProtein = 'frango_peito';
      const fallbackCarb = 'arroz_branco_cozido';
      const fallbackLegume = 'feijao_carioca_cozido';
      const fallbackSnackProt = 'ovo_cozido';
      const fallbackSnackCarb = ('tapioca_goma' in v5_FoodDatabase) ? 'tapioca_goma' : Object.keys(v5_FoodDatabase)[0];
      const fallbackVeg = 'alface_crespa_crua';
      const fallbackFruit = 'banana_nanica_crua';

      const MEMORY_CAP = 12; // short-term memory capacity

      // helper deterministic get (0/1 parity style)
      const get = (list, idx) => {
        if (!list || list.length === 0) return null;
        const pickIndex = (idx % list.length);
        return list[pickIndex] || list[0];
      };

      for(let w=0; w<totalWeeks; w++){
        const monthIndex = Math.floor(w / 4.345); // used to compute long-term penalizations

        // short-term memory lists (reiniciam por semana)
        let recentProteinPicks = [];
        let recentCarbPicks = [];

        let weekTemplate = buildWeekTemplate(dailyTargetCalories, diasTreinoCount, cheatPolicy, selectedDaysArr);
        weekTemplate = compensateCheatWeek(weekTemplate);
        const daysData = [];

        // prepare long-term penalize lists based on monthIndex
        const longTermPenalize = {};
        cats.forEach(cat => {
          const arr = fullRotation[cat] || [];
          longTermPenalize[cat] = arr.slice(0, Math.max(0, monthIndex));
        });

        for(let d=0; d<7; d++){
          const daySpec = weekTemplate[d];
          const isTraining = daySpec.isTrainingDay;
          const isCheat = daySpec.isCheatDay;
          const mealsCount = Math.min(6, Math.max(3, 3 + Math.floor(diasTreinoCount / 2)));
          const mealNames = ["Café da manhã","Lanche manhã","Almoço","Lanche tarde","Jantar","Ceia"].slice(0, mealsCount);

          // meal weights & nutrient timing
          let mealWeights = mealNames.map(m => /almoço|jantar/i.test(m) ? 1.8 : (/café/i.test(m) ? 1.2 : 0.6));
          if(isTraining){
            mealWeights = mealWeights.map((wgt,idx) => {
              const name = mealNames[idx].toLowerCase();
              if(/lanche tarde/.test(name) || /jantar/.test(name)) return wgt * 1.6; // more carbs around training
              return wgt;
            });
          } else {
            mealWeights = mealWeights.map((wgt,idx) => {
              const name = mealNames[idx].toLowerCase();
              if(/lanche tarde/.test(name) || /jantar/.test(name)) return wgt * 0.8; // less carbs rest days
              return wgt;
            });
          }
          const totalW = mealWeights.reduce((a,b)=>a+b,0);
          const meals = [];

          // daily pick lists to add to recent memory at end of day
          const dayProteinPicks = [];
          const dayCarbPicks = [];

          // prepare candidate pools for day (we'll re-use below)
          const mainProteinsCandidates = _rankFoodsByCategory(['proteina_main'], profileWithTargets, recentProteinPicks, longTermPenalize['proteina_main']);
          const fishProteinsCandidates = _rankFoodsByCategory(['peixe'], profileWithTargets, recentProteinPicks, longTermPenalize['peixe']);
          const mainCarbsCandidates = _rankFoodsByCategory(['cereal_main','tuberculo'], profileWithTargets, recentCarbPicks, (longTermPenalize['cereal_main'] || []).concat(longTermPenalize['tuberculo'] || []));
          const mainLegumesCandidates = _rankFoodsByCategory(['leguminosa'], profileWithTargets, recentProteinPicks, longTermPenalize['leguminosa']);
          const snackProteinsCandidates = _rankFoodsByCategory(['proteina_snack'], profileWithTargets, recentProteinPicks, longTermPenalize['proteina_snack']).concat(_rankFoodsByCategory(['laticinio_snack'], profileWithTargets, recentProteinPicks, longTermPenalize['laticinio_snack']));
          const snackCarbsCandidates = _rankFoodsByCategory(['cereal_snack'], profileWithTargets, recentCarbPicks, longTermPenalize['cereal_snack']).concat(_rankFoodsByCategory(['pao_snack'], profileWithTargets, recentCarbPicks, longTermPenalize['pao_snack']));
          const commonVegCandidates = _rankFoodsByCategory(['verdura'], profileWithTargets, [], longTermPenalize['verdura']);
          const commonFruitCandidates = _rankFoodsByCategory(['fruta'], profileWithTargets, [], longTermPenalize['fruta']);
          const gordurasBoasCandidates = _rankFoodsByCategory(['gordura_boa'], profileWithTargets, [], longTermPenalize['gordura_boa']);

          for(let m=0; m<mealsCount; m++){
            const mealName = mealNames[m];
            const weight = mealWeights[m];
            const mealCalories = Math.round((weight/totalW) * daySpec.baseCalories);

            const baseProtForMeal = Math.round((targets.protein_g / totalW) * weight);
            const baseCarbsForMeal = Math.round((targets.carbs_g / totalW) * weight);
            const baseFatForMeal = Math.round((targets.fat_g / totalW) * weight);

            let carbMultiplier=1.0, protMultiplier=1.0, fatMultiplier=1.0;
            const lname = mealName.toLowerCase();
            if(isTraining){
              if(/lanche tarde/.test(lname) || /jantar/.test(lname)){ carbMultiplier = 1.4; protMultiplier = 1.05; }
            } else {
              if(/lanche tarde/.test(lname) || /jantar/.test(lname)){ carbMultiplier = 0.75; protMultiplier = 1.08; fatMultiplier = 1.05; }
            }

            const protForMeal = Math.round(baseProtForMeal * protMultiplier);
            const carbsForMeal = Math.max(0, Math.round(baseCarbsForMeal * carbMultiplier));
            const fatForMeal = Math.round(baseFatForMeal * fatMultiplier);

            // BLUEPRINT selection for this meal
            let blueprintPool = [];
            if (lname.includes('café')) blueprintPool = BLUEPRINTS['café'];
            else if (lname.includes('almoço')) blueprintPool = BLUEPRINTS['almoço'];
            else if (lname.includes('jantar')) {
              blueprintPool = isTraining ? [BLUEPRINTS.jantar[0], BLUEPRINTS.jantar[2]] : [BLUEPRINTS.jantar[1], BLUEPRINTS.jantar[0]];
            }
            else if (lname.includes('lanche')) blueprintPool = BLUEPRINTS['lanche'];
            else if (lname.includes('ceia')) blueprintPool = BLUEPRINTS['ceia'];
            else blueprintPool = BLUEPRINTS['lanche'];

            const blueprintIdx = (d + w) % blueprintPool.length;
            const selectedBlueprint = blueprintPool[blueprintIdx];
            const slots = selectedBlueprint.slots || [null,null,null];

            // map slots to candidate categories and lists
            const protSlot = slots[0];
            const carbSlot = slots[1];
            const vegSlot = slots[2];

            const protCandidates = protSlot ? _rankFoodsByCategory(SLOT_MAP[protSlot] || [], profileWithTargets, recentProteinPicks, [].concat(...(SLOT_MAP[protSlot] || []).map(cat => longTermPenalize[cat] || []))) : [];
            const carbCandidates = carbSlot ? _rankFoodsByCategory(SLOT_MAP[carbSlot] || [], profileWithTargets, recentCarbPicks, [].concat(...(SLOT_MAP[carbSlot] || []).map(cat => longTermPenalize[cat] || []))) : [];
            const vegCandidates = vegSlot ? _rankFoodsByCategory(SLOT_MAP[vegSlot] || [], profileWithTargets, [], []) : [];

            const pickIdx = (w*100)+(d*10)+m;

            const protPick = protCandidates.length > 0 ? get(protCandidates, pickIdx) : (lname.includes('jantar') ? get(fishProteinsCandidates, pickIdx) : get(mainProteinsCandidates, pickIdx)) || fallbackProtein;
            const carbPick = carbCandidates.length > 0 ? get(carbCandidates, pickIdx+1) : (lname.includes('café') ? get(snackCarbsCandidates, pickIdx+1) : get(mainCarbsCandidates, pickIdx+1)) || (lname.includes('café') ? 'pao_integral_forma' : fallbackCarb);
            const vegPick = vegCandidates.length > 0 ? get(vegCandidates, pickIdx+2) : (lname.includes('lanche') ? get(commonFruitCandidates, pickIdx+2) : get(commonVegCandidates, pickIdx+2)) || fallbackVeg;

            let componentsToCalc = { protein: protPick || null, carb: carbPick || null, veg: vegPick || null };
            const extraComponents = [];

            // Suplementos override
            const wantsWhey = userHasSupplement(profile, 'whey') || userHasSupplement(profile, 'whey protein') || userHasSupplement(profile, 'whey concentrado') || userHasSupplement(profile, 'wheyprotein');
            const wantsCreatine = userHasSupplement(profile, 'creat') || userHasSupplement(profile, 'creatina') || userHasSupplement(profile, 'creatine');

            if(isTraining && wantsWhey && (/jantar|ceia/.test(lname))){
              componentsToCalc.protein = (v5_FoodDatabase['whey_concentrado'] ? 'whey_concentrado' : 'whey_protein_concentrado');
              if(!componentsToCalc.carb) componentsToCalc.carb = fallbackFruit;
            }

            // Specific adaptions for certain meal types
            if (lname.includes('café')) {
              // sometimes prefer eggs as protein snack
              if(!componentsToCalc.protein) componentsToCalc.protein = get(snackProteinsCandidates, pickIdx) || fallbackSnackProt;
              if(!componentsToCalc.carb) componentsToCalc.carb = get(snackCarbsCandidates, pickIdx) || fallbackSnackCarb;
            }
            if (lname.includes('almoço')) {
              extraComponents.push({ food: get(commonVegCandidates, pickIdx+3) || fallbackVeg, grams: 75, role: 'verdura' });
            }
            if (lname.includes('jantar') && !isTraining) {
              // low-carb behaviour already handled by blueprint selection, ensure carb null
              if(selectedBlueprint.name === 'Low-Carb') componentsToCalc.carb = null;
            }

            // Calcular Porções (v7.0)
            const grams = computePortionAmountsForMeal(findFood, { prot_g: protForMeal, carbs_g: carbsForMeal, fat_g: fatForMeal, calories: mealCalories }, componentsToCalc);

            // Build components for UI (use friendly portion info where available)
            const toDisplay = (idOrName) => {
              if(!idOrName) return null;
              const rec = findFood(idOrName);
              const raw = rec?.name || idOrName;
              return stripParenthesis(raw);
            };

            const components = [];
            if(componentsToCalc.protein && grams.protein_grams >= 10) components.push({ food: toDisplay(componentsToCalc.protein), grams: grams.protein_grams, role:'proteina', source_id: componentsToCalc.protein });
            if(componentsToCalc.carb && grams.carb_grams >= 10) components.push({ food: toDisplay(componentsToCalc.carb), grams: grams.carb_grams, role:'carbo', source_id: componentsToCalc.carb });
            if(componentsToCalc.veg && grams.veg_grams >= 10) components.push({ food: toDisplay(componentsToCalc.veg), grams: grams.veg_grams, role:'legume', source_id: componentsToCalc.veg });

            for(const ex of extraComponents){
              const rec = findFood(ex.food) || { name: ex.food };
              components.push({ food: stripParenthesis(rec.name || ex.food), grams: ex.grams || 50, role: ex.role || 'extra', source_id: ex.food });
            }

            // supplements like creatine (add small fixed grams)
            if(isTraining && wantsCreatine && (/jantar|ceia/.test(lname))){
              components.push({ food: stripParenthesis(v5_FoodDatabase['creatina_monohidratada'].name || 'Creatina'), grams: 3, role:'suplemento', source_id:'creatina_monohidratada' });
            }

            let groupKcal = 0;
            const finalComponents = components.map(cItem => {
              const rec = findFood(cItem.source_id || cItem.food);
              const kcal = rec?.nutrition ? _round((rec.nutrition.kcal || 0) * cItem.grams / 100, 0) : 0;
              groupKcal += kcal;
              return { ...cItem, kcal };
            });

            finalComponents.forEach(fc=>{
              if(fc.source_id){
                const rid = fc.source_id;
                if(v5_FoodDatabase[rid]){
                  if((fc.role || '').includes('proteina')) dayProteinPicks.push(rid);
                  if((fc.role || '').includes('carbo') || (fc.role || '').includes('legume')) dayCarbPicks.push(rid);
                } else {
                  const rec = findFood(fc.food);
                  if(rec && rec.id){
                    if((fc.role || '').includes('proteina')) dayProteinPicks.push(rec.id);
                    if((fc.role || '').includes('carbo') || (fc.role || '').includes('legume')) dayCarbPicks.push(rec.id);
                  }
                }
              }
            });

            meals.push({
              mealIndex: m, mealName, mealCaloriesTarget: mealCalories,
              components: finalComponents, isTrainingDay: isTraining, isCheatDay: isCheat,
              gramsComputed: grams, mealKcalTotal: groupKcal
            });
          } // end meals loop

          // end of day: append day picks to recent lists and cap memory
          recentProteinPicks = [...recentProteinPicks, ...dayProteinPicks];
          recentCarbPicks = [...recentCarbPicks, ...dayCarbPicks];
          if (recentProteinPicks.length > MEMORY_CAP) recentProteinPicks = recentProteinPicks.slice(recentProteinPicks.length - MEMORY_CAP);
          if (recentCarbPicks.length > MEMORY_CAP) recentCarbPicks = recentCarbPicks.slice(recentCarbPicks.length - MEMORY_CAP);

          daysData.push({
            dayIndex: d+1, dayOfWeekIndex: daySpec.dayOfWeekIndex, baseCalories: daySpec.baseCalories, isTrainingDay: isTraining, isCheatDay: isCheat, meals
          });
        } // end days loop

        const estimatedWeeklyCost = 0;
        timeline_weeks.push({
          weekIndex: w+1,
          weekStartISO: new Date(start.getTime() + (w*7*24*3600*1000)).toISOString().slice(0,10),
          days: daysData,
          estimatedWeeklyCost
        });
      } // end weeks loop

      const avgWeeklyCost = _round(timeline_weeks.reduce((s,w)=>s + (w.estimatedWeeklyCost || 0),0) / timeline_weeks.length, 2);
      const budgetAdherence = 0.9;
      const meta = { adherenceToCaloriesPct: 0.95, adherenceToBudgetPct: budgetAdherence, practicalityPct: 0.92, varietyScore: 0.9, feasibilityPct:0.9 };
      const credibilityScore = 90;

      const payload = {
        version: 'super-algo-v7.0-portion-blueprints',
        created_at: nowISO(),
        profile_snapshot: profile,
        targets,
        timeline_weeks,
        estimates: { avgWeeklyCost, weeklyBudget, dailyTargetCalories, tdee: targets.tdee, bmr: targets.bmr },
        credibility: { score: credibilityScore, breakdown: meta },
        provenance: { food_db_version: 'v5_FoodDatabase_user_portions', built_with: 'super-diet-engine-v7.0' }
      };
      if(options.debug) payload._internal = { fullRotation, weekTemplateUsed: timeline_weeks[0]?.days.map(d=>({ dow:d.dayOfWeekIndex, train:d.isTrainingDay, cheat:d.isCheatDay })) };
      return payload;
    }

    /* Persistence helpers inside engine (uses _supabase) */
    let _supabase = null;
    function initModule({ supabase: sup } = {}){ if(!sup) throw new Error('supabase client required'); _supabase = sup; }

    async function savePlan(userId, planPayload, options = {}){ 
      if(!_supabase) throw new Error('Supabase client not initialized.');
      const title = options.title || `Plano - ${planPayload.targets ? planPayload.targets.targetCalories + ' kCal' : nowISO()}`;
      const row = { user_id: userId, title, payload: planPayload };
      const { data, error } = await _supabase.from('user_diets').insert([row]);
      if(error) { console.error('Erro ao salvar plano:', error); throw error; }
      return data;
    }

    async function loadPlans(userId){
      if(!_supabase) throw new Error('Supabase client not initialized.');
      const { data, error } = await _supabase.from('user_diets').select('*').eq('user_id', userId).order('created_at', { ascending:false });
      if(error) { console.error('Erro ao carregar planos:', error); throw error; }
      return data;
    }

    async function loadLatestPlan(userId){
      const plans = await loadPlans(userId);
      return plans && plans.length ? plans[0] : null;
    }

    /* ========== PUBLIC API ========== */
    return {
      init: ({ supabase } = {}) => { if(!supabase) initModule({ supabase }); else if(supabase) initModule({ supabase }); },
      generatePlan: planLongTerm,
      savePlan, loadPlans, loadLatestPlan, findFood,
      // Expose calculateEndDate to be used from UI
      calculateEndDate,
      // Expose detectGoalType so UI can call it
      detectGoalType
    };

  })(); // end SuperDietEngine IIFE

  /* ========== UI functions (remain outside engine) ========== */

  function displayProgress(startDate, endDate){
    const now = new Date(); now.setHours(0,0,0,0);
    const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
    const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
    const totalDuration = eDate.getTime() - sDate.getTime();
    const elapsedDuration = now.getTime() - sDate.getTime();
    const daysRemaining = Math.ceil((eDate - now) / (1000*60*60*24));
    let progressPercentage = (elapsedDuration / totalDuration) * 100;
    if(progressPercentage < 0) progressPercentage = 0;
    if(progressPercentage > 100) progressPercentage = 100;
    document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
    document.getElementById('start-date-label').textContent = sDate.toLocaleDateString('pt-BR');
    document.getElementById('end-date-label').textContent = eDate.toLocaleDateString('pt-BR');
    document.getElementById('countdown-days').textContent = daysRemaining >= 0 ? daysRemaining : 0;
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('percurso').classList.add('active');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector('.link-percurso')?.classList.add('active');
  }

  function renderPlanToContainer(container, planPayload){
    container.innerHTML = '';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    const title = document.createElement('h4'); title.textContent = 'Plano de Dieta — visão geral';
    const meta = document.createElement('div'); meta.style.color = '#bbb';
    const targetCals = planPayload.targets.targetCalories || planPayload.estimates.dailyTargetCalories || '...';
    const tdee = planPayload.targets.tdee || planPayload.estimates.tdee || '...';
    meta.innerHTML = `Alvo: <b>${targetCals} kcal</b> <div style="font-size:12px;color:#bbb">TDEE: ${tdee} kcal</div>`;
    header.appendChild(title); header.appendChild(meta); container.appendChild(header);

    const months = {};
    planPayload.timeline_weeks.forEach(week => {
      const date = new Date(week.weekStartISO + 'T00:00:00Z');
      const monthKey = `${date.getUTCFullYear()}-${('0'+(date.getUTCMonth()+1)).slice(-2)}`;
      months[monthKey] = months[monthKey] || { monthIndex: date.getUTCMonth(), label: date.toLocaleString('pt-BR',{ timeZone: 'UTC', month:'long', year:'numeric' }), weeks: [] };
      months[monthKey].weeks.push(week);
    });

    const monthKeys = Object.keys(months).sort();
    const tabsBar = document.createElement('div'); tabsBar.className = 'plan-tabs'; container.appendChild(tabsBar);
    const contentArea = document.createElement('div'); container.appendChild(contentArea);

    monthKeys.forEach((mk, idx) => {
      const pill = document.createElement('div'); pill.className = 'plan-tab' + (idx===0 ? ' active' : ''); pill.textContent = months[mk].label;
      pill.onclick = () => { document.querySelectorAll('.plan-tab.active').forEach(p=>p.classList.remove('active')); pill.classList.add('active'); renderMonth(months[mk], contentArea); };
      tabsBar.appendChild(pill);
    });
    if(monthKeys.length) renderMonth(months[monthKeys[0]], contentArea);
  }

  function renderMonth(monthObj, contentArea){
    contentArea.innerHTML = '';
    const wrapper = document.createElement('div'); wrapper.style.marginTop = '12px';
    const days = [];
    monthObj.weeks.forEach(w => { w.days.forEach(d => { const copy = { ...d }; copy.weekIndex = w.weekIndex; days.push(copy); }); });

    const daysWrap = document.createElement('div'); daysWrap.className = 'plan-days';
    const dayNameMap = { 0:'Dom',1:'Seg',2:'Ter',3:'Qua',4:'Qui',5:'Sex',6:'Sab' };

    days.forEach(d => {
      const dayOfWeekIndex = d.dayOfWeekIndex;
      const dayName = dayNameMap[dayOfWeekIndex] !== undefined ? dayNameMap[dayOfWeekIndex] : 'Dia';
      const dayCard = document.createElement('div'); dayCard.className = 'plan-day';
      const dayTitle = document.createElement('div'); dayTitle.style.display='flex'; dayTitle.style.justifyContent='space-between'; dayTitle.style.alignItems='center';
      const left = document.createElement('div');
      const statusText = d.isTrainingDay ? 'DIA DE TREINO' : 'Dia de Descanso';
      const cheatText = d.isCheatDay ? ' • Cheat' : '';
      left.innerHTML = `<strong>${dayName}</strong><div style="color:${d.isTrainingDay ? 'var(--journey-red-1)' : '#bbb'};font-size:12px;font-weight:700;">${statusText} ${cheatText}</div>`;
      const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML = `<div style="font-weight:700">${d.baseCalories} kcal</div>`;
      dayTitle.appendChild(left); dayTitle.appendChild(right); dayCard.appendChild(dayTitle);

      d.meals.forEach(m => {
        const mealRow = document.createElement('div'); mealRow.className = 'meal-row';
        const mealLeft = document.createElement('div'); mealLeft.className = 'meal-left';
        const name = document.createElement('div'); name.className = 'meal-name'; name.textContent = m.mealName;
        const listPreview = document.createElement('div'); listPreview.style.color = '#bbb'; listPreview.style.fontSize = '13px';

        // NEW: display friendly portions if available (v7.0)
        const details = m.gramsComputed?.details || {};
        const items = m.components.map(c => {
          if (c.role === 'proteina' && details.prot_portion_name && typeof details.prot_portions !== 'undefined') {
            // show prot_portions
            return `${c.food} (${details.prot_portions} ${details.prot_portion_name})`;
          }
          if (c.role === 'carbo' && details.carb_portion_name && typeof details.carb_portions !== 'undefined') {
            return `${c.food} (${details.carb_portions} ${details.carb_portion_name})`;
          }
          // fallback for supplements / veg / fats: use grams
          return `${c.food} (${c.grams}g)`;
        }).join(' • ');

        listPreview.textContent = items;
        mealLeft.appendChild(name); mealLeft.appendChild(listPreview);

        const mealRight = document.createElement('div'); mealRight.style.display = 'flex'; mealRight.style.flexDirection = 'column'; mealRight.style.alignItems = 'flex-end';
        const kcal = document.createElement('div'); kcal.className = 'meal-kcal'; kcal.textContent = `${m.mealKcalTotal || '—'} kcal`;
        const editBtn = document.createElement('button'); editBtn.textContent = 'Editar'; editBtn.style.marginTop = '8px'; editBtn.onclick = () => openMealEditModal(m);
        mealRight.appendChild(kcal); mealRight.appendChild(editBtn);

        mealRow.appendChild(mealLeft); mealRow.appendChild(mealRight);
        dayCard.appendChild(mealRow);
      });

      daysWrap.appendChild(dayCard);
    });

    wrapper.appendChild(daysWrap);
    contentArea.appendChild(wrapper);
  }

  function openMealEditModal(meal){
    meal.components.forEach((c,i) => {
      const newG = prompt(`Editar ${c.food} (g) — atual: ${c.grams}`, c.grams);
      if(newG !== null){ const val = parseInt(newG,10); if(!isNaN(val)) meal.components[i].grams = Math.max(0, val); }
    });
    const dietaContent = document.getElementById('dieta-card-content');
    const latest = dietaContent?._lastPlan;
    if(dietaContent && latest) renderPlanToContainer(dietaContent, latest);
  }

  async function getCurrentUser(){ const { data } = await supabase.auth.getUser(); return data?.user; }
  async function fetchLatestUserDiet(){
    const user = await getCurrentUser();
    if(!user) return null;
    const { data, error } = await supabase.from('user_diets').select('*').eq('user_id', user.id).order('created_at', { ascending:false }).limit(1).single();
    if(error && error.code !== 'PGRST116') console.error('Erro fetchLatestUserDiet:', error.message);
    return data;
  }

  async function renderPercursoDietArea(){
    const dietaCard = document.getElementById('dieta-card');
    const targetContainer = document.createElement('div'); targetContainer.id = 'dieta-card-content';
    dietaCard.innerHTML = '<h4>Formulário: Dieta</h4>';
    dietaCard.appendChild(targetContainer);

    const latest = await fetchLatestUserDiet();
    if(latest && latest.payload){
      renderGeneratedPlanEditor(targetContainer, latest.payload, latest.id);
    } else {
      const p = document.createElement('p'); p.style.color='#bbb'; p.textContent = 'Gere sua meta para criar um plano.'; targetContainer.appendChild(p);
    }
  }

  function renderGeneratedPlanEditor(container, planPayload, existingId = null){
    container.innerHTML = '';
    const title = document.createElement('h4'); title.textContent = 'Formulário: Dieta — Plano gerado';
    const meta = document.createElement('p'); meta.style.color='#bbb';
    const targetCals = planPayload.targets.targetCalories || '...';
    const tdee = planPayload.targets.tdee || '...';
    meta.innerHTML = `Meta: ${planPayload.profile_snapshot.grande_meta || ''} | Alvo: <b>${targetCals} kcal</b> <span style="font-size:11px;color:#bbb">(TDEE: ${tdee} kcal)</span>`;
    container.appendChild(title); container.appendChild(meta);
    const planView = document.createElement('div'); planView.style.marginTop='12px'; planView.id='plan-view';
    container._lastPlan = planPayload;
    renderPlanToContainer(planView, planPayload);
    container.appendChild(planView);

    const btnWrap = document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='8px'; btnWrap.style.marginTop='12px';
    const saveBtn = document.createElement('button'); saveBtn.textContent = existingId ? 'Salvar alterações' : 'Salvar formulário'; saveBtn.className = 'playlist-btn';
    const saveNewBtn = document.createElement('button'); saveNewBtn.textContent = 'Salvar como novo'; saveNewBtn.style.background = '#444'; saveNewBtn.style.color = '#fff'; saveNewBtn.style.border = 'none'; saveNewBtn.style.padding = '10px 14px'; saveNewBtn.style.borderRadius='8px';
    const statusSpan = document.createElement('span'); statusSpan.style.color = '#bbb'; statusSpan.style.marginLeft = '8px';
    btnWrap.appendChild(saveBtn); btnWrap.appendChild(saveNewBtn); btnWrap.appendChild(statusSpan);
    container.appendChild(btnWrap);

    saveBtn.onclick = async () => {
      statusSpan.textContent = 'Salvando...';
      try{
        const user = await getCurrentUser();
        if(!user){ statusSpan.textContent = 'Usuário não autenticado.'; return; }
        planPayload.modified_at = new Date().toISOString();
        if(existingId){
          const { error } = await supabase.from('user_diets').update({ payload: planPayload }).eq('id', existingId);
          if(error){ console.error(error); statusSpan.textContent = 'Erro ao atualizar.'; return; }
          statusSpan.textContent = 'Salvo (atualizado).';
        } else {
          await SuperDietEngine.savePlan(user.id, planPayload, { title: `Plano - ${planPayload.targets.targetCalories} kcal` });
          statusSpan.textContent = 'Salvo com sucesso.';
          await renderPercursoDietArea();
        }
      } catch(err){ console.error(err); statusSpan.textContent = 'Erro: ' + err.message; }
    };

    saveNewBtn.onclick = async () => {
      statusSpan.textContent = 'Salvando cópia...';
      try{
        const user = await getCurrentUser();
        if(!user){ statusSpan.textContent = 'Usuário não autenticado.'; return; }
        await SuperDietEngine.savePlan(user.id, planPayload, { title: `Plano cópia - ${planPayload.targets.targetCalories} kcal` });
        statusSpan.textContent = 'Cópia salva.'; 
      } catch(err){ console.error(err); statusSpan.textContent = 'Erro: ' + err.message; }
    };
  }

  function loadFreshDifyChat(){
    const iframe = document.getElementById('dify-iframe');
    if(!iframe) return;
    const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
    const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;
    iframe.src = difyUrl;
  }

  /* UI initialization */
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize engine with supabase client
    try{
      SuperDietEngine.init({ supabase });
    }catch(e){
      // if not initialized it's ok for demo flows (some functions will throw)
      console.warn('SuperDietEngine init:', e?.message || e);
    }

    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const configBtn = document.getElementById('config-btn');
    const resetBtn = document.getElementById('reset-btn');
    const logoutBtn = document.getElementById('logout-btn');

    function openSidebar(){ sidebar.classList.add('open'); menuToggle.classList.add('open'); overlay.classList.add('show'); }
    function closeSidebar(){ sidebar.classList.remove('open'); menuToggle.classList.remove('open'); overlay.classList.remove('show'); }

    menuToggle.addEventListener('click', () => {
      if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
    });
    overlay.addEventListener('click', closeSidebar);

    // nav links
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tab = link.dataset.tab;
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        closeSidebar();
      });
    });

    // config button toggles reset/logout visibility
    configBtn.addEventListener('click', (e) => {
      e.preventDefault();
      logoutBtn.classList.toggle('hidden');
      resetBtn.classList.toggle('hidden');
    });

    resetBtn.addEventListener('click', () => {
      document.getElementById('ia-fit-form').reset();
      document.getElementById('prazo-group').style.display = 'none';
      document.getElementById('suplementos-detalhes-group').style.display = 'none';
      document.getElementById('objetivo').focus();
      // show the form again and hide the results/chat area
      document.getElementById('form-wrapper').style.display = 'block';
      document.getElementById('results-wrapper').style.display = 'none';
      // switch tab to IA planejamento (form)
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('ia-planejamento').classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector('.link-ia')?.classList.add('active');
      closeSidebar();
    });

    logoutBtn.addEventListener('click', async () => {
      try{
        await supabase.auth.signOut();
        window.location.reload();
      } catch(err){
        console.warn('logout falhou (demo):', err);
        alert('Logout falhou: ' + (err.message || err));
      }
    });

    // show/hide prazo and suplementos detail
    const objetivoInput = document.getElementById('objetivo');
    objetivoInput && objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none'; });

    const usoSupp = document.getElementById('uso_suplemento');
    usoSupp && usoSupp.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display = this.value === 'Sim' ? 'block' : 'none'; if(this.value !== 'Sim') document.getElementById('quais_suplementos').value = ''; });

    // playlist open
    document.getElementById('playlist-btn')?.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('video-aulas').classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    });

    (async function initializePageData(){
      const { data } = await supabase.auth.getUser();
      if(!data.user){
        document.getElementById('welcome-msg').textContent = 'Visitante (demo)';
        // show form by default for new/anonymous users
        document.getElementById('form-wrapper').style.display = 'block';
        document.getElementById('results-wrapper').style.display = 'none';
      } else {
        const user = data.user;
        document.getElementById('welcome-msg').textContent = user.email || user.id;
        try{
          const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
          if(!error && profile && profile.goal_end_date){
            displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
            document.getElementById('playlist-section').style.display = profile.goal_type ? 'block' : 'none';
            // show results/chat area by default for users with an active goal
            document.getElementById('form-wrapper').style.display = 'none';
            document.getElementById('results-wrapper').style.display = 'block';
          } else {
            document.getElementById('form-wrapper').style.display = 'block';
            document.getElementById('results-wrapper').style.display = 'none';
          }
        } catch(e){
          document.getElementById('form-wrapper').style.display = 'block';
          document.getElementById('results-wrapper').style.display = 'none';
        }
      }
      loadFreshDifyChat();
      await renderPercursoDietArea();
    })();

    // FIX: Prevent Enter in non-textarea fields from submitting the form accidentally
    const iaFitForm = document.getElementById('ia-fit-form');
    if(iaFitForm){
      iaFitForm.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){
          const active = document.activeElement;
          if(active && active.tagName !== 'TEXTAREA'){
            e.preventDefault();
            return false;
          }
        }
      });
    }

    // Form submit handler (kept mostly as-is) — will generate plan, save and render percurso
    if(iaFitForm){
      iaFitForm.addEventListener('submit', async function(event){
        event.preventDefault();
        const submitButton = iaFitForm.querySelector('button[type="submit"]');
        submitButton.disabled = true; submitButton.textContent = 'A gerar o seu plano...';
        try{
          const formElements = event.target.elements;
          const prazoText = formElements.prazo.value;
          // CHANGED: use SuperDietEngine.calculateEndDate (exposed)
          const endDate = (SuperDietEngine && typeof SuperDietEngine.calculateEndDate === 'function') ? SuperDietEngine.calculateEndDate(prazoText) : null;
          if(!endDate){ alert('Prazo inválido. Use "3 meses", "1 ano", "1.5 anos", etc.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }

          const startDate = new Date(); startDate.setHours(0,0,0,0);
          const objetivoText = formElements.objetivo.value;
          // CHANGED: call detectGoalType through SuperDietEngine (exposed)
          const goalType = (SuperDietEngine && typeof SuperDietEngine.detectGoalType === 'function') ? SuperDietEngine.detectGoalType(objetivoText) : 'ambos';

          const selectedDaysCheckboxes = document.querySelectorAll('input[name="dias_treino"]:checked');
          const selectedDaysArray = Array.from(selectedDaysCheckboxes).map(cb => cb.value);
          if(selectedDaysArray.length === 0){ alert('Selecione pelo menos um dia de treino.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }

          const updateData = {
            goal_start_date: startDate.toISOString(),
            goal_end_date: endDate.toISOString(),
            goal_prompt: objetivoText,
            goal_type: goalType
          };

          try{
            const current = await getCurrentUser();
            if(current){
              const { error } = await supabase.from('profiles').upsert({ id: current.id, ...updateData }, { onConflict: 'id' });
              if(error) console.warn('Erro ao atualizar perfil:', error);
            }
          }catch(e){ console.warn('Não conectado a supabase (demo).'); }

          displayProgress(startDate, endDate);
          document.getElementById('playlist-section').style.display = 'block';

          const inputs = {
            grande_meta: objetivoText,
            prazo: prazoText,
            sexo: formElements.sexo.value,
            altura: parseFloat((formElements.altura.value || '0').replace(',', '.')) || 1.7,
            peso: parseFloat((formElements.peso.value || '0').replace(',', '.')) || 70,
            idade: parseInt(formElements.idade.value,10) || 30,
            disponibilidade: selectedDaysArray.length,
            selected_days: selectedDaysArray,
            local_treino: formElements.local_treino.value,
            orcamento: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
            orcamento_mes_R$: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
            uso_suplemento: formElements.uso_suplemento.value,
            quais_suplementos: formElements.quais_suplementos.value || '',
            nivel: formElements.nivel.value
          };

          // generate plan via engine
          const diffTime = Math.abs(endDate - startDate);
          const diffDays = Math.ceil(diffTime / (1000*60*60*24));
          const months = Math.max(1, Math.round(diffDays / 30.44));
          const plan = await SuperDietEngine.generatePlan(inputs, { months, debug: false });

          // save plan using engine
          try{
            const currentUser = await getCurrentUser();
            if(currentUser){
              await SuperDietEngine.savePlan(currentUser.id, plan, { title: `Plano - ${plan.targets.targetCalories} kcal` });
            }
          } catch(saveError){
            console.error('Erro ao salvar plano:', saveError);
            alert('Meta atualizada, mas falha ao salvar plano: ' + (saveError.message || JSON.stringify(saveError)));
          }

          // switch to percurso and render
          document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
          document.getElementById('percurso').classList.add('active');
          document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
          document.querySelector('.link-percurso')?.classList.add('active');

          // render percurso area (will fetch latest saved plan)
          await renderPercursoDietArea();
          // also hide the initial form now that plan is generated
          document.getElementById('form-wrapper').style.display = 'none';
          document.getElementById('results-wrapper').style.display = 'block';
          submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho';
        } catch(err){
          console.error('Erro no fluxo de criação da meta:', err);
          alert('Erro interno: ' + (err.message || JSON.stringify(err)));
          submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho';
        }
      });
    }

  }); // DOMContentLoaded end
  </script>
</body>
</html>
