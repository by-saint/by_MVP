<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
      --accent-red-border: rgba(190,18,60,0.95);
    }

    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px;
    }
    h1, h2, h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }

    /* --- MENU E SIDEBAR --- */
    .menu-toggle {
        position: fixed;
        top: 25px;
        left: 25px;
        z-index: 1001;
        background: #333;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 5px;
        padding: 0;
    }
    .menu-toggle .bar {
        width: 24px;
        height: 3px;
        background-color: #fff;
        border-radius: 2px;
        transition: all 0.3s ease-in-out;
    }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100%;
        background-color: #1E1E1E;
        transition: left 0.3s ease-in-out;
        z-index: 1000;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .sidebar.open { left: 0; }
    .sidebar nav {
        padding-top: 100px;
    }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a {
        display: block;
        padding: 15px 30px;
        text-decoration: none;
        font-size: 1.1em;
        font-weight: 700;
        border-left: 5px solid transparent;
        transition: background-color 0.2s, border-left 0.2s;
    }
    .sidebar nav a:hover { background-color: #2c2c2c; }

    .link-ia, .link-aulas, .link-percurso {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    
    .sidebar .link-ia:hover, .sidebar .link-ia.active { border-left-color: var(--color-ia-specialist); }
    .sidebar .link-aulas:hover, .sidebar .link-aulas.active { border-left-color: var(--color-video-lessons); }
    .sidebar .link-percurso:hover, .sidebar .link-percurso.active { border-left-color: var(--color-journey); }

    .sidebar-footer {
        padding: 20px 30px;
        text-align: center;
    }
    .sidebar-config-btn {
        width: 100%;
        background: transparent;
        border: 1px solid #444;
        color: #aaa;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .sidebar-config-btn:hover {
        background-color: #333;
        color: #fff;
    }
    .sidebar-action-btn {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        margin-top: 10px;
    }
    .sidebar-reset-btn {
        background-color: transparent;
        border: 1px solid var(--color-ia-specialist);
        color: var(--color-ia-specialist);
    }
    .sidebar-reset-btn:hover {
        background-color: var(--color-ia-specialist);
        color: #fff;
    }
    .sidebar-logout-btn {
        background-color: #be123c;
        border: 1px solid #be123c;
        color: #fff;
    }
    .sidebar-logout-btn:hover {
        background-color: #ff4757;
        border-color: #ff4757;
    }
    .hidden {
        display: none;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .overlay.show { opacity: 1; visibility: visible; }

    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }

    /* Estilos do conteúdo principal */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }
    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .iframe-container { border-radius: 12px; overflow: hidden; height: auto; position: relative; }
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }

    /* Percurso layout specifics (new) */
    .percurso-months { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .month-tab { padding:8px 14px; border-radius:999px; background:rgba(255,255,255,0.03); cursor:pointer; font-weight:700; border:1px solid rgba(255,255,255,0.02); }
    .month-tab.active { border-color: var(--accent-red-border); box-shadow: 0 6px 18px rgba(190,18,60,0.12); }
    .month-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .month-card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18)); border-radius:12px; padding:16px; border: 1px solid rgba(255,255,255,0.02); }
    .day-card-percurso { background:#0f0f0f; border-radius:10px; padding:12px; border-left: 6px solid var(--accent-red-border); }
    .day-card-percurso h4 { margin:0 0 8px 0; color:#fff; font-size:16px; }
    .meal-row { display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
    .group-row { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.25)); border:1px solid rgba(190,18,60,0.06); }
    .group-left { display:flex; gap:10px; align-items:center; }
    .food-chip { min-width:38px; height:38px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; background: rgba(255,255,255,0.03); }
    .group-info { font-size:14px; color:#ddd; }
    .group-kcal { font-weight:800; color:#fff; font-size:14px; }
    .input-grams { width:84px; padding:6px; border-radius:8px; background:#1a1a1a; border:1px solid rgba(255,255,255,0.04); color:#fff; text-align:right; }
    .prep-select { padding:6px; border-radius:8px; background:#1a1a1a; border:1px solid rgba(255,255,255,0.04); color:#fff; }
    .credibility { margin-top:12px; padding:10px; border-radius:8px; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2)); border:1px solid rgba(255,255,255,0.02); color:#fff; display:flex; justify-content:space-between; align-items:center; }
    .cred-score { font-weight:800; color:var(--accent-red-border); font-size:20px; }

    @media (max-width:900px){
      .month-grid { grid-template-columns: 1fr; }
    }

  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Fale com a IA</h2>
      <div id="dify-container" class="iframe-container"></div>
      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>
      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Seu plano de dieta aparece abaixo. Edite porções em gramas se necessário; alterações salvam localmente no plano até que você clique em "Salvar Plano".</p>

    <div id="percurso-controls" style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <button id="btnSavePlan" class="playlist-btn" style="background: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2));">Salvar Plano</button>
      <button id="btnReloadPlan" class="playlist-btn" style="background:#333;">Recarregar Plano</button>
      <div id="credibility-display" style="margin-left:auto;"></div>
    </div>

    <div id="percurso-app">
      <!-- Month tabs + content injected here -->
      <div id="month-tabs" class="percurso-months"></div>
      <div id="month-content" class="month-grid"></div>
    </div>
  </div>
</div>

</div> 
<script type="module">
/* ===========================
   Módulo: SUPER DIET ENGINE
   (integrado inline para facilidade de instalação)
   =========================== */

const SuperDietEngine = (function(){
  // utilitárias (mesmas do design)
  function _round(n,d=2){ return Math.round((n+Number.EPSILON) * Math.pow(10,d))/Math.pow(10,d); }
  function _safeNum(v,f=0){ const n=Number(v); return isNaN(n)?f:n; }
  function normalizeName(s){ if(!s) return ''; return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,' ').trim(); }
  function nowISO(){ return new Date().toISOString(); }

  // master DB seed (subset + can be extended via loadExternal*)
  const seed = {
    "arroz tipo 1 cozido": { id:'arroz_cozido', name:'Arroz (tipo 1) cozido', nutrition:{ kcal:130, protein_g:2.7, carb_g:28.0, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'cereal', preps:['cozido'] },
    "feijao carioca cozido": { id:'feijao_carioca', name:'Feijão carioca cozido', nutrition:{ kcal:347, protein_g:21.1, carb_g:62.4, fat_g:1.4, fiber_g:16.6 }, price_per_kg:8.5, category:'leguminosa', preps:['cozido'] },
    "frango peito sem pele cozido": { id:'frango_peito', name:'Frango peito sem pele cozido', nutrition:{ kcal:165, protein_g:31.0, carb_g:0.0, fat_g:3.6 }, price_per_kg:18.0, category:'proteina_animal', preps:['grelhado','cozido','assado'] },
    "ovo inteiro cozido": { id:'ovo_cozido', name:'Ovo inteiro cozido', nutrition:{ kcal:155, protein_g:13.0, carb_g:1.1, fat_g:11.0 }, price_per_kg:15.0, category:'proteina_animal', preps:['cozido','frito'] },
    "arroz integral cozido": { id:'arroz_integral', name:'Arroz integral cozido', nutrition:{ kcal:111, protein_g:2.6, carb_g:23.5, fat_g:0.9, fiber_g:1.8 }, price_per_kg:6.0, category:'cereal', preps:['cozido'] },
    "banana nanica": { id:'banana_nanica', name:'Banana nanica', nutrition:{ kcal:89, protein_g:1.1, carb_g:22.8, fat_g:0.3, fiber_g:2.6 }, price_per_kg:4.0, category:'fruta', preps:['crua','assada'] },
    "alface americana": { id:'alface', name:'Alface americana', nutrition:{ kcal:15, protein_g:1.4, carb_g:2.9, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'verdura', preps:['crua'] },
    "brocolis cozido": { id:'brocolis', name:'Brócolis cozido', nutrition:{ kcal:55, protein_g:3.7, carb_g:11.1, fat_g:0.6, fiber_g:3.3 }, price_per_kg:7.0, category:'verdura', preps:['cozido','grelhado'] },
    "batata inglesa cozida": { id:'batata', name:'Batata inglesa cozida', nutrition:{ kcal:87, protein_g:1.9, carb_g:20.1, fat_g:0.1, fiber_g:1.8 }, price_per_kg:3.0, category:'tuberculo', preps:['cozido','assado','purê'] },
    "aveia flocos crua": { id:'aveia', name:'Aveia flocos', nutrition:{ kcal:389, protein_g:16.9, carb_g:66.3, fat_g:6.9, fiber_g:10.6 }, price_per_kg:9.5, category:'cereal', preps:['crua','cozida'] }
  };

  // build lookup
  function buildLookup(db){
    const byName={}, byId={};
    Object.values(db).forEach(r=>{
      byName[normalizeName(r.name)] = r;
      if(r.id) byId[r.id] = r;
    });
    return { byName, byId };
  }
  let lookup = buildLookup(seed);

  function findFood(key){
    if(!key) return null;
    if(typeof key === 'object' && key.name) return findFood(key.name);
    const k = key.toString();
    if(lookup.byId[k]) return lookup.byId[k];
    const norm = normalizeName(k);
    if(lookup.byName[norm]) return lookup.byName[norm];
    for(const nm in lookup.byName){
      if(nm.includes(norm) || norm.includes(nm)) return lookup.byName[nm];
    }
    return null;
  }

  // init supabase holder
  let _supabase = null;
  function init({ supabase }){
    if(!supabase) throw new Error('supabase required');
    _supabase = supabase;
  }

  /* --- core calculations (BMR, TDEE, targets) --- */
  function calcBMR(profile){
    const peso=_safeNum(profile.peso,70), altura_m=_safeNum(profile.altura, profile.altura_m||1.7), idade=_safeNum(profile.idade,30), sexo=(profile.sexo||'').toLowerCase();
    const h = Math.round(altura_m*100);
    if(sexo.startsWith('m')) return Math.round(10*peso + 6.25*h - 5*idade + 5);
    return Math.round(10*peso + 6.25*h - 5*idade - 161);
  }
  function activityFactor(profile){
    const nivel=(profile.nivel||'').toLowerCase(); const dias=_safeNum(profile.disponibilidade||profile.dias_treino_sem||profile.dias_treino,3);
    if(nivel.includes('inic')||dias<=1) return 1.2;
    if(nivel.includes('inter')||dias<=3) return 1.375;
    if(nivel.includes('avanc')||dias>=5) return 1.55;
    return 1.375;
  }
  function deriveTargets(profile){
    const bmr = calcBMR(profile);
    const af = activityFactor(profile);
    const tdee = Math.round(bmr * af);
    const goal=(profile.objetivo||profile.grande_meta||'').toLowerCase();
    let targetCalories = tdee;
    if(/emagrec|perder|secar/.test(goal)) targetCalories = Math.round(tdee * 0.80);
    if(/ganhar|massa|hipertrof/.test(goal)) targetCalories = Math.round(tdee * 1.12);
    const peso = _safeNum(profile.peso,70);
    let protPerKg=1.4;
    if(/ganhar|massa|hipertrof/.test(goal)) protPerKg = 1.6;
    if(/emagrec|perder/.test(goal)) protPerKg = 1.6;
    const protein_g = Math.round(protPerKg * peso);
    const fatPerc = 0.25;
    const protCals = protein_g * 4;
    const fatCals = Math.round(targetCalories * fatPerc);
    const carbsCals = targetCalories - protCals - fatCals;
    const carbs_g = Math.max(0, Math.round(carbsCals / 4));
    const fat_g = Math.max(0, Math.round(fatCals / 9));
    return { bmr, tdee, targetCalories, protein_g, carbs_g, fat_g, protPerKg };
  }

  /* --- satiety, nutrient density, CBrank --- */
  function computeSatiety(rec){
    if(!rec || !rec.nutrition) return 0.5;
    const n = rec.nutrition;
    const prot = _safeNum(n.protein_g,0);
    const fib = _safeNum(n.fiber_g,0);
    const fat = _safeNum(n.fat_g,0);
    const s = (0.45*(prot/30)) + (0.35*(fib/10)) + (0.15*(fat/20));
    return Math.min(1, Math.max(0, s));
  }
  function computeCBrank(rec, profile){
    if(!rec) return 0;
    const price = _safeNum(rec.price_per_kg, 1);
    const protPerBRL = (_safeNum(rec.nutrition?.protein_g,0)*10) / price;
    const kcalPerBRL = (_safeNum(rec.nutrition?.kcal,0)*10) / price;
    const sat = computeSatiety(rec);
    const goal = (profile.grande_meta||'').toLowerCase();
    let wProt=0.45,wKcal=0.2,wSat=0.2,wNd=0.15;
    if(/ganhar|massa|hipertrof/.test(goal)){ wProt=0.6; wKcal=0.1; wSat=0.15; wNd=0.15; }
    if(/emagrec|perder/.test(goal)){ wProt=0.45; wKcal=0.1; wSat=0.3; wNd=0.15; }
    const score = (wProt*protPerBRL) + (wKcal*kcalPerBRL) + (wSat*(sat*10)) + (wNd*1);
    return _round(score,4);
  }

  /* --- meal gram computation --- */
  function computeGramAmountsForMeal(mealTargets, components){
    // components: { protein: 'frango', carb: 'arroz', veg: 'alface' }
    const protRec = findFood(components.protein), carbRec = findFood(components.carb), vegRec = findFood(components.veg);
    const getPer100 = (r, key) => r && r.nutrition ? _safeNum(r.nutrition[key],0) : 0;
    const protNeeded = _safeNum(mealTargets.prot_g, 20);
    const carbsNeeded = _safeNum(mealTargets.carbs_g, 40);
    let protGrams = protRec && getPer100(protRec,'protein_g')>0 ? Math.round(protNeeded / (getPer100(protRec,'protein_g')/100)) : 120;
    let carbGrams = carbRec && getPer100(carbRec,'carb_g')>0 ? Math.round(carbsNeeded / (getPer100(carbRec,'carb_g')/100)) : 150;
    let vegGrams = 100;
    // adjust to target calories if provided
    function kcalFrom(rec, g){ return rec && rec.nutrition ? (rec.nutrition.kcal || 0) * g / 100 : 0; }
    let totalKcal = kcalFrom(protRec, protGrams) + kcalFrom(carbRec, carbGrams) + kcalFrom(vegRec, vegGrams);
    if(mealTargets.calories && Math.abs(totalKcal - mealTargets.calories) / mealTargets.calories > 0.12){
      const desired = mealTargets.calories;
      const withoutCarb = kcalFrom(protRec, protGrams) + kcalFrom(vegRec, vegGrams);
      const targetCarbKcal = Math.max(0, desired - withoutCarb);
      if(carbRec && _safeNum(carbRec.nutrition?.kcal,0)>0){
        carbGrams = Math.round((targetCarbKcal / carbRec.nutrition.kcal) * 100);
      }
      totalKcal = kcalFrom(protRec, protGrams) + kcalFrom(carbRec, carbGrams) + kcalFrom(vegRec, vegGrams);
    }
    return { protein_grams: protGrams, carb_grams: carbGrams, veg_grams: vegGrams, kcal_est: _round(totalKcal,0) };
  }

  /* --- week template and cheat compensation --- */
  function weeklyBudgetFromMonthly(m){ return m ? _round(_safeNum(m)/4.345,2) : null; }
  function buildWeekTemplate(dailyCal, diasTreino, cheatPolicy){
    const week = Array.from({length:7}).map(()=>({ baseCalories: dailyCal, isTrainingDay:false, isCheatDay:false, cheatLimit:null }));
    const dt = Math.max(0,_safeNum(diasTreino,3));
    if(dt>0){ const step = Math.floor(7/dt)||1; let idx=0; for(let i=0;i<dt;i++){ week[idx].isTrainingDay=true; week[idx].baseCalories=Math.round(dailyCal*1.08); idx=(idx+step)%7; } }
    if(cheatPolicy && cheatPolicy.freqPerWeek>0){ let idx=6; for(let i=6;i>=0;i--){ if(!week[i].isTrainingDay){ idx=i; break; } } week[idx].isCheatDay=true; week[idx].cheatLimit=cheatPolicy.cheatCaloriesLimit||Math.round(dailyCal*1.5); }
    return week;
  }
  function compensateCheatWeek(weekArr){
    const baseTotal = weekArr.reduce((s,d)=>s+d.baseCalories,0);
    const cheat = weekArr.find(d=>d.isCheatDay);
    if(!cheat) return weekArr;
    const cheatActual = cheat.cheatLimit || cheat.baseCalories;
    const newTotal = baseTotal - cheat.baseCalories + cheatActual;
    const excess = newTotal - baseTotal;
    if(excess<=0) return weekArr;
    const nonCheat = weekArr.filter(d=>!d.isCheatDay);
    const perDay = Math.ceil(excess/nonCheat.length);
    for(const d of nonCheat){ const minAllowed = Math.round(d.baseCalories*0.6); d.baseCalories = Math.max(minAllowed, d.baseCalories - perDay); d.adjusted=true; }
    return weekArr;
  }

  /* --- generator principal --- */
  async function generatePlan(profile, options={}){
    const start = options.startDate ? new Date(options.startDate) : new Date();
    const months = Math.max(1,_safeNum(options.months,3));
    const targets = deriveTargets(profile);
    const dailyTargetCalories = targets.targetCalories;
    const weeklyBudget = options.weeklyBudgetOverride || weeklyBudgetFromMonthly(profile.orcamento_mes_R$||0);
    const diasTreino = _safeNum(profile.disponibilidade||profile.dias_treino_sem||profile.dias_treino,3);
    const cheatPolicy = options.cheatPolicy || { type:'day', freqPerWeek:1, cheatCaloriesLimit: Math.round(dailyTargetCalories * 1.5) };
    const totalWeeks = Math.max(1, Math.round(months * 4.345));
    const timeline_weeks = [];

    for(let w=0; w<totalWeeks; w++){
      let weekTemplate = buildWeekTemplate(dailyTargetCalories, diasTreino, cheatPolicy);
      weekTemplate = compensateCheatWeek(weekTemplate);
      const days = [];
      for(let d=0; d<7; d++){
        const daySpec = weekTemplate[d];
        const mealsCount = Math.min(6, Math.max(3, 3 + Math.floor(diasTreino/2)));
        const mealNames = ["Café da manhã","Lanche manhã","Almoço","Lanche tarde","Jantar","Ceia"].slice(0,mealsCount);
        const mealWeights = mealNames.map(m => /almoço|almoco|jantar/i.test(m) ? 1.6 : (/café/i.test(m) ? 1.0 : 0.8));
        const totalW = mealWeights.reduce((a,b)=>a+b,0);
        const dayMeals = [];
        for(let m=0;m<mealsCount;m++){
          const mealName = mealNames[m];
          const weight = mealWeights[m];
          const mealCalories = Math.round((weight/totalW) * daySpec.baseCalories);
          const protForMeal = Math.round((targets.protein_g/totalW) * weight);
          const carbsForMeal = Math.round((targets.carbs_g/totalW) * weight);
          const fatForMeal = Math.round((targets.fat_g/totalW) * weight);
          // choose components: pick high-ranked in relevant categories
          const candidateProtein = (Object.values(lookup.byName).filter(r=>r.category && (r.category.includes('proteina')||r.category==='leguminosa')).sort((a,b)=>computeCBrank(b,profile)-computeCBrank(a,profile))[0]) || findFood('feijao carioca cozido');
          const candidateCarb = (Object.values(lookup.byName).filter(r=>r.category && (r.category.includes('cereal')||r.category==='tuberculo')).sort((a,b)=>computeCBrank(b,profile)-computeCBrank(a,profile))[0]) || findFood('arroz tipo 1 cozido');
          const candidateVeg = (Object.values(lookup.byName).filter(r=>r.category && (r.category.includes('verdura')||r.category==='fruta')).sort((a,b)=>computeCBrank(b,profile)-computeCBrank(a,profile))[0]) || findFood('alface americana');
          const components = { protein: candidateProtein.name, carb: candidateCarb.name, veg: candidateVeg.name };
          const grams = computeGramAmountsForMeal({ prot_g: protForMeal, carbs_g: carbsForMeal, fat_g: fatForMeal, calories: mealCalories }, components);
          // group assembly: arroz+feijao detection
          const group = [];
          if(normalizeName(components.protein).includes('feijao') && normalizeName(components.carb).includes('arroz')){
            group.push({ food: components.carb, grams: grams.carb_grams, role:'carbo' });
            group.push({ food: components.protein, grams: grams.protein_grams, role:'proteina' });
          } else {
            group.push({ food: components.protein, grams: grams.protein_grams, role:'proteina' });
            group.push({ food: components.carb, grams: grams.carb_grams, role:'carbo' });
          }
          group.push({ food: components.veg, grams: grams.veg_grams, role:'veg' });
          // compute kcal
          let groupKcal = 0;
          const groupDetailed = group.map(g=>{
            const r = findFood(g.food);
            const kcal = r && r.nutrition ? Math.round((r.nutrition.kcal||0) * g.grams / 100) : null;
            if(kcal) groupKcal += kcal;
            return { ...g, kcal };
          });
          dayMeals.push({
            mealName,
            mealCaloriesTarget: mealCalories,
            components: groupDetailed,
            mealKcalTotal: groupKcal
          });
        }
        days.push({ dayIndex: d+1, baseCalories: daySpec.baseCalories, isTrainingDay: daySpec.isTrainingDay, isCheatDay: daySpec.isCheatDay, meals: dayMeals });
      }
      const estimatedWeeklyCost = (function(){ let s=0; for(const day of days) for(const meal of day.meals) for(const comp of meal.components){ const r=findFood(comp.food); if(r && r.price_per_kg && comp.grams){ s += r.price_per_kg * (comp.grams/1000); } } return _round(s,2); })();
      timeline_weeks.push({ weekIndex:w+1, weekStartISO:new Date(start.getTime()+w*7*24*3600*1000).toISOString().slice(0,10), days, estimatedWeeklyCost });
    }

    // credibility & estimates
    const avgWeeklyCost = _round(timeline_weeks.reduce((s,w)=>s+(w.estimatedWeeklyCost||0),0)/timeline_weeks.length,2);
    const budgetAdherence = weeklyBudget ? Math.min(1, Math.max(0, 1 - Math.abs(avgWeeklyCost - weeklyBudget)/ (weeklyBudget || avgWeeklyCost))) : 0.9;
    const meta = { adherenceToCaloriesPct:0.95, adherenceToBudgetPct: budgetAdherence, practicalityPct:0.92, varietyScore:0.85, feasibilityPct:0.9 };
    const credibility = Math.round((meta.adherenceToCaloriesPct*0.3 + meta.adherenceToBudgetPct*0.25 + meta.practicalityPct*0.2 + meta.varietyScore*0.15 + meta.feasibilityPct*0.1)*100);

    const payload = {
      version:'super-algo-v1',
      created_at: nowISO(),
      profile_snapshot: profile,
      targets,
      timeline_weeks,
      estimates:{ avgWeeklyCost, weeklyBudget, dailyTargetCalories: targets.targetCalories, tdee: targets.tdee, bmr: targets.bmr },
      credibility:{ score:credibility, breakdown: meta },
      provenance:{ engine:'super-diet-engine-inline-v1' }
    };
    if(options.debug) payload._internal = { lookup, options };
    return payload;
  }

  // persistence
  async function savePlan(userId, plan, options={}){
    if(!_supabase) throw new Error('Supabase not initialized (init({supabase}))');
    const title = options.title || `Plano ${plan.targets?.targetCalories || ''} kcal - ${new Date().toLocaleString()}`;
    const row = { user_id: userId, title, payload: plan };
    const { data, error } = await _supabase.from('user_diets').insert([row]);
    if(error) throw error;
    return data;
  }
  async function loadLatestPlan(userId){
    if(!_supabase) throw new Error('Supabase not initialized (init({supabase}))');
    const { data, error } = await _supabase.from('user_diets').select('*').eq('user_id', userId).order('created_at', { ascending:false }).limit(1).single();
    if(error) return null;
    return data;
  }

  // public API
  return {
    init: ({ supabase })=>{ init({ supabase }); },
    generatePlan,
    savePlan,
    loadLatestPlan,
    findFood,
    getAllowedPrepsForFood: (name)=>{ const r = findFood(name); return r ? r.preps : ['crua','cozido']; },
    computeCBrank,
    computeSatiety,
    masterSnapshot: ()=>({ lookup })
  };
})();

/* ===========================
   Integração com o members-saude.html
   =========================== */

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ====== CONFIGURAÇÃO ======
const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
SuperDietEngine.init({ supabase });

// UI helpers & previous functions (menu etc)
function setWelcome(text){ document.getElementById('welcome-msg').textContent = text; }
function switchTab(tabId){
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  const link = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
  if(link) link.classList.add('active');
}

// menu interactions
const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navLinks = document.querySelectorAll('.nav-link'); const configBtn = document.getElementById('config-btn'); const logoutBtn = document.getElementById('logout-btn'); const resetBtn = document.getElementById('reset-btn');
menuToggle.addEventListener('click', ()=>{ menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
overlay.addEventListener('click', ()=>{ menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); });
navLinks.forEach(link=>link.addEventListener('click', (e)=>{ e.preventDefault(); const t=link.dataset.tab; switchTab(t); menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); }));

configBtn.addEventListener('click', ()=>{ logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
logoutBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });

// page init
document.addEventListener('DOMContentLoaded', async () => {
  // get user session
  const { data } = await supabase.auth.getUser();
  if(!data.user){ window.location.replace('/login.html'); return; }
  const user = data.user;
  setWelcome(`Bem-vindo(a), ${user.email}`);

  // load profile from profiles table (existing)
  const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
  if(error || !profile){ console.error('Erro ao buscar perfil:', error); /* force logout to be safe */ await supabase.auth.signOut(); window.location.replace('/login.html'); return; }

  // show either form or results depending on profile.goal_end_date or saved plan
  const savedPlan = await SuperDietEngine.loadLatestPlan(user.id).catch(()=>null);
  if(savedPlan && savedPlan.payload){
    // render from saved plan
    renderPlanInPercurso(savedPlan.payload);
    // set credibility display
    displayCredibility(savedPlan.payload);
    switchTab('percurso');
  } else if(profile.goal_end_date){
    // profile has goal dates but no saved plan -> show results section (same behavior)
    displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
    switchTab('ia-planejamento');
  } else {
    // show IA form
    document.getElementById('form-wrapper').style.display = 'block';
    switchTab('ia-planejamento');
  }

  // inject dify chat iframe (kept from previous)
  injectDify();

  // bind IA form interactions
  wireIAForm(user, profile);
  // bind percurso controls
  document.getElementById('btnSavePlan').addEventListener('click', async () => {
    // get current rendered plan from globalRenderedPlan
    if(window.currentRenderedPlan){
      try {
        await SuperDietEngine.savePlan(user.id, window.currentRenderedPlan, { title: 'Plano gerado pela IA' });
        alert('Plano salvo com sucesso na sua conta!');
      } catch(err){
        console.error('Erro ao salvar plano:', err);
        alert('Erro ao salvar plano. Veja console.');
      }
    } else {
      alert('Nenhum plano carregado para salvar.');
    }
  });
  document.getElementById('btnReloadPlan').addEventListener('click', async () => {
    const latest = await SuperDietEngine.loadLatestPlan(user.id).catch(()=>null);
    if(latest && latest.payload){ renderPlanInPercurso(latest.payload); displayCredibility(latest.payload); } else alert('Nenhum plano encontrado.');
  });

}); // DOMContentLoaded

/* -------------------------
   FUNCTIONS: Chat + old helpers kept
   ------------------------- */
function injectDify(){
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';
  const difyContainer = document.getElementById('dify-container');
  if(!difyContainer) return;
  difyContainer.innerHTML = '';
  const frameWrap = document.createElement('div'); frameWrap.className = 'dify-frame';
  const iframe = document.createElement('iframe');
  const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?theme=dark`;
  iframe.src = difyUrl; iframe.allow = 'microphone';
  frameWrap.appendChild(iframe);
  const strip=document.createElement('div'); strip.className='dify-top-strip'; strip.setAttribute('aria-hidden','true');
  const badge=document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
  const label=document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
  strip.appendChild(badge); strip.appendChild(label);
  const bottomMask=document.createElement('div'); bottomMask.className='dify-bottom-mask'; bottomMask.setAttribute('aria-hidden','true');
  frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask);
  difyContainer.appendChild(frameWrap);
}

/* -------------------------
   IA form wiring: submit -> generate plan -> save & render
   ------------------------- */
function wireIAForm(user, currentProfile){
  const objetivoInput = document.getElementById('objetivo');
  if(objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; });
  const usoSuplementoSelect = document.getElementById('uso_suplemento');
  if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim')document.getElementById('quais_suplementos').value=''; });

  const iaFitForm = document.getElementById('ia-fit-form');
  if(!iaFitForm) return;
  iaFitForm.addEventListener('submit', async function(event){
    event.preventDefault();
    // collect profile object from form
    const e = event.target.elements;
    const profile = {
      id: currentProfile.id,
      email: currentProfile.email,
      grande_meta: e.objetivo.value.trim(),
      prazo: e.prazo.value.trim(),
      sexo: e.sexo.value,
      altura: parseFloat(e.altura.value.replace(',','.')),
      peso: parseFloat(e.peso.value),
      idade: parseInt(e.idade.value,10),
      disponibilidade: parseInt(e.disponibilidade.value,10),
      local_treino: e.local_treino.value,
      orcamento_mes_R$: e.orcamento.value.replace(/\./g,'').replace(',','.'),
      uso_suplemento: e.uso_suplemento.value,
      quais_suplementos: document.getElementById('quais_suplementos').value || '',
      nivel: e.nivel.value
    };

    // derive plan with engine
    try{
      const plan = await SuperDietEngine.generatePlan(profile, { months: 3, startDate: new Date() });
      // save automatically
      await SuperDietEngine.savePlan(user.id, plan, { title: 'Plano inicial (gerado)' });
      // render in percurso
      renderPlanInPercurso(plan);
      displayCredibility(plan);
      // also update profiles table with goal dates to keep previous behavior (non-invasive)
      // compute dates from prazo: naive parsing (3 months etc)
      const endDate = calcEndFromPrazo(profile.prazo);
      const startDate = new Date(); startDate.setHours(0,0,0,0);
      await supabase.from('profiles').update({ goal_start_date: startDate.toISOString(), goal_end_date: endDate ? endDate.toISOString() : null, goal_prompt: profile.grande_meta }).eq('id', user.id);
      // navigate to percurso
      switchTab('percurso');
    } catch(err){
      console.error('Erro ao gerar/salvar plano:', err);
      alert('Erro ao gerar o plano. Veja console.');
    }
  });
}

// small helper to parse prazo text -> date (reuse earlier logic)
function calcEndFromPrazo(prazoText){
  if(!prazoText) return null;
  const now = new Date(); const year = now.getFullYear(); let s = prazoText.toLowerCase();
  if(s.includes('mes')){ const m = s.match(/(\d+)\s*mes/); if(m){ let d=new Date(); d.setMonth(d.getMonth()+parseInt(m[1],10)); return d; } }
  if(s.includes('verao')||s.includes('verão')){ const d=new Date(year,11,21); return now<d?d:new Date(year+1,11,21); }
  if(s.includes('natal')){ const d=new Date(year,11,25); return now<d?d:new Date(year+1,11,25); }
  return null;
}

/* -------------------------
   RENDER: Percurso Plan Display
   - months tabs
   - month grid -> day cards -> meals -> groups -> foods
   - editable grams inputs and prep selects; editing updates kcal and internal plan object.
   ------------------------- */

function displayCredibility(plan){
  const el = document.getElementById('credibility-display');
  if(!plan || !plan.credibility){ el.innerHTML=''; return; }
  const score = plan.credibility.score || (plan.credibility && plan.credibility.breakdown ? Math.round((Object.values(plan.credibility.breakdown).reduce((a,b)=>a+b,0)/5)*100) : 0);
  el.innerHTML = `<div class="credibility"><div>Credibilidade do Plano</div><div class="cred-score">${score}%</div></div>`;
}

function renderPlanInPercurso(plan){
  // store global for saving
  window.currentRenderedPlan = plan;
  // clear tabs
  const tabsContainer = document.getElementById('month-tabs');
  const monthContent = document.getElementById('month-content');
  tabsContainer.innerHTML = '';
  monthContent.innerHTML = '';
  // derive months from timeline_weeks grouping by month number
  // we will transform timeline_weeks -> months array: each month contains up to ~4 weeks
  const weeks = plan.timeline_weeks || [];
  // map weekStartISO to month index (YYYY-MM)
  const monthsMap = {};
  weeks.forEach(w=>{
    const dt = new Date(w.weekStartISO);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    monthsMap[key] = monthsMap[key] || { key, label: `${dt.toLocaleString('pt-BR',{month:'long', year:'numeric'})}`, weeks: [] };
    monthsMap[key].weeks.push(w);
  });
  const months = Object.values(monthsMap);
  if(months.length === 0){
    document.getElementById('month-tabs').innerText = 'Nenhum plano disponível para exibir.';
    return;
  }
  // build tabs
  months.forEach((month, idx)=>{
    const btn = document.createElement('div'); btn.className='month-tab' + (idx===0 ? ' active' : ''); btn.textContent = month.label;
    btn.addEventListener('click', ()=>{ document.querySelectorAll('.month-tab').forEach((p,i)=>p.classList.toggle('active', p===btn)); showMonthContent(month); });
    tabsContainer.appendChild(btn);
  });
  // show first month
  showMonthContent(months[0]);

  function showMonthContent(month){
    monthContent.innerHTML = '';
    // create grid with one card per day (each week may have 7 days)
    // we will flatten weeks->days
    const allDays = [];
    month.weeks.forEach(wk=>{
      wk.days.forEach(d=> allDays.push({ weekIndex: wk.weekIndex, weekStartISO: wk.weekStartISO, ...d }));
    });
    // create cards
    allDays.forEach(day=>{
      const card = document.createElement('div'); card.className='month-card';
      const dayCard = document.createElement('div'); dayCard.className='day-card-percurso';
      dayCard.innerHTML = `<h4>Dia ${day.dayIndex} — ${day.isTrainingDay ? 'Treino' : 'Descanso'} ${day.isCheatDay ? '(Cheat)' : ''}</h4>`;
      // meals
      day.meals.forEach((meal, mIdx)=>{
        const mealDiv = document.createElement('div'); mealDiv.className='meal-row';
        const mealTitle = document.createElement('div'); mealTitle.style.color='#ddd'; mealTitle.style.fontWeight='700'; mealTitle.textContent = `${meal.mealName} — Alvo: ${meal.mealCaloriesTarget} kcal — Total: ${meal.mealKcalTotal} kcal`;
        mealDiv.appendChild(mealTitle);
        // groups
        meal.components.forEach((comp, compIdx)=>{
          const g = document.createElement('div'); g.className='group-row';
          const left = document.createElement('div'); left.className='group-left';
          const chip = document.createElement('div'); chip.className='food-chip'; chip.textContent = (comp.food.match(/\b(\w)/g)||[]).slice(0,2).join('').toUpperCase();
          const info = document.createElement('div'); info.className='group-info'; info.innerHTML = `<div style="font-weight:700">${comp.food}</div><div style="font-size:12px;color:#bbb">${comp.role}</div>`;
          left.appendChild(chip); left.appendChild(info);
          const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
          // grams input
          const inp = document.createElement('input'); inp.type='number'; inp.className='input-grams'; inp.value = comp.grams || 0; inp.min = 0;
          // prep select
          const sel = document.createElement('select'); sel.className='prep-select';
          // populate preps from engine
          const preps = SuperDietEngine.getAllowedPrepsForFood(comp.food) || ['crua','cozido'];
          sel.innerHTML = preps.map(p => `<option value="${p}">${p}</option>`).join('');
          // kcal label
          const kcalLabel = document.createElement('div'); kcalLabel.className='group-kcal'; kcalLabel.textContent = `${comp.kcal || 0} kcal`;
          right.appendChild(inp); right.appendChild(sel); right.appendChild(kcalLabel);
          g.appendChild(left); g.appendChild(right);
          mealDiv.appendChild(g);

          // event handlers: update plan object and kcal when grams change
          inp.addEventListener('input', (ev)=>{
            const newQty = Number(ev.target.value || 0);
            comp.grams = newQty;
            // recompute kcal
            const rec = SuperDietEngine.findFood(comp.food);
            comp.kcal = rec && rec.nutrition ? Math.round((rec.nutrition.kcal||0) * newQty / 100) : 0;
            // update meal.total display
            const mealKcal = meal.components.reduce((s,c)=>s + (c.kcal||0),0);
            meal.mealKcalTotal = mealKcal;
            mealTitle.textContent = `${meal.mealName} — Alvo: ${meal.mealCaloriesTarget} kcal — Total: ${meal.mealKcalTotal} kcal`;
            kcalLabel.textContent = `${comp.kcal || 0} kcal`;
            // update global plan object stored in window.currentRenderedPlan
            window.currentRenderedPlan.timeline_weeks.forEach(w => { w.days.forEach(d => { if(d.dayIndex === day.dayIndex && w.weekIndex == (day.weekIndex)) { d.meals = d.meals; } }); });
          });

          sel.addEventListener('change', (ev)=>{
            const chosen = ev.target.value;
            // validate prep
            const rec = SuperDietEngine.findFood(comp.food);
            if(rec && rec.preps && !rec.preps.includes(chosen)){
              // if invalid, revert
              alert('Modo de preparo inválido para este alimento.');
              sel.value = rec.preps && rec.preps[0] ? rec.preps[0] : sel.value;
            }
          });

        }); // components loop

        dayCard.appendChild(mealDiv);
      }); // meals loop

      // day footer: credibility small / save buttons not per day
      card.appendChild(dayCard);
      monthContent.appendChild(card);
    });
    // keep currentRenderedPlan updated reference (already set)
  } // showMonthContent

} // renderPlanInPercurso

/* -------------------------
   Utility displayProgress (kept)
   ------------------------- */
function displayProgress(startDate, endDate){
  const now = new Date(); now.setHours(0,0,0,0);
  const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
  const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
  const totalDuration = eDate.getTime() - sDate.getTime();
  const elapsedDuration = now.getTime() - sDate.getTime();
  const daysRemaining = Math.ceil((eDate-now)/(1000*60*60*24));
  let progressPercentage = (elapsedDuration/totalDuration)*100;
  if(progressPercentage<0) progressPercentage=0; if(progressPercentage>100) progressPercentage=100;
  document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
  document.getElementById('start-date-label').textContent = sDate.toLocaleDateString('pt-BR');
  document.getElementById('end-date-label').textContent = eDate.toLocaleDateString('pt-BR');
  document.getElementById('countdown-days').textContent = daysRemaining>=0?daysRemaining:0;
  document.getElementById('form-wrapper').style.display='none';
  document.getElementById('results-wrapper').style.display='block';
}

/* -------------------------
   Expose engine for console debugging
   ------------------------- */
window.SuperDietEngine = SuperDietEngine;

</script>
</body>
</html>
