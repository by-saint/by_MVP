<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética (com parser integrado)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
    h1,h2,h3{ color:#f0f0f0; text-align:center; margin-top:30px; margin-bottom:15px; }

    /* sidebar/menu (copiado do seu estilo) */
    .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
    .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px;transition:all .3s}
    .menu-toggle.open .bar:nth-child(1){transform:translateY(8px) rotate(45deg)}
    .menu-toggle.open .bar:nth-child(2){opacity:0}
    .menu-toggle.open .bar:nth-child(3){transform:translateY(-8px) rotate(-45deg)}
    .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar.open{left:0}
    .sidebar nav{padding-top:100px}
    .sidebar nav ul{list-style:none;padding:0;margin:0}
    .sidebar nav a{display:block;padding:15px 30px;text-decoration:none;font-size:1.1em;font-weight:700;border-left:5px solid transparent;transition:background .2s,border-left .2s}
    .sidebar nav a:hover{background:#2c2c2c}
    .link-ia,.link-aulas,.link-percurso{background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .link-ia{background-image:linear-gradient(90deg,#38b6ff,#0056b3)}
    .link-aulas{background-image:linear-gradient(90deg,#c048f2,#6b21a8)}
    .link-percurso{background-image:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2))}
    .sidebar-footer{padding:20px 30px;text-align:center}
    .sidebar-config-btn{width:100%;background:transparent;border:1px solid #444;color:#aaa;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}
    .hidden{display:none}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .overlay.show{opacity:1;visibility:visible}
    .header{display:flex;justify-content:flex-end;align-items:center;margin-bottom:20px}
    #welcome-msg{color:#bbb}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .form-wrapper,.results-wrapper{width:100%;max-width:800px;margin:0 auto}
    .form-container,.results-container,.percurso-container{background:#1E1E1E;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid #333}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
    input,select,textarea{width:100%;padding:12px;background:#2C2C2C;border:1px solid #444;border-radius:8px;color:#E0E0E0;font-size:16px;box-sizing:border-box}
    textarea{resize:vertical;min-height:100px}
    .goal-section{background:linear-gradient(145deg,#2a2a2a,#1a1a1a);border:1px solid #444;padding:30px;margin-bottom:40px;border-radius:10px;text-align:center}
    .goal-title{font-size:28px;font-weight:700;background:linear-gradient(90deg,#007BFF,#00C6FF);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
    .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.25));border:1px solid rgba(190,18,60,.12);padding:20px;border-radius:12px}
    .paste-btn{--h:36px;display:inline-flex;align-items:center;justify-content:center;height:var(--h);min-width:160px;padding:8px 24px;border-radius:999px;background:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2));border:none;color:#fff;font-weight:700;cursor:pointer;position:relative}
    .small-note{font-size:13px;color:#cfc;opacity:.7;margin-top:6px}

    /* compact parser UI */
    .compact-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.06));padding:14px;border-radius:10px}
    .compact-input{width:100%;min-height:110px;padding:10px;border-radius:8px;background:#0f0f10;border:1px solid #222;color:#e6eefc}
    .compact-controls{display:flex;gap:10px;margin-top:8px}
    .compact-btn{padding:9px 14px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,#ff4b6b,#be123c);color:white;font-weight:700}
    .compact-btn.clear{background:#222;border:1px solid #333}
    .compact-btn.copy{background:#0b74ff}
    .compact-error{margin-top:8px;padding:10px;border-radius:8px;background:#3b0f0f;color:#ffdede;display:none}
    .kb-preview{margin-top:8px;font-size:13px;color:#bbb}
    .compact-root{margin-top:12px}
    @media(max-width:900px){.percurso-forms{grid-template-columns:1fr}.menu-toggle{top:14px;left:14px;width:44px;height:44px}}
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar">
  <nav>
    <ul>
      <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
      <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
      <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
    </ul>
  </nav>
  <div class="sidebar-footer">
    <button id="config-btn" class="sidebar-config-btn">⚙️ Configurações</button>
    <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
    <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<div class="container">
  <div class="header"><p id="welcome-msg">A carregar...</p></div>

  <!-- IA Especialista (mantive o seu formulário original) -->
  <div id="ia-planejamento" class="tab-content active">
    <div class="form-wrapper" id="form-wrapper" style="display: none;">
      <div class="form-container">
        <h1>Crie a sua Meta</h1>
        <form id="ia-fit-form">
          <div class="goal-section">
            <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
            <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
            <div id="prazo-group" class="form-group" style="margin-top:20px;text-align:left;display:none">
              <label for="prazo">Qual o prazo para esta meta?</label>
              <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
            </div>
          </div>

          <h3>Informações Básicas e Realidade Atual</h3>
          <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
          <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
          <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
          <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
          <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
          <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
          <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
          <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
          <div class="form-group" id="suplementos-detalhes-group" style="display:none"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
          <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
          <button type="submit">Crie seu próprio caminho</button>
        </form>
      </div>
    </div>

    <div class="results-wrapper" id="results-wrapper" style="display:none">
      <div class="results-container">
        <h2>Seu Plano de Ação</h2>
        <pre id="prompt-output"></pre>
        <button id="copy-btn" class="copy-button">Copiar Pedido</button>

        <h3>Comece sua Conversa com a IA</h3>
        <p style="text-align:center;color:#bbb;margin-top:-10px;margin-bottom:20px">Copie o pedido acima e cole no chat para receber o seu plano personalizado.</p>

        <div id="dify-container" class="iframe-container"></div>

        <div class="playlist-section" id="playlist-section" style="display:none">
          <h4>Roteiro de Aulas Sugerido</h4>
          <p style="color:#bbb;margin-top:-10px">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
          <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
        </div>

        <div class="progress-section">
          <h3>Sua Jornada</h3>
          <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
          <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
          <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video aulas (mantive seus iframes) -->
  <div id="video-aulas" class="tab-content">
    <h2>Nossas Aulas</h2>
    <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
    <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
    <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
  </div>

  <!-- Percurso: incluí o parser aqui -->
  <div id="percurso" class="tab-content">
    <div class="percurso-container">
      <h2>Meu Percurso</h2>
      <p style="text-align:center;color:#bbb">Visualize progresso, gere formulários a partir de códigos compactos e cole planos.</p>
      <div class="percurso-forms">
        <div class="percurso-card" id="treino-card">
          <h4>Formulário: Treino</h4>
          <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
          <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
          <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
            <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="label">Colar plano</span></button>
            <div class="small-note">Clique para colar (simulação)</div>
          </div>
        </div>

        <div class="percurso-card" id="dieta-card">
          <h4>Formulário: Dieta</h4>

          <!-- Parser UI -->
          <div class="compact-card">
            <label for="compactInput">Cole aqui o código compacto (formato compacto → formulário):</label>
            <textarea id="compactInput" class="compact-input" placeholder="Cole o código compacto aqui...">D12B11131d11111L290100L312150EB21131d11111L237200L309180E</textarea>
            <div class="compact-controls">
              <button id="runBtn" class="compact-btn">Rodar Código</button>
              <button id="clearBtn" class="compact-btn clear">Limpar</button>
              <button id="copyBtn" class="compact-btn copy">Copiar JSON</button>
            </div>
            <div id="compactError" class="compact-error"></div>
            <div id="kbPreview" class="kb-preview"></div>
            <div id="compactRoot" class="compact-root"></div>
          </div>
        </div>
      </div>

      <p style="text-align:center;color:#888;margin-top:18px">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo).</p>
    </div>
  </div>

</div>

<!-- ====== SCRIPTS: supabase (mantive), utilidades e parser corrigido ====== -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  /* ---------- utility functions (mantidas) ---------- */
  function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
  function calculateEndDate(prazoText) { if(!prazoText) return null; const now=new Date(); const year=now.getFullYear(); let prazoLower=prazoText.toLowerCase(); if(prazoLower.includes('final do ano')||prazoLower.includes('fim de ano')) return new Date(year,11,31); let match=prazoLower.match(/(\d+)\s+mes(es)?/); if(match){let d=new Date();d.setMonth(d.getMonth()+parseInt(match[1],10));return d;} match=prazoLower.match(/(\d+)\s+dia(s)?/); if(match){let d=new Date();d.setDate(d.getDate()+parseInt(match[1],10));return d;} if(prazoLower.includes('verao')||prazoLower.includes('verão')){const s=new Date(year,11,21);return now<s?s:new Date(year+1,11,21);} if(prazoLower.includes('natal')){const c=new Date(year,11,25);return now<c?c:new Date(year+1,11,25);} if(prazoLower.includes('ano novo')) return new Date(year+1,0,1); if(prazoLower.includes('pascoa')||prazoLower.includes('páscoa')){const e=getEaster(year);return now<e?e:getEaster(year+1);} return null; }
  function displayProgress(startDate,endDate){ const now=new Date(); now.setHours(0,0,0,0); const sDate=new Date(startDate); sDate.setHours(0,0,0,0); const eDate=new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate-getTime?sDate.getTime(): (eDate.getTime()-sDate.getTime()); const elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; const pb=document.getElementById('progress-bar'); if(pb) pb.style.width=`${progressPercentage}%`; const sLbl=document.getElementById('start-date-label'); const eLbl=document.getElementById('end-date-label'); if(sLbl) sLbl.textContent=sDate.toLocaleDateString('pt-BR'); if(eLbl) eLbl.textContent=eDate.toLocaleDateString('pt-BR'); const cd=document.getElementById('countdown-days'); if(cd) cd.textContent=daysRemaining>=0?daysRemaining:0; const fw=document.getElementById('form-wrapper'); const rs=document.getElementById('results-wrapper'); if(fw && rs){ fw.style.display='none'; rs.style.display='block'; } }

  function analyzeGoal(text){ const lowerText=(text||'').toLowerCase(); const emagrecerKeywords=['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento']; const musculoKeywords=['ganhar musculo','hipertrofia','sheipado','crescer','massa muscular','ficar forte','músculo']; const hasEmagrecer=emagrecerKeywords.some(k=>lowerText.includes(k)); const hasMusculo=musculoKeywords.some(k=>lowerText.includes(k)); if(hasEmagrecer && !hasMusculo) return 'emagrecer'; if(hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; }
  function reorderVideos(order){ const c=document.getElementById('video-aulas'); const v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

  /* ---------- KB parser (cobre o texto enviado por você) ---------- */
  const kbText = `
1\tAbóbora, cabotián\tcozida
5\tAbóbora, moranga\trefogada
7\tAbobrinha, italiana\tcozida
8\tAbobrinha, italiana\tcrua
9\tAbobrinha, italiana\trefogada
10\tAbobrinha, paulista\tcrua
11\tAcelga\tcrua
12\tAgrião\tcru
13\tAipo\tcru
14\tAlface, americana\tcrua
15\tAlface, crespa\tcrua
16\tAlface, lisa\tcrua
17\tAlface, roxa\tcrua
18\tAlfavaca\tcrua
19\tAlho\tcru
20\tAlho-poró\tcru
21\tAlmeirão\tcru
22\tAlmeirão\trefogado
23\tBatata, baroa\tcozida
25\tBatata, doce\tcozida
27\tBatata frita, tipo chips\tindustrializada
28\tBatata, inglesa\tcozida
30\tBatata, inglesa\tfrita
31\tBatata, inglesa\tsauté
32\tBerinjela\tcozida
34\tBeterraba\tcozida
35\tBeterraba\tcrua
36\tBrócolis\tcozido
37\tBrócolis\tcru
38\tCará\tcozido
40\tCanru\tcru
41\tCatalonha\tcrua
42\tCatalonha\trefogada
43\tCebola\tcrua
44\tCebolinha\tcrua
45\tCenoura\tcozida
46\tCenoura\tcrua
47\tChicória\tcrua
48\tChuchu\tcozido
49\tChuchu\tcru
50\tCoentro, folhas\tdesidratadas
51\tCouve, manteiga\tcrua
52\tCouve, manteiga\trefogada
53\tCouve-flor\tcozida
54\tCouve-flor\tcrua
55\tEspinafre, Nova Zelândia\tcru
56\tEspinafre, Nova Zelândia\trefogado
58\tJiló\tcru
60\tMandioca\tcozida
62\tManjericão\tcru
63\tMaxixe\tcru
64\tMostarda, folha\tcrua
65\tNabo\tcru
66\tNhoque, batata\tcozido
67\tPalmito, juçara\tem conserva
68\tPalmito, pupunha\tem conserva
69\tPepino\tcru
70\tPimentão, amarelo\tcru
71\tPimentão, verde\tcru
72\tPimentão, vermelho\tcru
73\tQuiabo\tcru
74\tRabanete\tcru
75\tRepolho, branco\tcru
76\tRepolho, roxo\tcru
77\tRepolho, roxo\trefogado
78\tRúcula\tcrua
79\tSalsa\tcrua
80\tSeleta de legumes\tenlatada
81\tSerralha\tcrua
82\tTaioba\tcrua
83\tTomate, com semente\tcru
84\tTomate\textrato
85\tTomate\tmolho industrializado
86\tTomate\tpurê
87\tTomate\tsalada
88\tVagem\tcrua
89\tAbacate\tcru
90\tAbacaxi\tcru
92\tAbiu\tcru
93\tAçaí, polpa, com xarope\t(incluído)
95\tAcerola\tcrua
96\tAmeixa, calda\tenlatada
97\tAmeixa\tcrua
98\tAtemoia\tcrua
99\tBanana, da terra\tcrua
100\tBanana, doce\tem barra
101\tBanana, figo\tcrua
102\tBanana, maçã\tcrua
103\tBanana, nanica\tcrua
104\tBanana, ouro\tcrua
105\tBanana, pacova\tcrua
106\tBanana, prata\tcrua
107\tCacau\tcru
108\tCajá-Manga\tcru
110\tCaju, suco\tconcentrado, envasado
111\tCajuí, chocolate\tcru
112\tCarambola\tcrua
113\tCiriguela\tcrua
114\tCupuaçu\tcru
116\tFigo\tcru
117\tFigo, enlatado\tem calda
118\tFruta-pão\tcrua
119\tGoiaba, branca, com casca\tcrua
120\tGoiaba, doce\tem pasta
121\tGoiaba, doce, cascão
122\tGoiaba, vermelha, com casca\tcrua
123\tGraviola\tcrua
125\tJabuticaba\tcrua
126\tJaca\tcrua
127\tJambo\tcru
128\tJamelão\tcru
129\tKiwi\tcru
130\tLaranja, baía\tcrua
131\tLaranja, baía\tsuco
132\tLaranja, da terra\tcrua
133\tLaranja, da terra\tsuco
134\tLaranja, lima\tcrua
135\tLaranja, lima\tsuco
136\tLaranja, pêra\tcrua
137\tLaranja, suco\t(suco genérico)
138\tLaranja, valência\tcrua
139\tLaranja, valência\tsuco
140\tLimão, cravo\tsuco
141\tLimão, tahiti\tcru
142\tMaçã, Argentina, com casca\tcrua
143\tMaçã, Fuji, com casca\tcrua
144\tMacaúba\tcru
145\tMamão, doce, em calda\tdrenado
146\tMamão, formosa\tcru
147\tMamão, papaia\tcru
148\tMamão verde, doce em calda\tdrenado
149\tManga, Haden\tcrua
150\tManga, Palmer\tcrua
152\tManga, Tommy Atkins\tcrua
153\tMangarataia\tcrua
155\tMaracujá, suco\tconcentrado
156\tMelancia\tcrua
157\tMelão\tcru
158\tMexerica, Murcote\tcrua
159\tMexerica, Rio\tcrua
160\tMorango\tcru
161\tNêspera\tcru
163\tPêra, Park\tcrua
164\tPêra, Williams\tcrua
165\tPêssego, Aurora\tcru
166\tPêssego, enlatado, em calda
167\tPinha\tcrua
168\tPitanga\tcrua
169\tRomã\tcrua
170\tTamarindo\tcru
171\tTangerina, Ponkan\tcrua
172\tTangerina, Ponkan\tsuco
173\tTucumã\tcru
174\tUmbu\tcru
176\tUva, Itália\tcrua
177\tUva, Rubi\tcrua
178\tUva, suco\tconcentrado, envasado
179\tAzeite, de dendê\t(óleo/gordura)
180\tAzeite, de oliva, extra virgem\t(óleo/gordura)
181\tManteiga, com sal\t(derivado)
182\tManteiga, sem sal\t(derivado)
183\tMargarina, com óleo hidrogenado\t(derivado)
184\tÓleo, de soja\t(óleo)
185\tAbadejo, filé, congelado\tassado
186\tAbadejo, filé, congelado\tcozido
188\tAbadejo, filé, congelado\tgrelhado
189\tAtum, conserva em óleo\t(conserva)
192\tBacalhau, salgado\trefogado
193\tCação, posta, com farinha de trigo\tfrita
194\tCação, posta\tcozida
196\tCamarão, Rio Grande, grande\tcozido
198\tCamarão, Sete Barbas, sem cabeça, com casca\tfrito
199\tCaranguejo\tcozido
200\tCorimbatá\tassado
201\tCorimbatá\tcozido
204\tCorvina grande\tassada
205\tCorvina grande\tcozida
206\tDourada de água doce\tfresca
208\tLambari, congelado\tfrito
209\tManjuba\tfrita
210\tManjuba, com farinha de trigo\tfrita
211\tManjuba\tfrita
212\tMerluza, filé\tassado
213\tMerluza, filé\tcozido
215\tPescada, branca\tfrita
217\tPescada, com farinha de trigo\tfrita
219\tPescada, filé\tfrita
220\tPescada, filé\tmolho escabeche
222\tPintado\tassado
224\tPintado\tgrelhado
226\tSalmão, com pele, fresco\tgrelhado
228\tSalmão, sem pele, fresco\tgrelhado
229\tSardinha\tassada
230\tSardinha, conserva em óleo\t(conserva)
231\tSardinha\tfrita
234\tArroz, integral\tcozido
237\tArroz, tipo 1\tcozido
238\tAveia, flocos\tcrua
239\tBiscoito, doce, maisena\t(processado)
240\tBiscoito, doce, recheado com chocolate\t(processado)
241\tBiscoito, doce, recheado com morango\t(processado)
242\tBiscoito, doce, wafer, recheado de chocolate\t(processado)
243\tBiscoito, doce, wafer, recheado de morango\t(processado)
244\tBiscoito, salgado, cream cracker\t(processado)
245\tBiscoito, polvilho\tdoce
246\tBolo, mistura para\t(processado)
247\tBolo, pronto, aipim\t(processado)
248\tBolo, pronto, chocolate\t(processado)
249\tBolo, pronto, coco\t(processado)
251\tCanjica, com leite integral\t(preparado)
252\tCereais, milho, flocos\tcom sal
253\tCereais, milho, flocos\tsem sal
254\tCereais, milho, infantil\t(processado)
255\tCereais, mistura para vitamina\t(processado)
256\tCereal matinal, milho\t(processado)
257\tCereal matinal, milho, açúcar\t(processado)
258\tCreme de arroz, pó\t(processado)
259\tCreme de milho, pó\t(processado)
260\tCurau, milho verde\t(preparado)
261\tFarinha, de arroz, enriquecida\t(derivado)
262\tFarinha, de centeio, integral\t(derivado)
263\tFarinha, de milho, amarela\t(derivado)
264\tFarinha, de rosca\t(derivado)
265\tFarinha, de trigo\t(derivado)
266\tFarinha, láctea, de cereais\t(derivado)
267\tFarinha, de mandioca, torrada\t(derivado)
268\tFarinha, de puba\t(derivado)
269\tFeijão, de mandioca\tcozido
271\tLasanha, massa fresca\tcozida
273\tMacarrão, instantâneo\t(processado)
278\tMilho, verde\tcru
279\tMilho, verde, enlatado\tdrenado
280\tMingau tradicional, pó\t(processado)
281\tPamonha, barra para cozimento\t(preparado)
282\tPão, aveia, forma\t(processado)
283\tPão, de glúten, forma\t(processado)
284\tPão, de glúten, forma\t(variante)
285\tPão, milho, forma\t(processado)
288\tPão, trigo, forma, integral\t(processado)
289\tPão, trigo, francês\t(processado)
290\tPão, trigo, sovado\t(processado)
293\tPastel, de queijo\tfrito
294\tPastel, de queijo\tfrito
295\tPastel, massa\tfrita
296\tPastel, massa\tfrita
297\tPipoca, com óleo de soja\tsem sal
298\tPolenta, pré-cozida\t(processado)
299\tTorrada, pão francês\t(processado)
300\tAçúcar, mascavo\t(ingrediente)
301\tAçúcar, refinado\t(ingrediente)
302\tChocolate, ao leite\t(processado)
303\tChocolate, ao leite, com castanha do Pará\t(processado)
304\tChocolate, ao leite, dietético\t(processado)
305\tChocolate, meio amargo\t(processado)
306\tCocada branca\t(doces)
307\tDoce, de abóbora, cremoso\t(doces)
308\tDoce, de leite, cremoso\t(doces)
309\tGeleia, mocotó, natural\t(doces)
310\tGlicose de milho\t(ingrediente)
311\tMaria mole\t(doces)
312\tMaria mole, coco queimado\t(doces)
313\tMarmelada\t(doces)
314\tMel, de abelha\t(doces)
315\tMelado\t(doces)
316\tQuindim\t(doces)
317\tRapadura\t(doces)
318\tCafé, pó, torrado\t(bebida/ingrediente)
319\tCapuccino, pó\t(bebida/ingrediente)
320\tFermento em pó, químico\t(ingrediente)
321\tFermento, biológico, levedura, tablete\t(ingrediente)
322\tGelatina, sabores variados, pó\t(ingrediente)
323\tSal, dietético\t(ingrediente)
324\tSal, grosso\t(ingrediente)
325\tShoyu\t(ingrediente/tempero)
326\tTempero à base de sal\t(tempero)
327\tAzeitona, preta\tconserva
328\tAzeitona, verde\tconserva
329\tChantilly, spray, com gordura vegetal\t(processado)
330\tLeite, de coco\t(derivado)
331\tMaionese, tradicional com ovos\t(condimento)
332\tBebida isotônica\t(processado)
333\tCafé, infusão\t10%
334\tCana, aguardente\t(álcool)
335\tCana, caldo\t(bebida)
336\tCerveja, pilsen\t(bebida)
337\tChá, erva-doce\tinfusão
338\tChá, mate\tinfusão
339\tChá, preto\tinfusão
340\tCoco, água de\t(bebida)
341\tRefrigerante, água tônica\t(bebida)
342\tRefrigerante, tipo cola\t(bebida)
343\tRefrigerante, tipo guaraná\t(bebida)
344\tRefrigerante, tipo laranja\t(bebida)
345\tRefrigerante, tipo limão\t(bebida)
346\tAchocolatado, pó\t(bebida)
347\tTacacá\t(prato)
348\tTapioca, com manteiga\t(prato)
349\tTucupi, com pimenta-de-cheiro\t(prato/molho)
350\tVaca atolada\t(prato)
351\tVatapá\t(prato)
352\tVirado à paulista\t(prato)
353\tYakisoba\t(prato)
354\tAcarajé\t(prato)
355\tArroz carreteiro\t(prato)
356\tBaião de dois, arroz e feijão-de-corda\t(prato)
357\tBarreado\t(prato)
358\tBife à cavalo, com contra filé\t(prato)
359\tBolinho de arroz\t(prato)
360\tCamarão à baiana\t(prato)
361\tCharuto, de repolho\t(prato)
362\tCuscuz, de milho, cozido com sal\t(prato)
363\tCuscuz, paulista\t(prato)
364\tCuxá, molho\t(prato/molho)
365\tDobradinha\t(prato)
366\tEstrogonofe de carne\t(prato)
367\tEstrogonofe de frango\t(prato)
368\tFeijoada tropeiro mineiro\t(prato)
369\tFeijoada\t(prato)
370\tFrango, com açafrão\t(prato)
371\tMacarrão, molho bolonhesa\t(prato)
372\tManiçoba\t(prato)
373\tQuibebe\t(prato)
374\tSalada, de legumes, com maionese\t(prato)
375\tSalada, de legumes, cozida no vapor\t(prato)
376\tSalpicão, de frango\t(prato)
377\tSarapatel\t(prato)
378\tTabule\t(prato)
379\tAmendoim, grão\tcru
380\tAmendoim, torrado, salgado\t(torrado/salgado)
381\tErvilha, em vagem\t(crua/cozida)
382\tErvilha, enlatada\tdrenada
383\tFeijão, carioca\tcozido
385\tFeijão, fradinho\tcozido
387\tFeijão, jalo\tcozido
389\tFeijão, preto\tcozido
391\tFeijão, rajado\tcozido
393\tFeijão, rosinha\tcozido
395\tFeijão, roxo\tcozido
399\tLentilha\tcozida
401\tPaçoca, amendoim\t(processado)
402\tPé-de-moleque, amendoim\t(doces)
403\tSoja, farinha\t(derivado)
404\tSoja, extrato solúvel, natural, fluido\t(produto)
405\tSoja, extrato solúvel, pó\t(produto)
406\tSoja, queijo (tofu)\t(produto)
408\tTremoço\tem conserva
409\tAmêndoa, torrada, salgada\t(oleaginosa)
410\tCastanha-de-caju, torrada, salgada\t(oleaginosa)
411\tCastanha-do-Brasil\tcrua
412\tCoco\tcru
413\tGergelim, semente\t(semente)
414\tLinhaça, semente\t(semente)
415\tPinhão\tcozido
416\tPupunha\tcozida
417\tNoz\tcrua
419\tPresunto, com capa de gordura\t(processado)
420\tPresunto, sem capa de gordura\t(processado)
421\tQuibe\tassado
423\tQuibe\tfrito
424\tSalame\t(processado)
426\tToucinho\tfrito
427\tApresentado\t(linha ambígua)
428\tCaldo de carne, tablete\t(ingrediente)
429\tCaldo de galinha, tablete\t(ingrediente)
430\tCarne, bovina, acém, moído, cozido
432\tCarne, bovina, acém, sem gordura, cozido
435\tCarne, bovina, almôndegas, fritas
436\tCarne, bovina, bucho, cozido
439\tCarne, bovina, capa de contra-filé, com gordura\tgrelhada
441\tCarne, bovina, capa de contra-filé, sem gordura\tgrelhada
442\tCarne, bovina, charque, cozido
444\tCarne, bovina, filé à milanesa\tfrita/assada
446\tCarne, bovina, contra-filé de costela\tgrelhado
448\tCarne, bovina, contra-filé, com gordura\tgrelhado
450\tCarne, bovina, contra-filé, sem gordura\tgrelhada
451\tCarne, bovina, costela\tassada
453\tCarne, bovina, coxão duro, sem gordura\tcozido
455\tCarne, bovina, coxão mole, sem gordura\tcozido
457\tCarne, bovina, cupim\tassado
460\tCarne, bovina, filé mignon, sem gordura\tcozido
462\tCarne, bovina, flanco, sem gordura\tcozido
464\tCarne, bovina, fraldinha, com gordura\tcozida
466\tCarne, bovina, lagarto\tcozido
468\tCarne, bovina, língua\tcozida
470\tCarne, bovina, maminha\tgrelhada
473\tCarne, bovina, miolo de alcatra, sem gordura\tgrelado
474\tCarne, bovina, músculo, sem gordura\tcozido
477\tCarne, bovina, paleta, sem gordura\tcozida
479\tCarne, bovina, patinho, sem gordura\tcozido
480\tCarne, bovina, patinho, sem gordura\tgrelhado
481\tCarne, bovina, peito, sem gordura\tcozido
484\tCarne, bovina, picanha, com gordura\tgrelhada
486\tCarne, bovina, picanha, sem gordura\tgrelada
487\tCarne, bovina, seca\tcozida
489\tCoxinha de frango\tfrita
491\tCroquete, de carne\tfrito
492\tEmpada de frango, pré-cozida\tassada
493\tEmpada de frango, pré-cozida\t(preparado)
495\tFrango, caipira, inteiro, com pele\tcozido
496\tFrango, caipira, inteiro, sem pele\tcozido
498\tFrango, coração\tgrelhado
499\tFrango, coxa, com pele\tassada
500\tFrango, coxa, com pele\tcozida
501\tFrango, coxa, sem pele\tcozida
503\tFrango, filé, à milanesa\t(preparado)
505\tFrango, inteiro, sem pele\tassado
506\tFrango, inteiro, sem pele\tcozido
508\tFrango, peito, com pele\tassado
510\tFrango, peito, sem pele\tcozido
512\tFrango, peito, sem pele\tgrelhado
513\tFrango, sobrecoxa, com pele\tassada
515\tFrango, sobrecoxa, sem pele\tassada
518\tHambúrguer, bovino\tfrito
519\tHambúrguer, bovino\tgrelhado
520\tLinguiça, frango\tfrita
521\tLinguiça, frango\tgrelhada
523\tLinguiça, porco\tfrita
524\tLinguiça, porco\tfrita
525\tLinguiça, porco\tgrelhada
526\tMortadela\t(processado)
527\tPeru, congelado\tassado
530\tPorco, bisteca\tfrita
531\tPorco, bisteca\tgrelhada
532\tPorco, costela\tassada
534\tPorco, lombo\tassado
537\tPorco, pernil\tassado
539\tBebida láctea, pêssego\t(produto)
540\tCreme de Leite\t(derivado)
541\tIogurte, natural\t(derivado)
542\tIogurte, natural, desnatado\t(derivado)
543\tIogurte, sabor abacaxi\t(derivado)
544\tIogurte, sabor morango\t(derivado)
545\tIogurte, sabor pêssego\t(derivado)
546\tLeite, condensado\t(derivado)
547\tLeite, de cabra\t(derivado)
548\tLeite, de vaca, achocolatado\t(derivado)
549\tLeite, de vaca, desnatado, pó\t(derivado)
550\tLeite, de vaca, desnatado, UHT\t(derivado)
551\tLeite, de vaca, integral\t(derivado)
552\tLeite, de vaca, integral, pó\t(derivado)
553\tLeite, fermentado\t(derivado)
554\tQueijo, minas, frescal\t(derivado)
555\tQueijo, minas, meia cura\t(derivado)
556\tQueijo, mozarela\t(derivado)
557\tQueijo, parmesão\t(derivado)
558\tQueijo, pasteurizado\t(derivado)
559\tQueijo, petit suisse, morango\t(derivado)
560\tQueijo, prato\t(derivado)
561\tQueijo, requeijão, cremoso\t(derivado)
562\tQueijo, ricota\t(derivado)
563\tOmelete, de queijo\t(preparado)
565\tOvo, de galinha, clara\tcozida/10minutos
566\tOvo, de galinha, gema\tcozida/10minutos
567\tOvo, de galinha, inteiro\tcozido/10minutos
569\tOvo, de galinha, inteiro\tfrito
  `.trim();

  function parseKBText(text){
    const lines = text.split(/\n/).map(l=>l.trim()).filter(l=>l.length>0);
    const kb = {};
    for(const line of lines){
      const m = line.match(/^\s*(\d+)\s+(.+)$/);
      if(!m) continue;
      const id = m[1];
      let rest = m[2].trim();
      let parts = rest.split(/\t/).map(p=>p.trim()).filter(p=>p!=='');
      if(parts.length===1) parts = rest.split(/\s{2,}/).map(p=>p.trim()).filter(p=>p!=='');
      let name = parts[0];
      let preparo = parts.length>1 ? parts.slice(1).join(' ').trim() : null;
      if(preparo){ preparo = preparo.replace(/\(.*\)/g,'').trim(); if(preparo==='') preparo=null; }
      kb[id] = { id, name: name||('ID '+id), preparo: preparo||null, default_portion_g: null, kcal_per_100g: null, pode_ser_cru: (preparo ? /cru|crua/i.test(preparo) : true) };
    }
    return kb;
  }

  /* ---------- Parser compacto (corrigido para aceitar L<id><qty> e L<len><id><qty>) ---------- */
  function parseCompactWithGroups(raw){
    if(!raw || typeof raw !== 'string') throw new Error('Código inválido');
    const code = raw.trim();
    let i=0;
    function peek(){ return code[i]; }
    function next(){ return code[i++]; }
    function eof(){ return i >= code.length; }
    function readDigits(){ let s=''; while(!eof() && /\d/.test(peek())) s += next(); return s; }
    function expect(ch,msg){ if(peek() !== ch) throw new Error(msg + ' (pos ' + i + '). Encontrado: "' + (peek()||'EOF') + '"'); }

    // helpers to read L... id+qty. Accept two variants:
    // 1) L <lenDigit 1-4> <id len> <qty 3>   (legacy)
    // 2) L <digits...>  where last 3 digits are qty and the rest is id (most common)
    function read_L_id_qty(){
      // we are at position where peek() === 'L'
      next(); // consume 'L'
      if(eof()) throw new Error('Conteúdo inesperado após "L" (pos ' + i + ')');
      // lookahead digits
      const remaining = code.slice(i);
      // If next char is a single digit between 1 and 4 and followed by at least len+3 digits, interpret as length prefix
      const nextChar = remaining[0];
      if(/^[1-4]$/.test(nextChar)){
        // try legacy format
        const len = parseInt(nextChar,10);
        // check we have enough digits for id + qty
        const after = code.slice(i+1); // after length-digit
        const m = after.match(/^(\d{` + len + `})(\d{3})/); // this inline won't work; do manual
        // implement manual:
        i++; // consume length-digit
        const idPart = code.substr(i, len);
        if(idPart.length < len || !/^\d+$/.test(idPart)) throw new Error('ID inválido no formato L<len><id><qty> (pos ' + i + ')');
        i += len;
        const qtyPart = code.substr(i, 3);
        if(qtyPart.length < 3 || !/^\d{3}$/.test(qtyPart)) throw new Error('Quantidade inválida (esperado 3 dígitos) na pos ' + i);
        i += 3;
        return { id: idPart.replace(/^0+/, '') || '0', qty: parseInt(qtyPart,10) };
      } else {
        // variant 2: read consecutive digits; must be at least 4 digits (1+3)
        const digits = readDigits();
        if(digits.length < 4) throw new Error('Esperado L<id><qty(3)> com pelo menos 4 dígitos após L (pos ' + (i - digits.length) + ')');
        const qtyStr = digits.slice(-3);
        const idStr = digits.slice(0, -3).replace(/^0+/, '') || '0';
        return { id: idStr, qty: parseInt(qtyStr,10) };
      }
    }

    // Start parse
    // Header: <type><months><tabCount>
    if(eof()) throw new Error('Código vazio');
    const type = next(); // 1 char
    if(eof()) throw new Error('Código incompleto: meses ausentes');
    const monthsChar = next();
    if(!/^\d$/.test(monthsChar)) throw new Error('Número de meses inválido na posição 2');
    const months = parseInt(monthsChar,10);
    if(eof()) throw new Error('Código incompleto: tabCount ausente');
    const tabCountChar = next();
    if(!/^\d$/.test(tabCountChar)) throw new Error('Número de abas inválido na posição 3');
    const tabCount = parseInt(tabCountChar,10);

    const tabs = [];
    for(let t=0; t<tabCount; t++){
      // expect 'B'
      if(eof()) throw new Error("Esperado 'B' (início de aba) mas fim do código");
      const bChar = next().toUpperCase();
      if(bChar !== 'B') throw new Error("Esperado 'B' no início da aba na posição " + (i-1));
      // months start/end/daysVar/mealsBitmap(2)
      if(eof()) throw new Error('Código incompleto na aba: faltam dados de mês');
      const ms = next(); if(!/^\d$/.test(ms)) throw new Error('Mês inicial inválido em pos ' + (i-1));
      const me = next(); if(!/^\d$/.test(me)) throw new Error('Mês final inválido em pos ' + (i-1));
      const daysVarChar = next(); if(!/^\d$/.test(daysVarChar)) throw new Error('Número de dias inválido em pos ' + (i-1));
      const monthsStart = parseInt(ms,10), monthsEnd = parseInt(me,10), daysVar = parseInt(daysVarChar,10);
      // meals bitmap: two digits
      const mb1 = next(); const mb2 = next();
      if(!/^\d$/.test(mb1) || !/^\d$/.test(mb2)) throw new Error('Bitmap de refeições inválido (são 2 dígitos) em pos ' + (i-2));
      const mealsBitmap = parseInt(mb1+mb2,10);

      const days = [];
      for(let d=0; d<daysVar; d++){
        // expect 'd' or 'D'
        if(eof()) throw new Error("Esperado 'd' (início de dia) mas fim do código");
        const dayChar = next().toUpperCase();
        if(dayChar !== 'D') throw new Error("Esperado 'd' no início do dia na posição " + (i-1));
        // dayIndex (1 digit) and mealEntryCount (1 digit)
        const dayIdxChar = next(); if(!/^\d$/.test(dayIdxChar)) throw new Error('Índice do dia inválido em pos ' + (i-1));
        const mealEntryCountChar = next(); if(!/^\d$/.test(mealEntryCountChar)) throw new Error('Contagem de refeições inválida em pos ' + (i-1));
        const dayIndex = parseInt(dayIdxChar,10), mealEntryCount = parseInt(mealEntryCountChar,10);
        const slots = [];
        for(let m=0; m<mealEntryCount; m++){
          // mealCode (1 digit), itemEntryCount(1 digit)
          const mealCodeChar = next(); if(!/^\d$/.test(mealCodeChar)) throw new Error('Código da refeição inválido em pos ' + (i-1));
          const mealCode = parseInt(mealCodeChar,10);
          const itemEntryCountChar = next(); if(!/^\d$/.test(itemEntryCountChar)) throw new Error('Contagem de itens inválida em pos ' + (i-1));
          const itemEntryCount = parseInt(itemEntryCountChar,10);
          const entries = [];
          for(let e=0; e<itemEntryCount; e++){
            if(eof()) throw new Error('Fim inesperado dentro de entries');
            const p = peek();
            if(p.toUpperCase() === 'G'){
              next(); // consume G
              if(eof()) throw new Error('Fim inesperado após G');
              const groupCountChar = next(); if(!/^\d$/.test(groupCountChar)) throw new Error('Contagem de grupos inválida após G em pos ' + (i-1));
              const groupCount = parseInt(groupCountChar,10);
              const groupItems = [];
              for(let g=0; g<groupCount; g++){
                // read L... pattern
                if(eof()) throw new Error('Fim inesperado dentro de grupo');
                if(peek().toUpperCase() !== 'L') throw new Error("Esperado 'L' antes do item do grupo em pos " + i);
                const it = read_L_id_qty();
                groupItems.push({ id: it.id, qty: it.qty });
              }
              entries.push({ type:'group', items: groupItems });
            } else {
              // single item: expect 'L'
              if(peek().toUpperCase() !== 'L') throw new Error("Esperado 'L' antes do item em pos " + i);
              const it = read_L_id_qty();
              entries.push({ type:'item', item: { id: it.id, qty: it.qty } });
            }
          } // end entries loop
          slots.push({ mealCode, entries });
        } // end mealEntryCount loop
        days.push({ dayIndex, slots });
      } // end days loop

      // expect 'E' end of tab
      if(eof()) throw new Error("Esperado 'E' (fim de aba) mas fim do código");
      const endChar = next().toUpperCase();
      if(endChar !== 'E') throw new Error("Esperado 'E' no fim da aba na posição " + (i-1));
      tabs.push({ monthStart: monthsStart, monthEnd: monthsEnd, daysVar, mealsBitmap, days });
    } // end tabs

    // if extra content left, error
    if(!eof()){
      const rest = code.slice(i);
      throw new Error('Conteúdo extra após parse na pos ' + i + ': "' + rest.slice(0,40) + '"');
    }

    return { type, months, tabs };
  }

  /* ---------- normalize & render (simplificado) ---------- */
  function normalizePlan(plan, kb){
    const fallback = 100;
    plan.tabs.forEach(tab=>{
      tab.days.forEach(day=>{
        day.slots.forEach(slot=>{
          slot.entries.forEach(entry=>{
            if(entry.type==='group'){
              entry.items.forEach(it=>{
                const kbItem = kb[it.id] || null;
                it.kb = kbItem;
                it.used_qty = it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : fallback) : it.qty;
                it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty*100/kbItem.default_portion_g) : null;
                it.kcal = kbItem && kbItem.kcal_per_100g ? Math.round(kbItem.kcal_per_100g * it.used_qty/100) : null;
              });
              entry.group_kcal = entry.items.reduce((s,i)=> s + (i.kcal || 0), 0);
            } else {
              const it = entry.item;
              const kbItem = kb[it.id] || null;
              it.kb = kbItem;
              it.used_qty = it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : fallback) : it.qty;
              it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty*100/kbItem.default_portion_g) : null;
              it.kcal = kbItem && kbItem.kcal_per_100g ? Math.round(kbItem.kcal_per_100g * it.used_qty/100) : null;
            }
          });
          slot.meal_total_kcal = slot.entries.reduce((s,en)=> s + (en.type==='group' ? (en.group_kcal || 0) : (en.item.kcal || 0)), 0);
        });
      });
    });
    return plan;
  }

  const MEAL_NAMES = { 1:"Refeição 1 (Café da manhã)", 2:"Refeição 2 (Lanche)", 3:"Refeição 3 (Almoço)", 4:"Refeição 4 (Café da tarde)", 5:"Refeição 5 (Janta)" };

  function renderForm(plan, kb, container){
    container.innerHTML = '';
    const summary = document.createElement('div'); summary.style.marginBottom='10px';
    summary.innerHTML = `<strong>Plano: type=${plan.type}, months=${plan.months}, abas=${plan.tabs.length}</strong>`;
    container.appendChild(summary);
    plan.tabs.forEach((tab,tabIdx)=>{
      const tabEl = document.createElement('div'); tabEl.style.marginTop='12px';
      tabEl.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Mês ${tab.monthStart}${tab.monthStart!==tab.monthEnd?(' - '+tab.monthEnd):''} • dias: ${tab.days.length}</div>`;
      tab.days.forEach(day=>{
        const dayCard = document.createElement('div'); dayCard.style.border='1px solid rgba(255,255,255,0.03)'; dayCard.style.padding='8px'; dayCard.style.borderRadius='8px'; dayCard.style.marginBottom='8px';
        dayCard.innerHTML = `<div style="font-weight:700">Dia ${day.dayIndex}</div>`;
        day.slots.forEach(slot=>{
          const mealDiv = document.createElement('div'); mealDiv.style.marginTop='8px';
          mealDiv.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${MEAL_NAMES[slot.mealCode]||('Refeição '+slot.mealCode)} • kcal: ${slot.meal_total_kcal ?? 0}</div>`;
          slot.entries.forEach(entry=>{
            if(entry.type === 'group'){
              const g = document.createElement('div'); g.style.border='1px dashed rgba(255,255,255,0.03)'; g.style.padding='8px'; g.style.borderRadius='8px'; g.style.marginBottom='8px';
              g.innerHTML = `<div style="font-weight:700">Grupo (kcal: ${entry.group_kcal ?? 0})</div>`;
              entry.items.forEach(it=>{
                const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px';
                const name = it.kb?.name || ('ID '+it.id);
                row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id}) porção padrão: ${it.kb?.default_portion_g ?? '—'} g</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
                g.appendChild(row);
              });
              mealDiv.appendChild(g);
            } else {
              const it = entry.item;
              const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px'; row.style.padding='6px'; row.style.border='1px solid rgba(255,255,255,0.02)'; row.style.borderRadius='8px';
              const name = it.kb?.name || ('ID '+it.id);
              row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id}) porção padrão: ${it.kb?.default_portion_g ?? '—'} g</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
              mealDiv.appendChild(row);
            }
          });
          dayCard.appendChild(mealDiv);
        });
        tabEl.appendChild(dayCard);
      });
      container.appendChild(tabEl);
    });
  }

  /* ---------- Wiring UI ---------- */
  const KB = parseKBText(kbText);
  document.getElementById('kbPreview').innerText = 'KB entries: ' + Object.keys(KB).length + ' (loaded).';

  const compactInput = document.getElementById('compactInput');
  const runBtn = document.getElementById('runBtn');
  const clearBtn = document.getElementById('clearBtn');
  const copyBtn = document.getElementById('copyBtn');
  const compactRoot = document.getElementById('compactRoot');
  const compactError = document.getElementById('compactError');

  function showError(msg){
    compactError.style.display = 'block';
    compactError.innerText = msg;
  }
  function hideError(){
    compactError.style.display = 'none';
    compactError.innerText = '';
  }

  runBtn.addEventListener('click', ()=>{
    hideError();
    compactRoot.innerHTML = '';
    const code = (compactInput.value||'').trim();
    if(!code){ showError('Cole um código compacto antes de rodar.'); return; }
    try {
      const plan = parseCompactWithGroups(code);
      normalizePlan(plan, KB);
      renderForm(plan, KB, compactRoot);
      window.currentCompactPlan = plan;
    } catch(err){
      showError('Erro ao parsear: ' + (err && err.message ? err.message : String(err)));
    }
  });

  clearBtn.addEventListener('click', ()=>{
    compactInput.value = '';
    compactRoot.innerHTML = '';
    hideError();
    window.currentCompactPlan = null;
  });

  copyBtn.addEventListener('click', ()=>{
    if(window.currentCompactPlan){
      navigator.clipboard.writeText(JSON.stringify(window.currentCompactPlan, null, 2)).then(()=> alert('JSON copiado para clipboard.'));
    } else {
      alert('Nenhum plano carregado para copiar.');
    }
  });

  /* ---------- menu & tab wiring & remaining original logic ---------- */
  document.getElementById('menu-toggle').addEventListener('click', function(){ this.classList.toggle('open'); document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); });
  document.getElementById('overlay').addEventListener('click', function(){ document.getElementById('menu-toggle').classList.remove('open'); document.getElementById('sidebar').classList.remove('open'); this.classList.remove('show'); });
  document.querySelectorAll('.nav-link').forEach(link=>{
    link.addEventListener('click', (e)=>{
      e.preventDefault();
      const tabId = link.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
      link.classList.add('active');
      document.getElementById('menu-toggle').classList.remove('open');
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('show');
    });
  });

  /* mantém sua lógica de inicialização e formulários originais (simplificado aqui para demo) */
  document.addEventListener('DOMContentLoaded', () => {
    // mostra formulário principal (sem supabase login real aqui na demo)
    const fw = document.getElementById('form-wrapper'); if(fw) fw.style.display='block';
    // ligações UX (suplementos, paste simulation)
    const objetivoInput = document.getElementById('objetivo'); if(objetivoInput){ objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none'; }); }
    const usoSup = document.getElementById('uso_suplemento'); if(usoSup){ usoSup.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display = this.value==='Sim' ? 'block' : 'none'; if(this.value !== 'Sim') document.getElementById('quais_suplementos').value = ''; }); }
    const pasteTreino = document.getElementById('paste-treino'); const pasteDieta = document.getElementById('paste-dieta');
    function simulatePaste(btn, targetId){
      const txt = document.getElementById('prompt-output').textContent || '';
      const target = document.getElementById(targetId);
      if(btn.disabled) return;
      btn.classList.add('pasted','done');
      btn.disabled = true;
      if(target) target.value = txt.trim() || '[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]';
    }
    if(pasteTreino) pasteTreino.addEventListener('click', ()=> simulatePaste(pasteTreino,'objetivo_treino'));
    if(pasteDieta) pasteDieta.addEventListener('click', ()=> simulatePaste(pasteDieta,'objetivo_dieta'));
  });
</script>
</body>
</html>
