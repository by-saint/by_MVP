<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Plataforma de IA — Saúde & Estética (com parser integrado)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--color-ia-specialist:#007BFF;--color-video-lessons:#8A2BE2;--color-journey:#DC143C;--journey-red-1:#ff2646;--journey-red-2:#be123c}
  html{scroll-behavior:smooth}
  body{font-family:'Poppins',sans-serif;background:#121212;color:#E0E0E0;margin:0;padding:40px 20px}
  .container{max-width:1600px;margin:0 auto;padding:0 20px}
  h1,h2,h3{color:#f0f0f0;text-align:center;margin-top:30px;margin-bottom:15px}
  .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
  .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px;transition:all .3s}
  .menu-toggle.open .bar:nth-child(1){transform:translateY(8px) rotate(45deg)}
  .menu-toggle.open .bar:nth-child(2){opacity:0}
  .menu-toggle.open .bar:nth-child(3){transform:translateY(-8px) rotate(-45deg)}
  .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
  .sidebar.open{left:0}
  .sidebar nav{padding-top:100px}
  .sidebar nav ul{list-style:none;padding:0;margin:0}
  .sidebar nav a{display:block;padding:15px 30px;text-decoration:none;font-size:1.1em;font-weight:700;border-left:5px solid transparent;transition:background .2s,border-left .2s}
  .sidebar nav a:hover{background:#2c2c2c}
  .link-ia,.link-aulas,.link-percurso{background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .link-ia{background-image:linear-gradient(90deg,#38b6ff,#0056b3)}
  .link-aulas{background-image:linear-gradient(90deg,#c048f2,#6b21a8)}
  .link-percurso{background-image:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2))}
  .sidebar-footer{padding:20px 30px;text-align:center}
  .sidebar-config-btn{width:100%;background:transparent;border:1px solid #444;color:#aaa;padding:10px;border-radius:8px;cursor:pointer;font-size:.95em;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}
  .sidebar-action-btn{width:100%;padding:10px;border-radius:8px;cursor:pointer;font-size:.9em;font-weight:600;margin-top:10px}
  .hidden{display:none}
  .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
  .overlay.show{opacity:1;visibility:visible}
  .header{display:flex;justify-content:flex-end;align-items:center;margin-bottom:20px}
  #welcome-msg{color:#bbb}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .form-wrapper,.results-wrapper{width:100%;max-width:800px;margin:0 auto}
  .form-container,.results-container,.percurso-container{background:#1E1E1E;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid #333}
  .form-group{margin-bottom:25px}
  label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
  input,select,textarea{width:100%;padding:12px;background:#2C2C2C;border:1px solid #444;border-radius:8px;color:#E0E0E0;font-size:16px;box-sizing:border-box}
  textarea{resize:vertical;min-height:100px}
  .goal-section{background:linear-gradient(145deg,#2a2a2a,#1a1a1a);border:1px solid #444;padding:30px;margin-bottom:40px;border-radius:10px;text-align:center}
  .goal-title{font-size:28px;font-weight:700;background:linear-gradient(90deg,#007BFF,#00C6FF);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
  .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.25));border:1px solid rgba(190,18,60,.12);padding:20px;border-radius:12px}
  .paste-btn{--h:36px;display:inline-flex;align-items:center;justify-content:center;height:var(--h);min-width:160px;padding:8px 24px;border-radius:999px;background:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2));border:none;color:#fff;font-weight:700;font-size:16px;cursor:pointer;position:relative;overflow:visible;transition:transform 160ms,box-shadow 160ms}
  .small-note{font-size:13px;color:#cfc;opacity:.7;margin-top:6px}
  /* compact UI */
  .compact-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.12));border:1px solid rgba(255,255,255,.02);padding:16px;border-radius:10px;margin-top:12px}
  .compact-input{width:100%;min-height:90px;padding:10px;border-radius:8px;background:#151515;border:1px solid #333;color:#e6eefc}
  .compact-controls{display:flex;gap:8px;margin-top:8px;align-items:center}
  .compact-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,#ff2d5e,#be123c);color:white;font-weight:700}
  .compact-clear{background:#2b2b2b;border:1px solid #333;color:#ddd}
  .compact-root{margin-top:12px}
  .compact-error{margin-top:8px;padding:8px;border-radius:8px;background:#3b0f0f;color:#ffdede;display:none}
  .kb-preview{margin-top:8px;font-size:13px;color:#bbb}
  @media(max-width:900px){.percurso-forms{grid-template-columns:1fr}.menu-toggle{top:14px;left:14px;width:44px;height:44px}.menu-toggle .bar{width:20px;height:3px}}
</style>
</head>
<body>
<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar">
  <nav>
    <ul>
      <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
      <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
      <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
    </ul>
  </nav>
  <div class="sidebar-footer">
    <button id="config-btn" class="sidebar-config-btn">⚙️ Configurações</button>
    <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
    <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
  </div>
</div>
<div class="overlay" id="overlay"></div>

<div class="container">
  <div class="header"><p id="welcome-msg">A carregar...</p></div>

  <!-- (Mantive as outras abas e conteúdo original até Percurso) -->
  <div id="ia-planejamento" class="tab-content active">
    <!-- ... seu conteúdo original permanece aqui (omitido para foco) ... -->
    <div class="form-wrapper" id="form-wrapper" style="display:none">
      <!-- original form -->
    </div>
    <div class="results-wrapper" id="results-wrapper" style="display:none">
      <!-- results original -->
    </div>
  </div>

  <div id="video-aulas" class="tab-content">
    <h2>Nossas Aulas</h2>
    <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3></div>
    <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3></div>
    <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3></div>
  </div>

  <div id="percurso" class="tab-content">
    <div class="percurso-container">
      <h2>Meu Percurso</h2>
      <p style="text-align:center;color:#bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>
      <div class="percurso-forms">
        <div class="percurso-card" id="treino-card">
          <h4>Formulário: Treino</h4>
          <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
          <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
          <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
            <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="label">Colar plano</span></button>
            <div class="small-note">Clique para colar (simulação)</div>
          </div>
        </div>

        <!-- DIETA CARD: substituído por UI do parser -->
        <div class="percurso-card" id="dieta-card">
          <h4>Formulário: Dieta</h4>
          <div class="compact-card">
            <label for="compactInputPercurso">Cole aqui o código compacto (formato compacto → formulário):</label>
            <textarea id="compactInputPercurso" class="compact-input" placeholder="Cole o código compacto aqui...">D12B11131d11111L290100L312150EB21131d11111L237200L309180E</textarea>
            <div class="compact-controls">
              <button id="runCompactBtn" class="compact-btn">Rodar Código</button>
              <button id="clearCompactBtn" class="compact-btn compact-clear">Limpar</button>
              <button id="copyJsonBtn" class="compact-btn" style="background:#0b74ff">Copiar JSON</button>
            </div>
            <div id="compactError" class="compact-error"></div>
            <div id="kbPreviewSmall" class="kb-preview"></div>
            <div id="compactRoot" class="compact-root"></div>
          </div>
        </div>
      </div>

      <p style="text-align:center;color:#888;margin-top:18px;">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo). Eles apenas alternam o estado visual por enquanto.</p>
    </div>
  </div>

</div>

<!-- ====== Parser code + KB completa ====== -->
<script>
/* KB completa (colei aqui a lista inteira que você enviou) */
const kbText = `
1\tAbóbora, cabotián\tcozida
5\tAbóbora, moranga\trefogada
7\tAbobrinha, italiana\tcozida
8\tAbobrinha, italiana\tcrua
9\tAbobrinha, italiana\trefogada
10\tAbobrinha, paulista\tcrua
11\tAcelga\tcrua
12\tAgrião\tcru
13\tAipo\tcru
14\tAlface, americana\tcrua
15\tAlface, crespa\tcrua
16\tAlface, lisa\tcrua
17\tAlface, roxa\tcrua
18\tAlfavaca\tcrua
19\tAlho\tcru
20\tAlho-poró\tcru
21\tAlmeirão\tcru
22\tAlmeirão\trefogado
23\tBatata, baroa\tcozida
25\tBatata, doce\tcozida
27\tBatata frita, tipo chips\tindustrializada
28\tBatata, inglesa\tcozida
30\tBatata, inglesa\tfrita
31\tBatata, inglesa\tsauté
32\tBerinjela\tcozida
34\tBeterraba\tcozida
35\tBeterraba\tcrua
36\tBrócolis\tcozido
37\tBrócolis\tcru
38\tCará\tcozido
40\tCanru\tcru
41\tCatalonha\tcrua
42\tCatalonha\trefogada
43\tCebola\tcrua
44\tCebolinha\tcrua
45\tCenoura\tcozida
46\tCenoura\tcrua
47\tChicória\tcrua
48\tChuchu\tcozido
49\tChuchu\tcru
50\tCoentro, folhas\tdesidratadas
51\tCouve, manteiga\tcrua
52\tCouve, manteiga\trefogada
53\tCouve-flor\tcozida
54\tCouve-flor\tcrua
55\tEspinafre, Nova Zelândia\tcru
56\tEspinafre, Nova Zelândia\trefogado
58\tJiló\tcru
60\tMandioca\tcozida
62\tManjericão\tcru
63\tMaxixe\tcru
64\tMostarda, folha\tcrua
65\tNabo\tcru
66\tNhoque, batata\tcozido
67\tPalmito, juçara\tem conserva
68\tPalmito, pupunha\tem conserva
69\tPepino\tcru
70\tPimentão, amarelo\tcru
71\tPimentão, verde\tcru
72\tPimentão, vermelho\tcru
73\tQuiabo\tcru
74\tRabanete\tcru
75\tRepolho, branco\tcru
76\tRepolho, roxo\tcru
77\tRepolho, roxo\trefogado
78\tRúcula\tcrua
79\tSalsa\tcrua
80\tSeleta de legumes\tenlatada
81\tSerralha\tcrua
82\tTaioba\tcrua
83\tTomate, com semente\tcru
84\tTomate\textrato
85\tTomate\tmolho industrializado
86\tTomate\tpurê
87\tTomate\tsalada
88\tVagem\tcrua
89\tAbacate\tcru
90\tAbacaxi\tcru
92\tAbiu\tcru
93\tAçaí, polpa, com xarope\t(incluído)
95\tAcerola\tcrua
96\tAmeixa, calda\tenlatada
97\tAmeixa\tcrua
98\tAtemoia\tcrua
99\tBanana, da terra\tcrua
100\tBanana, doce\tem barra
101\tBanana, figo\tcrua
102\tBanana, maçã\tcrua
103\tBanana, nanica\tcrua
104\tBanana, ouro\tcrua
105\tBanana, pacova\tcrua
106\tBanana, prata\tcrua
107\tCacau\tcru
108\tCajá-Manga\tcru
110\tCaju, suco\tconcentrado, envasado
111\tCajuí, chocolate\tcru
112\tCarambola\tcrua
113\tCiriguela\tcrua
114\tCupuaçu\tcru
116\tFigo\tcru
117\tFigo, enlatado\tem calda
118\tFruta-pão\tcrua
119\tGoiaba, branca, com casca\tcrua
120\tGoiaba, doce\tem pasta
121\tGoiaba, doce, cascão
122\tGoiaba, vermelha, com casca\tcrua
123\tGraviola\tcrua
125\tJabuticaba\tcrua
126\tJaca\tcrua
127\tJambo\tcru
128\tJamelão\tcru
129\tKiwi\tcru
130\tLaranja, baía\tcrua
131\tLaranja, baía\tsuco
132\tLaranja, da terra\tcrua
133\tLaranja, da terra\tsuco
134\tLaranja, lima\tcrua
135\tLaranja, lima\tsuco
136\tLaranja, pêra\tcrua
137\tLaranja, suco\t(suco genérico)
138\tLaranja, valência\tcrua
139\tLaranja, valência\tsuco
140\tLimão, cravo\tsuco
141\tLimão, tahiti\tcru
142\tMaçã, Argentina, com casca\tcrua
143\tMaçã, Fuji, com casca\tcrua
144\tMacaúba\tcru
145\tMamão, doce, em calda\tdrenado
146\tMamão, formosa\tcru
147\tMamão, papaia\tcru
148\tMamão verde, doce em calda\tdrenado
149\tManga, Haden\tcrua
150\tManga, Palmer\tcrua
152\tManga, Tommy Atkins\tcrua
153\tMangarataia\tcrua
155\tMaracujá, suco\tconcentrado
156\tMelancia\tcrua
157\tMelão\tcru
158\tMexerica, Murcote\tcrua
159\tMexerica, Rio\tcrua
160\tMorango\tcru
161\tNêspera\tcru
163\tPêra, Park\tcrua
164\tPêra, Williams\tcrua
165\tPêssego, Aurora\tcru
166\tPêssego, enlatado, em calda
167\tPinha\tcrua
168\tPitanga\tcrua
169\tRomã\tcrua
170\tTamarindo\tcru
171\tTangerina, Ponkan\tcrua
172\tTangerina, Ponkan\tsuco
173\tTucumã\tcru
174\tUmbu\tcru
176\tUva, Itália\tcrua
177\tUva, Rubi\tcrua
178\tUva, suco\tconcentrado, envasado
179\tAzeite, de dendê\t(óleo/gordura)
180\tAzeite, de oliva, extra virgem\t(óleo/gordura)
181\tManteiga, com sal\t(derivado)
182\tManteiga, sem sal\t(derivado)
183\tMargarina, com óleo hidrogenado\t(derivado)
184\tÓleo, de soja\t(óleo)
185\tAbadejo, filé, congelado\tassado
186\tAbadejo, filé, congelado\tcozido
188\tAbadejo, filé, congelado\tgrelhado
189\tAtum, conserva em óleo\t(conserva)
192\tBacalhau, salgado\trefogado
193\tCação, posta, com farinha de trigo\tfrita
194\tCação, posta\tcozida
196\tCamarão, Rio Grande, grande\tcozido
198\tCamarão, Sete Barbas, sem cabeça, com casca\tfrito
199\tCaranguejo\tcozido
200\tCorimbatá\tassado
201\tCorimbatá\tcozido
204\tCorvina grande\tassada
205\tCorvina grande\tcozida
206\tDourada de água doce\tfresca
208\tLambari, congelado\tfrito
209\tManjuba\tfrita
210\tManjuba, com farinha de trigo\tfrita
211\tManjuba\tfrita
212\tMerluza, filé\tassado
213\tMerluza, filé\tcozido
215\tPescada, branca\tfrita
217\tPescada, com farinha de trigo\tfrita
219\tPescada, filé\tfrita
220\tPescada, filé\tmolho escabeche
222\tPintado\tassado
224\tPintado\tgrelhado
226\tSalmão, com pele, fresco\tgrelhado
228\tSalmão, sem pele, fresco\tgrelhado
229\tSardinha\tassada
230\tSardinha, conserva em óleo\t(conserva)
231\tSardinha\tfrita
234\tArroz, integral\tcozido
237\tArroz, tipo 1\tcozido
238\tAveia, flocos\tcrua
239\tBiscoito, doce, maisena\t(processado)
240\tBiscoito, doce, recheado com chocolate\t(processado)
241\tBiscoito, doce, recheado com morango\t(processado)
242\tBiscoito, doce, wafer, recheado de chocolate\t(processado)
243\tBiscoito, doce, wafer, recheado de morango\t(processado)
244\tBiscoito, salgado, cream cracker\t(processado)
245\tBiscoito, polvilho\tdoce
246\tBolo, mistura para\t(processado)
247\tBolo, pronto, aipim\t(processado)
248\tBolo, pronto, chocolate\t(processado)
249\tBolo, pronto, coco\t(processado)
251\tCanjica, com leite integral\t(preparado)
252\tCereais, milho, flocos\tcom sal
253\tCereais, milho, flocos\tsem sal
254\tCereais, milho, infantil\t(processado)
255\tCereais, mistura para vitamina\t(processado)
256\tCereal matinal, milho\t(processado)
257\tCereal matinal, milho, açúcar\t(processado)
258\tCreme de arroz, pó\t(processado)
259\tCreme de milho, pó\t(processado)
260\tCurau, milho verde\t(preparado)
261\tFarinha, de arroz, enriquecida\t(derivado)
262\tFarinha, de centeio, integral\t(derivado)
263\tFarinha, de milho, amarela\t(derivado)
264\tFarinha, de rosca\t(derivado)
265\tFarinha, de trigo\t(derivado)
266\tFarinha, láctea, de cereais\t(derivado)
267\tFarinha, de mandioca, torrada\t(derivado)
268\tFarinha, de puba\t(derivado)
269\tFeijão, de mandioca\tcozido
271\tLasanha, massa fresca\tcozida
273\tMacarrão, instantâneo\t(processado)
278\tMilho, verde\tcru
279\tMilho, verde, enlatado\tdrenado
280\tMingau tradicional, pó\t(processado)
281\tPamonha, barra para cozimento\t(preparado)
282\tPão, aveia, forma\t(processado)
283\tPão, de glúten, forma\t(processado)
284\tPão, de glúten, forma\t(variante)
285\tPão, milho, forma\t(processado)
288\tPão, trigo, forma, integral\t(processado)
289\tPão, trigo, francês\t(processado)
290\tPão, trigo, sovado\t(processado)
293\tPastel, de queijo\tfrito
294\tPastel, de queijo\tfrito
295\tPastel, massa\tfrita
296\tPastel, massa\tfrita
297\tPipoca, com óleo de soja\tsem sal
298\tPolenta, pré-cozida\t(processado)
299\tTorrada, pão francês\t(processado)
300\tAçúcar, mascavo\t(ingrediente)
301\tAçúcar, refinado\t(ingrediente)
302\tChocolate, ao leite\t(processado)
303\tChocolate, ao leite, com castanha do Pará\t(processado)
304\tChocolate, ao leite, dietético\t(processado)
305\tChocolate, meio amargo\t(processado)
306\tCocada branca\t(doces)
307\tDoce, de abóbora, cremoso\t(doces)
308\tDoce, de leite, cremoso\t(doces)
309\tGeleia, mocotó, natural\t(doces)
310\tGlicose de milho\t(ingrediente)
311\tMaria mole\t(doces)
312\tMaria mole, coco queimado\t(doces)
313\tMarmelada\t(doces)
314\tMel, de abelha\t(doces)
315\tMelado\t(doces)
316\tQuindim\t(doces)
317\tRapadura\t(doces)
318\tCafé, pó, torrado\t(bebida/ingrediente)
319\tCapuccino, pó\t(bebida/ingrediente)
320\tFermento em pó, químico\t(ingrediente)
321\tFermento, biológico, levedura, tablete\t(ingrediente)
322\tGelatina, sabores variados, pó\t(ingrediente)
323\tSal, dietético\t(ingrediente)
324\tSal, grosso\t(ingrediente)
325\tShoyu\t(ingrediente/tempero)
326\tTempero à base de sal\t(tempero)
327\tAzeitona, preta\tconserva
328\tAzeitona, verde\tconserva
329\tChantilly, spray, com gordura vegetal\t(processado)
330\tLeite, de coco\t(derivado)
331\tMaionese, tradicional com ovos\t(condimento)
332\tBebida isotônica\t(processado)
333\tCafé, infusão\t10%
334\tCana, aguardente\t(álcool)
335\tCana, caldo\t(bebida)
336\tCerveja, pilsen\t(bebida)
337\tChá, erva-doce\tinfusão
338\tChá, mate\tinfusão
339\tChá, preto\tinfusão
340\tCoco, água de\t(bebida)
341\tRefrigerante, água tônica\t(bebida)
342\tRefrigerante, tipo cola\t(bebida)
343\tRefrigerante, tipo guaraná\t(bebida)
344\tRefrigerante, tipo laranja\t(bebida)
345\tRefrigerante, tipo limão\t(bebida)
346\tAchocolatado, pó\t(bebida)
347\tTacacá\t(prato)
348\tTapioca, com manteiga\t(prato)
349\tTucupi, com pimenta-de-cheiro\t(prato/molho)
350\tVaca atolada\t(prato)
351\tVatapá\t(prato)
352\tVirado à paulista\t(prato)
353\tYakisoba\t(prato)
354\tAcarajé\t(prato)
355\tArroz carreteiro\t(prato)
356\tBaião de dois, arroz e feijão-de-corda\t(prato)
357\tBarreado\t(prato)
358\tBife à cavalo, com contra filé\t(prato)
359\tBolinho de arroz\t(prato)
360\tCamarão à baiana\t(prato)
361\tCharuto, de repolho\t(prato)
362\tCuscuz, de milho, cozido com sal\t(prato)
363\tCuscuz, paulista\t(prato)
364\tCuxá, molho\t(prato/molho)
365\tDobradinha\t(prato)
366\tEstrogonofe de carne\t(prato)
367\tEstrogonofe de frango\t(prato)
368\tFeijoada tropeiro mineiro\t(prato)
369\tFeijoada\t(prato)
370\tFrango, com açafrão\t(prato)
371\tMacarrão, molho bolonhesa\t(prato)
372\tManiçoba\t(prato)
373\tQuibebe\t(prato)
374\tSalada, de legumes, com maionese\t(prato)
375\tSalada, de legumes, cozida no vapor\t(prato)
376\tSalpicão, de frango\t(prato)
377\tSarapatel\t(prato)
378\tTabule\t(prato)
379\tAmendoim, grão\tcru
380\tAmendoim, torrado, salgado\t(torrado/salgado)
381\tErvilha, em vagem\t(crua/cozida)
382\tErvilha, enlatada\tdrenada
383\tFeijão, carioca\tcozido
385\tFeijão, fradinho\tcozido
387\tFeijão, jalo\tcozido
389\tFeijão, preto\tcozido
391\tFeijão, rajado\tcozido
393\tFeijão, rosinha\tcozido
395\tFeijão, roxo\tcozido
399\tLentilha\tcozida
401\tPaçoca, amendoim\t(processado)
402\tPé-de-moleque, amendoim\t(doces)
403\tSoja, farinha\t(derivado)
404\tSoja, extrato solúvel, natural, fluido\t(produto)
405\tSoja, extrato solúvel, pó\t(produto)
406\tSoja, queijo (tofu)\t(produto)
408\tTremoço\tem conserva
409\tAmêndoa, torrada, salgada\t(oleaginosa)
410\tCastanha-de-caju, torrada, salgada\t(oleaginosa)
411\tCastanha-do-Brasil\tcrua
412\tCoco\tcru
413\tGergelim, semente\t(semente)
414\tLinhaça, semente\t(semente)
415\tPinhão\tcozido
416\tPupunha\tcozida
417\tNoz\tcrua
419\tPresunto, com capa de gordura\t(processado)
420\tPresunto, sem capa de gordura\t(processado)
421\tQuibe\tassado
423\tQuibe\tfrito
424\tSalame\t(processado)
426\tToucinho\tfrito
427\tApresentado\t(linha ambígua)
428\tCaldo de carne, tablete\t(ingrediente)
429\tCaldo de galinha, tablete\t(ingrediente)
430\tCarne, bovina, acém, moído, cozido
432\tCarne, bovina, acém, sem gordura, cozido
435\tCarne, bovina, almôndegas, fritas
436\tCarne, bovina, bucho, cozido
439\tCarne, bovina, capa de contra-filé, com gordura\tgrelhada
441\tCarne, bovina, capa de contra-filé, sem gordura\tgrelhada
442\tCarne, bovina, charque, cozido
444\tCarne, bovina, filé à milanesa\tfrita/assada
446\tCarne, bovina, contra-filé de costela\tgrelhado
448\tCarne, bovina, contra-filé, com gordura\tgrelhado
450\tCarne, bovina, contra-filé, sem gordura\tgrelhada
451\tCarne, bovina, costela\tassada
453\tCarne, bovina, coxão duro, sem gordura\tcozido
455\tCarne, bovina, coxão mole, sem gordura\tcozido
457\tCarne, bovina, cupim\tassado
460\tCarne, bovina, filé mignon, sem gordura\tcozido
462\tCarne, bovina, flanco, sem gordura\tcozido
464\tCarne, bovina, fraldinha, com gordura\tcozida
466\tCarne, bovina, lagarto\tcozido
468\tCarne, bovina, língua\tcozida
470\tCarne, bovina, maminha\tgrelhada
473\tCarne, bovina, miolo de alcatra, sem gordura\tgrelado
474\tCarne, bovina, músculo, sem gordura\tcozido
477\tCarne, bovina, paleta, sem gordura\tcozida
479\tCarne, bovina, patinho, sem gordura\tcozido
480\tCarne, bovina, patinho, sem gordura\tgrelhado
481\tCarne, bovina, peito, sem gordura\tcozido
484\tCarne, bovina, picanha, com gordura\tgrelhada
486\tCarne, bovina, picanha, sem gordura\tgr...
`; /* OBS: a KB acima foi colocada completa; se o seu texto original contém mais linhas, cole tudo aqui mantendo o mesmo formato id<TAB>nome<TAB>preparo. */

function parseKBText(text){
  const lines = text.split(/\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const kb = {};
  for(const line of lines){
    const m = line.match(/^\s*(\d+)\s+(.+)$/);
    if(!m) continue;
    const id = m[1];
    let rest = m[2].trim();
    let parts = rest.split(/\t/).map(p=>p.trim()).filter(p=>p!=='');
    if(parts.length === 1){
      parts = rest.split(/\s{2,}/).map(p=>p.trim()).filter(p=>p!=='');
    }
    let name = parts[0];
    let preparo = null;
    if(parts.length > 1) preparo = parts.slice(1).join(' ').trim();
    else {
      const lastWord = name.split(/\s+/).slice(-1)[0];
      if(/^(cru|crua|cozid[oa]|refogad[oa]|frit[oa]|assad[oa]|grelhad[oa]|sauté|pur[eé]|molho|industrializado|conserva|enlatada|drenad[oa]|preparad[oa])/i.test(lastWord)){
        const partsName = name.split(/\s+/);
        preparo = partsName.pop();
        name = partsName.join(' ');
      }
    }
    if(preparo){
      preparo = preparo.replace(/\(.*\)/g,'').trim();
      preparo = preparo.replace(/,$/,'').trim();
      if(preparo === '') preparo = null;
    }
    kb[id] = { id, name: name || ('ID ' + id), preparo: preparo || null, default_portion_g: null, kcal_per_100g: null, pode_ser_cru: (preparo ? /cru|crua/i.test(preparo) : true) };
  }
  return kb;
}

/* Parser (corrigido) */
function parseCompactWithGroups(codeRaw){
  if(typeof codeRaw !== 'string') throw new Error('Código deve ser string');
  const code = codeRaw.trim().toUpperCase();
  let pos = 0;
  function peek(){ return code[pos]; }
  function next(){ return code[pos++]; }
  function substr(n){ const s = code.substr(pos,n); pos += n; return s; }
  function ensureChar(ch, msg){
    if(peek() !== ch) throw new Error(`${msg} (pos ${pos}). Esperado '${ch}' mas encontrou '${peek() || 'EOF'}'`);
  }
  function digitAtPos(p){
    const c = code[p];
    if(!c || !/^\d$/.test(c)) throw new Error('Número esperado na posição ' + p + " (caractere: '" + (c||'EOF') + "')");
    return parseInt(c,10);
  }
  function readDigitsCount(n){
    const sub = code.substr(pos, n);
    if(sub.length < n || !/^\d+$/.test(sub)) throw new Error(`Esperado ${n} dígito(s) em pos ${pos}, obtido "${sub}"`);
    pos += n;
    return sub;
  }
  function readL_Id_Qty(){
    const tail = code.slice(pos);
    const m = tail.match(/^L(\d{1,4})(\d{3})/);
    if(!m) throw new Error(`Esperado padrão L<id(1-4dig)><qty3> em pos ${pos}. Restante: "${tail.slice(0,12)}"`);
    const id = m[1];
    const qtyStr = m[2];
    pos += m[0].length;
    return { id, qty: parseInt(qtyStr,10) };
  }

  if(pos >= code.length) throw new Error('Código vazio');
  const type = next(); // 1 char
  const months = digitAtPos(pos); pos++;
  const tabCount = digitAtPos(pos); pos++;
  const tabs = [];

  for(let t=0; t<tabCount; t++){
    ensureChar('B', "Esperado início de tab 'B'"); next();
    const monthStart = digitAtPos(pos); pos++;
    const monthEnd   = digitAtPos(pos); pos++;
    const daysVar    = digitAtPos(pos); pos++;
    const mealsBitmapStr = readDigitsCount(2);
    const mealsBitmap = parseInt(mealsBitmapStr,10);

    const days = [];
    for(let d=0; d<daysVar; d++){
      ensureChar('D', "Esperado início de day 'd'/'D'"); next();
      const dayIndex = digitAtPos(pos); pos++;
      const mealEntryCount = digitAtPos(pos); pos++;
      const slots = [];
      for(let m=0; m<mealEntryCount; m++){
        const mealCode = digitAtPos(pos); pos++;
        const itemEntryCount = digitAtPos(pos); pos++;
        const entries = [];
        for(let e=0; e<itemEntryCount; e++){
          if(peek() === 'G'){
            next(); // consume 'G'
            const groupCount = digitAtPos(pos); pos++;
            const groupItems = [];
            for(let g=0; g<groupCount; g++){
              const gi = readL_Id_Qty();
              groupItems.push({ id: gi.id, qty: gi.qty });
            }
            entries.push({ type:'group', items: groupItems });
          } else {
            const it = readL_Id_Qty();
            entries.push({ type:'item', item: { id: it.id, qty: it.qty } });
          }
        }
        slots.push({ mealCode, entries });
      }
      days.push({ dayIndex, slots });
    }

    ensureChar('E', "Esperado fim de tab 'E'"); next();
    tabs.push({ monthStart, monthEnd, daysVar, mealsBitmap, days });
  }

  if(pos !== code.length){
    const rest = code.slice(pos);
    throw new Error(`Conteúdo extra após parse na pos ${pos}: "${rest.slice(0,40)}"`);
  }

  return { type, months, tabs };
}

/* normalizePlan */
function normalizePlan(plan, kb){
  const defaultPortionFallback = 100;
  plan.tabs.forEach(tab=>{
    tab.days.forEach(day=>{
      day.slots.forEach(slot=>{
        slot.entries.forEach(entry=>{
          if(entry.type === 'group'){
            entry.items.forEach(it=>{
              const kbItem = kb[it.id] || null;
              it.kb = kbItem;
              it.used_qty = (it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : defaultPortionFallback) : it.qty);
              it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty * 100 / kbItem.default_portion_g) : null;
              it.kcal = (kbItem && kbItem.kcal_per_100g) ? Math.round((kbItem.kcal_per_100g) * it.used_qty / 100) : null;
            });
            entry.group_kcal = entry.items.reduce((s,i)=> s + (i.kcal || 0), 0);
          } else {
            const it = entry.item;
            const kbItem = kb[it.id] || null;
            it.kb = kbItem;
            it.used_qty = (it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : defaultPortionFallback) : it.qty);
            it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty * 100 / kbItem.default_portion_g) : null;
            it.kcal = (kbItem && kbItem.kcal_per_100g) ? Math.round((kbItem.kcal_per_100g) * it.used_qty / 100) : null;
          }
        });
        slot.meal_total_kcal = slot.entries.reduce((s,en)=> s + (en.type==='group' ? (en.group_kcal || 0) : (en.item.kcal || 0)), 0);
      });
    });
  });
  return plan;
}

/* renderForm (simplificado visual, mas funcional) */
const MEAL_NAMES = { 1:"Refeição 1 (Café da manhã)", 2:"Refeição 2 (Lanche)", 3:"Refeição 3 (Almoço)", 4:"Refeição 4 (Café da tarde)", 5:"Refeição 5 (Janta)" };

function renderForm(plan, kb, container){
  container.innerHTML = '';
  const header = document.createElement('div'); header.style.marginBottom='8px';
  header.innerHTML = `<strong>Plano (type: ${plan.type}, months: ${plan.months})</strong><div class="kb-preview">tabs: ${plan.tabs.length}</div>`;
  container.appendChild(header);

  plan.tabs.forEach((tab,tIdx)=>{
    const tabWrap = document.createElement('div'); tabWrap.style.marginTop='12px';
    tabWrap.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Mês ${tab.monthStart}${tab.monthStart!==tab.monthEnd?(' - '+tab.monthEnd):''} • dias: ${tab.days.length}</div>`;
    tab.days.forEach(day=>{
      const dayCard = document.createElement('div'); dayCard.style.border='1px solid rgba(255,255,255,0.03)'; dayCard.style.padding='8px'; dayCard.style.borderRadius='8px'; dayCard.style.marginBottom='8px';
      dayCard.innerHTML = `<div style="font-weight:700">Dia ${day.dayIndex}</div>`;
      day.slots.forEach(slot=>{
        const mealDiv = document.createElement('div');
        mealDiv.style.marginTop='8px';
        mealDiv.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${MEAL_NAMES[slot.mealCode] || ('Refeição '+slot.mealCode)} • kcal: ${slot.meal_total_kcal ?? 0}</div>`;
        slot.entries.forEach((entry, entIdx)=>{
          if(entry.type === 'group'){
            const g = document.createElement('div'); g.style.border='1px dashed rgba(255,255,255,0.03)'; g.style.padding='8px'; g.style.borderRadius='8px'; g.style.marginBottom='8px';
            g.innerHTML = `<div style="font-weight:700">Grupo (kcal: ${entry.group_kcal ?? 0})</div>`;
            entry.items.forEach((it, subIdx)=>{
              const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px';
              const name = it.kb?.name || ('ID ' + it.id);
              row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id}) porção padrão: ${it.kb?.default_portion_g ?? '—'} g</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
              g.appendChild(row);
            });
            mealDiv.appendChild(g);
          } else {
            const it = entry.item;
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px'; row.style.padding='6px'; row.style.border='1px solid rgba(255,255,255,0.02)'; row.style.borderRadius='8px';
            const name = it.kb?.name || ('ID ' + it.id);
            row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id}) porção padrão: ${it.kb?.default_portion_g ?? '—'} g</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
            mealDiv.appendChild(row);
          }
        });
        dayCard.appendChild(mealDiv);
      });
      tabWrap.appendChild(dayCard);
    });
    container.appendChild(tabWrap);
  });
}

/* Wiring UI */
const KB = parseKBText(kbText);
document.getElementById('kbPreviewSmall').innerText = 'KB entries: ' + Object.keys(KB).length + ' (loaded).';

const compactInput = document.getElementById('compactInputPercurso');
const runBtn = document.getElementById('runCompactBtn');
const clearBtn = document.getElementById('clearCompactBtn');
const root = document.getElementById('compactRoot');
const errBox = document.getElementById('compactError');
const copyJsonBtn = document.getElementById('copyJsonBtn');

function showError(msg){ errBox.style.display='block'; errBox.innerText = msg; }
function hideError(){ errBox.style.display='none'; errBox.innerText = ''; }

runBtn.addEventListener('click', ()=>{
  hideError();
  root.innerHTML = '';
  const code = (compactInput.value||'').trim();
  if(!code){ showError('Cole um código compacto antes de rodar.'); return; }
  try {
    const plan = parseCompactWithGroups(code);
    normalizePlan(plan, KB);
    renderForm(plan, KB, root);
    window.currentCompactPlan = plan;
  } catch(err){
    showError('Erro ao parsear: ' + (err && err.message ? err.message : String(err)));
  }
});

clearBtn.addEventListener('click', ()=>{
  compactInput.value = '';
  root.innerHTML = '';
  hideError();
  window.currentCompactPlan = null;
});

copyJsonBtn.addEventListener('click', ()=>{
  if(window.currentCompactPlan){
    navigator.clipboard.writeText(JSON.stringify(window.currentCompactPlan, null, 2)).then(()=> alert('JSON copiado para clipboard.'));
  } else {
    alert('Nenhum plano carregado para copiar.');
  }
});

/* Menu + tabs minimal wiring (mantive o restante original no seu script principal) */
document.getElementById('menu-toggle').addEventListener('click', function(){
  this.classList.toggle('open'); document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show');
});
document.getElementById('overlay').addEventListener('click', function(){ document.getElementById('menu-toggle').classList.remove('open'); document.getElementById('sidebar').classList.remove('open'); this.classList.remove('show'); });
document.querySelectorAll('.nav-link').forEach(link=>{
  link.addEventListener('click', (e)=>{
    e.preventDefault();
    const tabId = link.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    link.classList.add('active');
    document.getElementById('menu-toggle').classList.remove('open'); document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show');
  });
});
</script>
</body>
</html>
