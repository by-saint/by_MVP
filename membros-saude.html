<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* -------------------- SEU CSS (mantido) -------------------- */
    :root { --color-ia-specialist: #007BFF; --color-video-lessons: #8A2BE2; --color-journey: #DC143C; --journey-red-1: #ff2646; --journey-red-2: #be123c; --journey-dark: #2a0a12; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #E0E0E0; margin: 0; padding: 40px 20px; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
    h1,h2,h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }

    /* --- MENU E SIDEBAR --- */
    .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 1001; background: #333; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; padding: 0; }
    .menu-toggle .bar { width: 24px; height: 3px; background-color: #fff; border-radius: 2px; transition: all 0.3s ease-in-out; }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
    .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: #1E1E1E; transition: left 0.3s ease-in-out; z-index: 1000; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: space-between; }
    .sidebar.open { left: 0; }
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a { display: block; padding: 15px 30px; text-decoration: none; font-size: 1.1em; font-weight: 700; border-left: 5px solid transparent; transition: background-color 0.2s, border-left 0.2s; color: #ddd; }
    .sidebar nav a:hover { background-color: #2c2c2c; }
    .link-ia, .link-aulas, .link-percurso { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    .sidebar .link-ia.active, .sidebar .link-ia:hover { border-left-color: var(--color-ia-specialist); color: white; -webkit-text-fill-color: unset; }
    .sidebar .link-aulas.active, .sidebar .link-aulas:hover { border-left-color: var(--color-video-lessons); color: white; -webkit-text-fill-color: unset; }
    .sidebar .link-percurso.active, .sidebar .link-percurso:hover { border-left-color: var(--color-journey); color: white; -webkit-text-fill-color: unset; }
    .sidebar-footer { padding: 20px 30px; text-align: center; }
    .sidebar-config-btn { width: 100%; background: transparent; border: 1px solid #444; color: #aaa; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95em; font-weight: 600; transition: all 0.2s ease-in-out; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .sidebar-config-btn:hover { background-color: #333; color: #fff; }
    .sidebar-action-btn { width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease-in-out; margin-top: 10px; }
    .sidebar-reset-btn { background-color: transparent; border: 1px solid var(--color-ia-specialist); color: var(--color-ia-specialist); }
    .sidebar-reset-btn:hover { background-color: var(--color-ia-specialist); color: #fff; }
    .sidebar-logout-btn { background-color: #be123c; border: 1px solid #be123c; color: #fff; }
    .sidebar-logout-btn:hover { background-color: #ff4757; border-color: #ff4757; }
    .hidden { display: none; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .overlay.show { opacity: 1; visibility: visible; }
    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }
    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .iframe-container { border-radius: 12px; overflow: hidden; height: 700px; }
    #prompt-output { background-color: #2c2c2c; border: 1px solid #444; padding: 20px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border-radius: 8px; min-height: 120px; }
    .copy-button { display: block; width: 200px; margin: 20px auto 0 auto; padding: 10px 15px; background-color: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }
    .playlist-section { text-align: center; margin: 40px 0; }
    .playlist-btn { background-color: #007BFF; color: white; border: none; padding: 12px 24px; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 25px; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

    /* Percurso styles */
    .percurso-forms { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
    .percurso-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border: 1px solid rgba(190,18,60,0.12); padding: 20px; border-radius: 12px; }
    .percurso-card h4 { margin-top: 0; color: white; }
    .paste-btn { --h: 36px; display: inline-flex; align-items: center; justify-content: center; height: var(--h); min-width: 160px; padding: 8px 24px; border-radius: 999px; background: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); border: none; box-shadow: 0 6px 18px rgba(203,20,47,0.28), inset 0 -3px 6px rgba(0,0,0,0.15); color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; position: relative; overflow: visible; transition: transform 160ms ease, box-shadow 160ms ease; }
    .paste-btn .hole { position: absolute; left: 18px; width: 18px; height: 18px; border-radius: 50%; background: #1f0b0f; box-shadow: 0 0 0 4px rgba(0,0,0,0.25), inset 0 -2px 6px rgba(255,255,255,0.04); transform-origin: center; transform: translateX(0) scale(1); transition: transform 420ms cubic-bezier(.2,.9,.2,1), left 420ms cubic-bezier(.2,.9,.2,1), background 220ms; z-index: 2; }
    .paste-btn .hole::after { content: ""; position: absolute; inset: 4px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.06), rgba(0,0,0,0.8)); transform: scale(1); transition: transform 320ms ease; }
    .paste-btn .label { display: inline-block; transform: translateX(8px); transition: transform 320ms ease; z-index: 1; }
    .paste-btn.pasted { box-shadow: 0 4px 10px rgba(0,0,0,0.45), inset 0 -4px 10px rgba(0,0,0,0.25); }
    .paste-btn.pasted .hole { left: 20px; width: 22px; height: 22px; transform: translateX(-6px) scale(1.05); background: #000; animation: hole-pulse 900ms ease; }
    .paste-btn.pasted .hole::after { transform: scale(0.6); }
    .paste-btn.pasted .label { transform: translateX(14px); }
    .paste-btn.done { background: linear-gradient(90deg, #7a0f18, #3e0610); color: #ffecec; box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 -4px 12px rgba(0,0,0,0.4); }
    .paste-btn.done .label { letter-spacing: 0.2px; }
    @keyframes hole-pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } 40% { box-shadow: 0 0 0 6px rgba(255,255,255,0.03); transform: translateX(-3px) scale(1.02); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); transform: translateX(-6px) scale(1.05); } }
    .paste-btn.appearing { animation: btn-enter 350ms ease; }
    @keyframes btn-enter { from { transform: translateY(6px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    @media (max-width: 900px) { .percurso-forms { grid-template-columns: 1fr; } .paste-btn { min-width: 140px; } }
    .small-note { font-size: 13px; color: #cfc; opacity: 0.7; margin-top: 6px; }
  </style>
</head>
<body>
  <!-- SIDEBAR / MENU -->
  <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">
    <span class="bar"></span><span class="bar"></span><span class="bar"></span>
  </button>

  <div class="sidebar" id="sidebar" aria-hidden="true">
    <nav>
      <ul>
        <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
        <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
        <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button>
      <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
      <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="container">
    <div class="header">
      <p id="welcome-msg">A carregar...</p>
    </div>

    <!-- IA PLANEJAMENTO -->
    <div id="ia-planejamento" class="tab-content active">
      <div class="form-wrapper" id="form-wrapper" style="display:none;">
        <div class="form-container">
          <h1>Crie a sua Meta</h1>
          <form id="ia-fit-form">
            <div class="goal-section">
              <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
              <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>

              <div id="prazo-group" class="form-group" style="margin-top:20px;text-align:left;display:none;">
                <label for="prazo">Qual o prazo para esta meta?</label>
                <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão...">
              </div>
            </div>

            <h3>Informações Básicas e Realidade Atual</h3>

            <div class="form-group">
              <label for="sexo">Sexo</label>
              <select id="sexo" name="sexo" required>
                <option value="" disabled selected>Selecione...</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
              </select>
            </div>

            <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
            <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
            <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
            <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
            <div class="form-group"><label for="local_treino">Onde vai treinar?</label>
              <select id="local_treino" name="local_treino" required>
                <option value="" disabled selected>Selecione...</option>
                <option value="Academia">Academia</option>
                <option value="Casa">Em Casa</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orcamento">Orçamento mensal para dieta (R$)</label>
              <input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required>
            </div>

            <div class="form-group">
              <label for="uso_suplemento">Pretende usar suplementos?</label>
              <select id="uso_suplemento" name="uso_suplemento" required>
                <option value="" disabled selected>Selecione...</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>

            <div class="form-group" id="suplementos-detalhes-group" style="display:none;">
              <label for="quais_suplementos">Quais suplementos?</label>
              <textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea>
            </div>

            <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label>
              <select id="nivel" name="nivel" required>
                <option value="" disabled selected>Selecione...</option>
                <option value="iniciante">Iniciante</option>
                <option value="intermediario">Intermediário</option>
                <option value="avancado">Avançado</option>
              </select>
            </div>

            <button type="submit">Crie seu próprio caminho</button>
          </form>
        </div>
      </div>

      <div class="results-wrapper" id="results-wrapper" style="display:none;">
        <div class="results-container">
          <h2>Seu Plano de Ação</h2>
          <pre id="prompt-output"></pre>
          <button id="copy-btn" class="copy-button">Copiar Pedido</button>

          <h3>Converse com a IA</h3>
          <p style="text-align:center;margin-top:-10px;margin-bottom:20px;color:#bbb;">Use o chat abaixo para tirar dúvidas e pedir seu plano personalizado.</p>

          <div id="chatbox" style="background:#1E1E1E;border:1px solid #333;border-radius:12px;padding:20px;margin-top:20px;max-width:700px;margin-inline:auto;display:flex;flex-direction:column;">
            <div id="chat-messages" style="height:400px;overflow-y:auto;padding:10px;background:#121212;border-radius:8px;margin-bottom:10px;border:1px solid #2c2c2c;"></div>
            <div id="chat-input-container" style="display:flex;gap:10px;">
              <input id="chat-input" type="text" placeholder="Digite sua mensagem..." style="flex:1;padding:12px;background:#333;border:1px solid #555;border-radius:8px;color:#fff;" disabled>
              <button id="send-chat-btn" style="padding:12px 20px;background:#007BFF;color:white;border:none;border-radius:8px;cursor:pointer;opacity:0.5;" disabled>Enviar</button>
            </div>
          </div>

          <div class="playlist-section" id="playlist-section" style="display:none;">
            <h4>Roteiro de Aulas Sugerido</h4>
            <p style="color:#bbb;margin-top:-10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
            <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
          </div>

          <div class="progress-section">
            <h3>Sua Jornada</h3>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
            <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIDEO AULAS -->
    <div id="video-aulas" class="tab-content">
      <h2>Nossas Aulas</h2>
      <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
      <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
      <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
    </div>

    <!-- PERCURSO -->
    <div id="percurso" class="tab-content">
      <div class="percurso-container">
        <h2>Meu Percurso</h2>
        <p style="text-align:center;color:#bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>

        <div class="percurso-forms">
          <div class="percurso-card" id="treino-card">
            <h4>Formulário: Treino</h4>
            <div class="form-group">
              <label for="objetivo_treino">Objetivo de Treino</label>
              <textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea>
            </div>
            <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>

            <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
              <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="hole" aria-hidden="true"></span><span class="label">Colar plano</span></button>
              <div class="small-note">Clique para colar (simulação)</div>
            </div>
          </div>

          <div class="percurso-card" id="dieta-card">
            <h4>Formulário: Dieta</h4>
            <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta</label><textarea id="objetivo_dieta" placeholder="Ex: déficit calórico para secar..."></textarea></div>
            <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>

            <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
              <button class="paste-btn appearing" id="paste-dieta" aria-pressed="false" title="Colar conteúdo do pedido"><span class="hole" aria-hidden="true"></span><span class="label">Colar plano</span></button>
              <div class="small-note">Clique para colar (simulação)</div>
            </div>
          </div>
        </div>

        <p style="text-align:center;color:#888;margin-top:18px;">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo). Eles apenas alternam o estado visual por enquanto.</p>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // -------- CONFIG - atualize somente se necessário --------
    const SUPABASE_URL = "https://edxsgmchmwtpgnoxgrkb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs";
    // URL da Edge Function (substitua se for outro slug)
    const EDGE_URL = "https://edxsgmchmwtpgnoxgrkb.supabase.co/functions/v1/super-action";
    // -------------------------------------------------------

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // DOM references
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const navLinks = Array.from(document.querySelectorAll('.nav-link'));
    const configBtn = document.getElementById('config-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const resetBtn = document.getElementById('reset-btn');

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');

    const formWrapper = document.getElementById('form-wrapper');
    const resultsWrapper = document.getElementById('results-wrapper');
    const promptOutput = document.getElementById('prompt-output');
    const copyBtn = document.getElementById('copy-btn');
    const playlistSection = document.getElementById('playlist-section');

    const pasteTreino = document.getElementById('paste-treino');
    const pasteDieta = document.getElementById('paste-dieta');

    let currentUser = null;
    let profileGlobal = null;

    // ---------- helpers ----------
    function addMessage(text, sender = "bot") {
      const msg = document.createElement('div');
      msg.textContent = text;
      Object.assign(msg.style, {
        margin: "8px 0",
        padding: "10px 14px",
        borderRadius: "10px",
        maxWidth: "85%",
        wordWrap: "break-word",
        background: sender === "user" ? "#007BFF" : "#333",
        color: sender === "user" ? "#fff" : "#E0E0E0",
        alignSelf: sender === "user" ? "flex-end" : "flex-start",
        marginLeft: sender === "user" ? "auto" : "0",
        marginRight: sender === "user" ? "0" : "auto",
      });
      chatMessages.style.display = "flex";
      chatMessages.style.flexDirection = "column";
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getEaster(year) {
      const a = year % 19; const b = Math.floor(year / 100); const c = year % 100;
      const d = Math.floor(b / 4); const e = b % 4; const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3); const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4); const k = c % 4; const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451); const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    function calculateEndDate(prazoText) {
      if (!prazoText || !prazoText.trim()) return null;
      const now = new Date(); const year = now.getFullYear(); const prazoLower = prazoText.toLowerCase();
      let match = prazoLower.match(/(\d+)\s+mes(es)?/);
      if (match) { const d = new Date(); d.setMonth(d.getMonth() + parseInt(match[1], 10)); return d; }
      match = prazoLower.match(/(\d+)\s+dia(s)?/);
      if (match) { const d = new Date(); d.setDate(d.getDate() + parseInt(match[1], 10)); return d; }
      if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) return new Date(year, 11, 31);
      if (prazoLower.includes('verao') || prazoLower.includes('verão')) { const s = new Date(year, 11, 21); return now < s ? s : new Date(year + 1, 11, 21); }
      if (prazoLower.includes('natal')) { const c = new Date(year, 11, 25); return now < c ? c : new Date(year + 1, 11, 25); }
      if (prazoLower.includes('ano novo')) return new Date(year + 1, 0, 1);
      if (prazoLower.includes('pascoa') || prazoLower.includes('páscoa')) { const e = getEaster(year); return now < e ? e : getEaster(year + 1); }
      return null;
    }

    function displayProgress(startDate, endDate) {
      const now = new Date(); now.setHours(0,0,0,0);
      const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
      const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
      const totalDuration = eDate.getTime() - sDate.getTime();
      const elapsedDuration = now.getTime() - sDate.getTime();
      const daysRemaining = Math.max(0, Math.ceil((eDate - now) / (1000 * 60 * 60 * 24)));
      let progressPercentage = totalDuration > 0 ? (elapsedDuration / totalDuration) * 100 : 0;
      if (progressPercentage < 0) progressPercentage = 0;
      if (progressPercentage > 100) progressPercentage = 100;
      document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
      document.getElementById('start-date-label').textContent = sDate.toLocaleDateString('pt-BR');
      document.getElementById('end-date-label').textContent = eDate.toLocaleDateString('pt-BR');
      document.getElementById('countdown-days').textContent = daysRemaining;
      formWrapper.style.display = 'none';
      resultsWrapper.style.display = 'block';
    }

    function analyzeGoal(text) {
      if (!text) return 'ambos';
      const lowerText = text.toLowerCase();
      const emagrecerKeywords = ['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento'];
      const musculoKeywords = ['ganhar musculo','hipertrofia','shape','crescer','massa muscular','ficar forte','músculo','musculo'];
      const hasEmagrecer = emagrecerKeywords.some(k => lowerText.includes(k));
      const hasMusculo = musculoKeywords.some(k => lowerText.includes(k));
      if (hasEmagrecer && !hasMusculo) return 'emagrecer';
      if (hasMusculo && !hasEmagrecer) return 'musculo';
      return 'ambos';
    }

    function reorderVideos(order) {
      const c = document.getElementById('video-aulas');
      const v = {
        1: document.getElementById('video-block-1'),
        2: document.getElementById('video-block-2'),
        3: document.getElementById('video-block-3')
      };
      Object.values(v).forEach(b => { if (b && b.parentNode) b.parentNode.removeChild(b); });
      order.forEach(i => { if (v[i]) c.appendChild(v[i]); });
    }

    // ---------- Chat: carregar histórico (GET) ----------
    async function loadChatHistory() {
      chatMessages.innerHTML = '';
      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session ?? null;
      if (!session) {
        addMessage("⚠️ Você precisa estar logado para conversar.", "bot");
        return;
      }
      // habilita inputs
      chatInput.disabled = false;
      sendChatBtn.disabled = false;
      sendChatBtn.style.opacity = '1';

      const userToken = session.access_token;
      try {
        const res = await fetch(EDGE_URL, {
          method: 'GET',
          headers: {
            "Authorization": `Bearer ${userToken}`,
            "apikey": SUPABASE_ANON_KEY,
            "Content-Type": "application/json"
          },
          credentials: "include"
        });

        if (!res.ok) {
          const bodyText = await res.text().catch(()=>null);
          console.error('EDGE FUNCTION (load) ERROR', res.status, res.statusText, bodyText);
          addMessage(`❌ Erro ao carregar histórico (${res.status}). Veja console para detalhes.`, "bot");
          return;
        }

        const result = await res.json();
        const history = result.history ?? [];
        if (history.length > 0) {
          history.forEach(msg => {
            const sender = msg.role === 'user' ? 'user' : 'bot';
            addMessage(msg.content ?? '[sem conteúdo]', sender);
          });
        } else {
          addMessage("Olá! Como posso te ajudar a atingir sua meta hoje?", "bot");
        }
      } catch (error) {
        console.error("Falha ao carregar histórico:", error);
        addMessage("❌ Erro ao conectar com o assistente. Tente recarregar a página.", "bot");
      }
    }

    // ---------- Chat: enviar mensagem (POST) ----------
    async function sendMessageToEdge(text) {
      if (!text || !text.trim()) return;
      addMessage(text, "user");
      chatInput.value = '';
      sendChatBtn.disabled = true;
      sendChatBtn.textContent = '...';

      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session ?? null;
      if (!session) {
        addMessage("⚠️ Sua sessão expirou. Faça login novamente para continuar.", "bot");
        sendChatBtn.disabled = false;
        sendChatBtn.textContent = 'Enviar';
        return;
      }
      const userToken = session.access_token;

      try {
        const res = await fetch(EDGE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${userToken}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ message: text }),
          credentials: "include"
        });

        if (!res.ok) {
          const bodyText = await res.text().catch(()=>null);
          console.error('EDGE FUNCTION (send) ERROR', res.status, res.statusText, bodyText);
          addMessage(`❌ Erro ao enviar mensagem (${res.status}). Veja console para detalhes.`, "bot");
          return;
        }

        const result = await res.json();
        const answer = result.answer ?? result.data ?? JSON.stringify(result);
        addMessage(answer, "bot");
      } catch (error) {
        console.error("Falha ao enviar mensagem:", error);
        addMessage("❌ Erro ao enviar mensagem. Verifique sua conexão.", "bot");
      } finally {
        sendChatBtn.disabled = false;
        sendChatBtn.textContent = 'Enviar';
      }
    }

    // ---------- Events do chat ----------
    sendChatBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (text) sendMessageToEdge(text);
    });
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); const text = chatInput.value.trim(); if (text) sendMessageToEdge(text); }
    });

    // ---------- UI: menu e navegação ----------
    const switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      const t = document.getElementById(tabId);
      if (t) t.classList.add('active');
      navLinks.forEach(link => link.classList.remove('active'));
      const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
      if (activeLink) activeLink.classList.add('active');
    };

    const closeMenu = () => {
      menuToggle.classList.remove('open');
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
      sidebar.setAttribute('aria-hidden','true');
    };

    menuToggle.addEventListener('click', () => {
      menuToggle.classList.toggle('open');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
      const open = sidebar.classList.contains('open');
      sidebar.setAttribute('aria-hidden', (!open).toString());
    });

    overlay.addEventListener('click', closeMenu);
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = link.dataset.tab;
        switchTab(tabId);
        closeMenu();
      });
    });

    // ---------- Config / Logout / Reset ----------
    configBtn.addEventListener('click', (e) => {
      e.preventDefault();
      logoutBtn.classList.toggle('hidden');
      resetBtn.classList.toggle('hidden');
    });

    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.replace('/login.html');
    });

    resetBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null }).eq('id', currentUser.id);
      if (resetError) { console.error('Erro ao resetar a meta: ' + resetError.message); }
      else window.location.reload();
    });

    // ---------- FORM: criar meta ----------
    (function attachFormHandlers(){
      const objetivoInput = document.getElementById('objetivo');
      if (objetivoInput) {
        objetivoInput.addEventListener('input', function(){
          document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none';
        });
      }

      const usoSuplementoSelect = document.getElementById('uso_suplemento');
      if (usoSuplementoSelect) {
        usoSuplementoSelect.addEventListener('change', function(){
          document.getElementById('suplementos-detalhes-group').style.display = this.value === 'Sim' ? 'block' : 'none';
          if (this.value !== 'Sim') document.getElementById('quais_suplementos').value = '';
        });
      }

      const iaFitForm = document.getElementById('ia-fit-form');
      if (iaFitForm) {
        iaFitForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          const fe = event.target.elements;
          const prazoText = fe.prazo?.value?.trim();
          const endDate = calculateEndDate(prazoText) || (function(){ const d = new Date(); d.setMonth(d.getMonth()+3); return d; })();
          const startDate = new Date(); startDate.setHours(0,0,0,0);
          const objetivoText = fe.objetivo.value.trim();
          const goalType = analyzeGoal(objetivoText);
          const daysRemaining = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
          const prazoOtimizado = `${daysRemaining} dias (meta: ${prazoText || '3 meses'})`;
          const orcamentoValue = (fe.orcamento.value || '').replace(',', '.');

          const formData = {
            objetivo: objetivoText,
            prazo: prazoOtimizado,
            sexo: fe.sexo.value,
            altura: fe.altura.value,
            peso: fe.peso.value,
            idade: fe.idade.value,
            disponibilidade: fe.disponibilidade.value,
            local_treino: fe.local_treino.value,
            orcamento: orcamentoValue,
            uso_suplemento: fe.uso_suplemento.value,
            quais_suplementos: fe.quais_suplementos.value,
            nivel: fe.nivel.value
          };

          let suplementoInfo = `Pretende usar suplementos: ${formData.uso_suplemento}.`;
          if (formData.uso_suplemento === 'Sim' && formData.quais_suplementos) suplementoInfo += ` Os suplementos são: ${formData.quais_suplementos}.`;
          else if (formData.uso_suplemento === 'Sim') suplementoInfo += ` Ainda não decidiu quais.`;

          const initialMessage = [
            "**GERAR PLANO DE AÇÃO COMPLETO**",
            "**INSTRUÇÃO:** Aja como um coach de elite e crie um plano de ação detalhado com base nos seguintes dados do utilizador:",
            `**- Objetivo Principal:** ${formData.objetivo}`,
            `**- Prazo para a Meta:** ${formData.prazo}`,
            "**- Perfil do Utilizador:**",
            ` - Idade: ${formData.idade} anos`,
            ` - Sexo: ${formData.sexo}`,
            ` - Peso: ${formData.peso} kg`,
            ` - Altura: ${formData.altura} m`,
            ` - Nível de Experiência: ${formData.nivel}`,
            "**- Logística e Recursos:**",
            ` - Disponibilidade: ${formData.disponibilidade} dias/semana`,
            ` - Local de Treino: ${formData.local_treino}`,
            ` - Orçamento Mensal (Dieta/Sups): R$${formData.orcamento}`,
            ` - ${suplementoInfo}`,
            "**TAREFA:** Crie um plano prescritivo e completo, abordando treino, dieta e recomendações de estilo de vida para atingir a meta no prazo estipulado."
          ].join("\n");

          // salva em profiles (assume tabela profiles com id = user id)
          if (!currentUser) { console.error('Usuário não identificado para salvar a meta.'); return; }

          const { error: updateError } = await supabase.from('profiles').update({
            goal_start_date: startDate.toISOString(),
            goal_end_date: endDate.toISOString(),
            goal_prompt: initialMessage,
            goal_type: goalType
          }).eq('id', currentUser.id);

          if (updateError) { console.error("Erro ao salvar a meta: " + updateError.message); }
          else {
            promptOutput.textContent = initialMessage;
            playlistSection.style.display = 'block';
            displayProgress(startDate, endDate);
          }
        });
      }

      if (copyBtn) {
        copyBtn.addEventListener('click', function() {
          const textToCopy = promptOutput.textContent || '';
          const ta = document.createElement('textarea');
          ta.value = textToCopy;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand('copy');
            copyBtn.textContent = 'Copiado!';
            setTimeout(()=> { copyBtn.textContent = 'Copiar Pedido'; }, 2000);
          } catch (err) { console.error('Erro ao copiar', err); }
          ta.remove();
        });
      }

      const playlistBtn = document.getElementById('playlist-btn');
      if (playlistBtn) {
        playlistBtn.addEventListener('click', function() {
          if (!profileGlobal) return;
          let videoOrder;
          if (profileGlobal.goal_type === 'emagrecer') videoOrder = [3,2,1];
          else if (profileGlobal.goal_type === 'musculo') videoOrder = [3,1,2];
          else videoOrder = [1,2,3];
          reorderVideos(videoOrder);
          switchTab('video-aulas');
          document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' });
        });
      }

      // simulate paste
      function simulatePaste(buttonEl, targetTextareaId) {
        if (!buttonEl) return;
        const txtOutput = promptOutput.textContent || '';
        const target = document.getElementById(targetTextareaId);
        const label = buttonEl.querySelector('.label');
        if (buttonEl.disabled) return;
        buttonEl.classList.remove('appearing');
        void buttonEl.offsetWidth;
        if (txtOutput.trim() && target) target.value = txtOutput;
        else if (target) target.value = '[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]';
        if (label) label.textContent = 'Formulário pronto ✓';
        buttonEl.classList.add('pasted', 'done');
        buttonEl.setAttribute('aria-pressed', 'true');
        buttonEl.disabled = true;
        buttonEl.setAttribute('aria-disabled', 'true');
        if (target) try { target.focus(); } catch (e) {}
      }
      if (pasteTreino) pasteTreino.addEventListener('click', () => simulatePaste(pasteTreino, 'objetivo_treino'));
      if (pasteDieta) pasteDieta.addEventListener('click', () => simulatePaste(pasteDieta, 'objetivo_dieta'));
    })();

    // ---------- Inicialização: sessão / perfil / histórico ----------
    async function initializePageData() {
      // pega sessão
      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session ?? null;
      if (!session) {
        document.getElementById('welcome-msg').textContent = 'Faça login para continuar';
        formWrapper.style.display = 'none';
        resultsWrapper.style.display = 'none';
        // não redirecionamos automaticamente — apenas exibe instrução
        return;
      }

      const { data: userData, error: userErr } = await supabase.auth.getUser();
      if (userErr || !userData?.user) {
        console.error('Erro ao obter usuário:', userErr);
        document.getElementById('welcome-msg').textContent = 'Erro a obter usuário — faça login novamente';
        return;
      }
      currentUser = userData.user;
      document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${currentUser.email ?? currentUser.id}`;

      // busca perfil
      const { data: profile, error: profileErr } = await supabase.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
      if (profileErr) {
        console.error('Erro ao buscar perfil:', profileErr);
      } else profileGlobal = profile || null;

      if (profileGlobal && profileGlobal.goal_end_date) {
        displayProgress(new Date(profileGlobal.goal_start_date), new Date(profileGlobal.goal_end_date));
        promptOutput.textContent = profileGlobal.goal_prompt ?? '';
        if (profileGlobal.goal_type) playlistSection.style.display = 'block';
      } else {
        formWrapper.style.display = 'block';
        resultsWrapper.style.display = 'none';
      }

      // carrega histórico do chat
      await loadChatHistory();
    }

    // inicia
    initializePageData().catch(err => console.error('Inicialização falhou:', err));
  </script>
</body>
</html>
