<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* (mantive todo seu CSS original — por brevidade aqui vou omitir a repetição no corpo da resposta,
       mas ao colar no seu projeto use exatamente o CSS que já tinha) */
    /* --- COLE AQUI O MESMO CSS DO SEU ARQUIVO ORIGINAL --- */
    :root{--color-ia-specialist:#007BFF;--color-video-lessons:#8A2BE2;--color-journey:#DC143C;--journey-red-1:#ff2646;--journey-red-2:#be123c;--journey-dark:#2a0a12}html{scroll-behavior:smooth}body{font-family:'Poppins',sans-serif;background-color:#121212;color:#E0E0E0;margin:0;padding:40px 20px}.container{max-width:1600px;margin:0 auto;padding:0 20px}h1,h2,h3{color:#f0f0f0;text-align:center;margin-top:30px;margin-bottom:15px} /* etc... */
    /* Para evitar truncar aqui, no seu arquivo substitua este bloco pela sua folha CSS completa já existente. */
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Seu Plano de Ação</h2>
      <pre id="prompt-output"></pre>
      <button id="copy-btn" class="copy-button">Copiar Pedido</button>

      <h3>Comece sua Conversa com a IA</h3>
      <p style="text-align: center; margin-top: -10px; margin-bottom: 20px; color: #bbb;">O plano de dieta foi gerado automaticamente e salvo no percurso.</p>

      <div id="dify-container" class="iframe-container"></div>

      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>

      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Aqui você verá os formulários gerados e o progresso.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
        <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
          <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="hole" aria-hidden="true"></span><span class="label">Colar plano</span></button>
          <div class="small-note">Clique para colar (simulação)</div>
        </div>
      </div>

      <div class="percurso-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>
        <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta</label><textarea id="objetivo_dieta" placeholder="Ex: déficit calórico para secar..."></textarea></div>
        <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>
        <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
          <button class="paste-btn appearing" id="paste-dieta" aria-pressed="false" title="Colar conteúdo do pedido"><span class="hole" aria-hidden="true"></span><span class="label">Colar plano</span></button>
          <div class="small-note">Clique para colar (simulação)</div>
        </div>
      </div>
    </div>

    <p style="text-align:center; color:#888; margin-top:18px;">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo). Eles apenas alternam o estado visual por enquanto.</p>
  </div>
</div>

</div> 
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

    // utilitárias (mesmas da sua versão)
    function getEaster(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
    function calculateEndDate(prazoText){ if(!prazoText) return null; const now=new Date(); const year=now.getFullYear(); let prazoLower=prazoText.toLowerCase(); let match; if(prazoLower.includes('final do ano')||prazoLower.includes('fim de ano')) return new Date(year,11,31); match=prazoLower.match(/(\d+)\s+mes(es)?/); if(match){let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d;} match=prazoLower.match(/(\d+)\s+dia(s)?/); if(match){let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d;} if(prazoLower.includes('verao')||prazoLower.includes('verão')){const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21);} if(prazoLower.includes('natal')){const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25);} if(prazoLower.includes('ano novo')) return new Date(year+1,0,1); if(prazoLower.includes('pascoa')||prazoLower.includes('páscoa')){ const e=getEaster(year); return now<e?e:getEaster(year+1);} return null; }
    function displayProgress(startDate,endDate){ try{ const now=new Date(); now.setHours(0,0,0,0); const sDate=new Date(startDate); sDate.setHours(0,0,0,0); const eDate=new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; document.getElementById('progress-bar').style.width=`${progressPercentage}%`; document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR'); document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR'); document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0; document.getElementById('form-wrapper').style.display='none'; document.getElementById('results-wrapper').style.display='block'; }catch(e){console.error('displayProgress error',e);} }

    function analyzeGoal(text){ const lowerText=(text||'').toLowerCase(); const emagrecerKeywords=['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento']; const musculoKeywords=['ganhar musculo','hipertrofia','sheipado','crescer','massa muscular','ficar forte','músculo']; const hasEmagrecer=emagrecerKeywords.some(k=>lowerText.includes(k)); const hasMusculo=musculoKeywords.some(k=>lowerText.includes(k)); if(hasEmagrecer&&!hasMusculo) return 'emagrecer'; if(hasMusculo&&!hasEmagrecer) return 'musculo'; return 'ambos'; }
    function reorderVideos(order){ const c=document.getElementById('video-aulas'), v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

    // geração simples do formulário de dieta (formato B)
    function generateDietForm(formData, goalType){
      const weight = parseFloat(formData.peso) || 70;
      const heightM = parseFloat(formData.altura) || 1.7;
      const heightCm = Math.round(heightM * 100);
      const age = parseInt(formData.idade,10) || 30;
      const sexo = (formData.sexo||'masculino').toLowerCase();
      const s = sexo==='masculino'?5:-161;
      const bmr = Math.round(10*weight + 6.25*heightCm - 5*age + s);
      const dias = parseInt(formData.disponibilidade,10) || 3;
      let activityFactor = 1.2;
      if(dias<=2) activityFactor=1.2; else if(dias<=4) activityFactor=1.375; else if(dias<=6) activityFactor=1.55; else activityFactor=1.725;
      const tdee = Math.round(bmr * activityFactor);
      let targetCalories = tdee;
      if(goalType==='emagrecer') targetCalories = Math.round(tdee * 0.80);
      else if(goalType==='musculo') targetCalories = Math.round(tdee * 1.10);
      const proteinPerKg = goalType==='musculo'?1.8:1.2;
      const proteinGrams = Math.round(proteinPerKg * weight);
      const fatCalPerc = 0.25;
      const fatCalories = Math.round(targetCalories * fatCalPerc);
      const fatGrams = Math.round(fatCalories / 9);
      const proteinCalories = proteinGrams * 4;
      const remainingCalories = Math.max(0, targetCalories - (proteinCalories + fatGrams * 9));
      const carbGrams = Math.round(remainingCalories / 4);

      function buildDay(dayIndex){
        const meals = ['Café da manhã','Almoço','Jantar'].map(label=>{
          return {
            label,
            kcal: Math.round(targetCalories/3),
            protein_g: Math.round(proteinGrams/3),
            carb_g: Math.round(carbGrams/3),
            fat_g: Math.round(fatGrams/3)
          };
        });
        return { day: dayIndex, meals };
      }

      const days = [buildDay(1), buildDay(2)];
      const compactCode = `D2_${targetCalories}kcal_P${proteinGrams}g_C${carbGrams}g_F${fatGrams}g`;

      return {
        created_at: new Date().toISOString(),
        goal: formData.objetivo,
        goal_type: goalType,
        targetCalories,
        bmr,
        tdee,
        protein_g_day: proteinGrams,
        fat_g_day: fatGrams,
        carb_g_day: carbGrams,
        days,
        budget: formData.orcamento || '',
        compactCode
      };
    }

    // MAIN
    document.addEventListener('DOMContentLoaded', () => {
      let user = null;
      const menuToggle=document.getElementById('menu-toggle'), sidebar=document.getElementById('sidebar'), overlay=document.getElementById('overlay'), navLinks=document.querySelectorAll('.nav-link'), configBtn=document.getElementById('config-btn'), logoutBtn=document.getElementById('logout-btn'), resetBtn=document.getElementById('reset-btn');
      const switchTab=(tabId)=>{ document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById(tabId).classList.add('active'); navLinks.forEach(l=>l.classList.remove('active')); document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active'); };
      const closeMenu=()=>{ menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
      menuToggle.addEventListener('click', ()=>{ menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
      overlay.addEventListener('click', closeMenu);
      navLinks.forEach(link=>{ link.addEventListener('click', (e)=>{ e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
      configBtn.addEventListener('click', (e)=>{ e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
      logoutBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
      resetBtn.addEventListener('click', async ()=>{ if(!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null }).eq('id', user.id); if(resetError) console.error('Erro ao resetar a meta:', resetError); else window.location.reload(); });

      async function initializePageData(){
        const { data } = await supabase.auth.getUser();
        if(!data.user){ window.location.replace('/login.html'); return; }
        user = data.user;
        document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
        const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if(error || !profile){ console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }

        // mostramos formulário inicial se o usuário NÃO TEM uma meta iniciada (goal_start_date)
        if (!profile.goal_start_date) {
          document.getElementById('form-wrapper').style.display = 'block';
        } else {
          // se já há meta iniciada, mostramos progresso
          try { displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); } catch(e){}
        }

        // se houver goal_prompt, tentamos parsear e preencher percurso/dieta
        if (profile.goal_prompt) {
          let parsed = null;
          try { parsed = JSON.parse(profile.goal_prompt); } catch(e) { parsed = profile.goal_prompt; }
          document.getElementById('prompt-output').textContent = typeof parsed === 'object' ? JSON.stringify(parsed, null, 2) : String(parsed);
          if (parsed && parsed.days) {
            document.getElementById('objetivo_dieta').value = `Meta: ${parsed.goal || ''}\nCalorias diárias: ${parsed.targetCalories} kcal\nProteína/dia: ${parsed.protein_g_day} g\nCompact: ${parsed.compactCode}`;
            document.getElementById('orcamento_dieta').value = parsed.budget || '';
          }
          // se profile.goal_start_date estiver vazio mas já tem goal_prompt, você pode optar por mostrar o results; aqui mantemos formulário visível para permitir re-submissão, mas mostramos o conteúdo carregado
        }

        // load chat iframe (mantive) 
        function loadFreshDifyChat(){
          const difyContainer=document.getElementById('dify-container');
          if(!difyContainer) return;
          difyContainer.innerHTML='';
          const frameWrap=document.createElement('div'); frameWrap.className='dify-frame';
          const iframe=document.createElement('iframe');
          const randomSessionId=Date.now().toString(36)+Math.random().toString(36).substring(2);
          const difyUrl=`https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&_=${Date.now()}`;
          iframe.src=difyUrl; iframe.allow='microphone'; frameWrap.appendChild(iframe);
          const strip=document.createElement('div'); strip.className='dify-top-strip'; strip.setAttribute('aria-hidden','true');
          const badge=document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
          const label=document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
          strip.appendChild(badge); strip.appendChild(label);
          const bottomMask=document.createElement('div'); bottomMask.className='dify-bottom-mask'; bottomMask.setAttribute('aria-hidden','true');
          frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask); difyContainer.appendChild(frameWrap);
        }
        loadFreshDifyChat();

        // event handlers dos campos
        const objetivoInput = document.getElementById('objetivo');
        if(objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none'; });

        const usoSuplementoSelect = document.getElementById('uso_suplemento');
        if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim') document.getElementById('quais_suplementos').value=''; });

        // submit do formulário inicial: gera dieta e salva no Supabase (sem prompt)
        const iaFitForm = document.getElementById('ia-fit-form');
        if(iaFitForm){
          iaFitForm.addEventListener('submit', async function(event){
            event.preventDefault();
            const formElements = event.target.elements;
            const prazoText = formElements.prazo.value;
            const endDate = calculateEndDate(prazoText);
            if(!endDate){ console.error('Prazo inválido'); alert('Prazo inválido - use formatos como "3 meses", "30 dias", "até o verão", etc.'); return; }
            const startDate = new Date(); startDate.setHours(0,0,0,0);
            const objetivoText = formElements.objetivo.value;
            const goalType = analyzeGoal(objetivoText);
            const orcamentoValue = formElements.orcamento.value.replace(',', '.');

            const formData = {
              objetivo: objetivoText,
              prazo: prazoText,
              sexo: formElements.sexo.value,
              altura: formElements.altura.value,
              peso: formElements.peso.value,
              idade: formElements.idade.value,
              disponibilidade: formElements.disponibilidade.value,
              local_treino: formElements.local_treino.value,
              orcamento: orcamentoValue,
              uso_suplemento: formElements.uso_suplemento.value,
              quais_suplementos: formElements.quais_suplementos.value,
              nivel: formElements.nivel.value
            };

            // gera o formulário de dieta
            let dietForm;
            try {
              dietForm = generateDietForm(formData, goalType);
            } catch (errGen) {
              console.error('Erro ao gerar dieta:', errGen);
              alert('Erro ao gerar a dieta. Veja console.');
              return;
            }

            const payloadToSave = JSON.stringify(dietForm);

            try {
              const { error: updateError } = await supabase.from('profiles').update({
                goal_start_date: startDate.toISOString(),
                goal_end_date: endDate.toISOString(),
                goal_prompt: payloadToSave,
                goal_type: goalType
              }).eq('id', user.id);

              if (updateError) {
                console.error('Erro ao salvar no Supabase:', updateError);
                alert('Erro ao salvar no servidor. Veja console.');
                return;
              }

              // sucesso: atualiza UI
              document.getElementById('prompt-output').textContent = JSON.stringify(dietForm, null, 2);
              document.getElementById('objetivo_dieta').value = `Meta: ${dietForm.goal || formData.objetivo}\nCalorias diárias: ${dietForm.targetCalories} kcal\nProteína/dia: ${dietForm.protein_g_day} g\nCompact: ${dietForm.compactCode}`;
              document.getElementById('orcamento_dieta').value = dietForm.budget || orcamentoValue || '';
              document.getElementById('playlist-section').style.display = 'block';
              displayProgress(startDate, endDate);
              switchTab('percurso');
            } catch (errSave) {
              console.error('Exceção ao salvar dieta no Supabase', errSave);
              alert('Erro inesperado ao salvar. Veja console.');
            }
          });
        }

        const playlistBtn = document.getElementById('playlist-btn');
        if(playlistBtn) playlistBtn.addEventListener('click', function(){ if(!profile) return; let videoOrder; if(profile.goal_type==='emagrecer') videoOrder=[3,2,1]; else if(profile.goal_type==='musculo') videoOrder=[3,1,2]; else videoOrder=[1,2,3]; reorderVideos(videoOrder); switchTab('video-aulas'); document.getElementById('video-aulas').scrollIntoView({behavior:'smooth'}); });

        const copyBtn = document.getElementById('copy-btn');
        if(copyBtn) copyBtn.addEventListener('click', function(){ const textToCopy=document.getElementById('prompt-output').textContent || ''; const ta=document.createElement('textarea'); ta.value=textToCopy; ta.style.position='fixed'; document.body.appendChild(ta); ta.focus(); ta.select(); try{ document.execCommand('copy'); copyBtn.textContent='Copiado!'; setTimeout(()=>copyBtn.textContent='Copiar Pedido',2000);}catch(e){console.error('Erro copiar',e);} document.body.removeChild(ta); });

        // paste simulado (UI)
        const pasteTreino = document.getElementById('paste-treino'), pasteDieta = document.getElementById('paste-dieta');
        function simulatePaste(buttonEl, targetTextareaId){
          const txtOutput = document.getElementById('prompt-output').textContent || '';
          const target = document.getElementById(targetTextareaId);
          const label = buttonEl.querySelector('.label');
          if(buttonEl.disabled) return;
          buttonEl.classList.remove('appearing'); void buttonEl.offsetWidth; buttonEl.classList.add('appearing');
          if(txtOutput.trim() && target) target.value = txtOutput;
          else if(target) target.value='[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]';
          if(label) label.textContent='Formulário pronto ✓';
          buttonEl.classList.add('pasted','done'); buttonEl.setAttribute('aria-pressed','true'); buttonEl.disabled=true; buttonEl.setAttribute('aria-disabled','true');
          if(target){ try{ target.focus(); }catch(e){} }
        }
        if(pasteTreino) pasteTreino.addEventListener('click', ()=>simulatePaste(pasteTreino,'objetivo_treino'));
        if(pasteDieta) pasteDieta.addEventListener('click', ()=>simulatePaste(pasteDieta,'objetivo_dieta'));
      }

      initializePageData();
    });
</script>
</body>
</html>
