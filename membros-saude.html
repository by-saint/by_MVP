<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- CSS (mantive a maior parte do estilo original) --- */
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    h1,h2,h3 { color: #f0f0f0; text-align: center; margin-top: 20px; margin-bottom: 12px; }

    /* menu & sidebar */
    .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
    .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px;transition:all .3s}
    .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar.open{left:0}
    .sidebar nav{padding-top:100px}
    .sidebar nav a{display:block;padding:15px 30px;text-decoration:none;font-size:1.1em;font-weight:700;border-left:5px solid transparent}
    .link-ia{background-image:linear-gradient(90deg,#38b6ff,#0056b3);-webkit-background-clip:text;color:transparent}
    .link-aulas{background-image:linear-gradient(90deg,#c048f2,#6b21a8);-webkit-background-clip:text;color:transparent}
    .link-percurso{background-image:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2));-webkit-background-clip:text;color:transparent}
    .sidebar-footer{padding:20px 30px;text-align:center}
    .sidebar-config-btn{width:100%;background:transparent;border:1px solid #444;color:#aaa;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}

    /* content */
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 28px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
    label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
    input, select, textarea { width:100%; padding:10px; background:#2C2C2C; border:1px solid #444; border-radius:8px; color:#E0E0E0; box-sizing:border-box; }
    textarea{min-height:100px; resize:vertical;}
    button{cursor:pointer}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,#007BFF,#0056b3);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #444;color:#ddd}
    .small-note{font-size:13px;color:#cfc;opacity:0.8;margin-top:6px}
    .log-area{background:#3b0b0d;color:#ffdede;padding:14px;border-radius:8px;margin-top:12px;font-family:monospace;white-space:pre-wrap}
    .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:20px}
    .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.25));border:1px solid rgba(190,18,60,0.12);padding:16px;border-radius:12px}
    .food-line{display:flex;align-items:center;gap:10px;padding:6px 0}
    .food-id{background:#0d0d0d;border:1px solid #222;padding:6px 8px;border-radius:8px;font-weight:700;color:#ddd}
    .meal-title{font-weight:700;margin-bottom:6px}
    .day-card{background:#111;padding:10px;border-radius:10px;margin-bottom:10px}
    .copy-button{display:block;width:200px;margin:16px auto 0 auto;padding:10px 15px;background:#007BFF;color:white;border:none;border-radius:8px;cursor:pointer}
    @media(max-width:900px){ .percurso-forms{grid-template-columns:1fr} body{padding:20px} }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
  <div class="sidebar" id="sidebar">
    <nav>
      <ul style="list-style:none;padding-left:0;margin:0">
        <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
        <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
        <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="config-btn" class="sidebar-config-btn">⚙️ Configurações</button>
    </div>
  </div>

  <div class="container">
    <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:18px"><p id="welcome-msg" style="color:#bbb">A carregar...</p></div>

    <!-- IA Especialista (formulário principal) -->
    <div id="ia-planejamento" class="tab-content active">
      <div class="form-container">
        <h1>Crie a sua Meta</h1>
        <form id="ia-fit-form">
          <div style="margin-bottom:12px">
            <label for="objetivo">Qual é a sua Grande Meta?</label>
            <textarea id="objetivo" name="objetivo" placeholder="Ex: perder 6kg, ganhar massa..." required></textarea>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label for="sexo">Sexo</label>
              <select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select>
            </div>
            <div>
              <label for="idade">Idade</label>
              <input id="idade" name="idade" type="number" min="10" max="120" placeholder="Ex: 28" required>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <label for="altura">Altura (m)</label>
              <input id="altura" name="altura" type="text" inputmode="decimal" placeholder="Ex: 1.75" required>
            </div>
            <div>
              <label for="peso">Peso (kg)</label>
              <input id="peso" name="peso" type="number" placeholder="Ex: 75" required>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <label for="disponibilidade">Dias por semana para treinar</label>
              <input id="disponibilidade" name="disponibilidade" type="number" min="0" max="7" placeholder="Ex: 4" required>
            </div>
            <div>
              <label for="local_treino">Onde vai treinar?</label>
              <select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <label for="nivel">Seu nível em atividades físicas</label>
              <select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select>
            </div>
            <div>
              <label for="uso_suplemento">Pretende usar suplementos?</label>
              <select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Nao">Não</option></select>
            </div>
          </div>

          <div style="margin-top:14px">
            <label for="prazo">Prazo (ex: 3 meses / até o verão / final do ano)</label>
            <input id="prazo" name="prazo" placeholder="Ex: 3 meses" required>
          </div>

          <div style="margin-top:16px">
            <button id="submit-goal" class="btn btn-primary" type="submit">Gerar Planos (Formato B)</button>
          </div>
        </form>

        <div id="generated-summary" style="margin-top:18px;display:none" class="results-container">
          <h3>Resumo gerado</h3>
          <div id="summary-content" style="white-space:pre-wrap;color:#ddd;padding:8px"></div>
        </div>

      </div>
    </div>

    <!-- Video aulas (mantive como antes) -->
    <div id="video-aulas" class="tab-content" style="display:none">
      <h2>Nossas Aulas</h2>
      <div style="margin-bottom:16px"><h3>Aula 1: Introdução ao Treino Estético</h3>
        <div style="border-radius:8px;overflow:hidden"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen style="width:100%;height:360px;border:0;"></iframe></div>
      </div>
      <div style="margin-bottom:16px"><h3>Aula 2: Fundamentos da Nutrição</h3>
        <div style="border-radius:8px;overflow:hidden"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen style="width:100%;height:360px;border:0;"></iframe></div>
      </div>
      <div><h3>Aula 3: Desvendando a Hipertrofia</h3>
        <div style="border-radius:8px;overflow:hidden"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen style="width:100%;height:360px;border:0;"></iframe></div>
      </div>
    </div>

    <!-- Percurso: aqui aparecerão os formulários gerados automaticamente -->
    <div id="percurso" class="tab-content" style="display:none">
      <div class="percurso-container">
        <h2>Meu Percurso</h2>
        <p style="text-align:center;color:#bbb">Aqui estão os formulários (Dieta e Treino) gerados automaticamente pelo sistema (Formato B).</p>

        <div style="margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label style="margin:0;font-weight:700">Cole seu KB (opcional) — linhas: <code>id[TAB]descrição</code></label>
        </div>
        <textarea id="kb-input" placeholder="Opcional: cole KB completo (id[tab]descrição). Ex: 290	Pão, trigo, sovado — (processado)" style="margin-top:8px"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="load-kb" class="btn btn-ghost">Carregar KB</button>
          <div class="small-note">Se carregar o KB, a interface irá tentar mostrar nomes reais para os IDs usados nas refeições.</div>
        </div>

        <div class="percurso-forms" style="margin-top:20px">
          <!-- Card Dieta -->
          <div class="percurso-card" id="dieta-card">
            <h4>Formulário: Dieta</h4>
            <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta (gerado)</label><textarea id="objetivo_dieta" placeholder="Será preenchido automaticamente"></textarea></div>
            <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>
            <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
              <button id="copy-dieta-json" class="btn btn-primary">Copiar Dieta (JSON)</button>
              <button id="download-dieta" class="btn btn-ghost">Baixar Dieta (JSON)</button>
            </div>
            <div id="dieta-render" style="margin-top:12px"></div>
          </div>

          <!-- Card Treino -->
          <div class="percurso-card" id="treino-card">
            <h4>Formulário: Treino</h4>
            <div class="form-group"><label for="objetivo_treino">Objetivo de Treino (gerado)</label><textarea id="objetivo_treino" placeholder="Será preenchido automaticamente"></textarea></div>
            <div class="form-group"><label for="frequencia_treino">Frequência semanal (gerado)</label><input id="frequencia_treino" type="number" min="0" max="7" placeholder="Ex: 4"></div>
            <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
              <button id="copy-treino-json" class="btn btn-primary">Copiar Treino (JSON)</button>
              <button id="download-treino" class="btn btn-ghost">Baixar Treino (JSON)</button>
            </div>
            <div id="treino-render" style="margin-top:12px"></div>
          </div>
        </div>

        <div id="percurso-log" class="log-area" style="display:none"></div>

      </div>
    </div>

  </div> <!-- container -->

  <!-- Dify container (chat advisor) -->
  <div id="dify-container" style="max-width:1200px;margin:18px auto 80px;"></div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ================== CONFIGURAÇÃO ==================
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  // ================== UTILITÁRIOS NUTRI/CALORIAS (simples) ==================
  // Pequena base interna de alimentos com estimativa kcal/100g e nomes (usada para gerar a dieta).
  // Se você tiver KB com ids reais e calorias, podemos substituir.
  const INTERNAL_FOOD_DB = {
    "290": { name: "Pão, trigo, sovado", kcal_per_100g: 265 },
    "237": { name: "Arroz, tipo 1 - cozido", kcal_per_100g: 130 },
    "512": { name: "Frango, peito, sem pele - grelhado", kcal_per_100g: 165 },
    "229": { name: "Sardinha - assada", kcal_per_100g: 208 },
    "238": { name: "Aveia, flocos", kcal_per_100g: 389 },
    "541": { name: "Iogurte, natural", kcal_per_100g: 60 },
    "551": { name: "Leite, integral", kcal_per_100g: 60 },
    "309": { name: "Geleia, mocotó - natural", kcal_per_100g: 250 },
    "312": { name: "Maria mole, coco queimado", kcal_per_100g: 350 },
    "160": { name: "Morango", kcal_per_100g: 32 },
    // adicione mais conforme necessidade...
  };

  // Parser KB simples: transforma linhas "id[TAB]descrição" em mapa
  function parseKB(text) {
    const lines = (text || "").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const map = {};
    for (const line of lines) {
      const m = line.match(/^\s*(\d{1,4})\s+[\t\- ]\s*(.+)$/) || line.match(/^\s*(\d{1,4})\t(.+)$/) || line.match(/^\s*(\d{1,4})\s+(.+)$/);
      if (m) {
        map[String(parseInt(m[1],10))] = m[2].trim();
      } else {
        const mm = line.match(/^\s*(\d{1,4})\s*(.*)$/);
        if (mm) map[String(parseInt(mm[1],10))] = (mm[2]||"").trim();
      }
    }
    return map;
  }

  // ================== CALCULOS (BMR/TDEE) ==================
  function parseNumberSafe(v) {
    if (v===undefined || v===null) return NaN;
    const s = String(v).replace(',', '.').trim();
    return parseFloat(s);
  }

  function calculateBMR(sex, weightKg, heightM, age) {
    // Mifflin-St Jeor
    const heightCm = heightM * 100;
    const w = weightKg;
    const h = heightCm;
    const a = age;
    if (sex === 'masculino') {
      return 10*w + 6.25*h - 5*a + 5;
    } else {
      return 10*w + 6.25*h - 5*a - 161;
    }
  }
  function activityFactorFromDisponibilidade(daysPerWeek) {
    const d = Number(daysPerWeek);
    if (d <= 0) return 1.2;
    if (d <= 2) return 1.35;
    if (d <= 4) return 1.5;
    if (d <= 5) return 1.65;
    return 1.8;
  }
  function calculateTDEE(bmr, factor) {
    return bmr * factor;
  }

  // ================== GERAR DIETA (2 dias × 3 refeições) ==================
  function generateDietPlan(profile, kcalTargetPerDay) {
    // Estrutura: 2 dias, cada dia com 3 refeições
    // Repartimos calorias: 30% café, 40% almoço, 30% jantar
    const dayCount = 2;
    const mealDistribution = [0.30, 0.40, 0.30];
    // alimentos a usar (preferir KB carregado, se existir)
    // choose recommended items sequence (we'll try to use internal db)
    const foodPool = Object.keys(INTERNAL_FOOD_DB);
    function pickFoodsForMeal(mealCal) {
      // strategy: choose 2 items: um fonte de carbo (rice/bread/oats), uma fonte de proteína (chicken/sardinha) / ou fruta
      // keep simple: rotate pool
      const choices = [];
      // select first two different items (cyclic)
      for (let i=0;i<2;i++) {
        const idx = Math.floor(Math.random() * foodPool.length);
        choices.push(foodPool[idx]);
      }
      // compute grams such that sum(kcal) ~ mealCal
      // distribute calories evenly between the 2 choices
      const half = mealCal / choices.length;
      const items = choices.map(id => {
        const info = INTERNAL_FOOD_DB[id] || { kcal_per_100g: 120 };
        const grams = Math.max(10, Math.round((half / info.kcal_per_100g) * 100));
        return { id: String(id), qty_g: grams, name: info.name, kcal_per_100g: info.kcal_per_100g, kcal: Math.round(info.kcal_per_100g * grams / 100) };
      });
      // adjust rounding difference
      const totalKcal = items.reduce((s,i)=>s+i.kcal,0);
      const diff = Math.round(mealCal - totalKcal);
      if (Math.abs(diff) > 0) {
        // adjust first item grams a bit
        const first = items[0];
        const deltaGrams = Math.round((diff / first.kcal_per_100g) * 100);
        first.qty_g = Math.max(5, first.qty_g + deltaGrams);
        first.kcal = Math.round(first.kcal_per_100g * first.qty_g / 100);
      }
      return items;
    }

    const days = [];
    for (let d=1; d<=dayCount; d++) {
      const meals = [];
      for (let m=0;m<3;m++) {
        const mealCal = Math.round(kcalTargetPerDay * mealDistribution[m]);
        const mealItems = pickFoodsForMeal(mealCal);
        meals.push({ mealIndex: m+1, target_kcal: mealCal, items: mealItems });
      }
      days.push({ dayIndex: d, meals });
    }
    return { days, kcalTargetPerDay };
  }

  // ================== GERAR PLANO DE TREINO (2 dias exemplo) ==================
  function generateTrainingPlan(profile) {
    // Simples: cria 2 dias com exercícios baseados em nível e disponibilidade
    const nivel = profile.nivel || 'iniciante';
    const freq = Math.max(1, Math.min(7, Number(profile.disponibilidade || 3)));
    const days = [];
    const baseExercises = {
      iniciante: [
        { name: "Agachamento (peso corporal)", sets: 3, reps: "10-12" },
        { name: "Flexão de braço (joelhos se necessário)", sets: 3, reps: "8-12" },
        { name: "Remada austral (ou remada com halteres)", sets: 3, reps: "10-12" }
      ],
      intermediario: [
        { name: "Agachamento com barra", sets: 4, reps: "8-10" },
        { name: "Supino reto", sets: 4, reps: "8-10" },
        { name: "Remada curvada", sets: 4, reps: "8-10" }
      ],
      avancado: [
        { name: "Agachamento pesado", sets: 5, reps: "5-6" },
        { name: "Supino pesado", sets: 5, reps: "5-6" },
        { name: "Levantamento terra", sets: 4, reps: "4-6" }
      ]
    };
    // day A: superior/empurrar / day B: inferior/puxar (simplificado)
    const day1 = { dayIndex: 1, focus: "Parte superior (empurrar +/core)", exercises: baseExercises[nivel].slice(0,3) };
    const day2 = { dayIndex: 2, focus: "Parte inferior + posterior", exercises: baseExercises[nivel].slice(0,3).map(e => ({ ...e, name: e.name + (nivel==='iniciante' ? " (variante leve)" : "") })) };
    days.push(day1); days.push(day2);
    return { frequencyPerWeek: freq, days };
  }

  // ================== FUNÇÕES DE RENDER / UI ==================
  function showLog(msg, show=true) {
    const el = document.getElementById('percurso-log');
    el.style.display = show ? 'block' : 'none';
    el.textContent = msg;
  }

  function renderDietIntoUI(dietPlan, kbMap) {
    // fill objetivo_dieta textarea with summary and render detailed cards below
    const target = document.getElementById('objetivo_dieta');
    const summaryLines = [`Calorias alvo por dia: ${dietPlan.kcalTargetPerDay} kcal`, `Dias gerados: ${dietPlan.days.length}`];
    target.value = summaryLines.join("\n");
    const render = document.getElementById('dieta-render'); render.innerHTML = '';
    for (const day of dietPlan.days) {
      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">Dia ${day.dayIndex}</div><div style="color:#aaa">kcal/dia ~ ${day.meals.reduce((s,m)=>s+m.items.reduce((ss,it)=>ss+it.kcal,0),0)}</div></div>`;
      day.meals.forEach(m=>{
        const mealWrap = document.createElement('div'); mealWrap.style.marginTop='8px';
        mealWrap.innerHTML = `<div class="meal-title">Refeição ${m.mealIndex} — alvo ${m.target_kcal} kcal</div>`;
        m.items.forEach(it=>{
          const line = document.createElement('div'); line.className='food-line';
          const idp = document.createElement('div'); idp.className='food-id'; idp.textContent = `ID:${it.id}`;
          const namep = document.createElement('div'); namep.style.flex='1';
          namep.textContent = (kbMap && kbMap[it.id]) ? kbMap[it.id] : (INTERNAL_FOOD_DB[it.id] ? INTERNAL_FOOD_DB[it.id].name : `ID:${it.id} (nome não encontrado)`);
          const qtyp = document.createElement('div'); qtyp.style.minWidth='70px'; qtyp.style.textAlign='right'; qtyp.textContent = `${it.qty_g} g`;
          line.appendChild(idp); line.appendChild(namep); line.appendChild(qtyp);
          mealWrap.appendChild(line);
        });
        dayCard.appendChild(mealWrap);
      });
      render.appendChild(dayCard);
    }
  }

  function renderTrainingIntoUI(trainingPlan) {
    const target = document.getElementById('objetivo_treino');
    target.value = `Plano de treino — frequência: ${trainingPlan.frequencyPerWeek}x/sem\nDias: ${trainingPlan.days.length}`;
    const render = document.getElementById('treino-render'); render.innerHTML = '';
    trainingPlan.days.forEach(d=>{
      const dayCard = document.createElement('div'); dayCard.className='day-card';
      dayCard.innerHTML = `<div style="font-weight:700">Dia ${d.dayIndex} — ${d.focus}</div>`;
      d.exercises.forEach(ex=>{
        const exEl = document.createElement('div'); exEl.style.marginTop='8px';
        exEl.innerHTML = `<div style="font-weight:600">${ex.name}</div><div style="color:#aaa">S: ${ex.sets} • R: ${ex.reps}</div>`;
        dayCard.appendChild(exEl);
      });
      render.appendChild(dayCard);
    });
  }

  // ================== DIFY CHAT (conselheiro 24/7) ==================
  function loadFreshDifyChat() {
    const difyContainer = document.getElementById('dify-container');
    if(!difyContainer) return;
    difyContainer.innerHTML = '';
    const frameWrap = document.createElement('div'); frameWrap.className='dify-frame';
    const iframe = document.createElement('iframe');
    const randomSessionId = Date.now().toString(36) + Math.random().toString(36).slice(2);
    const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&_=${Date.now()}`;
    iframe.src = difyUrl; iframe.allow='microphone';
    frameWrap.appendChild(iframe);
    // top strip
    const strip = document.createElement('div'); strip.className='dify-top-strip';
    strip.setAttribute('aria-hidden','true');
    const badge = document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
    const label = document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
    strip.appendChild(badge); strip.appendChild(label);
    const bottomMask = document.createElement('div'); bottomMask.className='dify-bottom-mask';
    frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask);
    difyContainer.appendChild(frameWrap);
  }

  // ================== LÓGICA PRINCIPAL (inicialização + submit handler) ==================
  document.addEventListener('DOMContentLoaded', () => {
    // toggle sidebar
    const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar');
    menuToggle.addEventListener('click', ()=> { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); });

    // navigation tabs
    document.querySelectorAll('.nav-link').forEach(link=>{
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
        document.getElementById(link.dataset.tab).style.display='block';
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
        link.classList.add('active');
        // close sidebar on mobile
        sidebar.classList.remove('open');
        menuToggle.classList.remove('open');
      });
    });

    // Load Dify advisor chat
    loadFreshDifyChat();

    // KB loader
    let KB_MAP = {};
    document.getElementById('load-kb').addEventListener('click', (e)=>{
      e.preventDefault();
      const raw = document.getElementById('kb-input').value || '';
      KB_MAP = parseKB(raw);
      showLog(`KB carregado: ${Object.keys(KB_MAP).length} entradas.`, true);
    });

    // INITIAL: try to autoload a small KB so UI names are friendly (optional)
    const sampleKB = `290\tPão, trigo, sovado — (processado)
237\tArroz, tipo 1 — cozido
512\tFrango, peito, sem pele — grelhado
229\tSardinha — assada
238\tAveia, flocos
541\tIogurte, natural
551\tLeite, integral
309\tGeleia, mocotó, natural
312\tMaria mole, coco queimado
160\tMorango`;
    document.getElementById('kb-input').value = sampleKB;
    KB_MAP = parseKB(sampleKB);

    // Submit handler: Formulário principal -> GERA DIETA E TREINO AUTOMATICAMENTE (Formato B)
    const iaForm = document.getElementById('ia-fit-form');
    iaForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      try {
        // read form data
        const form = ev.target;
        const objetivo = form.objetivo.value.trim();
        const sexo = form.sexo.value;
        const idade = parseInt(form.idade.value,10);
        const altura = parseNumberSafe(form.altura.value); // metros
        const peso = parseNumberSafe(form.peso.value);
        const disponibilidade = parseInt(form.disponibilidade.value,10);
        const local_treino = form.local_treino.value;
        const nivel = form.nivel.value;
        const uso_suplemento = form.uso_suplemento.value;
        const prazoText = form.prazo.value;

        // validate
        if (!objetivo || !sexo || !idade || !altura || !peso) {
          showLog('Por favor preencha os campos obrigatórios.', true);
          return;
        }

        // Calcula BMR e TDEE
        const bmr = Math.round(calculateBMR(sexo, peso, altura, idade));
        const factor = activityFactorFromDisponibilidade(disponibilidade);
        const tdee = Math.round(calculateTDEE(bmr, factor));

        // Determina tipo de meta
        const lowerObj = objetivo.toLowerCase();
        let goalType = 'ambos';
        const emagrecerKeywords = ['emagrecer','perder peso','secar','definir'];
        const musculoKeywords = ['ganhar musculo','hipertrofia','massa muscular','ganhar massa','músculo','ficar forte'];
        const hasE = emagrecerKeywords.some(k=>lowerObj.includes(k));
        const hasM = musculoKeywords.some(k=>lowerObj.includes(k));
        if (hasE && !hasM) goalType='emagrecer';
        else if (hasM && !hasE) goalType='musculo';
        else goalType='ambos';

        // Aplica ajuste de calorias:
        let kcalTarget = tdee;
        if (goalType === 'emagrecer') kcalTarget = Math.round(tdee * 0.80); // -20%
        else if (goalType === 'musculo') kcalTarget = Math.round(tdee * 1.10); // +10%
        else kcalTarget = Math.round(tdee * 1.00); // manutenção

        // Gera planos (dieta + treino)
        const profile = { objetivo, sexo, idade, altura, peso, disponibilidade, local_treino, nivel, uso_suplemento };
        const dietPlan = generateDietPlan(profile, kcalTarget);
        const trainingPlan = generateTrainingPlan(profile);

        // Renderiza na UI (percurso)
        renderDietIntoUI(dietPlan, KB_MAP);
        renderTrainingIntoUI(trainingPlan);

        // Preenche inputs do percurso (para formatação/salvamento manual)
        const orcamentoInput = document.getElementById('orcamento_dieta');
        if (orcamentoInput && form.orcamento) orcamentoInput.value = form.orcamento ? form.orcamento.value : '';

        // Preenche frequencia treino
        const freqInput = document.getElementById('frequencia_treino');
        if (freqInput) freqInput.value = trainingPlan.frequencyPerWeek || disponibilidade || 3;

        // Guarda texto resumido nos textareas (objetivo)
        document.getElementById('objetivo_dieta').value = `Plano gerado automaticamente — ${goalType.toUpperCase()} • Calorias alvo/dia: ${kcalTarget} kcal\nObjetivo: ${objetivo}`;
        document.getElementById('objetivo_treino').value = `Plano de treino gerado automaticamente — ${goalType.toUpperCase()} • Frequência sugerida: ${trainingPlan.frequencyPerWeek}x/sem\nObjetivo: ${objetivo}`;

        // Exibe resumo ao usuário
        const summary = [
          `BMR estimado: ${bmr} kcal/dia`,
          `TDEE estimado: ${tdee} kcal/dia (fator atividade: ${factor.toFixed(2)})`,
          `Meta detectada: ${goalType}`,
          `Calorias alvo por dia: ${kcalTarget} kcal`,
          `Dieta gerada: ${dietPlan.days.length} dias x 3 refeições`,
          `Treino gerado: ${trainingPlan.days.length} dias`
        ].join("\n");
        document.getElementById('summary-content').textContent = summary;
        document.getElementById('generated-summary').style.display = 'block';

        // Gera estrutura JSON para salvar no Supabase (ajuste conforme seu schema)
        const now = new Date();
        const endDate = (function() {
          // tenta interpretar prazo: se "3 meses" -> adiciona 3 meses; se "verão"/"final do ano" mantém heurística simples
          const pt = (prazoText || '').toLowerCase();
          if (!pt) return null;
          const m = pt.match(/(\d+)\s+mes/);
          if (m) { const d = new Date(); d.setMonth(d.getMonth() + parseInt(m[1],10)); return d; }
          if (pt.includes('final') || pt.includes('fim')) { const d=new Date(); d.setMonth(11); d.setDate(31); return d; }
          return null;
        })();
        const saveObj = {
          goal_start_date: now.toISOString(),
          goal_end_date: endDate ? endDate.toISOString() : null,
          goal_type: goalType,
          goal_calories: kcalTarget,
          goal_prompt: null, // Formato B não usa prompt para gerar planos
          diet_plan: dietPlan,
          training_plan: trainingPlan
        };

        // Salva no Supabase (se o usuário estiver logado)
        try {
          const { data: authData } = await supabase.auth.getUser();
          if (authData && authData.user) {
            const user = authData.user;
            const { error: upError } = await supabase.from('profiles').update(saveObj).eq('id', user.id);
            if (upError) {
              showLog(`Aviso: não foi possível salvar a meta no Supabase: ${upError.message}`, true);
            } else {
              showLog('Planos gerados e salvos no seu perfil.', true);
            }
          } else {
            showLog('Planos gerados (usuário não autenticado — não foi salvo).', true);
          }
        } catch (e) {
          showLog('Erro ao tentar salvar no Supabase: ' + (e.message || e), true);
        }

      } catch (err) {
        // Log robusto: inclui dump de contexto e stack
        console.error(err);
        const msg = typeof err === 'object' && err !== null ? (err.message || JSON.stringify(err)) : String(err);
        const stack = err && err.stack ? err.stack : '(sem stack)';
        showLog(`Erro interno ao gerar planos:\n${msg}\n\nStack:\n${stack}`, true);
      }
    });

    // copiar/baixar JSON diet & treino
    document.getElementById('copy-dieta-json').addEventListener('click', (e)=>{
      e.preventDefault();
      // pega dados do render (reconstrói JSON simples)
      const dietJson = collectCurrentDietJSON();
      if (!dietJson) { showLog('Nenhuma dieta disponível para copiar.', true); return; }
      navigator.clipboard.writeText(JSON.stringify(dietJson, null, 2)).then(()=>showLog('Dieta copiada para a área de transferência.', true)).catch(err=>showLog('Erro ao copiar dieta: '+err, true));
    });
    document.getElementById('copy-treino-json').addEventListener('click', (e)=>{
      e.preventDefault();
      const trJson = collectCurrentTrainingJSON();
      if (!trJson) { showLog('Nenhum treino disponível para copiar.', true); return; }
      navigator.clipboard.writeText(JSON.stringify(trJson, null, 2)).then(()=>showLog('Treino copiado para a área de transferência.', true)).catch(err=>showLog('Erro ao copiar treino: '+err, true));
    });
    document.getElementById('download-dieta').addEventListener('click', (e)=>{ e.preventDefault(); const j = collectCurrentDietJSON(); if(!j) return showLog('Nada para baixar.', true); downloadJSON(j, 'dieta.json'); });
    document.getElementById('download-treino').addEventListener('click', (e)=>{ e.preventDefault(); const j = collectCurrentTrainingJSON(); if(!j) return showLog('Nada para baixar.', true); downloadJSON(j, 'treino.json'); });

    function collectCurrentDietJSON() {
      try {
        // coletar a partir do DOM (dieta-render)
        const container = document.getElementById('dieta-render');
        if (!container || !container.children.length) return null;
        // Mais simples: pegamos texto objetivo_dieta + detalhes estruturais (se quiser salvar a estrutura real, podemos criar estado global)
        const summary = document.getElementById('objetivo_dieta').value || '';
        // Para simplicidade retornamos summary + markup interno (para export)
        const details = container.innerHTML;
        return { summary, detailsHTML: details, timestamp: new Date().toISOString() };
      } catch (e) { return null; }
    }
    function collectCurrentTrainingJSON() {
      try {
        const container = document.getElementById('treino-render');
        if (!container || !container.children.length) return null;
        const summary = document.getElementById('objetivo_treino').value || '';
        const details = container.innerHTML;
        return { summary, detailsHTML: details, timestamp: new Date().toISOString() };
      } catch (e) { return null; }
    }
    function downloadJSON(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Inicia tentativa de autenticação / carregar perfil (manter compatibilidade)
    (async function initialLoad() {
      try {
        const { data } = await supabase.auth.getUser();
        if (!data || !data.user) {
          document.getElementById('welcome-msg').textContent = 'Bem-vindo(a) — sessão demo';
          return;
        }
        const user = data.user;
        document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
        // busca perfil
        const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (error) {
          console.warn('Erro ao buscar perfil:', error);
          return;
        }
        // se já existir diet/training no perfil, renderiza
        if (profile && profile.diet_plan) {
          renderDietIntoUI(profile.diet_plan, KB_MAP);
          document.getElementById('objetivo_dieta').value = `Plano carregado do perfil — calorias alvo: ${profile.goal_calories || '—'}`;
        }
        if (profile && profile.training_plan) {
          renderTrainingIntoUI(profile.training_plan);
          document.getElementById('objetivo_treino').value = `Treino carregado do perfil — frequência: ${profile.training_plan.frequencyPerWeek || '—'}`;
          document.getElementById('frequencia_treino').value = profile.training_plan.frequencyPerWeek || '';
        }
      } catch (e) {
        console.error('Erro init:', e);
      }
    })();

  }); // DOMContentLoaded end

</script>

</body>
</html>
