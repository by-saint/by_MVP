<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
    }
    html{scroll-behavior:smooth}
    body{
      font-family:'Poppins',sans-serif;
      background:#121212;color:#e0e0e0;margin:0;padding:40px 20px;
    }
    .container{max-width:1600px;margin:0 auto;padding:0 20px;}
    h1,h2,h3{color:#f0f0f0;text-align:center;margin-top:30px;margin-bottom:15px;}

    /* --- geral (mantido do original) --- */
    .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
    .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px;transition:all .3s}
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar.open{left:0}
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul{ list-style:none; padding:0; margin:0; }
    .sidebar nav a{ display:block; padding:15px 30px; text-decoration:none; font-size:1.1em; font-weight:700; border-left:5px solid transparent; transition: background-color .2s, border-left .2s; }
    .sidebar nav a:hover{ background:#2c2c2c; }

    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .overlay.show{opacity:1;visibility:visible}
    .header{display:flex;justify-content:flex-end;align-items:center;margin-bottom:20px}
    #welcome-msg{color:#bbb}

    .link-ia, .link-aulas, .link-percurso {
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }

    .sidebar-footer { padding: 20px 30px; text-align:center; }
    .sidebar-config-btn { width:100%; background:transparent; border:1px solid #444; color:#aaa; padding:10px;border-radius:8px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; }
    .sidebar-config-btn:hover { background:#333; color:#fff; }
    .sidebar-action-btn{ width:100%; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:10px; }
    .sidebar-reset-btn { background:transparent; border:1px solid var(--color-ia-specialist); color:var(--color-ia-specialist); }
    .sidebar-logout-btn { background:#be123c; border:1px solid #be123c; color:#fff; }

    .tab-content{display:none}.tab-content.active{display:block}
    .form-wrapper,.results-wrapper{width:100%;max-width:800px;margin:0 auto}
    .form-container,.results-container,.percurso-container{background:#1E1E1E;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid #333}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
    input,select,textarea{width:100%;padding:12px;background:#2C2C2C;border:1px solid #444;border-radius:8px;color:#E0E0E0;font-size:16px;box-sizing:border-box}
    textarea{resize:vertical;min-height:100px}
    .goal-section{background:linear-gradient(145deg,#2a2a2a,#1a1a1a);border:1px solid #444;padding:30px;margin-bottom:40px;border-radius:10px;text-align:center}
    .goal-title { font-size: 28px; font-weight:700; background: linear-gradient(90deg,#007BFF,#00C6FF); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    button[type="submit"]{width:100%;padding:15px;background:linear-gradient(90deg,#007BFF,#0056b3);border:none;border-radius:8px;color:#fff;font-size:18px;font-weight:600;cursor:pointer}
    .iframe-container{border-radius:12px;overflow:hidden;height:700px}
    #prompt-output{background:#2c2c2c;border:1px solid #444;padding:20px;font-family:monospace;white-space:pre-wrap;word-wrap:break-word;border-radius:8px}
    .copy-button{display:block;width:200px;margin:20px auto 0;padding:10px 15px;background:#007BFF;color:#fff;border:none;border-radius:8px;cursor:pointer}
    .progress-section{margin-top:40px;padding:20px;background:#2C2C2C;border-radius:10px}
    .progress-bar-container{width:100%;background:#444;border-radius:10px;overflow:hidden}
    .progress-bar{width:0%;background:#007BFF;height:20px;transition:width .5s}
    .progress-labels{display:flex;justify-content:space-between;font-size:12px;color:#aaa;margin-top:5px}
    .countdown-container{text-align:center;margin-top:20px}
    .countdown-days{font-size:4rem;font-weight:700;color:#fff;line-height:1}
    .countdown-label{font-size:1rem;color:#aaa}
    .text-glow-blue{ text-shadow:0 0 8px rgba(0,198,255,0.6) }
    .playlist-section{text-align:center;margin:40px 0}
    .playlist-btn{background:#007BFF;color:#fff;border:none;padding:12px 24px;font-size:1.1em;cursor:pointer;border-radius:8px}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin-top:25px;border-radius:12px}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}

    /* ========== NOVAS REGRAS: PERCURSO (forms treino + dieta) ========== */
    .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
    .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.25));border:1px solid rgba(190,18,60,.12);padding:20px;border-radius:12px;position:relative}
    .percurso-card h4{margin-top:0;color:#fff}

    /* paste wrapper e botão (o botão fica acima em z-index) */
    .paste-wrapper{position:relative;display:inline-flex;align-items:center;gap:12px;overflow:visible}
    .paste-btn{
      --h:36px;display:inline-flex;align-items:center;justify-content:center;height:var(--h);min-width:160px;padding:8px 24px;border-radius:999px;
      background:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2));border:none;
      box-shadow:0 6px 18px rgba(203,20,47,.28),inset 0 -3px 6px rgba(0,0,0,.15);color:#fff;font-weight:700;font-size:16px;cursor:pointer;
      position:relative;overflow:visible;transition:transform 160ms ease,box-shadow 160ms ease;z-index:2;
    }
    .paste-btn:active{transform:translateY(1px) scale(.997)}
    .paste-btn .hole{position:absolute;left:18px;width:18px;height:18px;border-radius:50%;background:#1f0b0f;box-shadow:0 0 0 4px rgba(0,0,0,.25),inset 0 -2px 6px rgba(255,255,255,.04);transform-origin:center;transform:translateX(0) scale(1);transition:transform 420ms cubic-bezier(.2,.9,.2,1),left 420ms cubic-bezier(.2,.9,.2,1);z-index:3}
    .paste-btn .label{display:inline-block;transform:translateX(8px);transition:transform 320ms ease;z-index:3}
    .paste-btn.pasted{box-shadow:0 4px 10px rgba(0,0,0,.45),inset 0 -4px 10px rgba(0,0,0,.25)}
    .paste-btn.pasted .hole{left:20px;width:22px;height:22px;transform:translateX(-6px) scale(1.05);background:#000;animation:hole-pulse .9s ease}
    .paste-btn.done{background:linear-gradient(90deg,#7a0f18,#3e0610);color:#ffecec;box-shadow:0 6px 20px rgba(0,0,0,.6),inset 0 -4px 12px rgba(0,0,0,.4)}
    .paste-btn:disabled{cursor:default;opacity:.92;filter:saturate(.95)}

    @keyframes hole-pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,0)}40%{box-shadow:0 0 0 6px rgba(255,255,255,.03);transform:translateX(-3px) scale(1.02)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0);transform:translateX(-6px) scale(1.05)}}

    /* ---------- novo: pull-handle MAIOR (16px), circular e COLADA ao botão (atrás) ---------- */
    .pull-handle{
      width:16px;height:16px;border-radius:50%;
      background: linear-gradient(180deg,#ffffff,#f3f3f3);
      position:absolute;left:-4px;top:50%;transform:translate(0,-50%);cursor:grab;
      box-shadow:0 6px 16px rgba(0,0,0,.45);touch-action:none;z-index:1;transition:box-shadow 180ms ease,transform 220ms ease;
      pointer-events:auto;
      border: 1px solid rgba(0,0,0,0.12);
    }
    .pull-handle:active{cursor:grabbing}
    .pull-handle.dragging{box-shadow:0 14px 32px rgba(0,0,0,.55)}
    @keyframes jelly{0%{transform:translate(0,-50%) scaleX(1) scaleY(1)}30%{transform:translate(-8px,-50%) scaleX(1.12) scaleY(.92)}55%{transform:translate(4px,-50%) scaleX(.96) scaleY(1.06)}100%{transform:translate(0,-50%) scaleX(1) scaleY(1)}}
    .jelly-release{animation:jelly .6s cubic-bezier(.2,.9,.2,1)}

    /* animação de entrada do botão */
    .paste-btn.appearing{animation:btn-enter .35s ease}
    @keyframes btn-enter{from{transform:translateY(6px) scale(.98);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}

    @media(max-width:900px){.percurso-forms{grid-template-columns:1fr}.pull-handle{left:-3px}.paste-btn{min-width:140px}}

    .small-note{font-size:13px;color:#cfc;opacity:.7;margin-top:6px}
  </style>
</head>
<body>
  <!-- menu -->
  <button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
  <div class="sidebar" id="sidebar">
    <nav>
      <ul>
        <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
        <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
        <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button>
      <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
      <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
    </div>
  </div>
  <div class="overlay" id="overlay"></div>

  <div class="container">
    <div class="header"><p id="welcome-msg">A carregar...</p></div>

    <!-- Conteúdo IA -->
    <div id="ia-planejamento" class="tab-content active">
      <div class="form-wrapper" id="form-wrapper" style="display:none">
        <div class="form-container">
          <h1>Crie a sua Meta</h1>
          <form id="ia-fit-form">
            <div class="goal-section">
              <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
              <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
              <div id="prazo-group" class="form-group" style="margin-top:20px;text-align:left;display:none">
                <label for="prazo">Qual o prazo para esta meta?</label>
                <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
              </div>
            </div>
            <h3>Informações Básicas e Realidade Atual</h3>
            <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
            <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
            <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
            <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
            <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
            <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
            <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
            <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
            <div class="form-group" id="suplementos-detalhes-group" style="display:none"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
            <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
            <button type="submit">Crie seu próprio caminho</button>
          </form>
        </div>
      </div>

      <div class="results-wrapper" id="results-wrapper" style="display:none">
        <div class="results-container">
          <h2>Seu Plano de Ação</h2>
          <pre id="prompt-output"></pre>
          <button id="copy-btn" class="copy-button">Copiar Pedido</button>
          <h3>Comece sua Conversa com a IA</h3>
          <p style="text-align:center;margin-top:-10px;margin-bottom:20px;color:#bbb">Copie o pedido acima e cole no chat para receber o seu plano personalizado.</p>
          <div id="dify-container" class="iframe-container"></div>

          <div class="playlist-section" id="playlist-section" style="display:none">
            <h4>Roteiro de Aulas Sugerido</h4>
            <p style="color:#bbb;margin-top:-10px">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
            <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
          </div>

          <div class="progress-section">
            <h3>Sua Jornada</h3>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
            <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- video-aulas -->
    <div id="video-aulas" class="tab-content">
      <h2>Nossas Aulas</h2>
      <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
      <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
      <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
    </div>

    <!-- percurso -->
    <div id="percurso" class="tab-content">
      <div class="percurso-container">
        <h2>Meu Percurso</h2>
        <p style="text-align:center;color:#bbb">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>

        <div class="percurso-forms">
          <!-- TREINO -->
          <div class="percurso-card" id="treino-card">
            <h4>Formulário: Treino</h4>
            <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
            <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
            <div style="height:42px;margin-top:8px;display:flex;align-items:center">
              <div class="paste-wrapper">
                <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido">
                  <span class="hole" aria-hidden="true"></span>
                  <span class="label">Colar plano</span>
                </button>
                <!-- handle será inserida pelo JS, posicionada atrás do botão -->
              </div>
              <div style="margin-left:12px" class="small-note">Clique para colar (simulação)</div>
            </div>
          </div>

          <!-- DIETA -->
          <div class="percurso-card" id="dieta-card">
            <h4>Formulário: Dieta</h4>
            <div class="form-group"><label for="objetivo_dieta">Objetivo de Dieta</label><textarea id="objetivo_dieta" placeholder="Ex: déficit calórico para secar..."></textarea></div>
            <div class="form-group"><label for="orcamento_dieta">Orçamento mensal (R$)</label><input id="orcamento_dieta" type="text" placeholder="Ex: 500"></div>
            <div style="height:42px;margin-top:8px;display:flex;align-items:center">
              <div class="paste-wrapper">
                <button class="paste-btn appearing" id="paste-dieta" aria-pressed="false" title="Colar conteúdo do pedido">
                  <span class="hole" aria-hidden="true"></span>
                  <span class="label">Colar plano</span>
                </button>
                <!-- handle será inserida pelo JS, posicionada atrás do botão -->
              </div>
              <div style="margin-left:12px" class="small-note">Clique para colar (simulação)</div>
            </div>
          </div>
        </div>

        <p style="text-align:center;color:#888;margin-top:18px">Puxe a pequena pontinha circular à esquerda (ela está atrás do botão) para "soltar" e desfazer o colar — a animação é elástica.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

    /* funções utilitárias (mantidas) */
    function getEaster(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day)}
    function calculateEndDate(prazoText){const now=new Date(),year=now.getFullYear();let prazoLower=(prazoText||'').toLowerCase();if(prazoLower.includes('final do ano')||prazoLower.includes('fim de ano'))return new Date(year,11,31);let match=prazoLower.match(/(\d+)\s+mes(es)?/);if(match){let d=new Date();d.setMonth(d.getMonth()+parseInt(match[1],10));return d}match=prazoLower.match(/(\d+)\s+dia(s)?/);if(match){let d=new Date();d.setDate(d.getDate()+parseInt(match[1],10));return d}if(prazoLower.includes('verao')||prazoLower.includes('verão')){const s=new Date(year,11,21);return now<s?s:new Date(year+1,11,21)}if(prazoLower.includes('natal')){const c=new Date(year,11,25);return now<c?c:new Date(year+1,11,25)}if(prazoLower.includes('ano novo'))return new Date(year+1,0,1);if(prazoLower.includes('pascoa')||prazoLower.includes('páscoa')){const e=getEaster(year);return now<e?e:getEaster(year+1)}return null}
    function displayProgress(startDate,endDate){const now=new Date();now.setHours(0,0,0,0);const sDate=new Date(startDate);sDate.setHours(0,0,0,0);const eDate=new Date(endDate);eDate.setHours(0,0,0,0);const totalDuration=eDate.getTime()-sDate.getTime(),elapsedDuration=now.getTime()-sDate.getTime();const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24));let progressPercentage=(elapsedDuration/totalDuration)*100;if(progressPercentage<0)progressPercentage=0;if(progressPercentage>100)progressPercentage=100;document.getElementById('progress-bar').style.width=`${progressPercentage}%`;document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR');document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR');document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0;document.getElementById('form-wrapper').style.display='none';document.getElementById('results-wrapper').style.display='block'}
    function analyzeGoal(text){const lowerText=(text||'').toLowerCase();const emagrecerKeywords=['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento'];const musculoKeywords=['ganhar musculo','hipertrofia','sheipado','crescer','massa muscular','ficar forte','músculo'];const hasEmagrecer=emagrecerKeywords.some(k=>lowerText.includes(k));const hasMusculo=musculoKeywords.some(k=>lowerText.includes(k));if(hasEmagrecer&&!hasMusculo)return'emagrecer';if(hasMusculo&&!hasEmagrecer)return'musculo';return'ambos'}
    function reorderVideos(order){const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')};Object.values(v).forEach(b=>b.remove());order.forEach(i=>c.appendChild(v[i]))}

    document.addEventListener('DOMContentLoaded',()=>{
      let user=null;
      const menuToggle=document.getElementById('menu-toggle'),sidebar=document.getElementById('sidebar'),overlay=document.getElementById('overlay'),navLinks=document.querySelectorAll('.nav-link'),configBtn=document.getElementById('config-btn'),logoutBtn=document.getElementById('logout-btn'),resetBtn=document.getElementById('reset-btn');

      const switchTab=(tabId)=>{document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(tabId).classList.add('active');navLinks.forEach(l=>l.classList.remove('active'));document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active');};
      const closeMenu=()=>{menuToggle.classList.remove('open');sidebar.classList.remove('open');overlay.classList.remove('show')};

      menuToggle.addEventListener('click',()=>{menuToggle.classList.toggle('open');sidebar.classList.toggle('open');overlay.classList.toggle('show')});
      overlay.addEventListener('click',closeMenu);
      navLinks.forEach(link=>{link.addEventListener('click',(e)=>{e.preventDefault();const tabId=link.dataset.tab;switchTab(tabId);closeMenu();});});
      configBtn.addEventListener('click',(e)=>{e.preventDefault();logoutBtn.classList.toggle('hidden');resetBtn.classList.toggle('hidden');});
      logoutBtn.addEventListener('click',async(e)=>{e.preventDefault();await supabase.auth.signOut();window.location.replace('/login.html');});
      resetBtn.addEventListener('click',async()=>{if(!user)return;const { error: resetError } = await supabase.from('profiles').update({ goal_start_date:null,goal_end_date:null,goal_prompt:null,goal_type:null }).eq('id', user.id); if(resetError){console.error('Erro ao resetar a meta: '+resetError.message)} else { window.location.reload(); }});

      async function initializePageData(){
        const { data } = await supabase.auth.getUser();
        if(!data.user){ window.location.replace('/login.html'); return; }
        user = data.user;
        document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;

        const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (error || !profile) { console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }

        if(profile.goal_end_date){ displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); document.getElementById('prompt-output').textContent = profile.goal_prompt; if(profile.goal_type) document.getElementById('playlist-section').style.display='block'; } else { document.getElementById('form-wrapper').style.display='block'; }

        const difyContainer = document.getElementById('dify-container');
        if (difyContainer && profile.conversation_id) {
          const iframe = document.createElement('iframe');
          iframe.src = `https://udify.app/chatbot/${DIFY_APP_TOKEN}`;
          iframe.style.cssText = 'width:100%;height:100%;border:none;';
          iframe.allow = 'microphone';
          difyContainer.appendChild(iframe);
          iframe.onload = () => {
            iframe.contentWindow.postMessage({ type: 'dify-chatbot-set-system-variable', data: { conversation_id: profile.conversation_id } }, 'https://udify.app');
          };
        }

        const objetivoInput=document.getElementById('objetivo');
        if(objetivoInput) objetivoInput.addEventListener('input',function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; });

        const usoSuplementoSelect=document.getElementById('uso_suplemento');
        if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change',function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim') document.getElementById('quais_suplementos').value=''; });

        const iaFitForm=document.getElementById('ia-fit-form');
        if(iaFitForm){
          iaFitForm.addEventListener('submit',async function(event){
            event.preventDefault();
            const formElements = event.target.elements;
            const prazoText = formElements.prazo.value;
            const endDate = calculateEndDate(prazoText);
            if(!endDate){ console.error("Prazo da meta inválido."); return; }
            const startDate = new Date(); startDate.setHours(0,0,0,0);
            const objetivoText = formElements.objetivo.value;
            const goalType = analyzeGoal(objetivoText);
            const daysRemaining = Math.ceil((endDate - startDate)/(1000*60*60*24));
            const prazoOtimizado = `${daysRemaining} dias (meta: ${prazoText})`;
            const orcamentoValue = formElements.orcamento.value.replace(',', '.');
            const formData={objetivo:objetivoText,prazo:prazoOtimizado,sexo:formElements.sexo.value,altura:formElements.altura.value,peso:formElements.peso.value,idade:formElements.idade.value,disponibilidade:formElements.disponibilidade.value,local_treino:formElements.local_treino.value,orcamento:orcamentoValue,uso_suplemento:formElements.uso_suplemento.value,quais_suplementos:formElements.quais_suplementos.value,nivel:formElements.nivel.value};
            let suplementoInfo=`Pretende usar suplementos: ${formData.uso_suplemento}.`;
            if(formData.uso_suplemento==='Sim'&&formData.quais_suplementos){suplementoInfo+=` Os suplementos são: ${formData.quais_suplementos}.`} else if(formData.uso_suplemento==='Sim'){suplementoInfo+=` Ainda não decidi quais.`}
            const initialMessage = `\n**GERAR PLANO DE AÇÃO COMPLETO**\n**INSTRUÇÃO:** Aja como um coach de elite e crie um plano de ação detalhado com base nos seguintes dados do utilizador:\n**- Objetivo Principal:** ${formData.objetivo}\n**- Prazo para a Meta:** ${formData.prazo}\n**- Perfil do Utilizador:**\n  - Idade: ${formData.idade} anos\n  - Sexo: ${formData.sexo}\n  - Peso: ${formData.peso} kg\n  - Altura: ${formData.altura} m\n  - Nível de Experiência: ${formData.nivel}\n**- Logística e Recursos:**\n  - Disponibilidade: ${formData.disponibilidade} dias/semana\n  - Local de Treino: ${formData.local_treino}\n  - Orçamento Mensal (Dieta/Sups): R$${formData.orcamento}\n  - ${suplementoInfo}\n**TAREFA:** Crie um plano prescritivo e completo, abordando treino, dieta e recomendações de estilo de vida para atingir a meta no prazo estipulado.`.trim();
            const { error: updateError } = await supabase.from('profiles').update({ goal_start_date:startDate.toISOString(),goal_end_date:endDate.toISOString(),goal_prompt:initialMessage,goal_type:goalType }).eq('id', user.id);
            if(updateError){ console.error("Erro ao salvar a meta: "+updateError.message); } else { document.getElementById('prompt-output').textContent = initialMessage; document.getElementById('playlist-section').style.display='block'; displayProgress(startDate,endDate); }
          });
        }

        const playlistBtn=document.getElementById('playlist-btn');
        if(playlistBtn){
          playlistBtn.addEventListener('click',function(){
            if(!profile) return;
            let videoOrder;
            if(profile.goal_type==='emagrecer'){videoOrder=[3,2,1];} else if(profile.goal_type==='musculo'){videoOrder=[3,1,2];} else { videoOrder=[1,2,3]; }
            reorderVideos(videoOrder);
            switchTab('video-aulas');
            document.getElementById('video-aulas').scrollIntoView({ behavior:'smooth' });
          });
        }

        const copyBtn=document.getElementById('copy-btn');
        if(copyBtn){
          copyBtn.addEventListener('click',function(){
            const textToCopy=document.getElementById('prompt-output').textContent;
            const textArea=document.createElement('textarea');
            textArea.value=textToCopy; textArea.style.position='fixed';
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try{ document.execCommand('copy'); const btn=document.getElementById('copy-btn'); btn.textContent='Copiado!'; setTimeout(()=>{btn.textContent='Copiar Pedido'},2000);}catch(err){console.error('Erro ao copiar',err)}
            document.body.removeChild(textArea);
          });
        }

        /* paste buttons behavior */
        const pasteTreino=document.getElementById('paste-treino');
        const pasteDieta=document.getElementById('paste-dieta');

        function simulatePasteAndLock(buttonEl,targetTextareaId){
          const txtOutput=document.getElementById('prompt-output').textContent||'';
          const target=document.getElementById(targetTextareaId);
          const label=buttonEl.querySelector('.label');
          if(buttonEl.disabled) return;
          buttonEl.classList.remove('appearing'); void buttonEl.offsetWidth; buttonEl.classList.add('appearing');
          if(txtOutput.trim() && target) target.value = txtOutput; else if(target) target.value='[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]';
          if(label) label.textContent='Formulário pronto ✓';
          buttonEl.classList.add('pasted','done'); buttonEl.setAttribute('aria-pressed','true'); buttonEl.disabled=true; buttonEl.setAttribute('aria-disabled','true');
        }

        if(pasteTreino) pasteTreino.addEventListener('click',()=>simulatePasteAndLock(pasteTreino,'objetivo_treino'));
        if(pasteDieta) pasteDieta.addEventListener('click',()=>simulatePasteAndLock(pasteDieta,'objetivo_dieta'));

        /* attach minimal circular handle positioned behind the button (agora maior e colada) */
        function attachMinimalPullHandle(buttonEl,targetTextareaId){
          const wrapper = buttonEl.closest('.paste-wrapper') || buttonEl.parentElement;
          if(!wrapper) return;
          const handle=document.createElement('div');
          handle.className='pull-handle';
          handle.setAttribute('role','button');
          handle.setAttribute('aria-label','Puxe para desfazer o colar');
          handle.tabIndex=0;
          wrapper.style.position = wrapper.style.position || 'relative';
          // insert BEFORE the button so it is behind (z-index:1) and nearly encostada
          wrapper.insertBefore(handle, buttonEl);

          let active=false,startX=0,currentX=0;
          const THRESHOLD = -36;
          const MIN = -120, MAX = 12;

          function setTransforms(dx){
            dx = Math.max(MIN, Math.min(MAX, dx));
            const scaleX = 1 + Math.min(1.3, Math.abs(dx)/90);
            handle.style.transform = `translate(${dx}px, -50%) scaleX(${scaleX.toFixed(3)})`;
            const btnDx = Math.round(dx * 0.22);
            buttonEl.style.transform = `translateX(${btnDx}px)`;
            const hole = buttonEl.querySelector('.hole');
            if(hole){ const holeShift = Math.round(btnDx * -0.6); const holeScale = 1 + Math.min(0.12, Math.abs(dx)/300); hole.style.transform = `translateX(${holeShift}px) scale(${holeScale.toFixed(3)})`; }
          }

          function pointerDown(e){
            if(!(buttonEl.disabled || buttonEl.classList.contains('done'))){
              // if not in pasted state, small hint animation
              handle.classList.add('dragging'); handle.classList.add('jelly-release');
              setTimeout(()=>{ handle.classList.remove('jelly-release'); handle.classList.remove('dragging') }, 320);
              return;
            }
            active=true;
            startX = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || 0;
            currentX = startX;
            handle.classList.add('dragging');
            if(e.pointerId) handle.setPointerCapture && handle.setPointerCapture(e.pointerId);
            e.preventDefault();
          }
          function pointerMove(e){
            if(!active) return;
            currentX = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || currentX;
            let dx = currentX - startX;
            dx = Math.max(MIN, Math.min(MAX, dx));
            setTransforms(dx);
          }
          function pointerUp(e){
            if(!active) return;
            active=false; handle.classList.remove('dragging');
            const dx = (currentX - startX);
            if(dx < THRESHOLD){
              handle.style.transition = 'transform 320ms cubic-bezier(.2,.9,.2,1)';
              handle.style.transform = `translate(${MIN - 20}px, -50%) scaleX(1.05)`;
              setTimeout(()=>{
                undoPaste(buttonEl,targetTextareaId);
                handle.style.transition = 'transform 600ms cubic-bezier(.2,.9,.2,1)';
                handle.classList.add('jelly-release');
                handle.style.transform = `translate(0px, -50%) scaleX(1)`;
                setTimeout(()=>{ handle.classList.remove('jelly-release'); handle.style.transition=''; },650);
              },170);
            } else {
              handle.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1)';
              handle.style.transform = 'translate(0, -50%) scaleX(1)';
              buttonEl.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1)';
              buttonEl.style.transform = 'translateX(0)';
              const hole = buttonEl.querySelector('.hole');
              if(hole) hole.style.transform = '';
              setTimeout(()=>{ handle.style.transition=''; buttonEl.style.transition=''; },430);
            }
          }
          function undoPaste(buttonEl,targetTextareaId){
            const target=document.getElementById(targetTextareaId);
            const label=buttonEl.querySelector('.label');
            if(target) target.value='';
            if(label) label.textContent='Colar plano';
            buttonEl.classList.remove('pasted','done'); buttonEl.disabled=false; buttonEl.removeAttribute('aria-disabled'); buttonEl.setAttribute('aria-pressed','false');
            buttonEl.classList.add('jelly-release'); setTimeout(()=>buttonEl.classList.remove('jelly-release'),700);
            buttonEl.style.transform=''; const hole=buttonEl.querySelector('.hole'); if(hole) hole.style.transform='';
          }

          handle.addEventListener('pointerdown',pointerDown);
          window.addEventListener('pointermove',pointerMove);
          window.addEventListener('pointerup',pointerUp);
          handle.addEventListener('keydown',(ev)=>{ if((ev.key==='Enter'||ev.key===' ') && (buttonEl.disabled || buttonEl.classList.contains('done'))){ ev.preventDefault(); handle.classList.add('jelly-release'); setTimeout(()=>handle.classList.remove('jelly-release'),650); undoPaste(buttonEl,targetTextareaId); }});
        }

        // attach to both paste buttons
        attachMinimalPullHandle(pasteTreino,'objetivo_treino');
        attachMinimalPullHandle(pasteDieta,'objetivo_dieta');
      } // end initializePageData
      initializePageData();
    }); // end DOMContentLoaded
  </script>
</body>
</html>
