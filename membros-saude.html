<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
      --percurso-border: linear-gradient(90deg,#ff2646,#be123c);
      --form-border: #be123c;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px;
    }
    h1, h2, h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }

    /* --- MENU E SIDEBAR --- */
    .menu-toggle {
        position: fixed;
        top: 25px;
        left: 25px;
        z-index: 1001;
        background: #333;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 5px;
        padding: 0;
    }
    .menu-toggle .bar {
        width: 24px;
        height: 3px;
        background-color: #fff;
        border-radius: 2px;
        transition: all 0.3s ease-in-out;
    }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100%;
        background-color: #1E1E1E;
        transition: left 0.3s ease-in-out;
        z-index: 1000;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .sidebar.open { left: 0; }
    .sidebar nav {
        padding-top: 100px;
    }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a {
        display: block;
        padding: 15px 30px;
        text-decoration: none;
        font-size: 1.1em;
        font-weight: 700;
        border-left: 5px solid transparent;
        transition: background-color 0.2s, border-left 0.2s;
    }
    .sidebar nav a:hover { background-color: #2c2c2c; }

    .link-ia, .link-aulas, .link-percurso {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    
    .sidebar .link-ia:hover, .sidebar .link-ia.active { border-left-color: var(--color-ia-specialist); }
    .sidebar .link-aulas:hover, .sidebar .link-aulas.active { border-left-color: var(--color-video-lessons); }
    .sidebar .link-percurso:hover, .sidebar .link-percurso.active { border-left-color: var(--color-journey); }

    .sidebar-footer {
        padding: 20px 30px;
        text-align: center;
    }
    .sidebar-config-btn {
        width: 100%;
        background: transparent;
        border: 1px solid #444;
        color: #aaa;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .sidebar-config-btn:hover { background-color: #333; color: #fff; }
    .sidebar-action-btn { width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
    .sidebar-reset-btn { background-color: transparent; border: 1px solid var(--color-ia-specialist); color: var(--color-ia-specialist); }
    .sidebar-logout-btn { background-color: #be123c; border: 1px solid #be123c; color: #fff; }
    .hidden { display: none; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .overlay.show { opacity: 1; visibility: visible; }

    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }

    /* content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }

    /* custom form border red, but subtle */
    #generated-diet-form fieldset { border: 1px solid rgba(190,18,60,0.14); box-shadow: 0 0 0 1px rgba(190,18,60,0.02) inset; border-left: 4px solid var(--form-border); }

    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .iframe-container { border-radius: 12px; overflow: hidden; height: auto; position: relative; } /* position relative to support overlay */
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }
    .playlist-section { text-align: center; margin: 40px 0; }
    .playlist-btn { background-color: #007BFF; color: white; border: none; padding: 12px 24px; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 25px; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .percurso-forms { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
    .percurso-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border: 1px solid rgba(190,18,60,0.12); padding: 20px; border-radius: 12px; }
    .percurso-card h4 { margin-top: 0; color: white; }
    .small-note { font-size: 13px; color: #cfc; opacity: 0.7; margin-top: 6px; }

    /* DIFY Frame: adjust so bottom-mask covers watermark on both desktop & mobile */
    .dify-frame {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(180deg, #0b0b0b, #121212);
      border: 3px solid rgba(0,0,0,0.9);
      box-shadow: 0 30px 60px rgba(0,0,0,0.7), inset 0 2px 0 rgba(255,255,255,0.02);
      min-height: 640px; /* standard smaller height but okay for desktop */
      max-height: calc(100vh - 120px);
    }
    .dify-frame iframe { width:100%; height:100%; border:0; display:block; min-height:600px; }

    .dify-top-strip {
      position: absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      height: 64px;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      border-radius: 12px;
      pointer-events: none;
    }
    .dify-top-badge { z-index:201; display:inline-flex; align-items:center; gap:10px; height:36px; padding:6px 14px; border-radius:999px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.02); color:#e6e6e6; font-size:14px; font-weight:700; }

    /* bottom mask: VISIBLE on desktop and mobile to cover attribution */
    .dify-bottom-mask {
      display: block;
      position: absolute;
      left: 14px;
      right: 14px;
      height: clamp(56px, 8vh, 120px);
      bottom: -6px;
      background: linear-gradient(180deg,#000,#000);
      opacity: 1;
      border-radius: 20px;
      box-shadow: 0 -10px 30px rgba(0,0,0,1), inset 0 6px 18px rgba(0,0,0,1);
      z-index: 9999;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      body { padding: 20px 12px; }
      .container { padding: 0 12px; }
      .menu-toggle { top: 14px; left: 14px; width: 44px; height: 44px; }
      .dify-frame { min-height: calc(100vh - 140px); max-height: calc(100vh - 120px); border-radius:12px; }
      .dify-frame iframe { min-height:calc(100vh - 180px); }
      .dify-top-strip { top: 8px; left: 8px; right: 8px; height:44px; padding:0 10px; border-radius:9px; }
      .dify-bottom-mask { left: 8px; right: 8px; bottom: -8px; height: clamp(64px, 10vh, 140px); border-radius: 18px; }
      .percurso-forms { grid-template-columns: 1fr; }
    }

    /* small utilities */
    .meta { color: #bbb; font-size: 0.95em; }
    .muted { color: #aaa; font-size: 0.9em; }
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Fale com a IA</h2>
      <div id="dify-container" class="iframe-container"></div>
      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>
      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
      </div>

      <div class="percurso-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>
        <!-- o conteúdo aqui será completamente substituído pelo formulário gerado -->
        <div id="dieta-card-content">
          <p style="color: #bbb;">Seu formulário de dieta será exibido aqui após você criar sua meta.</p>
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ====== CONFIGURAÇÃO ======
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  /**************************************************************************
   * SUPER DIET ENGINE (embutido) — versão final com melhorias Parte 1 Fase 5
   * - inclui pickCandidatesForMeal (refeição leve)
   * - adjustForGoalPrecise (superávit/deficit dependente de idade/dias treino)
   * - filtra componentes com grams <= 0
   * - rotação mensal aplicada corretamente
   **************************************************************************/
  const SuperDietEngine = (function(){

    function _round(n, d=2){ return Math.round((n + Number.EPSILON) * Math.pow(10,d)) / Math.pow(10,d); }
    function _safeNum(v, fallback=0){ const n = Number(v); return isNaN(n) ? fallback : n; }
    function normalizeName(s){
      if(!s) return '';
      return s.toString().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\(.*?\)/g,'').replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,' ').trim();
    }
    function nowISO(){ return (new Date()).toISOString(); }

    // master seed (subset) - you can inject external nutrition/prices later
    const masterDB = {
      "arroz tipo 1 cozido": { id:'arroz_cozido', name:'Arroz tipo 1 cozido', nutrition:{ kcal:130, protein_g:2.7, carb_g:28.0, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'cereal', preps:['cozido'] },
      "feijao carioca cozido": { id:'feijao_carioca', name:'Feijão carioca cozido', nutrition:{ kcal:347, protein_g:21.1, carb_g:62.4, fat_g:1.4, fiber_g:16.6 }, price_per_kg:8.5, category:'leguminosa', preps:['cozido'] },
      "frango peito sem pele cozido": { id:'frango_peito', name:'Frango peito sem pele cozido', nutrition:{ kcal:165, protein_g:31.0, carb_g:0.0, fat_g:3.6 }, price_per_kg:18.0, category:'proteina_animal', preps:['grelhado','cozido','assado'] },
      "ovo inteiro cozido": { id:'ovo_cozido', name:'Ovo inteiro cozido', nutrition:{ kcal:155, protein_g:13.0, carb_g:1.1, fat_g:11.0 }, price_per_kg:15.0, category:'proteina_animal', preps:['cozido','frito'] },
      "banana nanica": { id:'banana_nanica', name:'Banana nanica', nutrition:{ kcal:89, protein_g:1.1, carb_g:22.8, fat_g:0.3, fiber_g:2.6 }, price_per_kg:4.0, category:'fruta', preps:['crua','assada'] },
      "alface americana": { id:'alface', name:'Alface americana', nutrition:{ kcal:15, protein_g:1.4, carb_g:2.9, fat_g:0.2, fiber_g:1.0 }, price_per_kg:6.0, category:'verdura', preps:['crua'] },
      "aveia flocos crua": { id:'aveia', name:'Aveia flocos crua', nutrition:{ kcal:389, protein_g:16.9, carb_g:66.3, fat_g:6.9, fiber_g:10.6 }, price_per_kg:9.5, category:'cereal', preps:['crua','cozida'] },
      "arroz integral cozido": { id:'arroz_integral', name:'Arroz integral cozido', nutrition:{ kcal:111, protein_g:2.6, carb_g:23.5, fat_g:0.9, fiber_g:1.8 }, price_per_kg:6.0, category:'cereal', preps:['cozido'] },
      "lentilha cozida": { id:'lentilha', name:'Lentilha cozida', nutrition:{ kcal:116, protein_g:9.0, carb_g:20.1, fat_g:0.4, fiber_g:7.9 }, price_per_kg:10.0, category:'leguminosa', preps:['cozido'] },
      "batata inglesa cozida": { id:'batata', name:'Batata inglesa cozida', nutrition:{ kcal:87, protein_g:1.9, carb_g:20.1, fat_g:0.1, fiber_g:1.8 }, price_per_kg:3.0, category:'tuberculo', preps:['cozido','assado'] },
      "queijo minas frescal": { id:'queijo_minas', name:'Queijo minas frescal', nutrition:{ kcal:250, protein_g:18.0, carb_g:2.0, fat_g:20.0 }, price_per_kg:28.0, category:'laticinio', preps:['fresco'] },
      "sardinha conserva em oleo": { id:'sardinha', name:'Sardinha conserva em óleo', nutrition:{ kcal:208, protein_g:24.6, carb_g:0.0, fat_g:11.5 }, price_per_kg:22.0, category:'peixe', preps:['conserva'] },
    };

    function _buildLookup(db){
      const byName = {};
      const byId = {};
      Object.values(db).forEach(rec=>{
        byName[normalizeName(rec.name)] = rec;
        if(rec.id) byId[rec.id] = rec;
      });
      return { byName, byId };
    }
    let _lookup = _buildLookup(masterDB);

    function findFood(foodKey){
      if(!foodKey) return null;
      const k = foodKey.toString();
      if(_lookup.byId[k]) return _lookup.byId[k];
      const norm = normalizeName(k);
      if(_lookup.byName[norm]) return _lookup.byName[norm];
      for(const nm in _lookup.byName){
        if(nm.includes(norm) || norm.includes(nm)) return _lookup.byName[nm];
      }
      return null;
    }

    function loadExternalPrices(priceArray){
      if(!Array.isArray(priceArray)) throw new Error('Array esperado');
      for(const item of priceArray){
        const norm = normalizeName(item.name);
        if(_lookup.byName[norm]){
          _lookup.byName[norm].price_per_kg = _safeNum(item.price_per_kg, _lookup.byName[norm].price_per_kg || 0);
          _lookup.byName[norm].source = (item.source || '') + ( _lookup.byName[norm].source ? ' | ' + _lookup.byName[norm].source : '' );
        } else {
          const id = item.id || ('ext_' + norm.replace(/\s+/g,'_'));
          const rec = { id, name: item.name, nutrition: null, price_per_kg: _safeNum(item.price_per_kg,0), category: item.category || 'other', preps: item.preps || ['cru'] };
          _lookup.byName[norm] = rec; _lookup.byId[id] = rec;
        }
      }
    }
    function loadExternalNutrition(nutArray){
      if(!Array.isArray(nutArray)) throw new Error('Array esperado');
      for(const item of nutArray){
        const norm = normalizeName(item.name);
        if(_lookup.byName[norm]){
          _lookup.byName[norm].nutrition = item.nutrition;
          _lookup.byName[norm].source = (item.source || '') + ( _lookup.byName[norm].source ? ' | ' + _lookup.byName[norm].source : '' );
        } else {
          const id = item.id || ('ext_' + norm.replace(/\s+/g,'_'));
          const rec = { id, name: item.name, nutrition: item.nutrition, price_per_kg: item.price_per_kg || null, category: item.category || 'other', preps: item.preps || ['cru'] };
          _lookup.byName[norm] = rec; _lookup.byId[id] = rec;
        }
      }
    }

    function calcBMR(profile){
      const peso = _safeNum(profile.peso, 70);
      const altura_m = _safeNum(profile.altura, profile.altura_m || 1.7);
      const idade = _safeNum(profile.idade, 30);
      const sexo = (profile.sexo || '').toString().toLowerCase();
      const hcm = Math.round(altura_m * 100);
      if(sexo.startsWith('m')) return Math.round(10 * peso + 6.25 * hcm - 5 * idade + 5);
      return Math.round(10 * peso + 6.25 * hcm - 5 * idade - 161);
    }

    function activityFactor(profile){
      const nivel = (profile.nivel || '').toString().toLowerCase();
      const dias = _safeNum(profile.diasPorSemana || profile.disponibilidade || profile.dias_treino_sem || profile.dias_treino, 3);
      if(nivel.includes('inic') || dias <= 1) return 1.2;
      if(nivel.includes('inter') || dias <= 3) return 1.375;
      if(nivel.includes('avanc') || dias >=5) return 1.55;
      return 1.375;
    }

    function adjustForGoalPrecise(tdee, profile){
      const goalText = (profile.grande_meta || profile.goal || profile.goal_prompt || '').toString().toLowerCase();
      const idade = _safeNum(profile.idade, 30);
      const dias = _safeNum(profile.diasPorSemana || profile.disponibilidade || profile.dias_treino_sem || profile.dias_treino, 3);
      let multiplier = 1.0;
      if(/ganhar|massa|hipertrof/.test(goalText)){
        multiplier = 1.12; // base
        if(idade <= 21) multiplier = 1.18;
        if(dias >= 5) multiplier += 0.06;
        multiplier = Math.min(1.30, multiplier);
      } else if(/emagrec|perder|secar|definição|definir/.test(goalText)){
        multiplier = 0.85;
        if(idade >= 60) multiplier = 0.90;
      }
      return Math.round(tdee * multiplier);
    }

    function deriveTargets(profile){
      const bmr = calcBMR(profile);
      const af = activityFactor(profile);
      const tdee = Math.round(bmr * af);
      const targetCalories = adjustForGoalPrecise(tdee, profile);
      const peso = _safeNum(profile.peso, 70);
      let protPerKg = 1.4;
      const goalText = (profile.grande_meta || profile.goal || '').toString().toLowerCase();
      if(/ganhar|massa|hipertrof/.test(goalText)) protPerKg = (profile.idade && profile.idade <= 21) ? 1.8 : 1.6;
      if(/emagrec|perder/.test(goalText)) protPerKg = 1.6;
      const protein_g = Math.round(protPerKg * peso);
      const fatPerc = 0.25;
      const protCals = protein_g * 4;
      const fatCals = Math.round(targetCalories * fatPerc);
      const carbsCals = targetCalories - protCals - fatCals;
      const carbs_g = Math.max(0, Math.round(carbsCals / 4));
      const fat_g = Math.max(0, Math.round(fatCals / 9));
      return { bmr, tdee, targetCalories, protein_g, carbs_g, fat_g, protPerKg };
    }

    function computeCostMetrics(rec){
      if(!rec) return null;
      const price = _safeNum(rec.price_per_kg, null);
      const nut = rec.nutrition || null;
      if(!nut || !price) return null;
      const proteinPerKg = _safeNum(nut.protein_g,0) * 10;
      const kcalPerKg = _safeNum(nut.kcal,0) * 10;
      const proteinPerBRL = proteinPerKg / price;
      const kcalPerBRL = kcalPerKg / price;
      const costPer100g = price / 10;
      return { proteinPerBRL: _round(proteinPerBRL,2), kcalPerBRL: _round(kcalPerBRL,2), costPer100g: _round(costPer100g,2), costPerKg: price };
    }

    function computeSatietyScore(rec){
      if(!rec || !rec.nutrition) return 0.5;
      const n = rec.nutrition;
      const prot = _safeNum(n.protein_g,0);
      const fiber = _safeNum(n.fiber_g,0);
      const fat = _safeNum(n.fat_g,0);
      const waterProxy = Math.max(0, 100 - _safeNum(n.kcal,0));
      const s = (0.45*(prot/30)) + (0.35*(fiber/10)) + (0.15*(fat/20)) + (0.05*(waterProxy/100));
      return Math.min(1, Math.max(0, s));
    }

    function computeNutrientDensity(rec){
      if(!rec || !rec.nutrition) return 0.5;
      const n = rec.nutrition;
      const vitC = _safeNum(n.vitC_mg,0);
      const iron = _safeNum(n.iron_mg,0);
      const calcium = _safeNum(n.calcium_mg,0);
      const potassium = _safeNum(n.potassium_mg,0);
      const micronSum = (vitC/60) + (iron/8) + (calcium/1000) + (potassium/3500);
      const kcal = Math.max(1, _safeNum(n.kcal,100));
      return Math.min(2, (micronSum / kcal) * 100);
    }

    function computeCBrank(rec, profile){
      if(!rec) return -999;
      const cost = computeCostMetrics(rec);
      const sat = computeSatietyScore(rec);
      const nd = computeNutrientDensity(rec);
      const goalText = (profile.grande_meta || profile.goal || '').toString().toLowerCase();
      let wProt = 0.45, wKcal = 0.20, wSat = 0.20, wNd = 0.15;
      if(/ganhar|massa|hipertrof/.test(goalText)) { wProt = 0.6; wKcal=0.1; wSat=0.15; wNd=0.15; }
      if(/emagrec|perder/.test(goalText)) { wProt = 0.45; wKcal=0.1; wSat=0.30; wNd=0.15; }
      const protPerBRL = cost ? cost.proteinPerBRL : 0;
      const kcalPerBRL = cost ? cost.kcalPerBRL : 0;
      const score = (wProt * protPerBRL) + (wKcal * kcalPerBRL) + (wSat * (sat*10)) + (wNd * (nd));
      return _round(score,4);
    }

    function getAllowedPrepsForFood(foodName){
      const rec = findFood(foodName);
      if(!rec) return ['—'];
      return rec.preps || ['cru'];
    }
    function validatePrep(foodName, prep){
      const allowed = getAllowedPrepsForFood(foodName);
      return allowed.includes(prep);
    }

    function gramsFromMacroTarget(foodName, target_g, macro='protein'){
      const rec = findFood(foodName);
      if(!rec || !rec.nutrition) return null;
      const nut = rec.nutrition;
      const per100 = _safeNum(nut[macro + '_g'] || nut[macro] || 0, 0);
      if(per100 <= 0) return null;
      const grams = (target_g / (per100 / 100));
      return Math.round(grams);
    }

    function computeGramAmountsForMeal(foodDBFindFn, mealMacroTargets, components, mealName, profile){
      const protFood = components.protein, carbFood = components.carb, vegFood = components.veg;
      const protNut = findFood(protFood) ? findFood(protFood).nutrition : null;
      const carbNut = findFood(carbFood) ? findFood(carbFood).nutrition : null;
      const vegNut = findFood(vegFood) ? findFood(vegFood).nutrition : null;
      const out = { protein_grams:0, carb_grams:0, veg_grams:0, details:{} };

      if(protNut && _safeNum(protNut.protein_g,0) > 0){
        out.protein_grams = Math.max(0, Math.round( mealMacroTargets.prot_g / (protNut.protein_g / 100) ));
      } else { out.protein_grams = 100; }

      if(carbNut && _safeNum(carbNut.carb_g,0) > 0){
        out.carb_grams = Math.max(0, Math.round( mealMacroTargets.carbs_g / (carbNut.carb_g / 100) ));
      } else { out.carb_grams = 120; }

      out.veg_grams = 100;

      function kcalFrom(foodName, grams){
        const rec = findFood(foodName);
        if(!rec || !rec.nutrition) return 0;
        return (rec.nutrition.kcal || 0) * grams / 100;
      }
      const kcalProt = kcalFrom(protFood, out.protein_grams);
      const kcalCarb = kcalFrom(carbFood, out.carb_grams);
      const kcalVeg = kcalFrom(vegFood, out.veg_grams);
      let totalKcal = kcalProt + kcalCarb + kcalVeg;

      if(mealMacroTargets.calories && Math.abs(totalKcal - mealMacroTargets.calories) / mealMacroTargets.calories > 0.12){
        const desired = mealMacroTargets.calories;
        const withoutCarb = kcalProt + kcalVeg;
        const targetCarbKcal = Math.max(0, desired - withoutCarb);
        if(carbNut && _safeNum(carbNut.kcal,0) > 0){
          const newCarbGrams = Math.round((targetCarbKcal / carbNut.kcal) * 100);
          out.carb_grams = Math.max(0, newCarbGrams);
        }
        totalKcal = kcalFrom(protFood, out.protein_grams) + kcalFrom(carbFood, out.carb_grams) + kcalFrom(vegFood, out.veg_grams);
      }

      out.details = { kcal_est: _round(totalKcal,0), kcalProt:_round(kcalProt,0), kcalCarb:_round(kcalCarb,0), kcalVeg:_round(kcalVeg,0) };

      // adjust: if mealName é leve, reduzir carb/protein para porções realistas
      if(/café|lanche|ceia|breakfast|snack|supper/i.test((mealName||'').toLowerCase())){
        out.protein_grams = Math.min(out.protein_grams, 120);
        out.carb_grams = Math.min(out.carb_grams, 120);
        out.veg_grams = Math.min(out.veg_grams, 120);
      }
      return out;
    }

    function weeklyBudgetFromMonthly(monthly){
      if(!monthly) return null;
      const m = _safeNum(monthly, 0);
      const weeksPerMonth = 4.345;
      return _round(m / weeksPerMonth, 2);
    }

    function buildWeekTemplate(dailyTargetCalories, diasTreino, cheatPolicy){
      const week = Array.from({length:7}).map(()=>({ baseCalories: dailyTargetCalories, isTrainingDay:false, isCheatDay:false, cheatLimit:null }));
      const dt = Math.max(0, _safeNum(diasTreino, 3));
      if(dt > 0){
        const step = Math.floor(7 / dt) || 1;
        let idx = 0;
        for(let i=0;i<dt;i++){
          week[idx].isTrainingDay = true;
          week[idx].baseCalories = Math.round(dailyTargetCalories * 1.08);
          idx = (idx + step) % 7;
        }
      }
      if(cheatPolicy && cheatPolicy.freqPerWeek > 0){
        let idx = 6;
        for(let i=6;i>=0;i--){ if(!week[i].isTrainingDay){ idx = i; break; } }
        week[idx].isCheatDay = true;
        week[idx].cheatLimit = cheatPolicy.cheatCaloriesLimit || Math.round(dailyTargetCalories * 1.5);
      }
      return week;
    }

    function compensateCheatWeek(weekArr){
      const baseTotal = weekArr.reduce((s,d)=>s + d.baseCalories,0);
      const cheatDay = weekArr.find(d => d.isCheatDay);
      if(!cheatDay) return weekArr;
      const cheatActual = cheatDay.cheatLimit || cheatDay.baseCalories;
      const newTotal = baseTotal - cheatDay.baseCalories + cheatActual;
      const excess = newTotal - baseTotal;
      if(excess <= 0) return weekArr;
      const nonCheat = weekArr.filter(d=>!d.isCheatDay);
      const perDayReduction = Math.ceil(excess / nonCheat.length);
      for(const d of nonCheat){
        const minAllowed = Math.round(d.baseCalories * 0.6);
        d.baseCalories = Math.max(minAllowed, d.baseCalories - perDayReduction);
        d.adjustedForCheat = true;
      }
      return weekArr;
    }

    function rotateAlternativesForMonth(componentsList, monthIndex, alternatesByCategory){
      return componentsList.map(it => {
        const rec = findFood(it.food);
        if(!rec) return it;
        const cat = rec.category || null;
        if(cat && alternatesByCategory && alternatesByCategory[cat] && alternatesByCategory[cat].length > 0){
          const arr = alternatesByCategory[cat];
          const pick = arr[monthIndex % arr.length];
          return { ...it, food: pick };
        }
        return it;
      });
    }

    function _rankFoodsByCategory(categories, profile){
      const recs = [];
      for(const nm in _lookup.byName){
        const rec = _lookup.byName[nm];
        if(categories.includes(rec.category)){
          rec.rank = computeCBrank(rec, profile);
          recs.push(rec);
        }
      }
      recs.sort((a,b) => (b.rank || 0) - (a.rank || 0));
      return recs;
    }

    // --- New: pickCandidatesForMeal that avoids heavy items for light meals
    function _isLightMeal(mealName){
      const m = (mealName||'').toLowerCase();
      return /café|lanche|ceia|breakfast|snack|supper/i.test(m);
    }

    function pickCandidatesForMeal(categories, mealName, profile){
      const ranked = _rankFoodsByCategory(categories, profile);
      if(_isLightMeal(mealName)){
        const heavyCats = ['leguminosa', 'tuberculo', 'prato', 'processado', 'conserva'];
        const targets = deriveTargets(profile || {});
        const highEnergyRequired = (targets && targets.targetCalories && targets.targetCalories >= 3000);
        return ranked.filter(rec => {
          if(!rec) return false;
          if(highEnergyRequired) return true;
          if(heavyCats.includes(rec.category)) return false;
          const n = normalizeName(rec.name || '');
          if(n.includes('arroz') || n.includes('feijao') || n.includes('batata') || n.includes('mandioca')) return false;
          return true;
        });
      }
      return ranked;
    }

    function _estimateWeeklyCostFromPlan(weekDays){
      let total = 0;
      for(const d of weekDays){
        for(const m of d.meals){
          for(const comp of m.components){
            const rec = findFood(comp.food);
            if(rec && rec.price_per_kg && _safeNum(comp.grams,0) > 0){
              total += rec.price_per_kg * (comp.grams / 1000);
            }
          }
        }
      }
      return _round(total,2);
    }

    function computeCredibility(c){
      const wCalories = 0.30, wBudget = 0.25, wPractical = 0.20, wVariety = 0.15, wFeas = 0.10;
      const score = ( (c.adherenceToCaloriesPct||0) * wCalories +
                      (c.adherenceToBudgetPct||0) * wBudget +
                      (c.practicalityPct||0) * wPractical +
                      (c.varietyScore||0) * wVariety +
                      (c.feasibilityPct||0) * wFeas ) * 100;
      return _round(score,1);
    }

    function parseGoal(profile){
      const text = (profile.grande_meta || profile.goal || '').toString().toLowerCase();
      const m = text.match(/(\d+(\.\d+)?)/);
      const kg = m ? Number(m[1]) : null;
      const isLose = /emagrec|perder|secar/.test(text);
      const isGain = /ganhar|massa|hipertrof/.test(text);
      let prazo_weeks = null;
      if(profile.prazo){
        const pm = profile.prazo.match(/(\d+)\s*mes/);
        if(pm) prazo_weeks = Number(pm[1]) * 4.345;
        const pw = profile.prazo.match(/(\d+)\s*sem/);
        if(pw) prazo_weeks = Number(pw[1]);
      }
      return { kg, type: isLose ? 'lose' : (isGain ? 'gain' : 'maintain'), prazo_weeks };
    }

    let _supabase = null;
    function init({ supabase }){
      if(!supabase) throw new Error('supabase client required in init()');
      _supabase = supabase;
    }

    async function savePlan(userId, planPayload, options = {}){
      if(!_supabase) throw new Error('Supabase client not initialized. Call init({ supabase }) first.');
      const title = options.title || `Plano - ${planPayload.targets ? planPayload.targets.targetCalories + ' kCal' : nowISO()}`;
      const row = { user_id: userId, title, payload: planPayload };
      const { data, error } = await _supabase.from('user_diets').insert([row]);
      if(error) {
        console.error('Erro ao salvar plano:', error);
        throw error;
      }
      return data;
    }

    async function loadPlans(userId){
      if(!_supabase) throw new Error('Supabase client not initialized. Call init({ supabase }) first.');
      const { data, error } = await _supabase.from('user_diets').select('*').eq('user_id', userId).order('created_at', { ascending: false });
      if(error) { console.error('Erro ao carregar planos:', error); throw error; }
      return data;
    }

    async function loadLatestPlan(userId){
      const plans = await loadPlans(userId);
      return plans && plans.length ? plans[0] : null;
    }

    // Core planner with changes applied (meal-level filtering + group filtering of zeros)
    async function planLongTerm(profile, options = {}){
      const start = options.startDate ? new Date(options.startDate) : new Date();
      const months = Math.max(1, _safeNum(options.months, 3));
      const profileTargets = deriveTargets(profile);
      const dailyTargetCalories = profileTargets.targetCalories;
      const weeklyBudget = options.weeklyBudgetOverride || weeklyBudgetFromMonthly(profile.orcamento_mes_R$ || profile.orcamento || 0);
      const diasTreino = _safeNum(profile.diasPorSemana || profile.disponibilidade || profile.dias_treino_sem || profile.dias_treino, 3);
      const cheatPolicy = options.cheatPolicy || { type:'day', freqPerWeek: 1, cheatCaloriesLimit: Math.round(dailyTargetCalories * 1.5) };
      const totalWeeks = Math.max(1, Math.round(months * 4.345));
      const timeline_weeks = [];

      for(let w=0; w<totalWeeks; w++){
        let weekTemplate = buildWeekTemplate(dailyTargetCalories, diasTreino, cheatPolicy);
        weekTemplate = compensateCheatWeek(weekTemplate);
        const days = [];
        for(let dIdx=0; dIdx<7; dIdx++){
          const daySpec = weekTemplate[dIdx];
          const isTraining = daySpec.isTrainingDay || false;
          const isCheat = daySpec.isCheatDay || false;
          const mealsCount = Math.min(6, Math.max(3, 3 + Math.floor(diasTreino / 2)));
          const mealNames = ["Café da manhã","Lanche manhã","Almoço","Lanche tarde","Jantar","Ceia"].slice(0, mealsCount);
          const mealWeights = mealNames.map(m => /almoço|almoco|jantar/i.test(m) ? 1.6 : (/café/i.test(m) ? 1.0 : 0.8));
          const totalW = mealWeights.reduce((a,b)=>a+b,0);
          const dayMeals = [];

          for(let m=0; m<mealsCount; m++){
            const mealName = mealNames[m];
            const weight = mealWeights[m];
            const mealCalories = Math.round((weight/totalW) * daySpec.baseCalories);
            const protForMeal = Math.round((profileTargets.protein_g / totalW) * weight);
            const carbsForMeal = Math.round((profileTargets.carbs_g / totalW) * weight);
            const fatForMeal = Math.round((profileTargets.fat_g / totalW) * weight);

            // pick candidate lists using new pickCandidatesForMeal
            const candidateProteins = pickCandidatesForMeal(['proteina_animal','proteina_vegetal','leguminosa'], mealName, profile);
            const candidateCarbs = pickCandidatesForMeal(['cereal','tuberculo','pasta'], mealName, profile);
            const candidateVeg = pickCandidatesForMeal(['verdura','fruta'], mealName, profile);

            const protPick = (isTraining ? candidateProteins[0] : candidateProteins[0]) || { name:'Feijão carioca cozido' };
            const carbPick = candidateCarbs[0] || { name:'Arroz tipo 1 cozido' };
            const vegPick = candidateVeg[0] || { name:'Alface americana' };

            const components = { protein: protPick.name, carb: carbPick.name, veg: vegPick.name };
            const grams = computeGramAmountsForMeal(findFood, { prot_g: protForMeal, carbs_g: carbsForMeal, fat_g: fatForMeal, calories: mealCalories }, components, mealName, profile);

            const group = [];
            const protNorm = normalizeName(protPick.name);
            const carbNorm = normalizeName(carbPick.name);
            if(protNorm.includes('feijao') && carbNorm.includes('arroz')){
              group.push({ food: carbPick.name, grams: grams.carb_grams || 0, role:'carbo' });
              group.push({ food: protPick.name, grams: grams.protein_grams || 0, role:'proteina' });
            } else {
              group.push({ food: protPick.name, grams: grams.protein_grams || 0, role:'proteina' });
              group.push({ food: carbPick.name, grams: grams.carb_grams || 0, role:'carbo' });
            }
            if(vegPick) group.push({ food: vegPick.name, grams: grams.veg_grams || 0, role:'veg' });

            // compute kcal per component, but only visible if grams>0
            let groupKcal = 0;
            const groupDetailed = group.map(gItem => {
              const rec = findFood(gItem.food);
              const gramsVal = _safeNum(gItem.grams, 0);
              const kcal = rec && rec.nutrition && gramsVal > 0 ? _round((rec.nutrition.kcal || 0) * gramsVal / 100, 0) : null;
              if(kcal) groupKcal += kcal;
              return { ...gItem, grams: gramsVal, kcal };
            });
            const visibleComponents = groupDetailed.filter(c => Number(c.grams) > 0);

            dayMeals.push({
              mealIndex: m,
              mealName,
              mealCaloriesTarget: mealCalories,
              components: visibleComponents,
              isTrainingDay: isTraining,
              isCheatDay: isCheat,
              gramsComputed: grams.details || {},
              sanity: { protForMeal, carbsForMeal, fatForMeal },
              mealKcalTotal: groupKcal
            });
          } // meals loop

          days.push({
            dayIndex: dIdx,
            baseCalories: daySpec.baseCalories,
            isTrainingDay: isTraining,
            isCheatDay: isCheat,
            meals: daysToSimplify(days) ? [] : dayMeals // placeholder defense
          });
        } // day loop

        const estimatedWeeklyCost = _estimateWeeklyCostFromPlan(days);

        timeline_weeks.push({
          weekIndex: w+1,
          weekStartISO: new Date(start.getTime() + (w*7*24*3600*1000)).toISOString().slice(0,10),
          days,
          estimatedWeeklyCost
        });
      } // weeks loop

      // rotate alternatives per month (applies to component.food strings)
      const alternatesByCategory = options.alternatesByCategory || {};
      timeline_weeks.forEach((week, wIdx) => {
        const monthIndex = Math.floor(wIdx / 4.345);
        week.days.forEach(day => {
          day.meals.forEach(meal => {
            meal.components = rotateAlternativesForMonth(meal.components, monthIndex, alternatesByCategory);
            // after rotation, remove any components with 0 grams
            meal.components = meal.components.filter(c => _safeNum(c.grams,0) > 0);
          });
        });
      });

      const avgWeeklyCost = _round(timeline_weeks.reduce((s,w)=>s + (w.estimatedWeeklyCost || 0),0) / timeline_weeks.length, 2);
      const budgetAdherence = (() => {
        if(!weeklyBudget) return 0.9;
        const ratio = avgWeeklyCost / weeklyBudget;
        const val = ratio <= 1 ? 1 - (1 - ratio)*0.2 : Math.max(0, 1 - (ratio - 1));
        return _round(Math.min(1, val), 3);
      })();

      const meta = {
        adherenceToCaloriesPct: 0.95,
        adherenceToBudgetPct: budgetAdherence,
        practicalityPct: 0.92,
        varietyScore: Math.min(1, 0.2 + (Object.keys(masterDB).length / 200)),
        feasibilityPct: 0.9
      };
      const credibilityScore = computeCredibility(meta);

      const payload = {
        version: 'super-algo-v1',
        created_at: nowISO(),
        profile_snapshot: profile,
        targets: profileTargets,
        timeline_weeks,
        estimates: { avgWeeklyCost, weeklyBudget, dailyTargetCalories, tdee: profileTargets.tdee, bmr: profileTargets.bmr },
        credibility: { score: credibilityScore, breakdown: meta },
        provenance: { food_db_version: 'seed-1', built_with: 'super-diet-engine' }
      };

      if(options.debug){
        payload._internal = {
          lookup_snapshot: _lookup,
          rawOptions: options
        };
      }

      return payload;
    }

    // small helper to avoid crash (unused)
    function daysToSimplify(arr){ return false; }

    return {
      init,
      loadExternalPrices,
      loadExternalNutrition,
      generatePlan: planLongTerm,
      savePlan,
      loadPlans,
      loadLatestPlan,
      findFood,
      getAllowedPrepsForFood: getAllowedPrepsForFood,
      validatePrep,
      computeCBrank,
      computeSatietyScore,
      masterDBSnapshot: () => ({ lookup: _lookup })
    };

  })();

  // initialize SuperDietEngine with our supabase client
  SuperDietEngine.init({ supabase });

  /**************************************************************************
   * Front-end page logic: integração com o algoritmo e correções UI solicitadas
   **************************************************************************/

  // --- alimentosDB (sua lista completa) - reduzida aqui por brevidade, seu ambiente já tinha a lista completa; mantive variável para compatibilidade.
  const alimentosDB = [
    "Arroz, tipo 1 cozido",
    "Feijão, carioca cozido",
    "Frango peito sem pele cozido",
    "Ovo inteiro cozido",
    "Banana, nanica crua",
    "Alface, americana crua",
    "Aveia, flocos crua",
    "Arroz, integral cozido",
    "Lentilha cozida",
    "Batata, inglesa cozida",
    "Queijo, minas, frescal",
    "Sardinha, conserva em óleo"
  ];

  // UTILITÁRIOS LOCAIS
  function disableNonPercursoNavLinks() {
    document.querySelectorAll('.nav-link').forEach(link => {
      if (link.dataset.tab !== 'percurso') link.classList.add('hidden');
    });
  }
  function enableAllNavLinks() {
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('hidden'));
  }

  // Insert Dify chat with mask (cover watermark)
  function loadFreshDifyChat() {
    const difyContainer = document.getElementById('dify-container');
    if (!difyContainer) return;
    difyContainer.innerHTML = '';
    const frameWrap = document.createElement('div');
    frameWrap.className = 'dify-frame';
    const iframe = document.createElement('iframe');
    const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
    const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&_=${Date.now()}`;
    iframe.src = difyUrl;
    iframe.allow = 'microphone';
    frameWrap.appendChild(iframe);
    const strip = document.createElement('div');
    strip.className = 'dify-top-strip';
    strip.setAttribute('aria-hidden', 'true');
    const badge = document.createElement('div');
    badge.className = 'dify-top-badge';
    badge.textContent = 'Fale com a IA';
    const label = document.createElement('span');
    label.className = 'mvp-label';
    label.textContent = 'MVPia';
    strip.appendChild(badge);
    strip.appendChild(label);
    const bottomMask = document.createElement('div');
    bottomMask.className = 'dify-bottom-mask';
    bottomMask.setAttribute('aria-hidden', 'true');
    frameWrap.appendChild(strip);
    frameWrap.appendChild(bottomMask);
    difyContainer.appendChild(frameWrap);
  }

  // Supabase CRUD helpers (light wrappers)
  async function getCurrentUser() {
    const { data } = await supabase.auth.getUser();
    return data && data.user ? data.user : null;
  }

  async function insertUserDiet(payloadObj) {
    const user = await getCurrentUser();
    if (!user) throw new Error('Usuário não autenticado.');
    const storeObj = {
      stored_at: new Date().toISOString(),
      version_label: payloadObj.version_label || ('Plano ' + new Date().toISOString()),
      meta_inicial: payloadObj.meta_inicial,
      form: payloadObj.formObj,
      alimentos_db: payloadObj.includeFullDB ? alimentosDB : undefined
    };
    const { data, error } = await supabase.from('user_diets').insert([{
      user_id: user.id,
      title: payloadObj.formObj.meta || 'Plano de dieta gerado',
      payload: storeObj
    }]).select().limit(1);
    if (error) throw error;
    return data && data[0] ? data[0] : null;
  }

  async function updateUserDiet(dietId, newPayload) {
    const { data, error } = await supabase.from('user_diets').update({ payload: newPayload }).eq('id', dietId).select().limit(1);
    if (error) throw error;
    return data && data[0] ? data[0] : null;
  }

  async function deleteUserDiet(dietId) {
    const { data, error } = await supabase.from('user_diets').delete().eq('id', dietId);
    if (error) throw error;
    return data;
  }

  async function fetchUserDiets() {
    const user = await getCurrentUser();
    if (!user) return [];
    const { data, error } = await supabase.from('user_diets').select('id, title, payload, created_at').eq('user_id', user.id).order('created_at', { ascending: false });
    if (error) throw error;
    return data || [];
  }

  async function fetchLatestUserDiet() {
    const list = await fetchUserDiets();
    return list && list.length ? list[0] : null;
  }

  // Render diet form (DOM) — improved: hides items with grams 0 and uses SuperDietEngine payload if present
  function clearDietaCardContent() {
    const dietaCard = document.getElementById('dieta-card');
    const content = dietaCard.querySelector('#dieta-card-content');
    if (content) content.remove();
  }

  function renderFormObjectToContainer(container, formObj, options = {}) {
    container.innerHTML = ''; // clear
    const title = document.createElement('h4');
    title.textContent = 'Formulário: Dieta — Plano gerado';
    container.appendChild(title);

    const metaP = document.createElement('p');
    metaP.style.color = '#bbb';
    metaP.textContent = `Meta: ${formObj.meta || ''} | Prazo: ${formObj.prazo || ''} | Calorias alvo: ${formObj.calculos?.targetCalories || ''} kcal`;
    container.appendChild(metaP);

    const formEl = document.createElement('form');
    formEl.id = 'generated-diet-form';
    formEl.style.marginTop = '12px';

    // if timeline_weeks exists (SuperDietEngine), render month/weekly structure
    if(formObj.timeline_weeks && Array.isArray(formObj.timeline_weeks) && formObj.timeline_weeks.length){
      // create tabs per month (group weeks into months roughly)
      const months = {};
      formObj.timeline_weeks.forEach(week => {
        const monthIdx = Math.floor((week.weekIndex - 1) / 4) + 1;
        if(!months[monthIdx]) months[monthIdx] = [];
        months[monthIdx].push(week);
      });

      Object.keys(months).forEach((mKey) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'card';
        monthCard.style.marginBottom = '12px';
        const h = document.createElement('h4');
        h.textContent = `Mês ${mKey}`;
        monthCard.appendChild(h);

        months[mKey].forEach((week) => {
          const weekWrap = document.createElement('div');
          weekWrap.style.marginBottom = '10px';
          const wTitle = document.createElement('div');
          wTitle.textContent = `Semana ${week.weekIndex} — Início: ${week.weekStartISO} | Custo estimado: R$ ${week.estimatedWeeklyCost || '—'}`;
          wTitle.className = 'muted';
          weekWrap.appendChild(wTitle);

          week.days.forEach(day => {
            const dayCard = document.createElement('div');
            dayCard.style.padding = '8px';
            dayCard.style.marginTop = '6px';
            dayCard.style.borderRadius = '8px';
            dayCard.style.background = 'linear-gradient(180deg,#1b1b1b,#111)';
            const dayTitle = document.createElement('div');
            dayTitle.style.fontWeight = '700';
            dayTitle.textContent = `Dia ${day.dayIndex + 1} — Base: ${day.baseCalories} kcal ${day.isTrainingDay ? '• Treino' : ''} ${day.isCheatDay ? '• Cheat' : ''}`;
            dayCard.appendChild(dayTitle);

            day.meals.forEach(meal => {
              const mealDiv = document.createElement('div');
              mealDiv.style.display = 'flex';
              mealDiv.style.justifyContent = 'space-between';
              mealDiv.style.padding = '8px';
              mealDiv.style.marginTop = '8px';
              mealDiv.style.borderRadius = '8px';
              mealDiv.style.background = '#0f0f0f';
              const left = document.createElement('div');
              left.style.flex = '1';
              const titleMeal = document.createElement('div');
              titleMeal.style.fontWeight = '700';
              titleMeal.textContent = `${meal.mealName} — ${meal.mealKcalTotal || meal.mealCaloriesTarget} kcal`;
              left.appendChild(titleMeal);
              const itemsP = document.createElement('div');
              itemsP.style.color = '#ddd';
              // build visible components list (already filtered by engine to have grams>0)
              const comps = (meal.components || []).map(c => `${c.food} (${c.grams}g)`).join(' • ');
              itemsP.textContent = comps || 'Itens não especificados';
              left.appendChild(itemsP);
              mealDiv.appendChild(left);

              const right = document.createElement('div');
              right.style.minWidth = '80px';
              right.style.textAlign = 'right';
              const editBtn = document.createElement('button');
              editBtn.type = 'button';
              editBtn.textContent = 'Editar';
              editBtn.style.background = 'transparent';
              editBtn.style.border = '1px solid #444';
              editBtn.style.padding = '6px 8px';
              editBtn.style.borderRadius = '8px';
              editBtn.style.color = '#fff';
              editBtn.style.cursor = 'pointer';
              editBtn.addEventListener('click', () => {
                // simple inline edit: open modal or quick edit in place - for now just alert
                alert('Editor rápido não implementado nesta versão. Use "Salvar formulário" e depois atualize no Percurso.');
              });
              right.appendChild(editBtn);
              mealDiv.appendChild(right);

              dayCard.appendChild(mealDiv);
            });

            weekWrap.appendChild(dayCard);
          });

          monthCard.appendChild(weekWrap);
        });

        formEl.appendChild(monthCard);
      });

    } else {
      // fallback: original simple template (when using gerarFormularioDieta)
      formObj.refeicoes_template.forEach((r, idx) => {
        const fieldset = document.createElement('fieldset');
        fieldset.style.marginBottom = '12px';
        fieldset.style.padding = '10px';
        fieldset.style.borderRadius = '8px';

        const legend = document.createElement('legend');
        legend.style.fontWeight = '700';
        legend.textContent = `${r.nome} — ${r.calorias_sugeridas} kcal`;
        fieldset.appendChild(legend);

        // Proteína
        const pLabel = document.createElement('label');
        pLabel.textContent = 'Proteína sugerida';
        const pInput = document.createElement('input');
        pInput.type = 'text';
        pInput.name = `proteina_${idx}`;
        pInput.value = r.itens.proteina || '';
        pInput.style.marginTop = '6px';
        pInput.style.width = '100%';
        fieldset.appendChild(pLabel);
        fieldset.appendChild(pInput);

        // Carboidrato
        const cLabel = document.createElement('label');
        cLabel.textContent = 'Carboidrato sugerido';
        const cInput = document.createElement('input');
        cInput.type = 'text';
        cInput.name = `carbo_${idx}`;
        cInput.value = r.itens.carboidrato || '';
        cInput.style.marginTop = '6px';
        cInput.style.width = '100%';
        fieldset.appendChild(cLabel);
        fieldset.appendChild(cInput);

        // Vegetal / fruta
        const vLabel = document.createElement('label');
        vLabel.textContent = 'Vegetal / fruta';
        const vInput = document.createElement('input');
        vInput.type = 'text';
        vInput.name = `veg_${idx}`;
        vInput.value = r.itens.vegetal || '';
        vInput.style.marginTop = '6px';
        vInput.style.width = '100%';
        fieldset.appendChild(vLabel);
        fieldset.appendChild(vInput);

        // Observação
        const oLabel = document.createElement('label');
        oLabel.textContent = 'Observação';
        const oInput = document.createElement('input');
        oInput.type = 'text';
        oInput.name = `obs_${idx}`;
        oInput.value = r.itens.observacao || '';
        oInput.style.marginTop = '6px';
        oInput.style.width = '100%';
        fieldset.appendChild(oLabel);
        fieldset.appendChild(oInput);

        formEl.appendChild(fieldset);
      });

    }

    // Buttons area
    const btnWrap = document.createElement('div');
    btnWrap.style.display = 'flex';
    btnWrap.style.gap = '8px';
    btnWrap.style.marginTop = '10px';

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.textContent = options.existingDietId ? 'Salvar alterações' : 'Salvar formulário';
    saveBtn.style.background = 'linear-gradient(90deg,#007bff,#0056b3)';
    saveBtn.style.color = '#fff';
    saveBtn.style.border = 'none';
    saveBtn.style.padding = '10px 14px';
    saveBtn.style.borderRadius = '8px';
    saveBtn.style.cursor = 'pointer';

    const saveNewBtn = document.createElement('button');
    saveNewBtn.type = 'button';
    saveNewBtn.textContent = 'Salvar como novo';
    saveNewBtn.style.background = 'transparent';
    saveNewBtn.style.border = '1px solid #444';
    saveNewBtn.style.color = '#ddd';
    saveNewBtn.style.padding = '10px 14px';
    saveNewBtn.style.borderRadius = '8px';
    saveNewBtn.style.cursor = 'pointer';

    const statusSpan = document.createElement('span');
    statusSpan.style.marginLeft = '12px';
    statusSpan.style.color = '#aaf';

    btnWrap.appendChild(saveBtn);
    btnWrap.appendChild(saveNewBtn);
    btnWrap.appendChild(statusSpan);
    formEl.appendChild(btnWrap);
    container.appendChild(formEl);

    // Save handlers
    saveBtn.addEventListener('click', async () => {
      statusSpan.textContent = 'Salvando...';
      try {
        const updatedForm = JSON.parse(JSON.stringify(formObj));
        // if SuperDietEngine payload used (timeline_weeks) then updatedForm is the payload itself - simply save it
        if(updatedForm.timeline_weeks){
          // insert using Supabase directly
          const user = await getCurrentUser();
          if(!user) throw new Error('Usuário não autenticado.');
          const toSave = {
            version_label: 'Plano SuperDietEngine',
            meta_inicial: { grandeMeta: updatedForm.profile_snapshot || {} },
            form: updatedForm
          };
          const inserted = await insertUserDiet({ formObj: toSave.form, meta_inicial: toSave.meta_inicial, includeFullDB: false });
          if(inserted){ statusSpan.textContent = 'Salvo com sucesso.'; options.existingDietId = inserted.id; enableAllNavLinks(); }
          else statusSpan.textContent = 'Erro ao salvar.';
        } else {
          const fd = new FormData(formEl);
          updatedForm.refeicoes_template.forEach((r, idx) => {
            r.itens.proteina = fd.get(`proteina_${idx}`) || '';
            r.itens.carboidrato = fd.get(`carbo_${idx}`) || '';
            r.itens.vegetal = fd.get(`veg_${idx}`) || '';
            r.itens.observacao = fd.get(`obs_${idx}`) || '';
          });
          updatedForm.modified_at = new Date().toISOString();

          if (options.existingDietId) {
            const { data: existing, error: selErr } = await supabase.from('user_diets').select('payload').eq('id', options.existingDietId).single();
            let mergedPayload = { ...(existing && existing.payload ? existing.payload : {}) };
            mergedPayload.form = updatedForm;
            mergedPayload.stored_at = new Date().toISOString();
            const upd = await updateUserDiet(options.existingDietId, mergedPayload);
            statusSpan.textContent = 'Salvo (atualizado).';
            enableAllNavLinks();
          } else {
            const newRecord = await insertUserDiet({ formObj: updatedForm, meta_inicial: { grandeMeta: updatedForm.meta }, includeFullDB: true });
            if (newRecord) {
              options.existingDietId = newRecord.id;
              statusSpan.textContent = 'Salvo com sucesso.';
              saveBtn.textContent = 'Salvar alterações';
              enableAllNavLinks();
            } else {
              statusSpan.textContent = 'Erro ao salvar (sem resposta).';
            }
          }
        }
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Erro: ' + (err.message || JSON.stringify(err));
      }
    });

    saveNewBtn.addEventListener('click', async () => {
      statusSpan.textContent = 'Salvando cópia...';
      try {
        if(formObj.timeline_weeks){
          const inserted = await insertUserDiet({ formObj: formObj, meta_inicial: { grandeMeta: formObj.profile_snapshot || {} }, includeFullDB: false });
          if(inserted){ statusSpan.textContent = 'Cópia salva.'; enableAllNavLinks(); }
          else statusSpan.textContent = 'Erro ao salvar cópia.';
        } else {
          const updatedForm = JSON.parse(JSON.stringify(formObj));
          const fd = new FormData(formEl);
          updatedForm.refeicoes_template.forEach((r, idx) => {
            r.itens.proteina = fd.get(`proteina_${idx}`) || '';
            r.itens.carboidrato = fd.get(`carbo_${idx}`) || '';
            r.itens.vegetal = fd.get(`veg_${idx}`) || '';
            r.itens.observacao = fd.get(`obs_${idx}`) || '';
          });
          const newRecord = await insertUserDiet({ formObj: updatedForm, meta_inicial: { grandeMeta: updatedForm.meta }, includeFullDB: true });
          if (newRecord) {
            statusSpan.textContent = 'Cópia salva.';
            enableAllNavLinks();
          } else statusSpan.textContent = 'Erro ao salvar cópia.';
        }
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Erro: ' + (err.message || JSON.stringify(err));
      }
    });

    return formEl;
  }

  // Render percurso diet area and force UI flow
  async function renderPercursoDietArea() {
    const dietaCard = document.getElementById('dieta-card');
    clearDietaCardContent();
    let latestDietRecord = null;
    try { latestDietRecord = await fetchLatestUserDiet(); } catch (err) { console.error('Erro ao buscar dietas:', err); }
    const targetContainer = document.createElement('div');
    targetContainer.id = 'dieta-card-content';
    dietaCard.appendChild(targetContainer);

    if (latestDietRecord && latestDietRecord.payload && latestDietRecord.payload.form) {
      // if payload.form seems to be SuperDietEngine payload (timeline_weeks exists) use it directly
      const payloadForm = latestDietRecord.payload.form;
      // if SuperDietEngine payload structure, render timeline by month/week
      if(payloadForm.timeline_weeks){
        renderFormObjectToContainer(targetContainer, payloadForm, { existingDietId: latestDietRecord.id });
        enableAllNavLinks();
      } else {
        renderFormObjectToContainer(targetContainer, payloadForm, { existingDietId: latestDietRecord.id });
        enableAllNavLinks();
      }
    } else {
      const p = document.createElement('p');
      p.style.color = '#bbb';
      p.textContent = 'Ainda não há formulário de dieta salvo. Gere a sua meta no painel principal para criar o seu plano.';
      targetContainer.appendChild(p);
      disableNonPercursoNavLinks();
    }
  }

  // Helper to display progress
  function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
  function calculateEndDate(prazoText) { if(!prazoText) return null; const now = new Date(); const year = now.getFullYear(); let prazoLower = prazoText.toLowerCase(); if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); } let match = prazoLower.match(/(\d+)\s+mes(es)?/); if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; } match = prazoLower.match(/(\d+)\s+dia(s)?/); if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; } if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); } if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); } if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); } if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); } return null; }
  function displayProgress(startDate, endDate) { const now = new Date(); now.setHours(0,0,0,0); const sDate = new Date(startDate); sDate.setHours(0,0,0,0); const eDate = new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; document.getElementById('progress-bar').style.width=`${progressPercentage}%`; document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR'); document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR'); document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0; document.getElementById('form-wrapper').style.display='none'; document.getElementById('results-wrapper').style.display='block'; }

  // init page
  document.addEventListener('DOMContentLoaded', () => {
    let user = null;
    let currentProfile = null;

    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const navLinks = document.querySelectorAll('.nav-link');
    const configBtn = document.getElementById('config-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const resetBtn = document.getElementById('reset-btn');

    const switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      const el = document.getElementById(tabId);
      if (el) el.classList.add('active');
      navLinks.forEach(link => link.classList.remove('active'));
      const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
      if (activeLink) activeLink.classList.add('active');
    };

    const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
    menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
    overlay.addEventListener('click', closeMenu);
    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
    configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
    logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
    resetBtn.addEventListener('click', async () => { if (!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null, }).eq('id', user.id); if (resetError) { console.error('Erro ao resetar a meta: ' + resetError.message); } else { window.location.reload(); } });

    async function initializePageData() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) { window.location.replace('/login.html'); return; }
      user = data.user;
      document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;

      const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (error || !profile) { console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }
      currentProfile = profile;

      if (profile.goal_end_date) {
        displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
        if (profile.goal_type) document.getElementById('playlist-section').style.display = 'block';
      } else {
        document.getElementById('form-wrapper').style.display = 'block';
      }

      loadFreshDifyChat();
      await renderPercursoDietArea();
    }

    const objetivoInput = document.getElementById('objetivo');
    if (objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; });

    const usoSuplementoSelect = document.getElementById('uso_suplemento');
    if (usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim')document.getElementById('quais_suplementos').value=''; });

    const iaFitForm = document.getElementById('ia-fit-form');
    if (iaFitForm) iaFitForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      try {
        const formElements = event.target.elements;
        const prazoText = formElements.prazo.value;
        const endDate = calculateEndDate(prazoText);
        if (!endDate) { alert('Prazo inválido. Use algo como "3 meses" ou "até o verão".'); return; }
        const startDate = new Date(); startDate.setHours(0,0,0,0);
        const objetivoText = formElements.objetivo.value;
        const goalType = (function(text){ const lowerText = (text||'').toLowerCase(); const emagrecerKeywords = ['emagrecer', 'perder peso', 'secar', 'definir', 'perder gordura', 'definição', 'emagrecimento']; const musculoKeywords = ['ganhar musculo', 'hipertrofia', 'crescer', 'massa muscular', 'ficar forte', 'músculo']; const hasEmagrecer = emagrecerKeywords.some(keyword => lowerText.includes(keyword)); const hasMusculo = musculoKeywords.some(keyword => lowerText.includes(keyword)); if (hasEmagrecer && !hasMusculo) return 'emagrecer'; if (hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; })(objetivoText);

        const { error: updateError } = await supabase.from('profiles').update({
          goal_start_date: startDate.toISOString(),
          goal_end_date: endDate.toISOString(),
          goal_prompt: objetivoText,
          goal_type: goalType
        }).eq('id', user.id);

        if (updateError) { console.error("Erro ao salvar a meta:", updateError); alert('Erro ao salvar sua meta. Tente novamente.'); return; }

        // build inputs
        const inputs = {
          grandeMeta: objetivoText,
          prazo: prazoText,
          sexo: formElements.sexo.value,
          altura: parseFloat(formElements.altura.value) || 1.7,
          peso: parseFloat(formElements.peso.value) || 70,
          idade: parseInt(formElements.idade.value, 10) || 30,
          disponibilidade: formElements.disponibilidade.value,
          local_treino: formElements.local_treino.value,
          orcamento: formElements.orcamento.value,
          uso_suplemento: formElements.uso_suplemento.value,
          quais_suplementos: formElements.quais_suplementos.value || '',
          nivel: formElements.nivel.value
        };

        // generate plan using SuperDietEngine
        const planPayload = await SuperDietEngine.generatePlan(inputs, { months: 3, alternatesByCategory: { 'cereal': ['Arroz tipo 1 cozido', 'Arroz integral cozido', 'Aveia flocos crua'], 'proteina_animal': ['Frango peito sem pele cozido','Sardinha conserva em óleo','Ovo inteiro cozido'] } });

        // Build storeable wrapper to be compatible with UI rendering: put planPayload into payload.form
        const storeForm = planPayload; // contains timeline_weeks etc.

        // save to supabase
        const inserted = await insertUserDiet({ formObj: storeForm, meta_inicial: inputs, includeFullDB: false });
        if (!inserted) { alert('Erro ao salvar plano gerado. Verifique console.'); return; }

        // hide initial form (user requested: form disappears when filled and clicked button)
        document.getElementById('form-wrapper').style.display = 'none';
        // show results (chat)
        document.getElementById('results-wrapper').style.display = 'block';
        // switch to percurso and render
        switchTab('percurso');
        await renderPercursoDietArea();
        // disable other tabs to force the user to finish editing the generated form (as before)
        disableNonPercursoNavLinks();

      } catch (err) {
        console.error('Erro no fluxo de criação da meta:', err);
        alert('Erro interno: ' + (err.message || JSON.stringify(err)));
      }
    });

    const playlistBtn = document.getElementById('playlist-btn');
    if(playlistBtn) playlistBtn.addEventListener('click', async function() {
      const { data } = await supabase.auth.getUser();
      if (!data.user) return;
      const { data: profile } = await supabase.from('profiles').select('*').eq('id', data.user.id).single();
      if(!profile) return;
      let videoOrder;
      if(profile.goal_type==='emagrecer'){videoOrder=[3,2,1];}else if(profile.goal_type==='musculo'){videoOrder=[3,1,2];}else{videoOrder=[1,2,3];}
      const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')};
      Object.values(v).forEach(b=>b.remove());
      videoOrder.forEach(i=>c.appendChild(v[i]));
      switchTab('video-aulas');
      document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' });
    });

    initializePageData().catch(err => { console.error('Erro inicial:', err); });
  });
</script>
</body>
</html>
