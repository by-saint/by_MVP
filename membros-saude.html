<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
      --bg: #121212;
      --card: #1E1E1E;
      --muted: #bbb;
    }
    html { scroll-behavior: smooth; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: #E0E0E0; margin: 0; padding: 40px 20px; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
    h1,h2,h3{ color:#f0f0f0; text-align:center; margin-top:30px; margin-bottom:15px; }

    /* MENU / SIDEBAR */
    .menu-toggle { position: fixed; top: 25px; left: 25px; z-index: 1001; background: #333; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:5px; padding:0; }
    .menu-toggle .bar { width:24px; height:3px; background-color:#fff; border-radius:2px; transition: all 0.3s; }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--card); transition: left 0.28s ease; z-index:1000; border-right:1px solid #333; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar.open { left: 0; }
    .sidebar nav { padding-top: 100px; }
    .sidebar nav ul{ list-style:none; padding:0; margin:0; }
    /* Nav link style updated to show colored rectangle at left when active */
    .sidebar nav a{ display:block; padding:15px 30px; padding-left:44px; text-decoration:none; font-size:1.05em; font-weight:700; border-left:5px solid transparent; transition: background-color 0.2s, border-left 0.2s; color:var(--muted); position:relative; }
    .sidebar nav a::before { content: ''; position:absolute; left:12px; top:50%; transform:translateY(-50%); width:8px; height:60%; border-radius:4px; opacity:0; transition: opacity 0.18s, transform 0.18s; }
    .sidebar nav a:hover{ background-color:#2c2c2c; color:#fff; }
    .sidebar nav a.active{ background-color:rgba(255,255,255,0.02); color:#fff; }
    /* colored rectangle per tab */
    .link-ia.active::before { background: linear-gradient(180deg,var(--color-ia-specialist), #0056b3); opacity:1; }
    .link-aulas.active::before { background: linear-gradient(180deg,#c048f2,#6b21a8); opacity:1; }
    .link-percurso.active::before { background: linear-gradient(180deg,var(--journey-red-1),var(--journey-red-2)); opacity:1; }

    .sidebar-footer { padding:20px 30px; text-align:center; }
    .sidebar-config-btn { width:100%; background:transparent; border:1px solid #444; color:#aaa; padding:10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:600; }
    .sidebar-config-btn:hover{ background:#333; color:#fff; }
    .sidebar-action-btn{ width:100%; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.2s; margin-top:10px; }
    .sidebar-reset-btn{ background:transparent; border:1px solid var(--color-ia-specialist); color:var(--color-ia-specialist); }
    .sidebar-reset-btn:hover{ background:var(--color-ia-specialist); color:#fff; }
    .sidebar-logout-btn{ background:#be123c; border:1px solid #be123c; color:#fff; }
    .sidebar-logout-btn:hover{ background:#ff4757; border-color:#ff4757; }
    .hidden{ display:none; }

    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; opacity:0; visibility:hidden; transition:opacity 0.28s, visibility 0.28s; }
    .overlay.show{ opacity:1; visibility:visible; }

    .header { display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px; }
    #welcome-msg { color:#bbb; margin-right:20px; }

    .tab-content{ display:none; }
    .tab-content.active{ display:block; }
    .form-wrapper, .results-wrapper { width:100%; max-width:900px; margin:0 auto; }

    .form-container, .results-container, .percurso-container { background-color: var(--card); padding:40px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; color:#E0E0E0; }
    .form-group{ margin-bottom:20px; }
    label{ display:block; margin-bottom:8px; font-weight:600; color:#BBBBBB; }
    input, select, textarea { width:100%; padding:12px; background-color:#2C2C2C; border:1px solid #444; border-radius:8px; color:#E0E0E0; font-size:16px; box-sizing:border-box; }
    textarea{ resize:vertical; min-height:100px; }

    .goal-section{ background: linear-gradient(145deg,#2a2a2a,#1a1a1a); border:1px solid #444; padding:30px; margin-bottom:24px; border-radius:10px; text-align:center; }
    .goal-title{ font-size:28px; font-weight:700; background: linear-gradient(90deg,#007BFF,#00C6FF); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    button[type="submit"]{ width:100%; padding:15px; background:linear-gradient(90deg,#007BFF,#0056b3); border:none; border-radius:8px; color:#fff; font-size:18px; font-weight:600; cursor:pointer; }

    .progress-section{ margin-top:24px; padding:20px; background-color:#2C2C2C; border-radius:10px; }
    .progress-bar-container{ width:100%; background-color:#444; border-radius:10px; overflow:hidden; }
    .progress-bar{ width:0%; background-color:#007BFF; height:20px; transition: width 0.5s ease-in-out; }
    .progress-labels{ display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-top:5px; }
    .countdown-container{text-align:center; margin-top:20px; }
    .countdown-days{ font-size:4rem; font-weight:700; color:#fff; line-height:1; }
    .countdown-label{ font-size:1rem; color:#aaa; }

    .playlist-section{ text-align:center; margin:24px 0; }
    .playlist-btn{ background:#007BFF; color:white; border:none; padding:12px 24px; font-size:1.1em; cursor:pointer; border-radius:8px; }

    .percurso-forms{ display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:20px; }
    .percurso-card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border:1px solid rgba(190,18,60,0.06); padding:20px; border-radius:12px; }
    .generated-diet-card{ border:2px solid rgba(190,18,60,0.14); box-shadow:0 8px 24px rgba(190,18,60,0.06); padding:18px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.16)); color:#ddd; }

    /* Plan UI */
    .plan-tabs{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .plan-tab{ padding:8px 12px; border-radius:999px; background:#2b2b2b; color:#fff; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
    .plan-tab.active{ background: linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2)); color:white; }
    .plan-days{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .plan-day{ background: linear-gradient(180deg,#141414,#0f0f0f); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-row{ margin-bottom:10px; padding:8px; border-radius:8px; background:#0d0d0d; display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid rgba(255,255,255,0.02); }
    .meal-left{ display:flex; gap:10px; align-items:center; }
    .meal-name{ font-weight:700; color:#fff; }
    .meal-kcal{ font-weight:700; color:#f3f3f3; background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; }

    /* dify */
    .iframe-container{ border-radius:12px; overflow:hidden; position:relative; height:70vh; min-height:340px; max-height:720px; background:#000; }
    .dify-top-strip{ position:absolute; top:0; left:0; width:100%; height:50px; background:#000000; z-index:2; pointer-events:none; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-sizing:border-box; }
    .dify-top-badge{ font-weight:700; font-size:1.1em; color:#fff; background: linear-gradient(90deg,#007BFF,#0056b3); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .mvp-label{ font-size:10px; font-weight:700; color:#555; text-transform:uppercase; letter-spacing:0.5px; }

    /* day selector */
    .day-selector-container { background-color: #2C2C2C; border:1px solid #444; border-radius:8px; }
    .day-selector-summary { padding:12px; font-weight:600; color:#BBBBBB; cursor:pointer; position:relative; }
    .day-selector-summary::after { content:'▼'; font-size:0.8em; position:absolute; right:15px; top:14px; transition:transform 0.2s; }
    .day-selector-container[open] .day-selector-summary::after { transform: rotate(180deg); }
    .day-selector-grid { display:flex; flex-wrap:wrap; gap:10px; padding:0 12px 12px 12px; justify-content:center; }
    .day-circle-input{ display:none; }
    .day-circle-label{ display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:50%; border:2px solid #555; background:#333; color:#E0E0E0; font-size:14px; font-weight:700; cursor:pointer; user-select:none; }
    .day-circle-input:checked + .day-circle-label{ background:var(--color-ia-specialist); border-color:var(--color-ia-specialist); color:#fff; box-shadow:0 0 10px rgba(0,123,255,0.5); }

    @media(max-width:900px){
      .percurso-forms{ grid-template-columns:1fr; }
      .plan-days{ grid-template-columns:1fr; }
      body{ padding:20px 12px; }
      .day-circle-label{ width:36px; height:36px; font-size:13px; }
      .iframe-container{ height:48vh; min-height:220px; }
    }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>

  <div class="sidebar" id="sidebar">
    <nav>
      <ul>
        <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
        <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
        <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button>
      <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
      <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="container">
    <div class="header">
      <p id="welcome-msg">A carregar...</p>
    </div>

    <!-- IA PLANEJAMENTO -->
    <div id="ia-planejamento" class="tab-content active">
      <div class="form-wrapper" id="form-wrapper" style="display:block;">
        <div class="form-container">
          <h1>Crie a sua Meta</h1>
          <form id="ia-fit-form">
            <div class="goal-section">
              <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
              <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo... (Ex: perder 10kg, ganhar massa muscular)" required></textarea>

              <div id="prazo-group" class="form-group" style="margin-top:20px; text-align:left; display:none;">
                <label for="prazo">Qual o prazo para esta meta?</label>
                <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, 1 ano, 1.5 anos..." required>
              </div>
            </div>

            <h3>Informações Básicas e Realidade Atual</h3>

            <div class="form-group"><label for="sexo">Sexo</label>
              <select id="sexo" name="sexo" required>
                <option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option>
              </select>
            </div>

            <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
            <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
            <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>

            <div class="form-group">
              <details class="day-selector-container">
                <summary class="day-selector-summary">Dias de treino</summary>
                <div class="day-selector-grid">
                  <input type="checkbox" name="dias_treino" value="seg" id="dia-seg" class="day-circle-input"><label for="dia-seg" class="day-circle-label">Seg</label>
                  <input type="checkbox" name="dias_treino" value="ter" id="dia-ter" class="day-circle-input"><label for="dia-ter" class="day-circle-label">Ter</label>
                  <input type="checkbox" name="dias_treino" value="qua" id="dia-qua" class="day-circle-input"><label for="dia-qua" class="day-circle-label">Qua</label>
                  <input type="checkbox" name="dias_treino" value="qui" id="dia-qui" class="day-circle-input"><label for="dia-qui" class="day-circle-label">Qui</label>
                  <input type="checkbox" name="dias_treino" value="sex" id="dia-sex" class="day-circle-input"><label for="dia-sex" class="day-circle-label">Sex</label>
                  <input type="checkbox" name="dias_treino" value="sab" id="dia-sab" class="day-circle-input"><label for="dia-sab" class="day-circle-label">Sáb</label>
                  <input type="checkbox" name="dias_treino" value="dom" id="dia-dom" class="day-circle-input"><label for="dia-dom" class="day-circle-label">Dom</label>
                </div>
              </details>
            </div>

            <div class="form-group"><label for="local_treino">Onde vai treinar?</label>
              <select id="local_treino" name="local_treino" required>
                <option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option>
              </select>
            </div>

            <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>

            <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label>
              <select id="uso_suplemento" name="uso_suplemento" required>
                <option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option>
              </select>
            </div>

            <div class="form-group" id="suplementos-detalhes-group" style="display:none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>

            <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label>
              <select id="nivel" name="nivel" required>
                <option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option>
              </select>
            </div>

            <button type="submit">Crie seu próprio caminho</button>
          </form>
        </div>
      </div>

      <div class="results-wrapper" id="results-wrapper" style="display:none;">
        <div class="results-container">
          <h2>Fale com a IA</h2>
          <div id="dify-container" class="iframe-container">
            <div class="dify-top-strip"><div class="dify-top-badge">Fale com a IA</div><div class="mvp-label">MVPia</div></div>
            <iframe id="dify-iframe" src="" frameborder="0" style="position:absolute; inset:0; width:100%; height:100%;"></iframe>
            <div class="dify-bottom-mask"></div>
          </div>

          <div class="playlist-section" id="playlist-section" style="display:none;">
            <h4>Roteiro de Aulas Sugerido</h4>
            <p style="color:#bbb; margin-top:-10px;">Com base na sua meta, preparamos um roteiro para acelerar os seus resultados.</p>
            <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
          </div>

          <div class="progress-section">
            <h3>Sua Jornada</h3>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
            <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIDEO AULAS -->
    <div id="video-aulas" class="tab-content">
      <h2>Nossas Aulas</h2>
      <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
      <div id="video-block-2" style="margin-top:18px;"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
      <div id="video-block-3" style="margin-top:18px;"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:12px;"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0;"></iframe></div></div>
    </div>

    <!-- PERCURSO -->
    <div id="percurso" class="tab-content">
      <div class="percurso-container">
        <h2>Meu Percurso</h2>
        <p style="text-align:center;color:#bbb;">Abaixo está seu formulário / plano de dieta. Edite, salve ou crie novas versões.</p>
        <div class="percurso-forms">
          <div class="percurso-card" id="treino-card">
            <h4>Formulário: Treino</h4>
            <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
            <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
          </div>

          <div class="percurso-card generated-diet-card" id="dieta-card">
            <h4>Formulário: Dieta</h4>
            <div id="dieta-card-content"><p style="color:#bbb;">Seu formulário de dieta será exibido aqui após você criar sua meta.</p></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- SCRIPT (module kept for supabase import) -->
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Supabase example (use your credentials)
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  /* ===========================================
     SuperDietEngine v5/6 - FOOD DATABASE (user-provided)
     =========================================== */
  const v5_FoodDatabase = {
    /* ... (same food database as in previous message) ... */
  };

  // (populate v5_FoodDatabase entries as in prior full code)
  // For brevity here: we assume the same large v5_FoodDatabase object used earlier was pasted in full.
  // In your file keep the full v5_FoodDatabase object (from the code I previously gave).
  // --- ensure entries like 'frango_peito', 'frango_sobrecoxa', 'creatina_monohidratada' and others exist.

  // Add creatine entry and whey alias if missing
  v5_FoodDatabase['creatina_monohidratada'] = v5_FoodDatabase['creatina_monohidratada'] || {
    name: 'Creatina monohidratada',
    nutrition: { kcal:0, protein_g:0, carb_g:0, fat_g:0, fiber_g:0 },
    price_per_kg: 300.0,
    category: 'suplemento',
    ig: 0
  };
  if(v5_FoodDatabase['whey_protein_concentrado']){
    v5_FoodDatabase['whey_concentrado'] = { ...v5_FoodDatabase['whey_protein_concentrado'], name: 'Whey concentrado' };
  }

  /* Build master lookup and helper utilities */
  const masterDB = {};
  Object.keys(v5_FoodDatabase).forEach(k => {
    const s = v5_FoodDatabase[k];
    masterDB[k] = {
      id: k,
      name: s.name,
      nutrition: s.nutrition || {},
      price_per_kg: s.price_per_kg || 0,
      category: s.category || 'other',
      ig: (typeof s.ig !== 'undefined') ? s.ig : null
    };
  });

  function normalizeName(n){ return (n||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim(); }
  function stripParenthesis(name){ if(!name) return name; return name.replace(/\s*\(.*?\)\s*/g,'').trim(); }

  function buildLookup(db){
    const byName = {}, byId = {};
    Object.values(db).forEach(rec => {
      const norm = normalizeName(stripParenthesis(rec.name));
      byName[norm] = rec;
      byId[rec.id] = rec;
      byName[normalizeName(rec.id)] = rec;
    });
    return { byName, byId };
  }
  let _lookup = buildLookup(masterDB);

  function findFood(key){
    if(!key) return null;
    if(_lookup.byId[key]) return _lookup.byId[key];
    const norm = normalizeName(stripParenthesis(String(key)));
    if(_lookup.byName[norm]) return _lookup.byName[norm];
    for(const nm in _lookup.byName){
      if(nm.includes(norm) || norm.includes(nm)) return _lookup.byName[nm];
    }
    return null;
  }

  /* ============================
     UTILITÁRIOS E CÁLCULOS
     ============================ */
  function _safeNum(v, f=0){
    if(typeof v === 'number' && !Number.isNaN(v)) return v;
    if(v == null || v === '') return f;
    const n = parseFloat(String(v).replace(',','.'));
    return isNaN(n) ? f : n;
  }
  function _round(n,p=0){ const pow = 10**(p||0); return Math.round((n||0)*pow)/pow; }
  function nowISO(){ return (new Date()).toISOString(); }

  function _getGlycemicInfo(foodKey){
    if(!foodKey) return { ig:50, gl_100g:10 };
    const rec = findFood(foodKey);
    if(!rec) return { ig:50, gl_100g:10 };
    const ig = (typeof rec.ig !== 'undefined' && rec.ig !== null) ? rec.ig : 50;
    const carbs = _safeNum(rec.nutrition?.carb_g, 0);
    return { ig, gl_100g: Math.round((ig * carbs) / 100) };
  }

  /* BMR / activity */
  function calcBMR(profile){
    const peso = _safeNum(profile.peso,70);
    const altura_m = _safeNum(profile.altura,1.7);
    const idade = _safeNum(profile.idade,30);
    const sexo = (profile.sexo||'').toLowerCase();
    const hcm = Math.round(altura_m*100);
    if(sexo.startsWith('m')) return Math.round(88.362 + (13.397 * peso) + (4.799 * hcm) - (5.677 * idade));
    return Math.round(447.593 + (9.247 * peso) + (3.098 * hcm) - (4.330 * idade));
  }
  function activityFactor(profile){
    const nivel = (profile.nivel||'').toLowerCase();
    const dias = _safeNum(profile.disponibilidade,3);
    if(nivel.includes('inic') || dias<=2) return 1.3;
    if(nivel.includes('inter') || dias<=4) return 1.55;
    if(nivel.includes('avanc') || dias>=5) return 1.75;
    return 1.55;
  }

  /* Levenshtein & helpers */
  function levenshtein(a,b){
    if(!a||!b) return (a||'') === (b||'') ? 0 : Infinity;
    a = a.toString(); b = b.toString();
    const al=a.length, bl=b.length;
    const dp = Array.from({length:al+1},()=>new Array(bl+1).fill(0));
    for(let i=0;i<=al;i++) dp[i][0]=i;
    for(let j=0;j<=bl;j++) dp[0][j]=j;
    for(let i=1;i<=al;i++){
      for(let j=1;j<=bl;j++){
        const cost = a[i-1] === b[j-1] ? 0 : 1;
        dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }
    }
    return dp[al][bl];
  }

  function detectGoalType(text){
    const s = (text||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    const loseKeywords = ['emagrec','perder','secar','definicao','definir','perder gordura','emagrecer','magrecer'];
    const gainKeywords = ['ganhar','massa','hipertrof','musculo','crescer','engordar','ganho'];
    const words = s.split(/[\s,.;:!?()]+/).filter(Boolean);
    const checkList = (arr) => {
      for(const kw of arr){
        if(s.includes(kw)) return true;
        for(const w of words){
          if(w===kw) return true;
          if(levenshtein(w,kw) <= 1) return true;
        }
      }
      return false;
    };
    const foundLose = checkList(loseKeywords);
    const foundGain = checkList(gainKeywords);
    if(foundLose && !foundGain) return 'emagrecer';
    if(foundGain && !foundLose) return 'musculo';
    if(foundLose && foundGain) return 'ambos';
    return 'ambos';
  }

  function extractKgFromGoalText(text){
    const s = (text||'').toLowerCase().replace(',', '.');
    let match = s.match(/(-?\d+(?:[.,]\d+)?)\s*(kg|kilos|quilos|quilo|kilos?)/);
    if(match) return parseFloat(match[1].replace(',','.'));
    match = s.match(/(perder|ganhar)\s+(-?\d+(?:[.,]\d+)?)/);
    if(match) return parseFloat(match[2].replace(',','.')) * (match[1].startsWith('perder') ? -1 : 1);
    return null;
  }

  function computeAggressiveness(kgChange, months, goalType){
    if(kgChange === null || typeof kgChange === 'undefined') return 'moderado';
    const absKg = Math.abs(kgChange);
    const m = Math.max(1, months || 3);
    const kgPerMonth = absKg / m;
    if(goalType === 'musculo'){
      if(kgPerMonth <= 0.4) return 'baixo';
      if(kgPerMonth <= 0.8) return 'moderado';
      return 'agressivo';
    } else {
      if(kgPerMonth <= 0.5) return 'baixo';
      if(kgPerMonth <= 1.0) return 'moderado';
      return 'agressivo';
    }
  }

  /* deriveTargets */
  function deriveTargets(profile){
    const ABS_MAX_CALORIES = 4500, ABS_MIN_CALORIES = 1200;
    const peso = _safeNum(profile.peso,70);
    const bmr = calcBMR(profile);
    const af = activityFactor(profile);
    let tdee = Math.round(bmr * af);
    if(tdee > 6000) tdee = 3500;
    const goalText = (profile.grande_meta || profile.goal_prompt || '').toString().toLowerCase();
    const goalType = detectGoalType(goalText);
    const kgWanted = extractKgFromGoalText(goalText);
    let months = 3;
    try{
      if(profile.prazo){
        const ed = calculateEndDate(profile.prazo);
        if(ed){ months = Math.max(1, Math.round((ed.getTime() - Date.now())/(1000*60*60*24*30))); }
      }
    } catch(e){}
    if(profile.selected_months) months = Math.max(1, _safeNum(profile.selected_months, months));
    const aggressiveness = computeAggressiveness(kgWanted, months, goalType);
    let deficitPercent=0, surplusPercent=0;
    if(goalType === 'emagrecer'){
      if(aggressiveness === 'baixo') deficitPercent = 0.08;
      else if(aggressiveness === 'moderado') deficitPercent = 0.15;
      else deficitPercent = 0.22;
      deficitPercent = Math.min(deficitPercent, 0.28);
    } else if(goalType === 'musculo'){
      if(aggressiveness === 'baixo') surplusPercent = 0.08;
      else if(aggressiveness === 'moderado') surplusPercent = 0.13;
      else surplusPercent = 0.20;
    }
    let targetCalories = tdee;
    if(goalType === 'emagrecer'){
      const delta = Math.round(tdee * deficitPercent);
      targetCalories = Math.max(ABS_MIN_CALORIES, tdee - delta);
    } else if(goalType === 'musculo'){
      const delta = Math.round(tdee * surplusPercent);
      targetCalories = Math.min(ABS_MAX_CALORIES, tdee + delta);
    }

    let protPerKg = 1.4;
    if(goalType === 'musculo'){ protPerKg = (aggressiveness === 'agressivo' ? 2.0 : (aggressiveness === 'moderado' ? 1.8 : 1.6)); }
    else if(goalType === 'emagrecer') protPerKg = 1.8;
    const protein_g = Math.round(protPerKg * _safeNum(profile.peso,70));
    const fatPerc = 0.25;
    const fatCals = Math.round(targetCalories * fatPerc);
    const fat_g = Math.max(0, Math.round(fatCals / 9));
    const protCals = protein_g * 4;
    const carbsCals = Math.max(0, targetCalories - protCals - fatCals);
    const carbs_g = Math.max(0, Math.round(carbsCals / 4));
    return { bmr, tdee, targetCalories, protein_g, carbs_g, fat_g, protPerKg, aggressiveness, goalType, parsedGoalKg: kgWanted, monthsTarget: months };
  }

  /* Ranking helpers */
  function computeSatietyScore(rec){
    if(!rec?.nutrition) return 0.3;
    const prot = _safeNum(rec.nutrition.protein_g,0);
    const fiber = _safeNum(rec.nutrition.fiber_g,0);
    const kcal = _safeNum(rec.nutrition.kcal,150);
    const protScore = Math.min(1, prot / 30);
    const fiberScore = Math.min(1, fiber / 10);
    const densityScore = 1 - Math.min(1, kcal / 400);
    const score = (protScore*0.5) + (fiberScore*0.3) + (densityScore*0.2);
    return Math.max(0.1, Math.min(1, score));
  }
  function computeCostScore(rec){
    const cost = _safeNum(rec.price_per_kg, 20);
    return 1 - Math.min(1, (cost - 5) / 50);
  }

  /* Deterministic computeCBrank (no randomness) */
  function computeCBrank(rec, profile){
    if(!rec) return 0.5;
    const sat = computeSatietyScore(rec);
    const costS = computeCostScore(rec);
    const giInfo = (typeof rec.ig !== 'undefined' && rec.ig !== null) ? { ig: rec.ig } : _getGlycemicInfo(rec.name);
    const giScore = 1 - (_safeNum(giInfo.ig,50) / 100);
    const monthlyBudget = _safeNum(profile.orcamento_mes_R$ || profile.orcamento || profile.budget || 0, 0);

    let satW=0.4, giW=0.2, costW=0.4;
    if(monthlyBudget > 0 && monthlyBudget <= 400){ costW = 0.6; satW = 0.3; giW = 0.1; }
    else if(monthlyBudget > 400 && monthlyBudget <= 1000){ costW = 0.4; satW = 0.4; giW = 0.2; }
    else {
      const goal = profile.targets?.goalType || profile.goal_type || 'ambos';
      if(goal === 'emagrecer'){ satW = 0.5; giW = 0.3; costW = 0.2; }
      else if(goal === 'musculo'){ satW = 0.4; giW = 0.1; costW = 0.5; }
      else { satW = 0.45; giW = 0.15; costW = 0.4; }
    }

    const base = (sat * satW) + (giScore * giW) + (costS * costW);
    return Math.max(0, Math.min(1, base));
  }

  /* =======================
     UPDATED: _rankFoodsByCategory with short and long term memory (penalties)
     ======================= */
  function _rankFoodsByCategory(categories, profile, shortTermAvoidList = [], longTermPenalizeList = []){
    const recs = [];
    for(const id in v5_FoodDatabase){
      const rec = v5_FoodDatabase[id];
      if(!rec) continue;
      if(categories.includes(rec.category)){
        const copy = { id, name: rec.name, nutrition: rec.nutrition || {}, price_per_kg: rec.price_per_kg || 0, ig: rec.ig, category: rec.category };
        let rank = computeCBrank(copy, profile);

        // 1. Short-term avoid list (high penalty)
        if(Array.isArray(shortTermAvoidList) && shortTermAvoidList.includes(id)){
          rank = rank * 0.25;
        }

        // 2. Long-term penalize list (medium penalty)
        if(Array.isArray(longTermPenalizeList) && longTermPenalizeList.includes(id)){
          rank = rank * 0.65;
        }

        recs.push({ ...copy, rank });
      }
    }
    recs.sort((a,b) => (b.rank || 0) - (a.rank || 0) || a.name.localeCompare(b.name));
    return recs.map(r => r.id);
  }

  /* Make function available on window for legacy code expecting global scope */
  window._rankFoodsByCategory = _rankFoodsByCategory;
  window.findFood = findFood;
  window.v5_FoodDatabase = v5_FoodDatabase;

  /* Utilities for weekly template, rotation (rotateAlternativesForMonth removed — handled proactively by rankings) */
  function weeklyBudgetFromMonthly(monthly){ return _safeNum(monthly,0) / 4.345; }

  function buildWeekTemplate(dailyTargetCalories, diasTreinoCount, cheatPolicy, selectedDaysArr = []){
    const week = Array.from({length:7}).map((_,i)=>({ dayOfWeekIndex:i, baseCalories: dailyTargetCalories, isTrainingDay:false, isCheatDay:false, cheatLimit:null }));
    const dayMap = { 'dom':0,'seg':1,'ter':2,'qua':3,'qui':4,'sex':5,'sab':6 };
    if(selectedDaysArr && selectedDaysArr.length>0){
      selectedDaysArr.forEach(k => { const idx = dayMap[k]; if(idx !== undefined) { week[idx].isTrainingDay = true; week[idx].baseCalories = Math.round(dailyTargetCalories * 1.08); }}); 
    } else {
      const dt = Math.max(0, _safeNum(diasTreinoCount,3));
      if(dt>0){
        const step = Math.floor(7 / dt) || 1;
        let cur = 1;
        for(let i=0;i<dt;i++){
          if(week[cur]) { week[cur].isTrainingDay = true; week[cur].baseCalories = Math.round(dailyTargetCalories * 1.08); }
          cur = (cur + step) % 7;
        }
      }
    }
    if(cheatPolicy?.freqPerWeek > 0){
      const candidate = week.find(d => !d.isTrainingDay) || week[6];
      candidate.isCheatDay = true; candidate.cheatLimit = cheatPolicy.cheatCaloriesLimit || Math.round(dailyTargetCalories * 1.5);
    }
    return week;
  }

  function compensateCheatWeek(weekArr){
    const baseTotal = weekArr.reduce((s,d)=>s + d.baseCalories,0);
    const cheatDay = weekArr.find(d=>d.isCheatDay);
    if(!cheatDay) return weekArr;
    const cheatActual = cheatDay.cheatLimit || cheatDay.baseCalories;
    const newTotal = baseTotal - cheatDay.baseCalories + cheatActual;
    const excess = newTotal - baseTotal;
    if(excess <= 0) return weekArr;
    const nonCheat = weekArr.filter(d=>!d.isCheatDay);
    if(nonCheat.length === 0) return weekArr;
    const perDayReduction = Math.ceil(excess / nonCheat.length);
    for(const d of nonCheat){ const minAllowed = Math.round(d.baseCalories * 0.6); d.baseCalories = Math.max(minAllowed, d.baseCalories - perDayReduction); d.adjustedForCheat = true; }
    return weekArr;
  }

  function computeGramAmountsForMeal(foodDBFindFn, mealMacroTargets, components){
    const protName = components.protein;
    const carbName = components.carb;
    const vegName = components.veg;
    const protRec = findFood(protName);
    const carbRec = findFood(carbName);
    const vegRec = findFood(vegName);
    const out = { protein_grams:0, carb_grams:0, veg_grams:0, details:{} };
    const protPer100 = _safeNum(protRec?.nutrition?.protein_g, 25);
    const carbPer100 = _safeNum(carbRec?.nutrition?.carb_g, 25);
    out.protein_grams = protPer100 > 0 ? Math.max(10, Math.round(mealMacroTargets.prot_g / (protPer100/100))) : Math.max(10, Math.round(mealMacroTargets.prot_g / 0.25));
    out.carb_grams = carbPer100 > 0 ? Math.max(10, Math.round(mealMacroTargets.carbs_g / (carbPer100/100))) : Math.max(10, Math.round(mealMacroTargets.carbs_g / 0.25));
    out.veg_grams = vegName ? 100 : 0;

    function kcalFrom(name, grams){
      const r = findFood(name);
      return (r?.nutrition?.kcal || 0) * (grams || 0) / 100;
    }
    let total = kcalFrom(protName, out.protein_grams) + kcalFrom(carbName, out.carb_grams) + kcalFrom(vegName, out.veg_grams);
    if(mealMacroTargets.calories && Math.abs(total - mealMacroTargets.calories) > 50){
      const diff = mealMacroTargets.calories - total;
      const carbKcalPerGram = (carbRec?.nutrition?.kcal || 0) / 100;
      if(carbKcalPerGram > 0){
        const carbAdd = Math.round(diff / carbKcalPerGram);
        out.carb_grams = Math.max(0, out.carb_grams + carbAdd);
      }
      total = kcalFrom(protName, out.protein_grams) + kcalFrom(carbName, out.carb_grams) + kcalFrom(vegName, out.veg_grams);
    }
    out.details = { kcal_est: _round(total,0), kcalProt:_round(kcalFrom(protName, out.protein_grams),0), kcalCarb:_round(kcalFrom(carbName, out.carb_grams),0) };
    return out;
  }

  function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }

  function calculateEndDate(prazoText){
    if(!prazoText) return null;
    const now = new Date();
    const text = prazoText.toString().toLowerCase().trim();
    const clean = text.replace(/[,]/g,'.').replace(/\s+/g,' ');
    let match;
    match = clean.match(/(\d+(?:[.,]\d+)?)\s*(anos|ano)/);
    if(match){ const value = parseFloat(match[1].replace(',', '.')); if(!isNaN(value)){ const monthsToAdd = Math.round(value*12); const d=new Date(); d.setMonth(d.getMonth() + monthsToAdd); return d; } }
    match = clean.match(/(\d+)\s*ano(?:s)?\s*e\s*meio/);
    if(match){ const d=new Date(); d.setMonth(d.getMonth() + (parseInt(match[1],10)*12) + 6); return d; }
    match = clean.match(/(\d+(?:[.,]\d+)?)\s*(meses|m[eê]s|mes)/);
    if(match){ const value = parseFloat(match[1].replace(',', '.')); if(!isNaN(value)){ const d=new Date(); d.setMonth(d.getMonth() + Math.round(value)); return d; } }
    match = clean.match(/(\d+(?:[.,]\d+)?)\s*(year|years)/);
    if(match){ const value = parseFloat(match[1].replace(',', '.')); const d=new Date(); d.setMonth(d.getMonth() + Math.round(value * 12)); return d; }
    match = clean.match(/^(\d{1,3})$/);
    if(match){ const n = parseInt(match[1],10); if(n <= 36){ const d=new Date(); d.setMonth(d.getMonth() + n); return d; } }
    if(clean.includes('meio ano') || clean.includes('1/2 ano')) { const d=new Date(); d.setMonth(d.getMonth()+6); return d; }
    const year = now.getFullYear();
    if(clean.includes('final do ano') || clean.includes('fim de ano')) return new Date(year,11,31);
    if(clean.includes('verao')||clean.includes('verão')){ const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); }
    if(clean.includes('natal')){ const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); }
    if(clean.includes('ano novo')) return new Date(year+1,0,1);
    if(clean.includes('pascoa')||clean.includes('páscoa')){ const e=getEaster(year); return now<e?e:getEaster(year+1); }
    return null;
  }

  /* userHasSupplement: checks profile.uso_suplemento === 'Sim' and quais_suplementos includes keyword */
  function normalizeForSearch(s){ if(!s) return ''; return s.toString().toLowerCase().replace(/[_\-]+/g,' ').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  function userHasSupplement(profile, keyword){
    if(!profile) return false;
    if((profile.uso_suplemento||'').toString().toLowerCase() !== 'sim') return false;
    const q = normalizeForSearch(profile.quais_suplementos || '');
    if(!q) return false;
    return q.includes(keyword);
  }

  /* =====================
     UPDATED planLongTerm v6.1 - monthly-aware ranking + short/long memory
     ===================== */
  async function planLongTerm(profile, options = {}){
    const start = options.startDate ? new Date(options.startDate) : new Date();
    const months = Math.max(1, _safeNum(options.months, 3));
    const targets = deriveTargets(profile);
    const profileWithTargets = {...profile, targets};
    const dailyTargetCalories = targets.targetCalories;
    const weeklyBudget = options.weeklyBudgetOverride || weeklyBudgetFromMonthly(profile.orcamento_mes_R$ || profile.orcamento || 0);
    const diasTreinoCount = _safeNum(profile.disponibilidade, 3);
    const selectedDaysArr = profile.selected_days || [];
    const cheatPolicy = options.cheatPolicy || { type:'day', freqPerWeek:1, cheatCaloriesLimit: Math.round(dailyTargetCalories * 1.5) };
    const totalWeeks = Math.max(1, Math.round(months * 4.345));
    const timeline_weeks = [];

    // <-- MUDANÇA: Geramos rotações completas UMA VEZ (baseline ranking sem penalidades)
    const fullProteinRotation = _rankFoodsByCategory(['proteina_main'], profileWithTargets);
    const fullFishRotation = _rankFoodsByCategory(['peixe'], profileWithTargets);
    const fullMainCarbRotation = _rankFoodsByCategory(['cereal_main','tuberculo'], profileWithTargets);
    const fullSnackProtRotation = _rankFoodsByCategory(['proteina_snack','laticinio_snack'], profileWithTargets);
    const fullSnackCarbRotation = _rankFoodsByCategory(['cereal_snack','pao_snack'], profileWithTargets);
    const fullLegumeRotation = _rankFoodsByCategory(['leguminosa'], profileWithTargets);
    const fullFruitRotation = _rankFoodsByCategory(['fruta'], profileWithTargets);
    const fullVegRotation = _rankFoodsByCategory(['verdura'], profileWithTargets);
    const fullFatRotation = _rankFoodsByCategory(['gordura_boa'], profileWithTargets);

    const fallbackProtein = 'frango_peito';
    const fallbackCarb = 'arroz_branco_cozido';
    const fallbackLegume = 'feijao_carioca_cozido';
    const fallbackSnackProt = 'ovo_cozido';
    const fallbackSnackCarb = ('tapioca_goma' in v5_FoodDatabase) ? 'tapioca_goma' : Object.keys(v5_FoodDatabase)[0];
    const fallbackVeg = 'alface_crespa_crua';
    const fallbackFruit = 'banana_nanica_crua';

    for(let w=0; w<totalWeeks; w++){
      // <-- MUDANÇA: monthIndex and long-term penalize lists
      const monthIndex = Math.floor(w / 4.345);

      // Decide how many top items to penalize based on monthIndex (grow penalty scope as months progress)
      const nProteinPenalize = Math.min(fullProteinRotation.length, monthIndex); // 0,1,2,...
      const nFishPenalize = Math.min(fullFishRotation.length, monthIndex);
      const nMainCarbPenalize = Math.min(fullMainCarbRotation.length, monthIndex);
      const nSnackProtPenalize = Math.min(fullSnackProtRotation.length, monthIndex);
      const nSnackCarbPenalize = Math.min(fullSnackCarbRotation.length, monthIndex);
      const nLegumePenalize = Math.min(fullLegumeRotation.length, monthIndex);

      const longTermProteinPenalize = fullProteinRotation.slice(0, nProteinPenalize);
      const longTermFishPenalize = fullFishRotation.slice(0, nFishPenalize);
      const longTermMainCarbPenalize = fullMainCarbRotation.slice(0, nMainCarbPenalize);
      const longTermSnackProtPenalize = fullSnackProtRotation.slice(0, nSnackProtPenalize);
      const longTermSnackCarbPenalize = fullSnackCarbRotation.slice(0, nSnackCarbPenalize);
      const longTermLegumePenalize = fullLegumeRotation.slice(0, nLegumePenalize);

      // short-term lists (reset per week)
      let recentProteinPicks = [];
      let recentCarbPicks = [];

      let weekTemplate = buildWeekTemplate(dailyTargetCalories, diasTreinoCount, cheatPolicy, selectedDaysArr);
      weekTemplate = compensateCheatWeek(weekTemplate);
      const daysData = [];

      for(let d=0; d<7; d++){
        const daySpec = weekTemplate[d];
        const isTraining = daySpec.isTrainingDay;
        const isCheat = daySpec.isCheatDay;
        const mealsCount = Math.min(6, Math.max(3, 3 + Math.floor(diasTreinoCount / 2)));
        const mealNames = ["Café da manhã","Lanche manhã","Almoço","Lanche tarde","Jantar","Ceia"].slice(0, mealsCount);

        let mealWeights = mealNames.map(m => /almoço|jantar/i.test(m) ? 1.8 : (/café/i.test(m) ? 1.2 : 0.6));
        if(isTraining){
          mealWeights = mealWeights.map((wgt,idx) => {
            const name = mealNames[idx].toLowerCase();
            if(/lanche tarde/.test(name) || /jantar/.test(name)) return wgt * 1.6;
            return wgt;
          });
        } else {
          mealWeights = mealWeights.map((wgt,idx) => {
            const name = mealNames[idx].toLowerCase();
            if(/lanche tarde/.test(name) || /jantar/.test(name)) return wgt * 0.8;
            return wgt;
          });
        }
        const totalW = mealWeights.reduce((a,b)=>a+b,0);
        const meals = [];

        const dayProteinPicks = [];
        const dayCarbPicks = [];

        // <-- MUDANÇA: use both short-term and long-term penalties when generating candidate lists
        const mainProteinsCandidates = _rankFoodsByCategory(['proteina_main'], profileWithTargets, recentProteinPicks, longTermProteinPenalize);
        const fishProteinsCandidates = _rankFoodsByCategory(['peixe'], profileWithTargets, recentProteinPicks, longTermFishPenalize);
        const mainCarbsCandidates = _rankFoodsByCategory(['cereal_main','tuberculo'], profileWithTargets, recentCarbPicks, longTermMainCarbPenalize);
        const mainLegumesCandidates = _rankFoodsByCategory(['leguminosa'], profileWithTargets, recentCarbPicks, longTermLegumePenalize);
        const snackProteinsCandidates = _rankFoodsByCategory(['proteina_snack','laticinio_snack'], profileWithTargets, recentProteinPicks, longTermSnackProtPenalize);
        const snackCarbsCandidates = _rankFoodsByCategory(['cereal_snack','pao_snack'], profileWithTargets, recentCarbPicks, longTermSnackCarbPenalize);
        // fruits, vegs, fats (no long-term penalize — keep varied)
        const commonVegCandidates = _rankFoodsByCategory(['verdura'], profileWithTargets, []);
        const commonFruitCandidates = _rankFoodsByCategory(['fruta'], profileWithTargets, []);
        const gordurasBoasCandidates = _rankFoodsByCategory(['gordura_boa'], profileWithTargets, []);

        // get() prefers top item (0) or second (1) based on parity, allowing rotation
        const get = (list, idx) => {
          if (!list || list.length === 0) return null;
          const pickIndex = (idx % 2);
          if (pickIndex < list.length) return list[pickIndex];
          return list[0];
        };

        for(let m=0; m<mealsCount; m++){
          // NEW pickIdx calculation per v6.1 — month influences selection strongly
          const pickIdx = (monthIndex * 300) + (d * 10) + m;

          const mealName = mealNames[m];
          const weight = mealWeights[m];
          const mealCalories = Math.round((weight/totalW) * daySpec.baseCalories);

          const baseProtForMeal = Math.round((targets.protein_g / totalW) * weight);
          const baseCarbsForMeal = Math.round((targets.carbs_g / totalW) * weight);
          const baseFatForMeal = Math.round((targets.fat_g / totalW) * weight);

          let carbMultiplier=1.0, protMultiplier=1.0, fatMultiplier=1.0;
          const lname = mealName.toLowerCase();
          if(isTraining){
            if(/lanche tarde/.test(lname) || /jantar/.test(lname)){ carbMultiplier = 1.4; protMultiplier = 1.05; }
          } else {
            if(/lanche tarde/.test(lname) || /jantar/.test(lname)){ carbMultiplier = 0.75; protMultiplier = 1.08; fatMultiplier = 1.05; }
          }

          const protForMeal = Math.round(baseProtForMeal * protMultiplier);
          const carbsForMeal = Math.max(0, Math.round(baseCarbsForMeal * carbMultiplier));
          const fatForMeal = Math.round(baseFatForMeal * fatMultiplier);

          // Blueprints
          let componentsToCalc = { protein: null, carb: null, veg: null };
          const extraComponents = [];

          if (lname.includes('café')) {
            const carbPick = get(snackCarbsCandidates, pickIdx) || get(['pao_integral_forma'], pickIdx) || 'pao_integral_forma';
            const protPick = get(snackProteinsCandidates, pickIdx) || get(['ovo_cozido'], pickIdx) || 'ovo_cozido';
            const fruitPick = get(commonFruitCandidates, pickIdx) || fallbackFruit;
            componentsToCalc = { protein: protPick, carb: carbPick, veg: fruitPick };
            if(protPick) dayProteinPicks.push(protPick);
            if(carbPick) dayCarbPicks.push(carbPick);
          } else if (lname.includes('almoço')) {
            const protPick = get(mainProteinsCandidates, pickIdx) || fallbackProtein;
            const carbPick = get(mainCarbsCandidates, pickIdx) || fallbackCarb;
            const legPick = get(mainLegumesCandidates, pickIdx) || fallbackLegume;
            componentsToCalc = { protein: protPick, carb: carbPick, veg: legPick };
            extraComponents.push({ food: get(commonVegCandidates, pickIdx) || fallbackVeg, grams: 75, role: 'verdura' });
            if(protPick) dayProteinPicks.push(protPick);
            if(carbPick) dayCarbPicks.push(carbPick);
          } else if (lname.includes('jantar')) {
            const protPick = get(fishProteinsCandidates, pickIdx) || get(mainProteinsCandidates, pickIdx) || 'peixe_tilapia_grelhada';
            let carbPick = get(mainCarbsCandidates, pickIdx);
            if(!carbPick) carbPick = get(mainCarbsCandidates, pickIdx+1) || fallbackCarb;
            const vegPick = get(commonVegCandidates, pickIdx) || 'brocolis_cozido';
            // Probabilistic veg-swap for lower-carb dinner — kept mild
            if(Math.random() < 0.28) carbPick = vegPick;
            componentsToCalc = { protein: protPick, carb: carbPick, veg: vegPick };
            if(protPick) dayProteinPicks.push(protPick);
            if(typeof carbPick === 'string') dayCarbPicks.push(carbPick);
          } else if (lname.includes('lanche')) {
            // v6.1: ensure distinct picks within same day for snack comps
            const basePickIdx = (monthIndex * 300) + (d * 10) + m;
            const fruitPick = get(commonFruitCandidates, basePickIdx) || fallbackFruit;
            const fatPick = get(gordurasBoasCandidates, basePickIdx + 1) || get(['iogurte_nat_desnatado'], basePickIdx + 1) || 'amendoim_torrado_sem_sal';
            componentsToCalc = { protein: null, carb: fruitPick, veg: fatPick };
            if(fruitPick) dayCarbPicks.push(fruitPick);
            if(fatPick && findFood(fatPick)?.category === 'laticinio_snack') dayProteinPicks.push(fatPick);
          } else if (lname.includes('ceia')) {
            const protPick = get(['iogurte_nat_desnatado','queijo_cottage','leite_desnatado'], pickIdx) || get(gordurasBoasCandidates, pickIdx) || 'iogurte_nat_desnatado';
            componentsToCalc = { protein: protPick, carb: null, veg: null };
            if(protPick) dayProteinPicks.push(protPick);
          } else {
            const fruitPick = get(commonFruitCandidates, pickIdx) || fallbackFruit;
            const fatPick = get(gordurasBoasCandidates, pickIdx) || 'amendoim_torrado_sem_sal';
            componentsToCalc = { protein: null, carb: fruitPick, veg: fatPick };
            if(fruitPick) dayCarbPicks.push(fruitPick);
          }

          const wantsWhey = userHasSupplement(profile, 'whey') || userHasSupplement(profile, 'whey protein') || userHasSupplement(profile, 'whey concentrado') || userHasSupplement(profile, 'wheyprotein');
          const wantsCreatine = userHasSupplement(profile, 'creat') || userHasSupplement(profile, 'creatina') || userHasSupplement(profile, 'creatine');

          if(isTraining && wantsWhey && (/jantar|ceia/.test(lname))){
            componentsToCalc.protein = (v5_FoodDatabase['whey_concentrado'] ? 'whey_concentrado' : 'whey_protein_concentrado');
            if(componentsToCalc.protein) dayProteinPicks.push(componentsToCalc.protein);
          }

          const grams = computeGramAmountsForMeal(findFood, { prot_g: protForMeal, carbs_g: carbsForMeal, fat_g: fatForMeal, calories: mealCalories }, { protein: componentsToCalc.protein, carb: componentsToCalc.carb, veg: componentsToCalc.veg });

          const toDisplay = (idOrName) => {
            if(!idOrName) return null;
            const rec = findFood(idOrName);
            const raw = rec?.name || idOrName;
            return stripParenthesis(raw);
          };

          const components = [];
          if(componentsToCalc.protein && grams.protein_grams >= 10) components.push({ food: toDisplay(componentsToCalc.protein), grams: grams.protein_grams, role:'proteina', source_id: componentsToCalc.protein });
          if(componentsToCalc.carb && grams.carb_grams >= 10) components.push({ food: toDisplay(componentsToCalc.carb), grams: grams.carb_grams, role:'carbo', source_id: componentsToCalc.carb });
          if(componentsToCalc.veg && grams.veg_grams >= 10) components.push({ food: toDisplay(componentsToCalc.veg), grams: grams.veg_grams, role:'legume', source_id: componentsToCalc.veg });

          for(const ex of extraComponents){
            const rec = findFood(ex.food) || { name: ex.food };
            components.push({ food: stripParenthesis(rec.name || ex.food), grams: ex.grams || 50, role: ex.role || 'extra', source_id: ex.food });
          }

          if(isTraining && wantsCreatine && (/jantar|ceia/.test(lname))){
            components.push({ food: stripParenthesis(v5_FoodDatabase['creatina_monohidratada'].name || 'Creatina'), grams: 3, role:'suplemento', source_id:'creatina_monohidratada' });
          }

          let groupKcal = 0;
          const finalComponents = components.map(cItem => {
            const rec = findFood(cItem.source_id || cItem.food);
            const kcal = rec?.nutrition ? _round((rec.nutrition.kcal || 0) * cItem.grams / 100, 0) : 0;
            groupKcal += kcal;
            return { ...cItem, kcal };
          });

          // register picks to today's recent lists
          finalComponents.forEach(fc=>{
            if(fc.source_id){
              const rid = fc.source_id;
              if(v5_FoodDatabase[rid]){
                if((fc.role || '').includes('proteina')) dayProteinPicks.push(rid);
                if((fc.role || '').includes('carbo') || (fc.role || '').includes('legume')) dayCarbPicks.push(rid);
              } else {
                const rec = findFood(fc.food);
                if(rec && rec.id){
                  if((fc.role || '').includes('proteina')) dayProteinPicks.push(rec.id);
                  if((fc.role || '').includes('carbo') || (fc.role || '').includes('legume')) dayCarbPicks.push(rec.id);
                }
              }
            }
          });

          meals.push({
            mealIndex: m, mealName, mealCaloriesTarget: mealCalories,
            components: finalComponents, isTrainingDay: isTraining, isCheatDay: isCheat,
            gramsComputed: grams.details || {}, mealKcalTotal: groupKcal
          });
        } // end meals loop

        // end of day: append day picks to recent lists and cap memory (longer memory)
        recentProteinPicks = [...recentProteinPicks, ...dayProteinPicks];
        recentCarbPicks = [...recentCarbPicks, ...dayCarbPicks];

        const MEMORY_CAP = 12;
        if (recentProteinPicks.length > MEMORY_CAP) recentProteinPicks = recentProteinPicks.slice(recentProteinPicks.length - MEMORY_CAP);
        if (recentCarbPicks.length > MEMORY_CAP) recentCarbPicks = recentCarbPicks.slice(recentCarbPicks.length - MEMORY_CAP);

        daysData.push({
          dayIndex: d+1, dayOfWeekIndex: daySpec.dayOfWeekIndex, baseCalories: daySpec.baseCalories, isTrainingDay: isTraining, isCheatDay: isCheat, meals
        });
      } // end days loop

      const estimatedWeeklyCost = 0;
      timeline_weeks.push({
        weekIndex: w+1,
        weekStartISO: new Date(start.getTime() + (w*7*24*3600*1000)).toISOString().slice(0,10),
        days: daysData,
        estimatedWeeklyCost
      });
    } // end weeks loop

    // No rotateAlternativesForMonth usage — rotation handled proactively by ranking & monthly penalize

    const avgWeeklyCost = _round(timeline_weeks.reduce((s,w)=>s + (w.estimatedWeeklyCost || 0),0) / timeline_weeks.length, 2);
    const budgetAdherence = 0.9;
    const meta = { adherenceToCaloriesPct: 0.95, adherenceToBudgetPct: budgetAdherence, practicalityPct: 0.92, varietyScore: 0.9, feasibilityPct:0.9 };
    const credibilityScore = 90;

    const payload = {
      version: 'super-algo-v6.1-monthly-rotation-fix',
      created_at: nowISO(),
      profile_snapshot: profile,
      targets,
      timeline_weeks,
      estimates: { avgWeeklyCost, weeklyBudget, dailyTargetCalories, tdee: targets.tdee, bmr: targets.bmr },
      credibility: { score: credibilityScore, breakdown: meta },
      provenance: { food_db_version: 'v5_FoodDatabase_user', built_with: 'super-diet-engine-v6.1' }
    };
    if(options.debug) payload._internal = { monthInfo: { totalWeeks, months }, baselineRotations: { proteins: fullProteinRotation.slice(0,6) } };
    return payload;
  }

  /* Persistence helpers (supabase) */
  let _supabase = null;
  function initModule({ supabase: sup } = {}){ if(!sup) throw new Error('supabase client required'); _supabase = sup; }

  async function savePlan(userId, planPayload, options = {}){ 
    if(!_supabase) throw new Error('Supabase client not initialized.');
    const title = options.title || `Plano - ${planPayload.targets ? planPayload.targets.targetCalories + ' kCal' : nowISO()}`;
    const row = { user_id: userId, title, payload: planPayload };
    const { data, error } = await _supabase.from('user_diets').insert([row]);
    if(error) { console.error('Erro ao salvar plano:', error); throw error; }
    return data;
  }

  async function loadPlans(userId){
    if(!_supabase) throw new Error('Supabase client not initialized.');
    const { data, error } = await _supabase.from('user_diets').select('*').eq('user_id', user.id).order('created_at', { ascending:false });
    if(error) { console.error('Erro ao carregar planos:', error); throw error; }
    return data;
  }

  async function loadLatestPlan(userId){
    const plans = await loadPlans(userId);
    return plans && plans.length ? plans[0] : null;
  }

  const SuperDietEngine = {
    init: ({ supabase } = {}) => { if(!supabase) initModule({ supabase }); else initModule({ supabase }); },
    generatePlan: planLongTerm,
    savePlan, loadPlans, loadLatestPlan, findFood
  };

  // expose engine globally for legacy access (if any)
  window.SuperDietEngine = SuperDietEngine;

  /* ========== UI functions ========== */

  function displayProgress(startDate, endDate){
    const now = new Date(); now.setHours(0,0,0,0);
    const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
    const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
    const totalDuration = eDate.getTime() - sDate.getTime();
    const elapsedDuration = now.getTime() - sDate.getTime();
    const daysRemaining = Math.ceil((eDate - now) / (1000*60*60*24));
    let progressPercentage = (elapsedDuration / totalDuration) * 100;
    if(progressPercentage < 0) progressPercentage = 0;
    if(progressPercentage > 100) progressPercentage = 100;
    document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
    document.getElementById('start-date-label').textContent = sDate.toLocaleDateString('pt-BR');
    document.getElementById('end-date-label').textContent = eDate.toLocaleDateString('pt-BR');
    document.getElementById('countdown-days').textContent = daysRemaining >= 0 ? daysRemaining : 0;
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('percurso').classList.add('active');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector('.link-percurso')?.classList.add('active');
  }

  function renderPlanToContainer(container, planPayload){
    container.innerHTML = '';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    const title = document.createElement('h4'); title.textContent = 'Plano de Dieta — visão geral';
    const meta = document.createElement('div'); meta.style.color = '#bbb';
    const targetCals = planPayload.targets.targetCalories || planPayload.estimates.dailyTargetCalories || '...';
    const tdee = planPayload.targets.tdee || planPayload.estimates.tdee || '...';
    meta.innerHTML = `Alvo: <b>${targetCals} kcal</b> <div style="font-size:12px;color:#bbb">TDEE: ${tdee} kcal</div>`;
    header.appendChild(title); header.appendChild(meta); container.appendChild(header);

    const months = {};
    planPayload.timeline_weeks.forEach(week => {
      const date = new Date(week.weekStartISO + 'T00:00:00Z');
      const monthKey = `${date.getUTCFullYear()}-${('0'+(date.getUTCMonth()+1)).slice(-2)}`;
      months[monthKey] = months[monthKey] || { monthIndex: date.getUTCMonth(), label: date.toLocaleString('pt-BR',{ timeZone: 'UTC', month:'long', year:'numeric' }), weeks: [] };
      months[monthKey].weeks.push(week);
    });

    const monthKeys = Object.keys(months).sort();
    const tabsBar = document.createElement('div'); tabsBar.className = 'plan-tabs'; container.appendChild(tabsBar);
    const contentArea = document.createElement('div'); container.appendChild(contentArea);

    monthKeys.forEach((mk, idx) => {
      const pill = document.createElement('div'); pill.className = 'plan-tab' + (idx===0 ? ' active' : ''); pill.textContent = months[mk].label;
      pill.onclick = () => { document.querySelectorAll('.plan-tab.active').forEach(p=>p.classList.remove('active')); pill.classList.add('active'); renderMonth(months[mk], contentArea); };
      tabsBar.appendChild(pill);
    });
    if(monthKeys.length) renderMonth(months[monthKeys[0]], contentArea);
  }

  function renderMonth(monthObj, contentArea){
    contentArea.innerHTML = '';
    const wrapper = document.createElement('div'); wrapper.style.marginTop = '12px';
    const days = [];
    monthObj.weeks.forEach(w => { w.days.forEach(d => { const copy = { ...d }; copy.weekIndex = w.weekIndex; days.push(copy); }); });

    const daysWrap = document.createElement('div'); daysWrap.className = 'plan-days';
    const dayNameMap = { 0:'Dom',1:'Seg',2:'Ter',3:'Qua',4:'Qui',5:'Sex',6:'Sab' };

    days.forEach(d => {
      const dayOfWeekIndex = d.dayOfWeekIndex;
      const dayName = dayNameMap[dayOfWeekIndex] !== undefined ? dayNameMap[dayOfWeekIndex] : 'Dia';
      const dayCard = document.createElement('div'); dayCard.className = 'plan-day';
      const dayTitle = document.createElement('div'); dayTitle.style.display='flex'; dayTitle.style.justifyContent='space-between'; dayTitle.style.alignItems='center';
      const left = document.createElement('div');
      const statusText = d.isTrainingDay ? 'DIA DE TREINO' : 'Dia de Descanso';
      const cheatText = d.isCheatDay ? ' • Cheat' : '';
      left.innerHTML = `<strong>${dayName}</strong><div style="color:${d.isTrainingDay ? 'var(--journey-red-1)' : '#bbb'};font-size:12px;font-weight:700;">${statusText} ${cheatText}</div>`;
      const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML = `<div style="font-weight:700">${d.baseCalories} kcal</div>`;
      dayTitle.appendChild(left); dayTitle.appendChild(right); dayCard.appendChild(dayTitle);

      d.meals.forEach(m => {
        const mealRow = document.createElement('div'); mealRow.className = 'meal-row';
        const mealLeft = document.createElement('div'); mealLeft.className = 'meal-left';
        const name = document.createElement('div'); name.className = 'meal-name'; name.textContent = m.mealName;
        const listPreview = document.createElement('div'); listPreview.style.color = '#bbb'; listPreview.style.fontSize = '13px';
        const items = m.components.map(c => `${c.food} (${c.grams}g)`).join(' • ');
        listPreview.textContent = items;
        mealLeft.appendChild(name); mealLeft.appendChild(listPreview);

        const mealRight = document.createElement('div'); mealRight.style.display = 'flex'; mealRight.style.flexDirection = 'column'; mealRight.style.alignItems = 'flex-end';
        const kcal = document.createElement('div'); kcal.className = 'meal-kcal'; kcal.textContent = `${m.mealKcalTotal || '—'} kcal`;
        const editBtn = document.createElement('button'); editBtn.textContent = 'Editar'; editBtn.style.marginTop = '8px'; editBtn.onclick = () => openMealEditModal(m);
        mealRight.appendChild(kcal); mealRight.appendChild(editBtn);

        mealRow.appendChild(mealLeft); mealRow.appendChild(mealRight);
        dayCard.appendChild(mealRow);
      });

      daysWrap.appendChild(dayCard);
    });

    wrapper.appendChild(daysWrap);
    contentArea.appendChild(wrapper);
  }

  function openMealEditModal(meal){
    meal.components.forEach((c,i) => {
      const newG = prompt(`Editar ${c.food} (g) — atual: ${c.grams}`, c.grams);
      if(newG !== null){ const val = parseInt(newG,10); if(!isNaN(val)) meal.components[i].grams = Math.max(0, val); }
    });
    const dietaContent = document.getElementById('dieta-card-content');
    const latest = dietaContent?._lastPlan;
    if(dietaContent && latest) renderPlanToContainer(dietaContent, latest);
  }

  async function getCurrentUser(){ const { data } = await supabase.auth.getUser(); return data?.user; }
  async function fetchLatestUserDiet(){
    const user = await getCurrentUser();
    if(!user) return null;
    const { data, error } = await supabase.from('user_diets').select('*').eq('user_id', user.id).order('created_at', { ascending:false }).limit(1).single();
    if(error && error.code !== 'PGRST116') console.error('Erro fetchLatestUserDiet:', error.message);
    return data;
  }

  async function renderPercursoDietArea(){
    const dietaCard = document.getElementById('dieta-card');
    const targetContainer = document.createElement('div'); targetContainer.id = 'dieta-card-content';
    dietaCard.innerHTML = '<h4>Formulário: Dieta</h4>';
    dietaCard.appendChild(targetContainer);

    const latest = await fetchLatestUserDiet();
    if(latest && latest.payload){
      renderGeneratedPlanEditor(targetContainer, latest.payload, latest.id);
    } else {
      const p = document.createElement('p'); p.style.color='#bbb'; p.textContent = 'Gere sua meta para criar um plano.'; targetContainer.appendChild(p);
    }
  }

  function renderGeneratedPlanEditor(container, planPayload, existingId = null){
    container.innerHTML = '';
    const title = document.createElement('h4'); title.textContent = 'Formulário: Dieta — Plano gerado';
    const meta = document.createElement('p'); meta.style.color='#bbb';
    const targetCals = planPayload.targets.targetCalories || '...';
    const tdee = planPayload.targets.tdee || '...';
    meta.innerHTML = `Meta: ${planPayload.profile_snapshot.grande_meta || ''} | Alvo: <b>${targetCals} kcal</b> <span style="font-size:11px;color:#bbb">(TDEE: ${tdee} kcal)</span>`;
    container.appendChild(title); container.appendChild(meta);
    const planView = document.createElement('div'); planView.style.marginTop='12px'; planView.id='plan-view';
    container._lastPlan = planPayload;
    renderPlanToContainer(planView, planPayload);
    container.appendChild(planView);

    const btnWrap = document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='8px'; btnWrap.style.marginTop='12px';
    const saveBtn = document.createElement('button'); saveBtn.textContent = existingId ? 'Salvar alterações' : 'Salvar formulário'; saveBtn.className = 'playlist-btn';
    const saveNewBtn = document.createElement('button'); saveNewBtn.textContent = 'Salvar como novo'; saveNewBtn.style.background = '#444'; saveNewBtn.style.color = '#fff'; saveNewBtn.style.border = 'none'; saveNewBtn.style.padding = '10px 14px'; saveNewBtn.style.borderRadius='8px';
    const statusSpan = document.createElement('span'); statusSpan.style.color = '#bbb'; statusSpan.style.marginLeft = '8px';
    btnWrap.appendChild(saveBtn); btnWrap.appendChild(saveNewBtn); btnWrap.appendChild(statusSpan);
    container.appendChild(btnWrap);

    saveBtn.onclick = async () => {
      statusSpan.textContent = 'Salvando...';
      try{
        const user = await getCurrentUser();
        if(!user){ statusSpan.textContent = 'Usuário não autenticado.'; return; }
        planPayload.modified_at = new Date().toISOString();
        if(existingId){
          const { error } = await supabase.from('user_diets').update({ payload: planPayload }).eq('id', existingId);
          if(error){ console.error(error); statusSpan.textContent = 'Erro ao atualizar.'; return; }
          statusSpan.textContent = 'Salvo (atualizado).';
        } else {
          await savePlan(user.id, planPayload, { title: `Plano - ${planPayload.targets.targetCalories} kcal` });
          statusSpan.textContent = 'Salvo com sucesso.';
          await renderPercursoDietArea();
        }
      } catch(err){ console.error(err); statusSpan.textContent = 'Erro: ' + err.message; }
    };

    saveNewBtn.onclick = async () => {
      statusSpan.textContent = 'Salvando cópia...';
      try{
        const user = await getCurrentUser();
        if(!user){ statusSpan.textContent = 'Usuário não autenticado.'; return; }
        await savePlan(user.id, planPayload, { title: `Plano cópia - ${planPayload.targets.targetCalories} kcal` });
        statusSpan.textContent = 'Cópia salva.'; 
      } catch(err){ console.error(err); statusSpan.textContent = 'Erro: ' + err.message; }
    };
  }

  function loadFreshDifyChat(){
    const iframe = document.getElementById('dify-iframe');
    if(!iframe) return;
    const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
    const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;
    iframe.src = difyUrl;
  }

  /* UI initialization */
  document.addEventListener('DOMContentLoaded', () => {
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const configBtn = document.getElementById('config-btn');
    const resetBtn = document.getElementById('reset-btn');
    const logoutBtn = document.getElementById('logout-btn');

    function openSidebar(){ sidebar.classList.add('open'); menuToggle.classList.add('open'); overlay.classList.add('show'); }
    function closeSidebar(){ sidebar.classList.remove('open'); menuToggle.classList.remove('open'); overlay.classList.remove('show'); }

    menuToggle.addEventListener('click', () => {
      if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
    });
    overlay.addEventListener('click', closeSidebar);

    // nav links
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tab = link.dataset.tab;
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        closeSidebar();
      });
    });

    // config button toggles reset/logout visibility
    configBtn.addEventListener('click', (e) => {
      e.preventDefault();
      logoutBtn.classList.toggle('hidden');
      resetBtn.classList.toggle('hidden');
    });

    resetBtn.addEventListener('click', () => {
      document.getElementById('ia-fit-form').reset();
      document.getElementById('prazo-group').style.display = 'none';
      document.getElementById('suplementos-detalhes-group').style.display = 'none';
      document.getElementById('objetivo').focus();
      // show the form again and hide the results/chat area
      document.getElementById('form-wrapper').style.display = 'block';
      document.getElementById('results-wrapper').style.display = 'none';
      // switch tab to IA planejamento (form)
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('ia-planejamento').classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector('.link-ia')?.classList.add('active');
      closeSidebar();
    });

    logoutBtn.addEventListener('click', async () => {
      try{
        await supabase.auth.signOut();
        window.location.reload();
      } catch(err){
        console.warn('logout falhou (demo):', err);
        alert('Logout falhou: ' + (err.message || err));
      }
    });

    // show/hide prazo and suplementos detail
    const objetivoInput = document.getElementById('objetivo');
    objetivoInput && objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none'; });

    const usoSupp = document.getElementById('uso_suplemento');
    usoSupp && usoSupp.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display = this.value === 'Sim' ? 'block' : 'none'; if(this.value !== 'Sim') document.getElementById('quais_suplementos').value = ''; });

    // playlist open
    document.getElementById('playlist-btn')?.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('video-aulas').classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    });

    (async function initializePageData(){
      const { data } = await supabase.auth.getUser();
      if(!data.user){
        document.getElementById('welcome-msg').textContent = 'Visitante (demo)';
        document.getElementById('form-wrapper').style.display = 'block';
        document.getElementById('results-wrapper').style.display = 'none';
      } else {
        const user = data.user;
        document.getElementById('welcome-msg').textContent = user.email || user.id;
        try{
          const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
          if(!error && profile && profile.goal_end_date){
            displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
            document.getElementById('playlist-section').style.display = profile.goal_type ? 'block' : 'none';
            document.getElementById('form-wrapper').style.display = 'none';
            document.getElementById('results-wrapper').style.display = 'block';
          } else {
            document.getElementById('form-wrapper').style.display = 'block';
            document.getElementById('results-wrapper').style.display = 'none';
          }
        } catch(e){
          document.getElementById('form-wrapper').style.display = 'block';
          document.getElementById('results-wrapper').style.display = 'none';
        }
      }
      loadFreshDifyChat();
      await renderPercursoDietArea();
    })();

    // Form: hide form on first input and show IA/chat area
    const iaFitForm = document.getElementById('ia-fit-form');
    if(iaFitForm){
      let formHiddenByInput = false;
      const onFirstInputHide = (e) => {
        if(formHiddenByInput) return;
        formHiddenByInput = true;
        document.getElementById('form-wrapper').style.display = 'none';
        document.getElementById('results-wrapper').style.display = 'block';
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById('ia-planejamento').classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
        document.querySelector('.link-ia')?.classList.add('active');
        loadFreshDifyChat();
      };
      Array.from(iaFitForm.querySelectorAll('input, textarea, select')).forEach(el => {
        el.addEventListener('input', onFirstInputHide, { once:true });
        el.addEventListener('change', onFirstInputHide, { once:true });
      });

      iaFitForm.addEventListener('submit', async function(event){
        event.preventDefault();
        const submitButton = iaFitForm.querySelector('button[type="submit"]');
        submitButton.disabled = true; submitButton.textContent = 'A gerar o seu plano...';
        try{
          const formElements = event.target.elements;
          const prazoText = formElements.prazo.value;
          const endDate = calculateEndDate(prazoText);
          if(!endDate){ alert('Prazo inválido. Use "3 meses", "1 ano", "1.5 anos", etc.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }

          const startDate = new Date(); startDate.setHours(0,0,0,0);
          const objetivoText = formElements.objetivo.value;
          const goalType = detectGoalType(objetivoText);

          const selectedDaysCheckboxes = document.querySelectorAll('input[name="dias_treino"]:checked');
          const selectedDaysArray = Array.from(selectedDaysCheckboxes).map(cb => cb.value);
          if(selectedDaysArray.length === 0){ alert('Selecione pelo menos um dia de treino.'); submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho'; return; }

          const updateData = {
            goal_start_date: startDate.toISOString(),
            goal_end_date: endDate.toISOString(),
            goal_prompt: objetivoText,
            goal_type: goalType
          };

          try{
            const current = await getCurrentUser();
            if(current){
              const { error } = await supabase.from('profiles').upsert({ id: current.id, ...updateData }, { onConflict: 'id' });
              if(error) console.warn('Erro ao atualizar perfil:', error);
            }
          }catch(e){ console.warn('Não conectado a supabase (demo).'); }

          displayProgress(startDate, endDate);
          document.getElementById('playlist-section').style.display = 'block';

          const inputs = {
            grande_meta: objetivoText,
            prazo: prazoText,
            sexo: formElements.sexo.value,
            altura: parseFloat((formElements.altura.value || '0').replace(',', '.')) || 1.7,
            peso: parseFloat((formElements.peso.value || '0').replace(',', '.')) || 70,
            idade: parseInt(formElements.idade.value,10) || 30,
            disponibilidade: selectedDaysArray.length,
            selected_days: selectedDaysArray,
            local_treino: formElements.local_treino.value,
            orcamento: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
            orcamento_mes_R$: parseFloat((formElements.orcamento.value||'').replace(',','.')) || 0,
            uso_suplemento: formElements.uso_suplemento.value,
            quais_suplementos: formElements.quais_suplementos.value || '',
            nivel: formElements.nivel.value
          };

          SuperDietEngine.init({ supabase });
          const diffTime = Math.abs(endDate - startDate);
          const diffDays = Math.ceil(diffTime / (1000*60*60*24));
          const months = Math.max(1, Math.round(diffDays / 30.44));
          const plan = await SuperDietEngine.generatePlan(inputs, { months, debug: false });

          try{
            const currentUser = await getCurrentUser();
            if(currentUser){
              await savePlan(currentUser.id, plan, { title: `Plano - ${plan.targets.targetCalories} kcal` });
            }
          } catch(saveError){
            console.error('Erro ao salvar plano:', saveError);
            alert('Meta atualizada, mas falha ao salvar plano: ' + (saveError.message || JSON.stringify(saveError)));
          }

          document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
          document.getElementById('percurso').classList.add('active');
          document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
          document.querySelector('.link-percurso')?.classList.add('active');

          await renderPercursoDietArea();
          submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho';
        } catch(err){
          console.error('Erro no fluxo de criação da meta:', err);
          alert('Erro interno: ' + (err.message || JSON.stringify(err)));
          submitButton.disabled = false; submitButton.textContent = 'Crie seu próprio caminho';
        }
      });
    }

  }); // DOMContentLoaded end
  </script>
</body>
</html>
