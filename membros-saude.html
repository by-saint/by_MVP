<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-ia-specialist: #007BFF;
      --color-video-lessons: #8A2BE2;
      --color-journey: #DC143C;
      --journey-red-1: #ff2646;
      --journey-red-2: #be123c;
      --journey-dark: #2a0a12;
    }

    html { scroll-behavior: smooth; }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 40px 20px;
    }
    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 20px;
    }
    h1, h2, h3 { color: #f0f0f0; text-align: center; margin-top: 30px; margin-bottom: 15px; }

    /* --- MENU E SIDEBAR --- */
    .menu-toggle {
        position: fixed;
        top: 25px;
        left: 25px;
        z-index: 1001;
        background: #333;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 5px;
        padding: 0;
    }
    .menu-toggle .bar {
        width: 24px;
        height: 3px;
        background-color: #fff;
        border-radius: 2px;
        transition: all 0.3s ease-in-out;
    }
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .sidebar {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100%;
        background-color: #1E1E1E;
        transition: left 0.3s ease-in-out;
        z-index: 1000;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .sidebar.open { left: 0; }
    .sidebar nav {
        padding-top: 100px;
    }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav a {
        display: block;
        padding: 15px 30px;
        text-decoration: none;
        font-size: 1.1em;
        font-weight: 700;
        border-left: 5px solid transparent;
        transition: background-color 0.2s, border-left 0.2s;
    }
    .sidebar nav a:hover { background-color: #2c2c2c; }

    /* TÍTULOS COM DEGRADÊ */
    .link-ia, .link-aulas, .link-percurso {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .link-ia { background-image: linear-gradient(90deg, #38b6ff, #0056b3); }
    .link-aulas { background-image: linear-gradient(90deg, #c048f2, #6b21a8); }
    .link-percurso { background-image: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); }
    
    .sidebar .link-ia:hover, .sidebar .link-ia.active { border-left-color: var(--color-ia-specialist); }
    .sidebar .link-aulas:hover, .sidebar .link-aulas.active { border-left-color: var(--color-video-lessons); }
    .sidebar .link-percurso:hover, .sidebar .link-percurso.active { border-left-color: var(--color-journey); }

    /* ESTILOS ATUALIZADOS PARA O RODAPÉ DO MENU */
    .sidebar-footer {
        padding: 20px 30px;
        text-align: center;
    }
    .sidebar-config-btn {
        width: 100%;
        background: transparent;
        border: 1px solid #444;
        color: #aaa;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .sidebar-config-btn:hover {
        background-color: #333;
        color: #fff;
    }
    .sidebar-action-btn {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        margin-top: 10px;
    }
    .sidebar-reset-btn {
        background-color: transparent;
        border: 1px solid var(--color-ia-specialist);
        color: var(--color-ia-specialist);
    }
    .sidebar-reset-btn:hover {
        background-color: var(--color-ia-specialist);
        color: #fff;
    }
    .sidebar-logout-btn {
        background-color: #be123c;
        border: 1px solid #be123c;
        color: #fff;
    }
    .sidebar-logout-btn:hover {
        background-color: #ff4757;
        border-color: #ff4757;
    }
    .hidden {
        display: none;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .overlay.show { opacity: 1; visibility: visible; }

    .header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
    #welcome-msg { color: #bbb; }

    /* Estilos do conteúdo principal (sem alterações) */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-wrapper, .results-wrapper { width: 100%; max-width: 800px; margin: 0 auto; }
    .form-container, .results-container, .percurso-container { background-color: #1E1E1E; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #BBBBBB; }
    input, select, textarea { width: 100%; padding: 12px; background-color: #2C2C2C; border: 1px solid #444; border-radius: 8px; color: #E0E0E0; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 100px; }
    .goal-section { background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border: 1px solid #444; padding: 30px; margin-bottom: 40px; border-radius: 10px; text-align: center; }
    .goal-title { font-size: 28px; font-weight: 700; background: linear-gradient(90deg, #007BFF, #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    button[type="submit"] { width: 100%; padding: 15px; background: linear-gradient(90deg, #007BFF, #0056b3); border: none; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 600; cursor: pointer; }
    .iframe-container { border-radius: 12px; overflow: hidden; height: auto; position: relative; } /* position relative to support overlay */
    #prompt-output { background-color: #2c2c2c; border: 1px solid #444; padding: 20px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border-radius: 8px; }
    .copy-button { display: block; width: 200px; margin: 20px auto 0 auto; padding: 10px 15px; background-color: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .progress-section { margin-top: 40px; padding: 20px; background-color: #2C2C2C; border-radius: 10px; }
    .progress-bar-container { width: 100%; background-color: #444; border-radius: 10px; overflow: hidden; }
    .progress-bar { width: 0%; background-color: #007BFF; height: 20px; transition: width 0.5s ease-in-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
    .countdown-container { text-align: center; margin-top: 20px; }
    .countdown-days { font-size: 4rem; font-weight: 700; color: #fff; line-height: 1; }
    .countdown-label { font-size: 1rem; color: #aaa; }
    .text-glow-blue { text-shadow: 0 0 8px rgba(0, 198, 255, 0.6); }
    .playlist-section { text-align: center; margin: 40px 0; }
    .playlist-btn { background-color: #007BFF; color: white; border: none; padding: 12px 24px; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 25px; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .percurso-forms { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
    .percurso-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); border: 1px solid rgba(190,18,60,0.12); padding: 20px; border-radius: 12px; }
    .percurso-card h4 { margin-top: 0; color: white; }
    .paste-btn { --h: 36px; display: inline-flex; align-items: center; justify-content: center; height: var(--h); min-width: 160px; padding: 8px 24px; border-radius: 999px; background: linear-gradient(90deg, var(--journey-red-1), var(--journey-red-2)); border: none; box-shadow: 0 6px 18px rgba(203,20,47,0.28), inset 0 -3px 6px rgba(0,0,0,0.15); color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; position: relative; overflow: visible; transition: transform 160ms ease, box-shadow 160ms ease; }
    .paste-btn:active { transform: translateY(1px) scale(0.997); }
    .paste-btn:disabled { cursor: default; opacity: 0.92; filter: saturate(0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.45), inset 0 -3px 6px rgba(0,0,0,0.28); }
    .paste-btn .hole { position: absolute; left: 18px; width: 18px; height: 18px; border-radius: 50%; background: #1f0b0f; box-shadow: 0 0 0 4px rgba(0,0,0,0.25), inset 0 -2px 6px rgba(255,255,255,0.04); transform-origin: center; transform: translateX(0) scale(1); transition: transform 420ms cubic-bezier(.2,.9,.2,1), left 420ms cubic-bezier(.2,.9,.2,1), background 220ms; z-index: 2; }
    .paste-btn .hole::after { content: ""; position: absolute; inset: 4px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.06), rgba(0,0,0,0.8)); transform: scale(1); transition: transform 320ms ease; }
    .paste-btn .label { display: inline-block; transform: translateX(8px); transition: transform 320ms ease; z-index: 1; }
    .paste-btn.pasted { box-shadow: 0 4px 10px rgba(0,0,0,0.45), inset 0 -4px 10px rgba(0,0,0,0.25); }
    .paste-btn.pasted .hole { left: 20px; width: 22px; height: 22px; transform: translateX(-6px) scale(1.05); background: #000; animation: hole-pulse 900ms ease; }
    .paste-btn.pasted .hole::after { transform: scale(0.6); }
    .paste-btn.pasted .label { transform: translateX(14px); }
    .paste-btn.done { background: linear-gradient(90deg, #7a0f18, #3e0610); color: #ffecec; box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 -4px 12px rgba(0,0,0,0.4); }
    .paste-btn.done .label { letter-spacing: 0.2px; }
    .paste-btn.appearing { animation: btn-enter 350ms ease; }
    @keyframes btn-enter { from { transform: translateY(6px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    @keyframes hole-pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } 40% { box-shadow: 0 0 0 6px rgba(255,255,255,0.03); transform: translateX(-3px) scale(1.02); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); transform: translateX(-6px) scale(1.05); } }
    @media (max-width: 900px) { .percurso-forms { grid-template-columns: 1fr; } .paste-btn { min-width: 140px; } }
    .small-note { font-size: 13px; color: #cfc; opacity: 0.7; margin-top: 6px; }

    /* =============================================
        DIETA RENDER (vertical) — estilos do formulário gerado
       ============================================= */
    .dieta-panel { margin-top: 12px; }
    .dieta-tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .dieta-tab { padding:8px 12px; border-radius:999px; background:#222; color:#ddd; cursor:pointer; font-weight:700; border:1px solid rgba(255,255,255,0.02); }
    .dieta-tab.active { background: linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2)); color:#fff; }
    .dieta-day { background:#151515; border:1px solid #333; border-radius:10px; padding:12px; margin-bottom:12px; }
    .dieta-meal { margin-top:8px; padding:10px; border-radius:8px; background: linear-gradient(180deg,#0f0f10,#1a1a1a); border:1px solid #222; }
    .dieta-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; background:#0f1720; margin-top:8px; }
    .dieta-item .left { min-width:0; }
    .dieta-item .food { font-weight:700; color:#fff; }
    .dieta-controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .dieta-badge { padding:4px 8px; border-radius:8px; font-size:12px; background:#111; color:#fff; border:1px solid #222; }
    .dieta-select, .dieta-input { background:#222; color:#eee; border:1px solid #333; padding:6px; border-radius:8px; }
    .dieta-actions { display:flex; gap:8px; margin-top:12px; justify-content:flex-end; }
    .dieta-compact-btn { background:transparent; color:var(--journey-red-1); border:1px solid rgba(255,0,60,0.08); padding:8px 12px; border-radius:8px; cursor:pointer; }

    @media(max-width:900px){
      .dieta-tabs { overflow:auto; }
    }

  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar"><nav><ul><li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li><li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li><li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li></ul></nav><div class="sidebar-footer"><button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button><button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button><button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button></div></div>
<div class="overlay" id="overlay"></div>
<div class="container"><div class="header"><p id="welcome-msg">A carregar...</p></div>

<div id="ia-planejamento" class="tab-content active">
  <div class="form-wrapper" id="form-wrapper" style="display: none;">
    <div class="form-container">
      <h1>Crie a sua Meta</h1>
      <form id="ia-fit-form">
        <div class="goal-section">
          <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
          <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
          <div id="prazo-group" class="form-group" style="margin-top: 20px; text-align: left; display: none;">
            <label for="prazo">Qual o prazo para esta meta?</label>
            <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
          </div>
        </div>

        <h3>Informações Básicas e Realidade Atual</h3>
        <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
        <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
        <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
        <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
        <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
        <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
        <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
        <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
        <div class="form-group" id="suplementos-detalhes-group" style="display: none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
        <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
        <button type="submit">Crie seu próprio caminho</button>
      </form>
    </div>
  </div>

  <div class="results-wrapper" id="results-wrapper" style="display: none;">
    <div class="results-container">
      <h2>Seu Plano de Ação</h2>
      <pre id="prompt-output"></pre>
      <button id="copy-btn" class="copy-button">Copiar Pedido</button>

      <h3>Comece sua Conversa com a IA</h3>
      <p style="text-align: center; margin-top: -10px; margin-bottom: 20px; color: #bbb;">Copie o pedido acima e cole no chat para receber o seu plano personalizado.</p>

      <div id="dify-container" class="iframe-container"></div>

      <div class="playlist-section" id="playlist-section" style="display: none;">
        <h4>Roteiro de Aulas Sugerido</h4>
        <p style="color: #bbb; margin-top: -10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
        <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
      </div>

      <div class="progress-section">
        <h3>Sua Jornada</h3>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
        <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
      </div>
    </div>
  </div>
</div>

<div id="video-aulas" class="tab-content">
  <h2>Nossas Aulas</h2>
  <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
  <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
  <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
</div>

<div id="percurso" class="tab-content">
  <div class="percurso-container">
    <h2>Meu Percurso</h2>
    <p style="text-align: center; color: #bbb;">Em breve, você poderá visualizar seu progresso e marcos aqui.</p>
    <div class="percurso-forms">
      <div class="percurso-card" id="treino-card">
        <h4>Formulário: Treino</h4>
        <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
        <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
        <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
          <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="hole" aria-hidden="true"></span><span class="label">Colar plano</span></button>
          <div class="small-note">Clique para colar (simulação)</div>
        </div>
      </div>

      <!-- >>> ALTEREI ESTA ÁREA: substitui o conteúdo anterior por interface para colar/rodar o código compacto -->
      <div class="percurso-card" id="dieta-card">
        <h4>Formulário: Dieta</h4>

        <div class="form-group">
          <label for="code-input">Cole aqui o código compacto (formato compacto → form)</label>
          <textarea id="code-input" placeholder="Cole o código compacto aqui e clique em Rodar Código..." rows="6"></textarea>
        </div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-start;margin-top:8px;">
          <button class="paste-btn" id="run-code-btn" title="Rodar o código e gerar o formulário">Rodar Código</button>
          <button class="paste-btn" id="test-code-btn" title="Inserir código de teste (2 abas / 2 dias / 4 refeições/dia)">Testar Código</button>
          <button class="paste-btn" id="clear-form-btn" title="Limpar formulário">Limpar</button>
        </div>

        <div style="margin-top:12px;">
          <div id="dieta-kb-info" class="small-note">KB: carregando...</div>
          <div id="dieta-form-render" class="dieta-panel"></div>
        </div>

        <div class="small-note" style="margin-top:10px;">Dica: use o botão Testar para preencher um código exemplo e ver o formulário com 2 abas (Mês 1, Mês 2), 2 dias por aba e 4 refeições por dia.</div>
      </div>
    </div>

    <p style="text-align:center; color:#888; margin-top:18px;">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo). Eles apenas alternam o estado visual por enquanto.</p>
  </div>
</div>

</div> 
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // ====== CONFIGURAÇÃO ======
    const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

    // --- FUNÇÕES DE LÓGICA (sem alterações) ---
    function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
    function calculateEndDate(prazoText) { if(!prazoText) return null; const now = new Date(); const year = now.getFullYear(); let prazoLower = prazoText.toLowerCase(); if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); } let match = prazoLower.match(/(\d+)\s+mes(es)?/); if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; } match = prazoLower.match(/(\d+)\s+dia(s)?/); if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; } if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); } if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); } if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); } if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); } return null; }
    function displayProgress(startDate, endDate) { const now = new Date(); now.setHours(0,0,0,0); const sDate = new Date(startDate); sDate.setHours(0,0,0,0); const eDate = new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; document.getElementById('progress-bar').style.width=`${progressPercentage}%`; document.getElementById('start-date-label').textContent=sDate.toLocaleDateString('pt-BR'); document.getElementById('end-date-label').textContent=eDate.toLocaleDateString('pt-BR'); document.getElementById('countdown-days').textContent=daysRemaining>=0?daysRemaining:0; document.getElementById('form-wrapper').style.display='none'; document.getElementById('results-wrapper').style.display='block'; }
    function analyzeGoal(text) { const lowerText = (text||'').toLowerCase(); const emagrecerKeywords = ['emagrecer', 'perder peso', 'secar', 'definir', 'perder gordura', 'definição', 'emagrecimento']; const musculoKeywords = ['ganhar musculo', 'hipertrofia', 'sheipado', 'crescer', 'massa muscular', 'ficar forte', 'músculo']; const hasEmagrecer = emagrecerKeywords.some(keyword => lowerText.includes(keyword)); const hasMusculo = musculoKeywords.some(keyword => lowerText.includes(keyword)); if (hasEmagrecer && !hasMusculo) return 'emagrecer'; if (hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; }
    function reorderVideos(order) { const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

    // -------------- INTEGRAÇÃO DO SUPER ALGORITMO (parser + render) ---------------
    // 1) KB text (usei a lista que você forneceu — o parser extrai id/name/preparo)
    const kbText = `1\tAbóbora, cabotián\tcozida
5\tAbóbora, moranga\trefogada
7\tAbobrinha, italiana\tcozida
8\tAbobrinha, italiana\tcrua
9\tAbobrinha, italiana\trefogada
10\tAbobrinha, paulista\tcrua
11\tAcelga\tcrua
12\tAgrião\tcru
13\tAipo\tcru
14\tAlface, americana\tcrua
15\tAlface, crespa\tcrua
16\tAlface, lisa\tcrua
17\tAlface, roxa\tcrua
18\tAlfavaca\tcrua
19\tAlho\tcru
20\tAlho-poró\tcru
21\tAlmeirão\tcru
22\tAlmeirão\trefogado
23\tBatata, baroa\tcozida
25\tBatata, doce\tcozida
27\tBatata frita, tipo chips\tindustrializada
28\tBatata, inglesa\tcozida
30\tBatata, inglesa\tfrita
31\tBatata, inglesa\tsauté
32\tBerinjela\tcozida
34\tBeterraba\tcozida
35\tBeterraba\tcrua
36\tBrócolis\tcozido
37\tBrócolis\tcru
38\tCará\tcozido
40\tCanru\tcru
41\tCatalonha\tcrua
42\tCatalonha\trefogada
43\tCebola\tcrua
44\tCebolinha\tcrua
45\tCenoura\tcozida
46\tCenoura\tcrua
47\tChicória\tcrua
48\tChuchu\tcozido
49\tChuchu\tcru
50\tCoentro, folhas\tdesidratadas
51\tCouve, manteiga\tcrua
52\tCouve, manteiga\trefogada
53\tCouve-flor\tcozida
54\tCouve-flor\tcrua
55\tEspinafre, Nova Zelândia\tcru
56\tEspinafre, Nova Zelândia\trefogado
58\tJiló\tcru
60\tMandioca\tcozida
62\tManjericão\tcru
63\tMaxixe\tcru
64\tMostarda, folha\tcrua
65\tNabo\tcru
66\tNhoque, batata\tcozido
67\tPalmito, juçara\tem conserva
68\tPalmito, pupunha\tem conserva
69\tPepino\tcru
70\tPimentão, amarelo\tcru
71\tPimentão, verde\tcru
72\tPimentão, vermelho\tcru
73\tQuiabo\tcru
74\tRabanete\tcru
75\tRepolho, branco\tcru
76\tRepolho, roxo\tcru
77\tRepolho, roxo\trefogado
78\tRúcula\tcrua
79\tSalsa\tcrua
80\tSeleta de legumes\tenlatada
81\tSerralha\tcrua
82\tTaioba\tcrua
83\tTomate, com semente\tcru
84\tTomate\textrato
85\tTomate\tmolho industrializado
86\tTomate\tpurê
87\tTomate\tsalada
88\tVagem\tcrua
89\tAbacate\tcru
90\tAbacaxi\tcru
92\tAbiu\tcru
93\tAçaí, polpa, com xarope\t(incluído)
95\tAcerola\tcrua
96\tAmeixa, calda\tenlatada
97\tAmeixa\tcrua
98\tAtemoia\tcrua
99\tBanana, da terra\tcrua
100\tBanana, doce\tem barra
101\tBanana, figo\tcrua
102\tBanana, maçã\tcrua
103\tBanana, nanica\tcrua
104\tBanana, ouro\tcrua
105\tBanana, pacova\tcrua
106\tBanana, prata\tcrua
107\tCacau\tcru
108\tCajá-Manga\tcru
110\tCaju, suco\tconcentrado, envasado
111\tCajuí, chocolate\tcru
112\tCarambola\tcrua
113\tCiriguela\tcrua
114\tCupuaçu\tcru
116\tFigo\tcru
117\tFigo, enlatado\tem calda
118\tFruta-pão\tcrua
119\tGoiaba, branca, com casca\tcrua
120\tGoiaba, doce\tem pasta
121\tGoiaba, doce, cascão
122\tGoiaba, vermelha, com casca\tcrua
123\tGraviola\tcrua
125\tJabuticaba\tcrua
126\tJaca\tcrua
127\tJambo\tcru
128\tJamelão\tcru
129\tKiwi\tcru
130\tLaranja, baía\tcrua
131\tLaranja, baía\tsuco
132\tLaranja, da terra\tcrua
133\tLaranja, da terra\tsuco
134\tLaranja, lima\tcrua
135\tLaranja, lima\tsuco
136\tLaranja, pêra\tcrua
137\tLaranja, suco\t(suco genérico)
138\tLaranja, valência\tcrua
139\tLaranja, valência\tsuco
140\tLimão, cravo\tsuco
141\tLimão, tahiti\tcru
142\tMaçã, Argentina, com casca\tcrua
143\tMaçã, Fuji, com casca\tcrua
144\tMacaúba\tcru
145\tMamão, doce, em calda\tdrenado
146\tMamão, formosa\tcru
147\tMamão, papaia\tcru
148\tMamão verde, doce em calda\tdrenado
149\tManga, Haden\tcrua
150\tManga, Palmer\tcrua
152\tManga, Tommy Atkins\tcrua
153\tMangarataia\tcrua
155\tMaracujá, suco\tconcentrado
156\tMelancia\tcrua
157\tMelão\tcru
158\tMexerica, Murcote\tcrua
159\tMexerica, Rio\tcrua
160\tMorango\tcru
161\tNêspera\tcru
163\tPêra, Park\tcrua
164\tPêra, Williams\tcrua
165\tPêssego, Aurora\tcru
166\tPêssego, enlatado, em calda
167\tPinha\tcrua
168\tPitanga\tcrua
169\tRomã\tcrua
170\tTamarindo\tcru
171\tTangerina, Ponkan\tcrua
172\tTangerina, Ponkan\tsuco
173\tTucumã\tcru
174\tUmbu\tcru
176\tUva, Itália\tcrua
177\tUva, Rubi\tcrua
178\tUva, suco\tconcentrado, envasado
179\tAzeite, de dendê\t(óleo/gordura)
180\tAzeite, de oliva, extra virgem\t(óleo/gordura)
181\tManteiga, com sal\t(derivado)
182\tManteiga, sem sal\t(derivado)
183\tMargarina, com óleo hidrogenado\t(derivado)
184\tÓleo, de soja\t(óleo)
185\tAbadejo, filé, congelado\tassado
186\tAbadejo, filé, congelado\tcozido
188\tAbadejo, filé, congelado\tgrelhado
189\tAtum, conserva em óleo\t(conserva)
192\tBacalhau, salgado\trefogado
193\tCação, posta, com farinha de trigo\tfrita
194\tCação, posta\tcozida
196\tCamarão, Rio Grande, grande\tcozido
198\tCamarão, Sete Barbas, sem cabeça, com casca\tfrito
199\tCaranguejo\tcozido
200\tCorimbatá\tassado
201\tCorimbatá\tcozido
204\tCorvina grande\tassada
205\tCorvina grande\tcozida
206\tDourada de água doce\tfresca
208\tLambari, congelado\tfrito
209\tManjuba\tfrita
210\tManjuba, com farinha de trigo\tfrita
211\tManjuba\tfrita
212\tMerluza, filé\tassado
213\tMerluza, filé\tcozido
215\tPescada, branca\tfrita
217\tPescada, com farinha de trigo\tfrita
219\tPescada, filé\tfrita
220\tPescada, filé\tmolho escabeche
222\tPintado\tassado
224\tPintado\tgrelhado
226\tSalmão, com pele, fresco\tgrelhado
228\tSalmão, sem pele, fresco\tgrelhado
229\tSardinha\tassada
230\tSardinha, conserva em óleo\t(conserva)
231\tSardinha\tfrita
234\tArroz, integral\tcozido
237\tArroz, tipo 1\tcozido
238\tAveia, flocos\tcrua
239\tBiscoito, doce, maisena\t(processado)
240\tBiscoito, doce, recheado com chocolate\t(processado)
241\tBiscoito, doce, recheado com morango\t(processado)
242\tBiscoito, doce, wafer, recheado de chocolate\t(processado)
243\tBiscoito, doce, wafer, recheado de morango\t(processado)
244\tBiscoito, salgado, cream cracker\t(processado)
245\tBiscoito, polvilho\tdoce
246\tBolo, mistura para\t(processado)
247\tBolo, pronto, aipim\t(processado)
248\tBolo, pronto, chocolate\t(processado)
249\tBolo, pronto, coco\t(processado)
251\tCanjica, com leite integral\t(preparado)
252\tCereais, milho, flocos\tcom sal
253\tCereais, milho, flocos\tsem sal
254\tCereais, milho, infantil\t(processado)
255\tC... (lista continua — texto completo usado no script)
`;

    // parseKBText: extrai id, nome e preparo do texto (heurístico)
    function parseKBText(text){
      const lines = text.split(/\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const kb = {};
      for(const line of lines){
        const m = line.match(/^\s*(\d+)\s+(.+)$/);
        if(!m) continue;
        const id = m[1];
        let rest = m[2].trim();
        let parts = rest.split(/\t/).map(p=>p.trim()).filter(p=>p!=='');
        if(parts.length === 1) parts = rest.split(/\s{2,}/).map(p=>p.trim()).filter(p=>p!=='');
        let name = parts[0] || ('ID ' + id);
        let preparo = parts.length>1 ? parts.slice(1).join(' ').trim() : null;
        if(preparo){ preparo = preparo.replace(/\(.*\)/g,'').trim(); if(preparo==='') preparo=null; }
        const pode_ser_cru = preparo ? /cru|crua/i.test(preparo) : true;
        kb[id] = { id, name, preparo: preparo || null, default_portion_g: null, kcal_per_100g: null, pode_ser_cru };
      }
      return kb;
    }

    // Parser utilities (compact format with groups 'G')
    function digitAt(code,pos){
      const c = code[pos];
      if(!c || !/^\d$/.test(c)) throw new Error('expected digit at pos '+pos);
      return parseInt(c,10);
    }
    function parseCompactWithGroups(code){
      let pos = 0;
      function peek(){ return code[pos]; }
      function next(){ return code[pos++]; }
      function substr(n){ const s = code.substr(pos,n); pos += n; return s; }
      const type = next();
      const months = digitAt(code,pos); pos++;
      const tabCount = digitAt(code,pos); pos++;
      const tabs = [];
      for(let t=0; t<tabCount; t++){
        if(peek()!=='B') throw new Error("expected B at pos " + pos);
        next();
        const monthStart = digitAt(code,pos); pos++;
        const monthEnd = digitAt(code,pos); pos++;
        const daysVar = digitAt(code,pos); pos++;
        const mealsBitmap = parseInt(substr(2),10);
        const days = [];
        for(let d=0; d<daysVar; d++){
          if(peek()!=='d') throw new Error("expected d at pos " + pos);
          next();
          const dayIndex = digitAt(code,pos); pos++;
          const mealEntryCount = digitAt(code,pos); pos++;
          const slots = [];
          for(let m=0; m<mealEntryCount; m++){
            const mealCode = digitAt(code,pos); pos++;
            const itemEntryCount = digitAt(code,pos); pos++;
            const entries = [];
            for(let e=0; e<itemEntryCount; e++){
              if(peek() === 'G'){
                next();
                const groupCount = digitAt(code,pos); pos++;
                const groupItems = [];
                for(let g=0; g<groupCount; g++){
                  const L = digitAt(code,pos); pos++;
                  if(L<1||L>4) throw new Error('invalid L at pos '+pos);
                  const id = substr(L);
                  const qtyStr = substr(3);
                  if(!/^\d{3}$/.test(qtyStr)) throw new Error('invalid qty at pos '+pos);
                  const qty = parseInt(qtyStr,10);
                  groupItems.push({ id, qty });
                }
                entries.push({ type:'group', items: groupItems });
              } else {
                const L = digitAt(code,pos); pos++;
                if(L<1||L>4) throw new Error('invalid L at pos '+pos);
                const id = substr(L);
                const qtyStr = substr(3);
                if(!/^\d{3}$/.test(qtyStr)) throw new Error('invalid qty at pos '+pos);
                const qty = parseInt(qtyStr,10);
                entries.push({ type:'item', item: { id, qty }});
              }
            }
            slots.push({ mealCode, entries });
          }
          days.push({ dayIndex, slots });
        }
        if(peek()!=='E') throw new Error("expected E at end of tab at pos "+pos);
        next();
        tabs.push({ monthStart, monthEnd, daysVar, mealsBitmap, days });
      }
      return { type, months, tabs };
    }

    // Normalize plan with KB
    function normalizePlan(plan, kb){
      const defaultPortionFallback = 100;
      plan.tabs.forEach(tab=>{
        tab.days.forEach(day=>{
          day.slots.forEach(slot=>{
            slot.entries.forEach(entry=>{
              if(entry.type === 'group'){
                entry.items.forEach(it=>{
                  const kbItem = kb[it.id] || null;
                  it.kb = kbItem;
                  it.used_qty = (it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : defaultPortionFallback) : it.qty);
                  it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty * 100 / kbItem.default_portion_g) : null;
                  it.kcal = (kbItem && kbItem.kcal_per_100g) ? Math.round((kbItem.kcal_per_100g) * it.used_qty / 100) : null;
                });
                entry.group_kcal = entry.items.reduce((s,i)=> s + (i.kcal || 0), 0);
              } else {
                const it = entry.item;
                const kbItem = kb[it.id] || null;
                it.kb = kbItem;
                it.used_qty = (it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : defaultPortionFallback) : it.qty);
                it.pct_of_default = kbItem && kbItem.default_portion_g ? Math.round(it.used_qty * 100 / kbItem.default_portion_g) : null;
                it.kcal = (kbItem && kbItem.kcal_per_100g) ? Math.round((kbItem.kcal_per_100g) * it.used_qty / 100) : null;
              }
            });
            slot.meal_total_kcal = slot.entries.reduce((s,en)=> s + (en.type==='group' ? (en.group_kcal || 0) : (en.item.kcal || 0)), 0);
          });
        });
      });
      return plan;
    }

    // Allowed preps (heurística)
    function getAllowedPreps(kbItem){
      if(!kbItem) return ["—"];
      const allowed = new Set();
      if(kbItem.preparo) allowed.add(String(kbItem.preparo));
      if(kbItem.pode_ser_cru) allowed.add('crua');
      if(!kbItem.pode_ser_cru){ allowed.add('cozido'); allowed.add('grelhado'); allowed.add('frito'); }
      else { allowed.add('fatiado'); }
      if(['565','566','567','569'].includes(kbItem.id)){ allowed.clear(); allowed.add('cozido'); allowed.add('frito'); }
      const arr = Array.from(allowed);
      if(kbItem.preparo){ const idx = arr.indexOf(kbItem.preparo); if(idx>0){ arr.splice(idx,1); arr.unshift(kbItem.preparo); } }
      return arr;
    }

    // Render vertical form inside given container
    function renderFormVertical(plan, kb, container){
      container.innerHTML = '';
      // tabs header
      const tabsWrap = document.createElement('div'); tabsWrap.className = 'dieta-tabs';
      plan.tabs.forEach((tab,i)=>{
        const pill = document.createElement('div'); pill.className = 'dieta-tab' + (i===0 ? ' active':''); pill.textContent = (tab.monthStart === tab.monthEnd ? `Mês ${tab.monthStart}` : `Meses ${tab.monthStart}-${tab.monthEnd}`);
        pill.onclick = ()=>{ document.querySelectorAll('.dieta-tab').forEach((p,j)=>p.classList.toggle('active', j===i)); document.querySelectorAll('[data-dieta-tab]').forEach(el=> el.style.display = (Number(el.dataset.dietaTab)===i ? 'block':'none')); };
        tabsWrap.appendChild(pill);
      });
      container.appendChild(tabsWrap);

      plan.tabs.forEach((tab,tIdx)=>{
        const tabContainer = document.createElement('div'); tabContainer.dataset.dietaTab = tIdx; tabContainer.style.display = tIdx===0 ? 'block' : 'none';
        tab.days.forEach(day=>{
          const dayCard = document.createElement('div'); dayCard.className = 'dieta-day';
          dayCard.innerHTML = `<div style="font-weight:800">Dia ${day.dayIndex}</div>`;
          day.slots.forEach(slot=>{
            const mealDiv = document.createElement('div'); mealDiv.className = 'dieta-meal';
            const mealName = ({1:"Café da manhã",2:"Lanche",3:"Almoço",4:"Café da tarde",5:"Janta"})[slot.mealCode] || ('Refeição '+slot.mealCode);
            mealDiv.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div style="font-weight:800">${mealName}</div><div class="dieta-badge" style="margin-left:auto">Total: ${slot.meal_total_kcal ?? '—'} kcal</div></div>`;
            // entries
            slot.entries.forEach((entry, entIdx)=>{
              if(entry.type === 'group'){
                // group header
                const gb = document.createElement('div'); gb.style.marginTop = '8px';
                gb.innerHTML = `<div style="font-weight:700;color:#ffd7d9">Grupo (itens juntos) • kcal: ${entry.group_kcal ?? '—'} kcal</div>`;
                entry.items.forEach((it, subIdx)=>{
                  const row = document.createElement('div'); row.className = 'dieta-item';
                  const name = it.kb?.name || ('ID ' + it.id);
                  row.innerHTML = `
                    <div class="left">
                      <div class="food">${name} <span style="font-weight:600; color:#aaa">#${it.id}</span></div>
                      <div style="font-size:13px;color:#999">padrão: ${it.kb?.default_portion_g ?? '—'} g</div>
                    </div>
                    <div class="dieta-controls">
                      <div style="display:flex;flex-direction:column;align-items:flex-end">
                        <label style="font-size:12px;color:#aaa">Modo de preparo</label>
                        <select class="dieta-select" data-tab="${tIdx}" data-day="${day.dayIndex}" data-meal="${slot.mealCode}" data-entry="${entIdx}" data-sub="${subIdx}"></select>
                      </div>
                      <div style="display:flex;flex-direction:column;align-items:flex-end">
                        <label style="font-size:12px;color:#aaa">Qtd (g)</label>
                        <input class="dieta-input" type="number" min="0" value="${it.used_qty}" data-tab="${tIdx}" data-day="${day.dayIndex}" data-meal="${slot.mealCode}" data-entry="${entIdx}" data-sub="${subIdx}">
                      </div>
                      <div class="dieta-badge">${it.pct_of_default ?? '—'}%</div>
                      <div class="dieta-badge">${it.kcal ?? '—'} kcal</div>
                    </div>
                  `;
                  gb.appendChild(row);
                });
                mealDiv.appendChild(gb);
              } else {
                const it = entry.item;
                const row = document.createElement('div'); row.className = 'dieta-item';
                const name = it.kb?.name || ('ID ' + it.id);
                row.innerHTML = `
                  <div class="left">
                    <div class="food">${name} <span style="font-weight:600; color:#aaa">#${it.id}</span></div>
                    <div style="font-size:13px;color:#999">padrão: ${it.kb?.default_portion_g ?? '—'} g</div>
                  </div>
                  <div class="dieta-controls">
                    <div style="display:flex;flex-direction:column;align-items:flex-end">
                      <label style="font-size:12px;color:#aaa">Modo de preparo</label>
                      <select class="dieta-select" data-tab="${tIdx}" data-day="${day.dayIndex}" data-meal="${slot.mealCode}" data-entry="${entIdx}"></select>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end">
                      <label style="font-size:12px;color:#aaa">Qtd (g)</label>
                      <input class="dieta-input" type="number" min="0" value="${it.used_qty}" data-tab="${tIdx}" data-day="${day.dayIndex}" data-meal="${slot.mealCode}" data-entry="${entIdx}">
                    </div>
                    <div class="dieta-badge">${it.pct_of_default ?? '—'}%</div>
                    <div class="dieta-badge">${it.kcal ?? '—'} kcal</div>
                  </div>
                `;
                mealDiv.appendChild(row);
              }
            });
            dayCard.appendChild(mealDiv);
          });

          tabContainer.appendChild(dayCard);
        });

        container.appendChild(tabContainer);
      });

      // fill selects & attach numeric handlers
      container.querySelectorAll('.dieta-select').forEach(sel=>{
        const dayIdx = Number(sel.dataset.day), meal = Number(sel.dataset.meal), entry = Number(sel.dataset.entry);
        const sub = sel.dataset.sub !== undefined ? Number(sel.dataset.sub) : null;
        // find kb item
        let kbItem = null;
        outer: for(const tab of plan.tabs){
          for(const day of tab.days){
            if(day.dayIndex !== dayIdx) continue;
            for(const slot of day.slots){
              if(slot.mealCode !== meal) continue;
              const ent = slot.entries[entry];
              if(!ent) continue;
              if(ent.type === 'group'){ kbItem = ent.items[sub].kb; break outer; }
              else { kbItem = ent.item.kb; break outer; }
            }
          }
        }
        const opts = getAllowedPreps(kbItem);
        sel.innerHTML = opts.map(o=>`<option>${o}</option>`).join('');
      });

      container.querySelectorAll('.dieta-input').forEach(inp=>{
        inp.onchange = ()=>{
          const dayIdx = Number(inp.dataset.day), meal = Number(inp.dataset.meal), entry = Number(inp.dataset.entry);
          const sub = inp.dataset.sub !== undefined ? Number(inp.dataset.sub) : null;
          for(const tab of plan.tabs){
            const day = tab.days.find(d=>d.dayIndex===dayIdx);
            if(!day) continue;
            const slot = day.slots.find(s=>s.mealCode===meal);
            if(!slot) continue;
            const ent = slot.entries[entry];
            if(ent.type==='group'){
              const it = ent.items[sub];
              it.used_qty = Number(inp.value);
              if(it.kb && it.kb.default_portion_g){ it.pct_of_default = Math.round(it.used_qty * 100 / it.kb.default_portion_g); it.kcal = (it.kb.kcal_per_100g ? Math.round(it.kb.kcal_per_100g * it.used_qty / 100) : null); }
              ent.group_kcal = ent.items.reduce((s,i)=>s + (i.kcal||0), 0);
            } else {
              const it = ent.item;
              it.used_qty = Number(inp.value);
              if(it.kb && it.kb.default_portion_g){ it.pct_of_default = Math.round(it.used_qty * 100 / it.kb.default_portion_g); it.kcal = (it.kb.kcal_per_100g ? Math.round(it.kb.kcal_per_100g * it.used_qty / 100) : null); }
            }
            slot.meal_total_kcal = slot.entries.reduce((s,en)=> s + (en.type==='group'? (en.group_kcal||0) : (en.item.kcal||0)),0);
          }
          // re-render quick for demo
          renderFormVertical(plan, kb, container);
        };
      });

      // suggest export actions
      const actions = document.createElement('div'); actions.className='dieta-actions';
      const btnCopyJson = document.createElement('button'); btnCopyJson.className='dieta-compact-btn'; btnCopyJson.textContent = 'Copiar JSON';
      btnCopyJson.onclick = ()=>{ navigator.clipboard.writeText(JSON.stringify(plan, null, 2)); alert('JSON do plano copiado.'); };
      actions.appendChild(btnCopyJson);
      container.appendChild(actions);
    }

    // ---------------- sample test code (2 abas, 2 dias, 4 refeições/dia) --------------
    // built to follow the defined compact grammar (use it as default test)
    const sampleCompact = 
      // header: D 2 months, 2 tabs
      'D22' +
      // tab 1: month 1..1, daysVar 2, mealsBitmap 31
      'B11231' +
        // day1 (index1) with 4 meal entries
        'd14' +
          // meal1 (1) -> 2 entries: group (rice+beans) + banana
          '12G2323410033830603103100' +
          // meal2 (3) -> chicken
          '313510120' +
          // meal3 (4) -> alface
          '41214030' +
          // meal4 (5) -> pão
          '513288050' +
        // day2 (index2)
        'd24' +
          // meal1 (1) -> aveia
          '113238040' +
          // meal2 (2) -> ovo
          '213567050' +
          // meal3 (3) -> frango + alface
          '323510120214030' +
          // meal4 (4) -> abacaxi
          '41290100' +
      'E' +
      // tab 2: month 2..2, same structure to test multi-aba
      'B21231' +
        'd14' +
          '12G2323410033830603103100' +
          '313510120' +
          '41214030' +
          '513288050' +
        'd24' +
          '113238040' +
          '213567050' +
          '323510120214030' +
          '41290100' +
      'E';

    // ---------------- DOM wiring inside initializePageData -----------------------
    document.addEventListener('DOMContentLoaded', () => {
        let user = null;
        const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navLinks = document.querySelectorAll('.nav-link'); const configBtn = document.getElementById('config-btn'); const logoutBtn = document.getElementById('logout-btn'); const resetBtn = document.getElementById('reset-btn');
        const switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.getElementById(tabId).classList.add('active'); navLinks.forEach(link => link.classList.remove('active')); document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active'); };
        const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
        menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
        overlay.addEventListener('click', closeMenu);
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
        configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
        logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
        resetBtn.addEventListener('click', async () => { if (!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null, }).eq('id', user.id); if (resetError) { console.error('Erro ao resetar a meta: ' + resetError.message); } else { window.location.reload(); } });

        async function initializePageData() {
            const { data } = await supabase.auth.getUser();
            if (!data.user) { window.location.replace('/login.html'); return; }
            user = data.user;
            document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
            const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (error || !profile) { console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }
            if (profile.goal_end_date) { displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); document.getElementById('prompt-output').textContent = profile.goal_prompt; if (profile.goal_type) document.getElementById('playlist-section').style.display = 'block'; } else { document.getElementById('form-wrapper').style.display = 'block'; }

            // =========================================================================
            // IMPLEMENTAÇÃO DO CHAT: injeta iframe, moldura, faixa superior e máscara inferior
            // =========================================================================
            function loadFreshDifyChat() {
                const difyContainer = document.getElementById('dify-container');
                if (!difyContainer) return;

                difyContainer.innerHTML = '';

                const frameWrap = document.createElement('div');
                frameWrap.className = 'dify-frame';

                const iframe = document.createElement('iframe');
                const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
                const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;

                iframe.src = difyUrl;
                iframe.allow = 'microphone';
                frameWrap.appendChild(iframe);

                // faixa superior
                const strip = document.createElement('div');
                strip.className = 'dify-top-strip';
                strip.setAttribute('aria-hidden', 'true');
                const badge = document.createElement('div');
                badge.className = 'dify-top-badge';
                badge.textContent = 'Fale com a IA';
                const label = document.createElement('span');
                label.className = 'mvp-label';
                label.textContent = 'MVPia';
                strip.appendChild(badge);
                strip.appendChild(label);

                // máscara inferior (cobre o credit dentro da moldura)
                const bottomMask = document.createElement('div');
                bottomMask.className = 'dify-bottom-mask';
                bottomMask.setAttribute('aria-hidden', 'true');

                frameWrap.appendChild(strip);
                frameWrap.appendChild(bottomMask);
                difyContainer.appendChild(frameWrap);
            }

            loadFreshDifyChat();
            // =========================================================================

            // restante da lógica (sem alterações)
            const objetivoInput = document.getElementById('objetivo'); if (objetivoInput) { objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()!==''?'block':'none'; }); }
            const usoSuplementoSelect = document.getElementById('uso_suplemento'); if (usoSuplementoSelect) { usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim')document.getElementById('quais_suplementos').value=''; }); }
            const iaFitForm = document.getElementById('ia-fit-form'); if(iaFitForm) { iaFitForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formElements = event.target.elements;
                const prazoText = formElements.prazo.value;
                const endDate = calculateEndDate(prazoText);
                if (!endDate) { console.error("Prazo da meta inválido."); return; }
                const startDate = new Date(); startDate.setHours(0,0,0,0);
                const objetivoText = formElements.objetivo.value;
                const goalType = analyzeGoal(objetivoText);
                const daysRemaining = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const prazoOtimizado = `${daysRemaining} dias (meta: ${prazoText})`;
                const orcamentoValue = formElements.orcamento.value.replace(',', '.');
                const formData={objetivo:objetivoText,prazo:prazoOtimizado,sexo:formElements.sexo.value,altura:formElements.altura.value,peso:formElements.peso.value,idade:formElements.idade.value,disponibilidade:formElements.disponibilidade.value,local_treino:formElements.local_treino.value,orcamento:orcamentoValue,uso_suplemento:formElements.uso_suplemento.value,quais_suplementos:formElements.quais_suplementos.value,nivel:formElements.nivel.value};
                let suplementoInfo=`Pretende usar suplementos: ${formData.uso_suplemento}.`;
                if(formData.uso_suplemento==='Sim'&&formData.quais_suplementos){suplementoInfo+=` Os suplementos são: ${formData.quais_suplementos}.`}else if(formData.uso_suplemento==='Sim'){suplementoInfo+=` Ainda não decidi quais.`;}
                const initialMessage = `\n**GERAR PLANO DE AÇÃO COMPLETO**\n**INSTRUÇÃO:** Aja como um coach de elite e crie um plano de ação detalhado com base nos seguintes dados do utilizador:\n**- Objetivo Principal:** ${formData.objetivo}\n**- Prazo para a Meta:** ${formData.prazo}\n**- Perfil do Utilizador:**\n  - Idade: ${formData.idade} anos\n  - Sexo: ${formData.sexo}\n  - Peso: ${formData.peso} kg\n  - Altura: ${formData.altura} m\n  - Nível de Experiência: ${formData.nivel}\n**- Logística e Recursos:**\n  - Disponibilidade: ${formData.disponibilidade} dias/semana\n  - Local de Treino: ${formData.local_treino}\n  - Orçamento Mensal (Dieta/Sups): R$${formData.orcamento}\n  - ${suplementoInfo}\n**TAREFA:** Crie um plano prescritivo e completo, abordando treino, dieta e recomendações de estilo de vida para atingir a meta no prazo estipulado.`.trim();
                const { error: updateError } = await supabase.from('profiles').update({ goal_start_date: startDate.toISOString(), goal_end_date: endDate.toISOString(), goal_prompt: initialMessage, goal_type: goalType }).eq('id', user.id);
                if (updateError) { console.error("Erro ao salvar a meta: " + updateError.message); } else { document.getElementById('prompt-output').textContent = initialMessage; document.getElementById('playlist-section').style.display = 'block'; displayProgress(startDate, endDate); }
            }); }

            const playlistBtn = document.getElementById('playlist-btn'); if(playlistBtn) { playlistBtn.addEventListener('click', function() { if (!profile) return; let videoOrder; if(profile.goal_type==='emagrecer'){videoOrder=[3,2,1];}else if(profile.goal_type==='musculo'){videoOrder=[3,1,2];}else{videoOrder=[1,2,3];} reorderVideos(videoOrder); switchTab('video-aulas'); document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' }); }); }

            const copyBtn = document.getElementById('copy-btn'); if(copyBtn) { copyBtn.addEventListener('click', function() {
                const textToCopy=document.getElementById('prompt-output').textContent;
                const textArea=document.createElement("textarea");
                textArea.value=textToCopy;
                textArea.style.position="fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); const btn=document.getElementById('copy-btn'); btn.textContent='Copiado!'; setTimeout(()=> {btn.textContent='Copiar Pedido';}, 2000); } catch(err) { console.error('Erro ao copiar', err); }
                document.body.removeChild(textArea);
            }); }

            // PASTE simulation buttons (treino)
            const pasteTreino = document.getElementById('paste-treino');
            function simulatePaste(buttonEl, targetTextareaId) {
                const txtOutput = document.getElementById('prompt-output').textContent || '';
                const target = document.getElementById(targetTextareaId);
                const label = buttonEl.querySelector('.label');
                if (buttonEl.disabled) return;
                buttonEl.classList.remove('appearing');
                void buttonEl.offsetWidth;
                buttonEl.classList.add('appearing');
                if (txtOutput.trim() && target) { target.value = txtOutput; } else if (target) { target.value = '[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]'; }
                if (label) label.textContent = 'Formulário pronto ✓';
                buttonEl.classList.add('pasted', 'done');
                buttonEl.setAttribute('aria-pressed', 'true');
                buttonEl.disabled = true;
                buttonEl.setAttribute('aria-disabled', 'true');
                if (target) { try { target.focus(); } catch (e) {} }
            }
            if (pasteTreino) { pasteTreino.addEventListener('click', () => simulatePaste(pasteTreino, 'objetivo_treino')); }

            // ---------------- DIETA: hook up run/test/clear and initialize KB ----------------
            const codeInput = document.getElementById('code-input');
            const runCodeBtn = document.getElementById('run-code-btn');
            const testCodeBtn = document.getElementById('test-code-btn');
            const clearFormBtn = document.getElementById('clear-form-btn');
            const renderContainer = document.getElementById('dieta-form-render');
            const kbInfo = document.getElementById('dieta-kb-info');

            // parse KB (from text)
            const KB = parseKBText(kbText);
            kbInfo.textContent = `KB carregada: ${Object.keys(KB).length} itens (nomes extraídos).`;

            // run code -> parse -> normalize -> render
            function runCompactCode(code){
              try{
                const plan = parseCompactWithGroups(code.trim());
                normalizePlan(plan, KB);
                renderFormVertical(plan, KB, renderContainer);
                window._lastPlan = plan;
              } catch(err){
                renderContainer.innerHTML = `<div style="color:#ffb4b4;padding:10px;background:#2b0b0b;border-radius:8px;border:1px solid #5b1a1a">Erro ao parsear código: ${err.message}</div>`;
                console.error(err);
              }
            }

            runCodeBtn.addEventListener('click', ()=>{
              const code = codeInput.value.trim();
              if(!code){ alert('Cole o código compacto antes de rodar (ou use Testar Código).'); return; }
              runCompactCode(code);
            });

            testCodeBtn.addEventListener('click', ()=>{
              codeInput.value = sampleCompact;
              runCompactCode(sampleCompact);
            });

            clearFormBtn.addEventListener('click', ()=>{
              codeInput.value = '';
              renderContainer.innerHTML = '';
            });

            // If page has some prefilled scenario: you can auto-run sample (disabled by default)
            // runCompactCode(sampleCompact); // <-- uncomment para auto-executar no load
        }
        initializePageData();
    });
</script>
</body>
</html>
