<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--color-ia-specialist:#007BFF;--color-video-lessons:#8A2BE2;--color-journey:#DC143C;--journey-red-1:#ff2646;--journey-red-2:#be123c;--journey-dark:#2a0a12}
    html{scroll-behavior:smooth}
    body{font-family:'Poppins',sans-serif;background:#121212;color:#E0E0E0;margin:0;padding:40px 20px}
    .container{max-width:1600px;margin:0 auto;padding:0 20px}
    h1,h2,h3{color:#f0f0f0;text-align:center;margin-top:30px;margin-bottom:15px}
    .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
    .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px;transition:all .3s}
    .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar.open{left:0}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;pointer-events:none}
    .overlay.show{opacity:1;visibility:visible;pointer-events:auto}
    .hidden{display:none}
    .form-wrapper,.results-wrapper{width:100%;max-width:800px;margin:0 auto}
    .form-container,.results-container,.percurso-container{background:#1E1E1E;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid #333}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
    input,select,textarea{width:100%;padding:12px;background:#2C2C2C;border:1px solid #444;border-radius:8px;color:#E0E0E0;font-size:16px;box-sizing:border-box}
    textarea{resize:vertical;min-height:100px}
    .goal-section{background:linear-gradient(145deg,#2a2a2a,#1a1a1a);border:1px solid #444;padding:30px;margin-bottom:40px;border-radius:10px;text-align:center}
    .goal-title{font-size:28px;font-weight:700;background:linear-gradient(90deg,#007BFF,#00C6FF);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    button[type="button"]{width:100%;padding:15px;background:linear-gradient(90deg,#007BFF,#0056b3);border:none;border-radius:8px;color:#fff;font-size:18px;font-weight:600;cursor:pointer}
    .progress-section{margin-top:40px;padding:20px;background:#2C2C2C;border-radius:10px}
    .progress-bar-container{width:100%;background:#444;border-radius:10px;overflow:hidden}
    .progress-bar{width:0%;background:#007BFF;height:20px;transition:width .5s}
    .countdown-days{font-size:4rem;font-weight:700;color:#fff}
    .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
    .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.25));border:1px solid rgba(190,18,60,.12);padding:20px;border-radius:12px}
    #dify-container{position:relative;width:100%;margin:18px auto 0 auto;padding:0}
    .dify-frame{position:relative;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#0b0b0b,#121212);border:3px solid rgba(0,0,0,.9);box-shadow:0 30px 60px rgba(0,0,0,.7);min-height:420px}
    .dify-frame iframe{display:block;width:100%;height:100%;border:0;background:transparent;min-height:300px}
    @media (max-width:900px){body{padding:20px 12px}.percurso-forms{grid-template-columns:1fr}}
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar">
  <nav>
    <ul>
      <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
      <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
      <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
    </ul>
  </nav>
  <div class="sidebar-footer">
    <button id="config-btn" class="sidebar-config-btn"><span>⚙️</span><span>Configurações</span></button>
    <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
    <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
  </div>
</div>
<div class="overlay" id="overlay"></div>

<div class="container">
  <div class="header"><p id="welcome-msg">A carregar...</p></div>

  <!-- IA PLANEJAMENTO -->
  <div id="ia-planejamento" class="tab-content active">
    <div class="form-wrapper" id="form-wrapper" style="display:none;">
      <div class="form-container">
        <h1>Crie a sua Meta</h1>
        <form id="ia-fit-form" novalidate>
          <div class="goal-section">
            <h2 class="goal-title">Qual é a sua Grande Meta?</h2>
            <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
            <div id="prazo-group" class="form-group" style="margin-top:20px;text-align:left;display:none;">
              <label for="prazo">Qual o prazo para esta meta?</label>
              <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
            </div>
          </div>

          <h3>Informações Básicas e Realidade Atual</h3>
          <div class="form-group"><label for="sexo">Sexo</label>
            <select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select>
          </div>
          <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
          <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
          <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
          <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
          <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
          <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
          <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label>
            <select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select>
          </div>
          <div class="form-group" id="suplementos-detalhes-group" style="display:none;"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
          <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>

          <!-- botão principal (type=button para chamar handler manualmente) -->
          <button id="submit-ia-btn" type="button">Crie seu próprio caminho</button>
        </form>
      </div>
    </div>

    <div class="results-wrapper" id="results-wrapper" style="display:none;">
      <div class="results-container">
        <h2>Fale com a IA</h2>
        <div id="dify-container" class="iframe-container"></div>
        <div class="playlist-section" id="playlist-section" style="display:none;">
          <h4>Roteiro de Aulas Sugerido</h4>
          <p style="color:#bbb;margin-top:-10px;">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
          <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
        </div>
        <div class="progress-section">
          <h3>Sua Jornada</h3>
          <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
          <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
          <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIDEO AULAS -->
  <div id="video-aulas" class="tab-content">
    <h2>Nossas Aulas</h2>
    <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
    <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
    <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
  </div>

  <!-- PERCURSO -->
  <div id="percurso" class="tab-content">
    <div class="percurso-container">
      <h2>Meu Percurso</h2>
      <p style="text-align:center;color:#bbb;">Aqui aparece o plano de dieta gerado automaticamente quando você começar o seu caminho.</p>
      <div class="percurso-forms">
        <div class="percurso-card" id="treino-card">
          <h4>Formulário: Treino</h4>
          <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia..." readonly></textarea></div>
          <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4" readonly></div>
        </div>

        <div class="percurso-card" id="dieta-card">
          <h4>Plano de Dieta (gerado automaticamente)</h4>
          <div id="dieta-generated-area">
            <div class="form-group"><label>Objetivo de Dieta</label><textarea id="objetivo_dieta_generated" readonly placeholder="Será preenchido ao criar seu caminho..."></textarea></div>
            <div class="form-group"><label>Orçamento mensal (R$)</label><input id="orcamento_dieta_generated" type="text" readonly></div>
            <div class="form-group"><label>Restrições / Preferências</label><input id="restricoes_dieta_generated" type="text" readonly></div>
            <div style="margin-top:10px"><button id="salvar-dieta-btn" type="button" style="background:#22c55e">Salvar Plano no Supabase</button></div>
            <div id="dieta-result" style="margin-top:12px;color:#ddd;font-size:14px;white-space:pre-wrap;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ========= CONFIG =========
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  // SQL para instruir caso tabela 'diets' não exista
  const DIETS_TABLE_SQL = `CREATE TABLE IF NOT EXISTS diets (
  id serial PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  objective text,
  budget text,
  restrictions text,
  plan_json jsonb
);`;

  const INITIAL_FOODS_SAMPLE = [
    "Arroz, integral cozido","Frango, peito, sem pele, grelhado","Ovo, inteiro cozido","Batata, inglesa cozida","Banana, nanica crua",
    "Maçã, Fuji, com casca crua","Abacate cru","Brócolis cozido","Feijão, carioca cozido","Aveia, flocos crua","Azeite, de oliva, extra virgem",
    "Queijo, minas, frescal","Pão, trigo, forma, integral","Salmão, sem pele, fresco grelhado"
  ];

  // ---------- utilitários / heurísticas ----------
  function guessCategory(name){ const n=(name||'').toLowerCase(); if(/(frango|carne|peito|atum|salmão|sardinha|camarão|bacalhau)/.test(n)) return 'protein'; if(/(arroz|pão|macarr|massa|batata|mandioca|milho)/.test(n)) return 'grain'; if(/(feijão|lentilha|soja|tofu)/.test(n)) return 'legume'; if(/(azeite|óleo|manteiga|noz|castanha)/.test(n)) return 'fat'; if(/(iogurte|leite|queijo|ovo)/.test(n)) return 'dairy'; if(/(bolo|biscoito|chocolate|processado|refrigerante)/.test(n)) return 'processed'; if(/(suco|agua|cerveja|chá|café)/.test(n)) return 'beverage'; return 'vegfruit'; }
  function estimateNutrientsByCategory(cat){ switch(cat){case'protein':return{k:200,p:26,c:0,f:8};case'grain':return{k:130,p:3.5,c:28,f:1.5};case'legume':return{k:110,p:8,c:17,f:1.5};case'fat':return{k:900,p:0,c:0,f:100};case'dairy':return{k:150,p:8,c:6,f:8};case'processed':return{k:400,p:6,c:45,f:20};case'beverage':return{k:50,p:0,c:12,f:0};default:return{k:50,p:1.2,c:8,f:0.2};} }
  function calcTMB(sex,weight,height,age){ const s=(String(sex||'').toLowerCase().startsWith('f'))?-161:5; const h=height*100; return 10*weight + 6.25*h - 5*age + s; }
  function activityFactorByLevel(level,days){ if(!level) return (days>=4?1.55:1.375); level=level.toLowerCase(); if(level.includes('iniciante')||level.includes('sedent')) return 1.2; if(level.includes('intermediario')||level.includes('leve')) return 1.375; if(level.includes('avancado')||level.includes('moderado')) return 1.55; return 1.55; }

  function generateDietPlan(formInputs,foodsList){
    const weight=Number(formInputs.peso), height=Number(formInputs.altura), age=Number(formInputs.idade), sex=formInputs.sexo, days=Number(formInputs.disponibilidade)||0, level=formInputs.nivel, goal=(formInputs.objetivo||'').toLowerCase();
    const tmb=calcTMB(sex,weight,height,age), factor=activityFactorByLevel(level,days), tdee=Math.round(tmb*factor);
    let targetCalories=tdee;
    if(goal.includes('perder')||goal.includes('emagrecer')||goal.includes('secar')) targetCalories=Math.round(tdee-500);
    else if(goal.includes('ganhar')||goal.includes('hipertrofia')||goal.includes('massa')) targetCalories=Math.round(tdee+300);
    targetCalories=Math.max(1000,targetCalories);
    const proteinPerKg=(days>=3)?1.8:1.2;
    const proteinG=Math.round(weight*proteinPerKg*10)/10;
    const proteinCals=proteinG*4;
    const fatCals=targetCalories*0.25; const fatG=Math.round((fatCals/9)*10)/10;
    const carbsCals=targetCalories-proteinCals-fatCals; const carbsG=Math.round((carbsCals/4)*10)/10;
    const mealsCount=(days>=3)?5:4;
    const baseSplit=[0.22,0.12,0.28,0.18,0.12,0.08].slice(0,mealsCount); let sum=baseSplit.reduce((a,b)=>a+b,0); const split=baseSplit.map(x=>x/sum);
    const foods=foodsList.map(f=>{ const name=(typeof f==='string')?f:(f.name||f); const cat=guessCategory(name); const est=estimateNutrientsByCategory(cat); return {name,category:cat,kcal100g:est.k,prot100g:est.p,carb100g:est.c,fat100g:est.f};});
    function pickCandidateFor(type){ let candidates; if(type==='protein') candidates=foods.filter(x=>x.category==='protein'||x.category==='dairy'||x.category==='legume'); else if(type==='carb') candidates=foods.filter(x=>x.category==='grain'||x.category==='processed'||x.category==='vegfruit'); else candidates=foods.filter(x=>x.category==='vegfruit'||x.category==='fat'||x.category==='legume'); if(!candidates||candidates.length===0) candidates=foods; return candidates[Math.floor(Math.random()*candidates.length)]; }
    function gramsForMacro(food,macroTargetGram,macroKey){ const per100=food[macroKey+'100g']||0.1; const grams=Math.max(15,Math.round((macroTargetGram/per100)*100/10)*10); return grams; }
    function kcalFrom(food,g){return Math.round(food.kcal100g*g/100)}
    const meals=[]; for(let i=0;i<mealsCount;i++){
      const protShare=proteinG*split[i], carbShare=carbsG*split[i]; const protFood=pickCandidateFor('protein'), carbFood=pickCandidateFor('carb'), vegFood=pickCandidateFor('veg'); const protGrams=gramsForMacro(protFood,protShare,'prot'); const carbGrams=gramsForMacro(carbFood,carbShare,'carb'); const vegGrams=Math.max(50,Math.round(120*split[i]));
      const portions=[ {food:protFood.name,grams:protGrams,kcal:kcalFrom(protFood,protGrams)}, {food:carbFood.name,grams:carbGrams,kcal:kcalFrom(carbFood,carbGrams)}, {food:vegFood.name,grams:vegGrams,kcal:kcalFrom(vegFood,vegGrams)} ];
      const mealKcal=portions.reduce((a,b)=>a+b.kcal,0);
      meals.push({name:`Refeição ${i+1}`,kcal:mealKcal,portions});
    }
    return { generated_at:new Date().toISOString(), tmb, tdee, targetCalories, macros:{protein_g:proteinG,fat_g:fatG,carbs_g:carbsG}, meals, notes:"Estimativa gerada automaticamente. Valores aproximados; para produção, carregue base nutricional detalhada (TACO/USDA)." };
  }

  // ---------- Supabase helpers ----------
  async function ensureFoodCatalogHasData(){
    try{
      const { data, error } = await supabase.from('food_catalog').select('id,name').limit(1);
      if(error){
        if((error.message && error.message.toLowerCase().includes('relation "food_catalog"')) || (error.code && error.code==='42P01')) return { ok:false, reason:'missing_table' };
        return { ok:false, reason:'error', error };
      }
      if(!data || data.length===0){
        const rows = INITIAL_FOODS_SAMPLE.map(n=>({ name:n }));
        const { error: insertErr } = await supabase.from('food_catalog').insert(rows);
        if(insertErr) return { ok:false, reason:'insert_error', error:insertErr };
        return { ok:true, inserted:rows.length };
      }
      return { ok:true, present:true };
    } catch(e){ return { ok:false, reason:'exception', error:e }; }
  }

  async function fetchAllFoodsFromDB(){
    try{
      const { data, error } = await supabase.from('food_catalog').select('name').order('id', { ascending:true });
      if(error){
        if(error.message && error.message.toLowerCase().includes('relation "food_catalog"')) throw new Error('missing_table');
        throw error;
      }
      return data.map(r => r.name);
    } catch(e){ throw e; }
  }

  async function saveDietToDB(userId, planObject, meta){
    try{
      const payload = { user_id:userId, created_at:new Date().toISOString(), plan_json:planObject, objective:meta.objective||null, budget:meta.budget||null, restrictions:meta.restrictions||null };
      const { data, error } = await supabase.from('diets').insert([payload]).select();
      if(error){
        if(error.message && error.message.toLowerCase().includes('relation "diets"')) return { ok:false, reason:'missing_table' };
        return { ok:false, reason:'insert_error', error };
      }
      return { ok:true, data };
    } catch(e){ return { ok:false, reason:'exception', error:e }; }
  }

  // ---------- UI + fluxo principal ----------
  document.addEventListener('DOMContentLoaded', async () => {
    // UI controls
    const menuToggle = document.getElementById('menu-toggle'),
          sidebar = document.getElementById('sidebar'),
          overlay = document.getElementById('overlay'),
          navLinks = document.querySelectorAll('.nav-link'),
          configBtn = document.getElementById('config-btn'),
          logoutBtn = document.getElementById('logout-btn'),
          resetBtn = document.getElementById('reset-btn');

    const switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
      const t = document.getElementById(tabId);
      if (t) t.classList.add('active');
      navLinks.forEach(l=>l.classList.remove('active'));
      const link = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
      if (link) link.classList.add('active');
    };
    const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
    menuToggle.addEventListener('click', ()=>{ menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
    overlay.addEventListener('click', closeMenu);
    navLinks.forEach(link => link.addEventListener('click', (e)=>{ e.preventDefault(); switchTab(link.dataset.tab); closeMenu(); }));
    configBtn.addEventListener('click', (e)=>{ e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
    logoutBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
    resetBtn.addEventListener('click', async ()=>{ const { data: authData } = await supabase.auth.getUser(); if(!authData || !authData.user) return; const usr = authData.user; const { error } = await supabase.from('profiles').update({ goal_start_date:null, goal_end_date:null, goal_prompt:null, goal_type:null }).eq('id', usr.id); if(error) console.error('Erro reset:', error); else window.location.reload(); });

    // auth check
    const { data: authData } = await supabase.auth.getUser();
    if(!authData || !authData.user){ window.location.replace('/login.html'); return; }
    const user = authData.user;
    document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;

    // ensure foods table present or provide notice (non-blocking)
    const ensureFood = await ensureFoodCatalogHasData();
    if(!ensureFood.ok && ensureFood.reason === 'missing_table'){
      document.getElementById('dieta-result').innerText = "A tabela 'food_catalog' não existe no Supabase. Execute seu SQL no Editor para criá-la — o gerador usará essa tabela.";
    }

    // try fetch profile (if exists show progress else show form)
    let currentProfile = null;
    try{
      const { data: profile, error: profileErr } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if(profileErr){ document.getElementById('form-wrapper').style.display='block'; }
      else { currentProfile = profile; if(profile.goal_end_date){ displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); if(profile.goal_type) document.getElementById('playlist-section').style.display='block'; } else { document.getElementById('form-wrapper').style.display='block'; } }
    } catch(e){ console.error('Erro profile:', e); document.getElementById('form-wrapper').style.display='block'; }

    // inject Dify chat frame
    (function loadFreshDifyChat(){
      const difyContainer = document.getElementById('dify-container');
      if(!difyContainer) return;
      difyContainer.innerHTML = '';
      const frameWrap = document.createElement('div'); frameWrap.className = 'dify-frame';
      const iframe = document.createElement('iframe');
      iframe.src = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?theme=dark`;
      iframe.allow = 'microphone';
      frameWrap.appendChild(iframe);
      const strip = document.createElement('div'); strip.className = 'dify-top-strip'; strip.setAttribute('aria-hidden','true');
      const badge = document.createElement('div'); badge.className = 'dify-top-badge'; badge.textContent = 'Fale com a IA';
      const label = document.createElement('span'); label.className = 'mvp-label'; label.textContent = 'MVPia';
      strip.appendChild(badge); strip.appendChild(label);
      const bottomMask = document.createElement('div'); bottomMask.className = 'dify-bottom-mask';
      frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask);
      difyContainer.appendChild(frameWrap);
    })();

    // UI small toggles
    const objetivoInput = document.getElementById('objetivo');
    if(objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display = this.value.trim() !== '' ? 'block' : 'none'; });
    const usoSuplementoSelect = document.getElementById('uso_suplemento');
    if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display = this.value === 'Sim' ? 'block' : 'none'; if(this.value !== 'Sim') document.getElementById('quais_suplementos').value = ''; });

    // last plan memory
    let lastGeneratedPlan = null;

    function renderPlanInPercurso(plan, meta){
      document.getElementById('objetivo_dieta_generated').value = meta.objective || '';
      document.getElementById('orcamento_dieta_generated').value = meta.budget || '';
      document.getElementById('restricoes_dieta_generated').value = meta.restrictions || '';
      const lines = [];
      lines.push(`Meta calórica estimada: ${plan.targetCalories} kcal`);
      lines.push(`Macros (g): Proteína ${plan.macros.protein_g}g • Gordura ${plan.macros.fat_g}g • Carboidrato ${plan.macros.carbs_g}g`);
      lines.push('--- Refeições sugeridas ---');
      plan.meals.forEach(m => {
        lines.push(`${m.name} — ${m.kcal} kcal`);
        m.portions.forEach(p => lines.push(` • ${p.food} — ${p.grams} g (${p.kcal} kcal)`));
      });
      lines.push('--- Observações ---');
      lines.push(plan.notes);
      document.getElementById('dieta-result').innerText = lines.join('\n');
    }

    // submit handler: VALIDA -> UPSERT PROFILE -> GERA PLANO -> SALVA DIETA -> REDIRECIONA PARA PERCURSO (após salvar ou mostrando aviso)
    const iaFitForm = document.getElementById('ia-fit-form');
    const submitBtn = document.getElementById('submit-ia-btn');

    async function handleIaSubmit(e){
      if(e && e.preventDefault) e.preventDefault();

      // validação manual: assegura que campos obrigatórios não estão vazios
      const required = ['objetivo','prazo','sexo','altura','peso','idade','disponibilidade','local_treino','orcamento','uso_suplemento','nivel'];
      for(const id of required){
        const el = document.getElementById(id);
        if(!el) continue;
        if(String(el.value||'').trim() === ''){
          document.getElementById('dieta-result').innerText = `Preencha o campo obrigatório: ${id}`;
          switchTab('ia-planejamento');
          return;
        }
      }

      // calcula datas (prazo)
      const formElements = iaFitForm.elements;
      const prazoText = formElements.prazo.value;
      function getEaster(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month-1, day); }
      function calculateEndDate(prazoText){
        if(!prazoText) return null;
        const now=new Date(), year=now.getFullYear(), prazoLower=prazoText.toLowerCase();
        if(prazoLower.includes('final do ano')||prazoLower.includes('fim de ano')) return new Date(year,11,31);
        let match = prazoLower.match(/(\d+)\s+mes(es)?/);
        if(match){ let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; }
        match = prazoLower.match(/(\d+)\s+dia(s)?/);
        if(match){ let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; }
        if(prazoLower.includes('verao')||prazoLower.includes('verão')){ const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); }
        if(prazoLower.includes('natal')){ const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); }
        if(prazoLower.includes('ano novo')) return new Date(year+1,0,1);
        if(prazoLower.includes('pascoa')||prazoLower.includes('páscoa')){ const e=getEaster(year); return now<e?e:getEaster(year+1); }
        return null;
      }

      const endDate = calculateEndDate(prazoText);
      if(!endDate){ document.getElementById('dieta-result').innerText = "Prazo inválido. Use '3 meses' ou 'até o verão'."; return; }
      const startDate = new Date(); startDate.setHours(0,0,0,0);
      const objetivoText = formElements.objetivo.value;
      function analyzeGoal(text){ const lower=(text||'').toLowerCase(); const emag=['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento']; const mus=['ganhar musculo','hipertrofia','crescer','massa muscular','ficar forte','músculo']; const hasE=emag.some(k=>lower.includes(k)); const hasM=mus.some(k=>lower.includes(k)); if(hasE && !hasM) return 'emagrecer'; if(hasM && !hasE) return 'musculo'; return 'ambos'; }
      const goalType = analyzeGoal(objetivoText);

      // 1) Upsert profile (meta)
      try{
        const upsertPayload = {
          id: user.id,
          email: user.email,
          goal_start_date: startDate.toISOString(),
          goal_end_date: endDate.toISOString(),
          goal_prompt: objetivoText,
          goal_type: goalType
        };
        const { data: upsertData, error: upsertError } = await supabase.from('profiles').upsert(upsertPayload, { onConflict: 'id' }).select();
        if(upsertError){
          console.warn('Erro ao upsert profile:', upsertError);
          document.getElementById('dieta-result').innerText = 'Meta criada localmente, mas houve erro ao salvar perfil (ver console).';
        } else {
          currentProfile = (upsertData && upsertData[0]) || currentProfile;
        }
      } catch(err){
        console.error('Erro ao upsert profile:', err);
        document.getElementById('dieta-result').innerText = 'Erro ao salvar meta (ver console).';
      }

      // 2) Gerar plano usando inputs do formulário
      const formInputs = {
        objetivo: formElements.objetivo.value,
        sexo: formElements.sexo.value,
        altura: parseFloat((formElements.altura.value||'').replace(',','.')),
        peso: parseFloat(formElements.peso.value),
        idade: parseInt(formElements.idade.value,10),
        disponibilidade: parseInt(formElements.disponibilidade.value||'0',10),
        nivel: formElements.nivel.value,
        orcamento: formElements.orcamento.value,
        uso_suplemento: formElements.uso_suplemento.value,
        quais_suplementos: formElements.quais_suplementos ? formElements.quais_suplementos.value : ''
      };

      // fetch foods (ou usa amostra)
      let foods = [];
      try{ foods = await fetchAllFoodsFromDB(); } catch(e){ if(e.message === 'missing_table'){ document.getElementById('dieta-result').innerText = "A tabela 'food_catalog' não existe no Supabase. Usando amostra."; foods = INITIAL_FOODS_SAMPLE; } else { console.error(e); foods = INITIAL_FOODS_SAMPLE; } }

      const plan = generateDietPlan(formInputs, foods);
      lastGeneratedPlan = plan;

      // 3) salva plano na tabela diets (espera retorno)
      let savedOk = false;
      let saveResult = null;
      try{
        saveResult = await saveDietToDB(user.id, plan, { objective: formInputs.objetivo, budget: formInputs.orcamento, restrictions: formInputs.uso_suplemento === 'Sim' ? formInputs.quais_suplementos : '' });
        if(saveResult.ok) savedOk = true;
      } catch(e){ console.error('Erro saveDietToDB:', e); }

      // 4) renderiza no percurso e navega para lá
      renderPlanInPercurso(plan, { objective: formInputs.objetivo, budget: formInputs.orcamento, restrictions: formInputs.uso_suplemento === 'Sim' ? formInputs.quais_suplementos : '' });

      // Exibe mensagem de acordo com resultado de salvamento e então muda de aba
      if(savedOk){
        document.getElementById('dieta-result').innerText += "\n\nPlano salvo no Supabase com sucesso!";
      } else {
        // se falhou por falta de tabela, mostre instrução; caso contrário, mostre erro genérico.
        const reason = (saveResult && saveResult.reason) ? saveResult.reason : 'unknown';
        if(reason === 'missing_table'){
          document.getElementById('dieta-result').innerText += "\n\nAVISO: A tabela 'diets' não existe no Supabase. Execute este SQL no Editor para criá-la:\n\n" + DIETS_TABLE_SQL;
        } else {
          document.getElementById('dieta-result').innerText += "\n\nErro ao salvar plano no Supabase (ver console). O plano foi gerado localmente e mostrado nesta aba.";
        }
      }

      // garantir que o cliente veja a aba Percurso imediatamente
      switchTab('percurso');

      // atualizar UI de progresso (por consistência): mostra results e barra
      document.getElementById('playlist-section').style.display = 'block';
      displayProgress(startDate, endDate);
    }

    // ligar o botão ao handler
    if(submitBtn) submitBtn.addEventListener('click', handleIaSubmit);
    if(iaFitForm) iaFitForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); handleIaSubmit(); });

    // salvar plano manual (botão no percurso)
    const salvarBtn = document.getElementById('salvar-dieta-btn');
    if(salvarBtn) salvarBtn.addEventListener('click', async ()=>{
      if(!lastGeneratedPlan){ document.getElementById('dieta-result').innerText = 'Nenhum plano gerado ainda. Crie seu caminho primeiro.'; return; }
      const meta = { objective: document.getElementById('objetivo_dieta_generated').value, budget: document.getElementById('orcamento_dieta_generated').value, restrictions: document.getElementById('restricoes_dieta_generated').value };
      const res = await saveDietToDB(user.id, lastGeneratedPlan, meta);
      if(!res.ok){
        if(res.reason === 'missing_table'){
          document.getElementById('dieta-result').innerText += "\n\nA tabela 'diets' não existe. SQL:\n\n" + DIETS_TABLE_SQL;
        } else {
          document.getElementById('dieta-result').innerText += "\n\nErro ao salvar plano (veja console).";
          console.error(res);
        }
      } else {
        document.getElementById('dieta-result').innerText += "\n\nPlano salvo com sucesso!";
      }
    });

    // playlist btn behavior (reorder videos)
    const playlistBtn = document.getElementById('playlist-btn');
    if(playlistBtn) playlistBtn.addEventListener('click', function(){
      if(!currentProfile) return;
      let videoOrder;
      if(currentProfile.goal_type === 'emagrecer') videoOrder = [3,2,1];
      else if(currentProfile.goal_type === 'musculo') videoOrder = [3,1,2];
      else videoOrder = [1,2,3];
      const c = document.getElementById('video-aulas');
      const v = {1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')};
      Object.values(v).forEach(b=>b.remove());
      videoOrder.forEach(i=>c.appendChild(v[i]));
      switchTab('video-aulas');
      document.getElementById('video-aulas').scrollIntoView({ behavior: 'smooth' });
    });

    // displayProgress (mostra barra e datas e esconde form principal)
    function displayProgress(startDate, endDate){
      const now = new Date(); now.setHours(0,0,0,0);
      const sDate = new Date(startDate); sDate.setHours(0,0,0,0);
      const eDate = new Date(endDate); eDate.setHours(0,0,0,0);
      const totalDuration = eDate.getTime() - sDate.getTime();
      const elapsedDuration = now.getTime() - sDate.getTime();
      const daysRemaining = Math.ceil((eDate - now) / (1000*60*60*24));
      let progressPercentage = totalDuration>0 ? (elapsedDuration / totalDuration) * 100 : 0;
      if(progressPercentage < 0) progressPercentage = 0;
      if(progressPercentage > 100) progressPercentage = 100;
      document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
      document.getElementById('start-date-label').textContent = sDate.toLocaleDateString('pt-BR');
      document.getElementById('end-date-label').textContent = eDate.toLocaleDateString('pt-BR');
      document.getElementById('countdown-days').textContent = daysRemaining >= 0 ? daysRemaining : 0;
      document.getElementById('form-wrapper').style.display = 'none';
      document.getElementById('results-wrapper').style.display = 'block';
    }

  }); // DOMContentLoaded
</script>

</body>
</html>
