<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Plataforma de IA — Saúde & Estética</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --color-ia-specialist:#007BFF; --color-video-lessons:#8A2BE2; --color-journey:#DC143C; --journey-red-1:#ff2646; --journey-red-2:#be123c; }
    html{scroll-behavior:smooth}
    body{font-family:'Poppins',sans-serif;background:#121212;color:#E0E0E0;margin:0;padding:40px 20px}
    .container{max-width:1600px;margin:0 auto;padding:0 20px}
    h1,h2,h3{color:#f0f0f0;text-align:center;margin-top:30px;margin-bottom:15px}
    .menu-toggle{position:fixed;top:25px;left:25px;z-index:1001;background:#333;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;padding:0}
    .menu-toggle .bar{width:24px;height:3px;background:#fff;border-radius:2px}
    .menu-toggle.open .bar:nth-child(1){transform:translateY(8px) rotate(45deg)}
    .menu-toggle.open .bar:nth-child(2){opacity:0}
    .menu-toggle.open .bar:nth-child(3){transform:translateY(-8px) rotate(-45deg)}
    .sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#1E1E1E;transition:left .3s;z-index:1000;border-right:1px solid #333;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar.open{left:0}
    .sidebar nav{padding-top:100px}
    .sidebar nav ul{list-style:none;padding:0;margin:0}
    .sidebar nav a{display:block;padding:15px 30px;text-decoration:none;font-size:1.1em;font-weight:700;border-left:5px solid transparent;transition:background .2s,border-left .2s}
    .sidebar nav a:hover{background:#2c2c2c}
    .link-ia,.link-aulas,.link-percurso{background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .link-ia{background-image:linear-gradient(90deg,#38b6ff,#0056b3)}
    .link-aulas{background-image:linear-gradient(90deg,#c048f2,#6b21a8)}
    .link-percurso{background-image:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2))}
    .sidebar-footer{padding:20px 30px;text-align:center}
    .sidebar-config-btn{width:100%;background:transparent;border:1px solid #444;color:#aaa;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}
    .hidden{display:none}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .overlay.show{opacity:1;visibility:visible}
    .header{display:flex;justify-content:flex-end;align-items:center;margin-bottom:20px}
    #welcome-msg{color:#bbb}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .form-wrapper,.results-wrapper{width:100%;max-width:800px;margin:0 auto}
    .form-container,.results-container,.percurso-container{background:#1E1E1E;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid #333}
    label{display:block;margin-bottom:8px;font-weight:600;color:#BBBBBB}
    input,select,textarea{width:100%;padding:12px;background:#2C2C2C;border:1px solid #444;border-radius:8px;color:#E0E0E0;font-size:16px;box-sizing:border-box}
    textarea{resize:vertical;min-height:100px}
    .percurso-forms{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
    .percurso-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.25));border:1px solid rgba(190,18,60,.12);padding:20px;border-radius:12px}
    .paste-btn{--h:36px;display:inline-flex;align-items:center;justify-content:center;height:var(--h);min-width:160px;padding:8px 24px;border-radius:999px;background:linear-gradient(90deg,var(--journey-red-1),var(--journey-red-2));border:none;color:#fff;font-weight:700;cursor:pointer}
    .compact-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.06));padding:14px;border-radius:10px}
    .compact-input{width:100%;min-height:110px;padding:10px;border-radius:8px;background:#0f0f10;border:1px solid #222;color:#e6eefc}
    .compact-controls{display:flex;gap:10px;margin-top:8px}
    .compact-btn{padding:9px 14px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,#ff4b6b,#be123c);color:white;font-weight:700}
    .compact-btn.clear{background:#222;border:1px solid #333}
    .compact-btn.copy{background:#0b74ff}
    .compact-error{margin-top:8px;padding:10px;border-radius:8px;background:#3b0f0f;color:#ffdede;display:none;white-space:pre-wrap;font-family:monospace;font-size:13px}
    .kb-preview{margin-top:8px;font-size:13px;color:#bbb}
    .compact-root{margin-top:12px}
    @media(max-width:900px){.percurso-forms{grid-template-columns:1fr}.menu-toggle{top:14px;left:14px;width:44px;height:44px}}
  </style>
</head>
<body>

<button class="menu-toggle" id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
<div class="sidebar" id="sidebar">
  <nav>
    <ul>
      <li><a href="#" class="nav-link link-ia active" data-tab="ia-planejamento">IA Especialista</a></li>
      <li><a href="#" class="nav-link link-aulas" data-tab="video-aulas">Videoaulas</a></li>
      <li><a href="#" class="nav-link link-percurso" data-tab="percurso">Percurso</a></li>
    </ul>
  </nav>
  <div class="sidebar-footer">
    <button id="config-btn" class="sidebar-config-btn">⚙️ Configurações</button>
    <button id="reset-btn" class="sidebar-action-btn sidebar-reset-btn hidden">Definir Nova Meta</button>
    <button id="logout-btn" class="sidebar-action-btn sidebar-logout-btn hidden">Sair da conta</button>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<div class="container">
  <div class="header"><p id="welcome-msg">A carregar...</p></div>

  <!-- IA Especialista -->
  <div id="ia-planejamento" class="tab-content active">
    <div class="form-wrapper" id="form-wrapper" style="display:none">
      <div class="form-container">
        <h1>Crie a sua Meta</h1>
        <form id="ia-fit-form">
          <div class="goal-section">
            <h2 class="goal-title text-glow-blue">Qual é a sua Grande Meta?</h2>
            <textarea id="objetivo" name="objetivo" placeholder="Escreva aqui seu principal objetivo..." required></textarea>
            <div id="prazo-group" class="form-group" style="margin-top:20px;text-align:left;display:none">
              <label for="prazo">Qual o prazo para esta meta?</label>
              <input type="text" id="prazo" name="prazo" placeholder="Ex: 3 meses, até o verão..." required>
            </div>
          </div>

          <h3>Informações Básicas e Realidade Atual</h3>
          <div class="form-group"><label for="sexo">Sexo</label><select id="sexo" name="sexo" required><option value="" disabled selected>Selecione...</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>
          <div class="form-group"><label for="altura">Altura (m)</label><input type="text" inputmode="decimal" id="altura" name="altura" placeholder="Ex: 1.75" required></div>
          <div class="form-group"><label for="peso">Peso (kg)</label><input type="number" id="peso" name="peso" placeholder="Ex: 75" required></div>
          <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade" placeholder="Ex: 25" required></div>
          <div class="form-group"><label for="disponibilidade">Dias por semana para treinar</label><input type="number" id="disponibilidade" name="disponibilidade" placeholder="Ex: 4" min="1" max="7" required></div>
          <div class="form-group"><label for="local_treino">Onde vai treinar?</label><select id="local_treino" name="local_treino" required><option value="" disabled selected>Selecione...</option><option value="Academia">Academia</option><option value="Casa">Em Casa</option></select></div>
          <div class="form-group"><label for="orcamento">Orçamento mensal para dieta (R$)</label><input type="text" inputmode="decimal" id="orcamento" name="orcamento" placeholder="Ex: 500 ou 4.500,50" required></div>
          <div class="form-group"><label for="uso_suplemento">Pretende usar suplementos?</label><select id="uso_suplemento" name="uso_suplemento" required><option value="" disabled selected>Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
          <div class="form-group" id="suplementos-detalhes-group" style="display:none"><label for="quais_suplementos">Quais suplementos?</label><textarea id="quais_suplementos" name="quais_suplementos" placeholder="Ex: Whey, Creatina..."></textarea></div>
          <div class="form-group"><label for="nivel">Seu nível em atividades físicas</label><select id="nivel" name="nivel" required><option value="" disabled selected>Selecione...</option><option value="iniciante">Iniciante</option><option value="intermediario">Intermediário</option><option value="avancado">Avançado</option></select></div>
          <button type="submit">Crie seu próprio caminho</button>
        </form>
      </div>
    </div>

    <div class="results-wrapper" id="results-wrapper" style="display:none">
      <div class="results-container">
        <h2>Seu Plano de Ação</h2>
        <pre id="prompt-output"></pre>
        <button id="copy-btn-main" class="copy-button">Copiar Pedido</button>

        <h3>Comece sua Conversa com a IA</h3>
        <p style="text-align:center;color:#bbb;margin-top:-10px;margin-bottom:20px">Copie o pedido acima e cole no chat para receber o seu plano personalizado.</p>

        <div id="dify-container" class="iframe-container"></div>

        <div class="playlist-section" id="playlist-section" style="display:none">
          <h4>Roteiro de Aulas Sugerido</h4>
          <p style="color:#bbb;margin-top:-10px">Com base na sua meta, preparámos um roteiro para acelerar os seus resultados.</p>
          <button id="playlist-btn" class="playlist-btn">Ver seu Roteiro de Aulas</button>
        </div>

        <div class="progress-section">
          <h3>Sua Jornada</h3>
          <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
          <div class="progress-labels"><span id="start-date-label"></span><span id="end-date-label"></span></div>
          <div class="countdown-container"><div id="countdown-days" class="countdown-days"></div><div class="countdown-label">dias para mudar de vida</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video aulas -->
  <div id="video-aulas" class="tab-content">
    <h2>Nossas Aulas</h2>
    <div id="video-block-1"><h3>Aula 1: Introdução ao Treino Estético</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/NzRo6GJgDc0" allowfullscreen></iframe></div></div>
    <div id="video-block-2"><h3>Aula 2: Fundamentos da Nutrição</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/_TRvuAD2A1I" allowfullscreen></iframe></div></div>
    <div id="video-block-3"><h3>Aula 3: Desvendando a Hipertrofia</h3><div class="video-container"><iframe src="https://www.youtube.com/embed/jufiwAs6HEI" allowfullscreen></iframe></div></div>
  </div>

  <!-- Percurso (inclui parser e KB completo) -->
  <div id="percurso" class="tab-content">
    <div class="percurso-container">
      <h2>Meu Percurso</h2>
      <p style="text-align:center;color:#bbb">Visualize progresso, gere formulários a partir de códigos compactos e cole planos.</p>
      <div class="percurso-forms">
        <div class="percurso-card" id="treino-card">
          <h4>Formulário: Treino</h4>
          <div class="form-group"><label for="objetivo_treino">Objetivo de Treino</label><textarea id="objetivo_treino" placeholder="Ex: hipertrofia de membros superiores..."></textarea></div>
          <div class="form-group"><label for="frequencia_treino">Frequência semanal</label><input id="frequencia_treino" type="number" min="1" max="7" placeholder="Ex: 4"></div>
          <div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;margin-top:8px;">
            <button class="paste-btn appearing" id="paste-treino" aria-pressed="false" title="Colar conteúdo do pedido"><span class="label">Colar plano</span></button>
            <div class="small-note">Clique para colar (simulação)</div>
          </div>
        </div>

        <div class="percurso-card" id="dieta-card">
          <h4>Formulário: Dieta</h4>

          <div class="compact-card">
            <label for="compactInput">Cole aqui o código compacto (formato compacto → formulário):</label>
            <textarea id="compactInput" class="compact-input" placeholder="Cole o código compacto aqui..."></textarea>
            <div class="compact-controls">
              <button id="runBtn" class="compact-btn">Rodar Código</button>
              <button id="clearBtn" class="compact-btn clear">Limpar</button>
              <button id="copyBtn" class="compact-btn copy">Copiar JSON</button>
            </div>
            <div id="compactError" class="compact-error"></div>
            <div id="kbPreview" class="kb-preview"></div>
            <div id="compactRoot" class="compact-root"></div>
          </div>

        </div>
      </div>

      <p style="text-align:center;color:#888;margin-top:18px">Os botões "Colar" simulam colar o conteúdo gerado no painel IA (quando ativo).</p>
    </div>
  </div>

</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ====== CONFIGURAÇÃO (mantenha as suas chaves) ======
  const SUPABASE_URL = 'https://edxsgmchmwtpgnoxgrkb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DIFY_APP_TOKEN = 'lbpbrmsV3IaH9e0X';

  // ---------- KB COMPLETO (somente nome) ----------
  // IDs conforme lista que você enviou — cada item tem 'name'.
  const KB = {
    "1":{"name":"Abóbora, cabotián — cozida"},
    "5":{"name":"Abóbora, moranga — refogada"},
    "7":{"name":"Abobrinha, italiana — cozida"},
    "8":{"name":"Abobrinha, italiana — crua"},
    "9":{"name":"Abobrinha, italiana — refogada"},
    "10":{"name":"Abobrinha, paulista — crua"},
    "11":{"name":"Acelga — crua"},
    "12":{"name":"Agrião — cru"},
    "13":{"name":"Aipo — cru"},
    "14":{"name":"Alface, americana — crua"},
    "15":{"name":"Alface, crespa — crua"},
    "16":{"name":"Alface, lisa — crua"},
    "17":{"name":"Alface, roxa — crua"},
    "18":{"name":"Alfavaca — crua"},
    "19":{"name":"Alho — cru (uso culinário)"},
    "20":{"name":"Alho-poró — cru"},
    "21":{"name":"Almeirão — cru"},
    "22":{"name":"Almeirão — refogado"},
    "23":{"name":"Batata, baroa — cozida"},
    "25":{"name":"Batata, doce — cozida"},
    "27":{"name":"Batata frita, tipo chips — industrializada"},
    "28":{"name":"Batata, inglesa — cozida"},
    "30":{"name":"Batata, inglesa — frita"},
    "31":{"name":"Batata, inglesa — sauté"},
    "32":{"name":"Berinjela — cozida"},
    "34":{"name":"Beterraba — cozida"},
    "35":{"name":"Beterraba — crua"},
    "36":{"name":"Brócolis — cozido"},
    "37":{"name":"Brócolis — cru"},
    "38":{"name":"Cará — cozido"},
    "40":{"name":"Canru — cru"},
    "41":{"name":"Catalonha — crua"},
    "42":{"name":"Catalonha — refogada"},
    "43":{"name":"Cebola — crua"},
    "44":{"name":"Cebolinha — crua"},
    "45":{"name":"Cenoura — cozida"},
    "46":{"name":"Cenoura — crua"},
    "47":{"name":"Chicória — crua"},
    "48":{"name":"Chuchu — cozido"},
    "49":{"name":"Chuchu — cru"},
    "50":{"name":"Coentro, folhas — desidratadas"},
    "51":{"name":"Couve, manteiga — crua"},
    "52":{"name":"Couve, manteiga — refogada"},
    "53":{"name":"Couve-flor — cozida"},
    "54":{"name":"Couve-flor — crua"},
    "55":{"name":"Espinafre, Nova Zelândia — cru"},
    "56":{"name":"Espinafre, Nova Zelândia — refogado"},
    "58":{"name":"Jiló — cru"},
    "60":{"name":"Mandioca — cozida"},
    "62":{"name":"Manjericão — cru"},
    "63":{"name":"Maxixe — cru"},
    "64":{"name":"Mostarda, folha — crua"},
    "65":{"name":"Nabo — cru"},
    "66":{"name":"Nhoque, batata — cozido"},
    "67":{"name":"Palmito, juçara — em conserva"},
    "68":{"name":"Palmito, pupunha — em conserva"},
    "69":{"name":"Pepino — cru"},
    "70":{"name":"Pimentão, amarelo — cru"},
    "71":{"name":"Pimentão, verde — cru"},
    "72":{"name":"Pimentão, vermelho — cru"},
    "73":{"name":"Quiabo — cru"},
    "74":{"name":"Rabanete — cru"},
    "75":{"name":"Repolho, branco — cru"},
    "76":{"name":"Repolho, roxo — cru"},
    "77":{"name":"Repolho, roxo — refogado"},
    "78":{"name":"Rúcula — crua"},
    "79":{"name":"Salsa — crua"},
    "80":{"name":"Seleta de legumes — enlatada"},
    "81":{"name":"Serralha — crua"},
    "82":{"name":"Taioba — crua"},
    "83":{"name":"Tomate, com semente — cru"},
    "84":{"name":"Tomate — extrato"},
    "85":{"name":"Tomate — molho industrializado"},
    "86":{"name":"Tomate — purê"},
    "87":{"name":"Tomate — salada"},
    "88":{"name":"Vagem — crua"},
    "89":{"name":"Abacate — cru"},
    "90":{"name":"Abacaxi — cru"},
    "92":{"name":"Abiu — cru"},
    "93":{"name":"Açaí, polpa, com xarope"},
    "95":{"name":"Acerola — crua"},
    "96":{"name":"Ameixa, calda — enlatada"},
    "97":{"name":"Ameixa — crua"},
    "98":{"name":"Atemoia — crua"},
    "99":{"name":"Banana, da terra — crua"},
    "100":{"name":"Banana, doce — em barra (processado)"},
    "101":{"name":"Banana, figo — crua"},
    "102":{"name":"Banana, maçã — crua"},
    "103":{"name":"Banana, nanica — crua"},
    "104":{"name":"Banana, ouro — crua"},
    "105":{"name":"Banana, pacova — crua"},
    "106":{"name":"Banana, prata — crua"},
    "107":{"name":"Cacau — cru"},
    "108":{"name":"Cajá-Manga — cru"},
    "110":{"name":"Caju, suco — concentrado, envasado"},
    "111":{"name":"Cajuí, chocolate — cru"},
    "112":{"name":"Carambola — crua"},
    "113":{"name":"Ciriguela — crua"},
    "114":{"name":"Cupuaçu — cru"},
    "116":{"name":"Figo — cru"},
    "117":{"name":"Figo, enlatado — em calda"},
    "118":{"name":"Fruta-pão — crua"},
    "119":{"name":"Goiaba, branca, com casca — crua"},
    "120":{"name":"Goiaba, doce — em pasta"},
    "121":{"name":"Goiaba, doce, cascão"},
    "122":{"name":"Goiaba, vermelha, com casca — crua"},
    "123":{"name":"Graviola — crua"},
    "125":{"name":"Jabuticaba — crua"},
    "126":{"name":"Jaca — crua"},
    "127":{"name":"Jambo — cru"},
    "128":{"name":"Jamelão — cru"},
    "129":{"name":"Kiwi — cru"},
    "130":{"name":"Laranja, baía — crua"},
    "131":{"name":"Laranja, baía — suco"},
    "132":{"name":"Laranja, da terra — crua"},
    "133":{"name":"Laranja, da terra — suco"},
    "134":{"name":"Laranja, lima — crua"},
    "135":{"name":"Laranja, lima — suco"},
    "136":{"name":"Laranja, pêra — crua"},
    "137":{"name":"Laranja, suco (genérico)"},
    "138":{"name":"Laranja, valência — crua"},
    "139":{"name":"Laranja, valência — suco"},
    "140":{"name":"Limão, cravo — suco"},
    "141":{"name":"Limão, tahiti — cru"},
    "142":{"name":"Maçã, Argentina, com casca — crua"},
    "143":{"name":"Maçã, Fuji, com casca — crua"},
    "144":{"name":"Macaúba — cru"},
    "145":{"name":"Mamão, doce, em calda — drenado"},
    "146":{"name":"Mamão, formosa — cru"},
    "147":{"name":"Mamão, papaia — cru"},
    "148":{"name":"Mamão verde, doce em calda — drenado"},
    "149":{"name":"Manga, Haden — crua"},
    "150":{"name":"Manga, Palmer — crua"},
    "152":{"name":"Manga, Tommy Atkins — crua"},
    "153":{"name":"Mangarataia — crua"},
    "155":{"name":"Maracujá, suco — concentrado"},
    "156":{"name":"Melancia — crua"},
    "157":{"name":"Melão — cru"},
    "158":{"name":"Mexerica, Murcote — crua"},
    "159":{"name":"Mexerica, Rio — crua"},
    "160":{"name":"Morango — cru"},
    "161":{"name":"Nêspera — cru"},
    "163":{"name":"Pêra, Park — crua"},
    "164":{"name":"Pêra, Williams — crua"},
    "165":{"name":"Pêssego, Aurora — cru"},
    "166":{"name":"Pêssego, enlatado, em calda"},
    "167":{"name":"Pinha — cru"},
    "168":{"name":"Pitanga — cru"},
    "169":{"name":"Romã — cru"},
    "170":{"name":"Tamarindo — cru"},
    "171":{"name":"Tangerina, Ponkan — cru"},
    "172":{"name":"Tangerina, Ponkan — suco"},
    "173":{"name":"Tucumã — cru"},
    "174":{"name":"Umbu — cru"},
    "176":{"name":"Uva, Itália — crua"},
    "177":{"name":"Uva, Rubi — crua"},
    "178":{"name":"Uva, suco — concentrado, envasado"},
    "179":{"name":"Azeite, de dendê"},
    "180":{"name":"Azeite, de oliva, extra virgem"},
    "181":{"name":"Manteiga, com sal"},
    "182":{"name":"Manteiga, sem sal"},
    "183":{"name":"Margarina, com óleo hidrogenado"},
    "184":{"name":"Óleo, de soja"},
    "185":{"name":"Abadejo, filé, congelado — assado"},
    "186":{"name":"Abadejo, filé, congelado — cozido"},
    "188":{"name":"Abadejo, filé, congelado — grelhado"},
    "189":{"name":"Atum, conserva em óleo"},
    "192":{"name":"Bacalhau, salgado — refogado"},
    "193":{"name":"Cação, posta, com farinha de trigo — frita"},
    "194":{"name":"Cação, posta — cozida"},
    "196":{"name":"Camarão, Rio Grande, grande — cozido"},
    "198":{"name":"Camarão, Sete Barbas, sem cabeça, com casca — frito"},
    "199":{"name":"Caranguejo — cozido"},
    "200":{"name":"Corimbatá — assado"},
    "201":{"name":"Corimbatá — cozido"},
    "204":{"name":"Corvina grande — assada"},
    "205":{"name":"Corvina grande — cozida"},
    "206":{"name":"Dourada de água doce — fresca"},
    "208":{"name":"Lambari, congelado — frito"},
    "209":{"name":"Manjuba — frita"},
    "210":{"name":"Manjuba, com farinha de trigo — frita"},
    "211":{"name":"Manjuba — frita (variante)"},
    "212":{"name":"Merluza, filé — assado"},
    "213":{"name":"Merluza, filé — cozido"},
    "215":{"name":"Pescada, branca — frita"},
    "217":{"name":"Pescada, com farinha de trigo — frita"},
    "219":{"name":"Pescada, filé — frita"},
    "220":{"name":"Pescada, filé — molho escabeche"},
    "222":{"name":"Pintado — assado"},
    "224":{"name":"Pintado — grelhado"},
    "226":{"name":"Salmão, com pele, fresco — grelhado"},
    "228":{"name":"Salmão, sem pele, fresco — grelhado"},
    "229":{"name":"Sardinha — assada"},
    "230":{"name":"Sardinha, conserva em óleo"},
    "231":{"name":"Sardinha — frita"},
    "234":{"name":"Arroz, integral — cozido"},
    "237":{"name":"Arroz, tipo 1 — cozido"},
    "238":{"name":"Aveia, flocos — crua"},
    "239":{"name":"Biscoito, doce, maisena"},
    "240":{"name":"Biscoito, doce, recheado com chocolate"},
    "241":{"name":"Biscoito, doce, recheado com morango"},
    "242":{"name":"Biscoito, doce, wafer, recheado de chocolate"},
    "243":{"name":"Biscoito, doce, wafer, recheado de morango"},
    "244":{"name":"Biscoito, salgado, cream cracker"},
    "245":{"name":"Biscoito, polvilho — doce"},
    "246":{"name":"Bolo, mistura para"},
    "247":{"name":"Bolo, pronto, aipim"},
    "248":{"name":"Bolo, pronto, chocolate"},
    "249":{"name":"Bolo, pronto, coco"},
    "251":{"name":"Canjica, com leite integral"},
    "252":{"name":"Cereais, milho, flocos, com sal"},
    "253":{"name":"Cereais, milho, flocos, sem sal"},
    "254":{"name":"Cereais, milho, infantil"},
    "255":{"name":"Cereais, mistura para vitamina"},
    "256":{"name":"Cereal matinal, milho"},
    "257":{"name":"Cereal matinal, milho, açúcar"},
    "258":{"name":"Creme de arroz, pó"},
    "259":{"name":"Creme de milho, pó"},
    "260":{"name":"Curau, milho verde"},
    "261":{"name":"Farinha, de arroz, enriquecida"},
    "262":{"name":"Farinha, de centeio, integral"},
    "263":{"name":"Farinha, de milho, amarela"},
    "264":{"name":"Farinha, de rosca"},
    "265":{"name":"Farinha, de trigo"},
    "266":{"name":"Farinha, láctea, de cereais"},
    "267":{"name":"Farinha, de mandioca, torrada"},
    "268":{"name":"Farinha, de puba"},
    "269":{"name":"Feijão, de mandioca — cozido"},
    "271":{"name":"Lasanha, massa fresca — cozida"},
    "273":{"name":"Macarrão, instantâneo"},
    "278":{"name":"Milho, verde — cru"},
    "279":{"name":"Milho, verde, enlatado — drenado"},
    "280":{"name":"Mingau tradicional, pó"},
    "281":{"name":"Pamonha, barra para cozimento"},
    "282":{"name":"Pão, aveia, forma"},
    "283":{"name":"Pão, de glúten, forma"},
    "284":{"name":"Pão, de glúten, forma (variante)"},
    "285":{"name":"Pão, milho, forma"},
    "288":{"name":"Pão, trigo, forma, integral"},
    "289":{"name":"Pão, trigo, francês"},
    "290":{"name":"Pão, trigo, sovado"},
    "293":{"name":"Pastel, de queijo — frito"},
    "294":{"name":"Pastel, de queijo — frito (variante)"},
    "295":{"name":"Pastel, massa — frita"},
    "296":{"name":"Pastel, massa — frita (variante)"},
    "297":{"name":"Pipoca, com óleo de soja — sem sal"},
    "298":{"name":"Polenta, pré-cozida"},
    "299":{"name":"Torrada, pão francês"},
    "300":{"name":"Açúcar, mascavo"},
    "301":{"name":"Açúcar, refinado"},
    "302":{"name":"Chocolate, ao leite"},
    "303":{"name":"Chocolate, ao leite, com castanha do Pará"},
    "304":{"name":"Chocolate, ao leite, dietético"},
    "305":{"name":"Chocolate, meio amargo"},
    "306":{"name":"Cocada branca"},
    "307":{"name":"Doce, de abóbora, cremoso"},
    "308":{"name":"Doce, de leite, cremoso"},
    "309":{"name":"Geleia, mocotó, natural"},
    "310":{"name":"Glicose de milho"},
    "311":{"name":"Maria mole"},
    "312":{"name":"Maria mole, coco queimado"},
    "313":{"name":"Marmelada"},
    "314":{"name":"Mel, de abelha"},
    "315":{"name":"Melado"},
    "316":{"name":"Quindim"},
    "317":{"name":"Rapadura"},
    "318":{"name":"Café, pó, torrado"},
    "319":{"name":"Capuccino, pó"},
    "320":{"name":"Fermento em pó, químico"},
    "321":{"name":"Fermento, biológico, levedura, tablete"},
    "322":{"name":"Gelatina, sabores variados, pó"},
    "323":{"name":"Sal, dietético"},
    "324":{"name":"Sal, grosso"},
    "325":{"name":"Shoyu"},
    "326":{"name":"Tempero à base de sal"},
    "327":{"name":"Azeitona, preta — conserva"},
    "328":{"name":"Azeitona, verde — conserva"},
    "329":{"name":"Chantilly, spray, com gordura vegetal"},
    "330":{"name":"Leite, de coco"},
    "331":{"name":"Maionese, tradicional com ovos"},
    "332":{"name":"Bebida isotônica"},
    "333":{"name":"Café, infusão 10%"},
    "334":{"name":"Cana, aguardente"},
    "335":{"name":"Cana, caldo"},
    "336":{"name":"Cerveja, pilsen"},
    "337":{"name":"Chá, erva-doce — infusão"},
    "338":{"name":"Chá, mate — infusão"},
    "339":{"name":"Chá, preto — infusão"},
    "340":{"name":"Coco, água de — bebida"},
    "341":{"name":"Refrigerante, água tônica"},
    "342":{"name":"Refrigerante, tipo cola"},
    "343":{"name":"Refrigerante, tipo guaraná"},
    "344":{"name":"Refrigerante, tipo laranja"},
    "345":{"name":"Refrigerante, tipo limão"},
    "346":{"name":"Achocolatado, pó"},
    "347":{"name":"Tacacá"},
    "348":{"name":"Tapioca, com manteiga"},
    "349":{"name":"Tucupi, com pimenta-de-cheiro"},
    "350":{"name":"Vaca atolada"},
    "351":{"name":"Vatapá"},
    "352":{"name":"Virado à paulista"},
    "353":{"name":"Yakisoba"},
    "354":{"name":"Acarajé"},
    "355":{"name":"Arroz carreteiro"},
    "356":{"name":"Baião de dois, arroz e feijão-de-corda"},
    "357":{"name":"Barreado"},
    "358":{"name":"Bife à cavalo, com contra filé"},
    "359":{"name":"Bolinho de arroz"},
    "360":{"name":"Camarão à baiana"},
    "361":{"name":"Charuto, de repolho"},
    "362":{"name":"Cuscuz, de milho, cozido com sal"},
    "363":{"name":"Cuscuz, paulista"},
    "364":{"name":"Cuxá, molho"},
    "365":{"name":"Dobradinha"},
    "366":{"name":"Estrogonofe de carne"},
    "367":{"name":"Estrogonofe de frango"},
    "368":{"name":"Feijoada tropeiro mineiro"},
    "369":{"name":"Feijoada"},
    "370":{"name":"Frango, com açafrão"},
    "371":{"name":"Macarrão, molho bolonhesa"},
    "372":{"name":"Maniçoba"},
    "373":{"name":"Quibebe"},
    "374":{"name":"Salada, de legumes, com maionese"},
    "375":{"name":"Salada, de legumes, cozida no vapor"},
    "376":{"name":"Salpicão, de frango"},
    "377":{"name":"Sarapatel"},
    "378":{"name":"Tabule"},
    "379":{"name":"Amendoim, grão — cru"},
    "380":{"name":"Amendoim, torrado, salgado"},
    "381":{"name":"Ervilha, em vagem"},
    "382":{"name":"Ervilha, enlatada — drenada"},
    "383":{"name":"Feijão, carioca — cozido"},
    "385":{"name":"Feijão, fradinho — cozido"},
    "387":{"name":"Feijão, jalo — cozido"},
    "389":{"name":"Feijão, preto — cozido"},
    "391":{"name":"Feijão, rajado — cozido"},
    "393":{"name":"Feijão, rosinha — cozido"},
    "395":{"name":"Feijão, roxo — cozido"},
    "399":{"name":"Lentilha — cozida"},
    "401":{"name":"Paçoca, amendoim"},
    "402":{"name":"Pé-de-moleque, amendoim"},
    "403":{"name":"Soja, farinha"},
    "404":{"name":"Soja, extrato solúvel, natural, fluido"},
    "405":{"name":"Soja, extrato solúvel, pó"},
    "406":{"name":"Soja, queijo (tofu)"},
    "408":{"name":"Tremoço — em conserva"},
    "409":{"name":"Amêndoa, torrada, salgada"},
    "410":{"name":"Castanha-de-caju, torrada, salgada"},
    "411":{"name":"Castanha-do-Brasil — cru"},
    "412":{"name":"Coco — cru"},
    "413":{"name":"Gergelim, semente"},
    "414":{"name":"Linhaça, semente"},
    "415":{"name":"Pinhão — cozido"},
    "416":{"name":"Pupunha — cozida"},
    "417":{"name":"Noz — cru"},
    "419":{"name":"Presunto, com capa de gordura"},
    "420":{"name":"Presunto, sem capa de gordura"},
    "421":{"name":"Quibe — assado"},
    "423":{"name":"Quibe — frito"},
    "424":{"name":"Salame"},
    "426":{"name":"Toucinho — frito"},
    "427":{"name":"Apresentado (linha ambígua)"},
    "428":{"name":"Caldo de carne, tablete"},
    "429":{"name":"Caldo de galinha, tablete"},
    "430":{"name":"Carne, bovina, acém, moído, cozido"},
    "432":{"name":"Carne, bovina, acém, sem gordura, cozido"},
    "435":{"name":"Carne, bovina, almôndegas, fritas"},
    "436":{"name":"Carne, bovina, bucho, cozido"},
    "439":{"name":"Carne, bovina, capa de contra-filé, com gordura — grelhada"},
    "441":{"name":"Carne, bovina, capa de contra-filé, sem gordura — grelhada"},
    "442":{"name":"Carne, bovina, charque, cozido"},
    "444":{"name":"Carne, bovina, filé à milanesa — frita/assada"},
    "446":{"name":"Carne, bovina, contra-filé de costela — grelhado"},
    "448":{"name":"Carne, bovina, contra-filé, com gordura — grelhado"},
    "450":{"name":"Carne, bovina, contra-filé, sem gordura — grelhada"},
    "451":{"name":"Carne, bovina, costela — assada"},
    "453":{"name":"Carne, bovina, coxão duro, sem gordura — cozido"},
    "455":{"name":"Carne, bovina, coxão mole, sem gordura — cozido"},
    "457":{"name":"Carne, bovina, cupim — assado"},
    "460":{"name":"Carne, bovina, filé mignon, sem gordura — cozido"},
    "462":{"name":"Carne, bovina, flanco, sem gordura — cozido"},
    "464":{"name":"Carne, bovina, fraldinha, com gordura — cozida"},
    "466":{"name":"Carne, bovina, lagarto — cozido"},
    "468":{"name":"Carne, bovina, língua — cozida"},
    "470":{"name":"Carne, bovina, maminha — grelhada"},
    "473":{"name":"Carne, bovina, miolo de alcatra, sem gordura — grelhado"},
    "474":{"name":"Carne, bovina, músculo, sem gordura — cozido"},
    "477":{"name":"Carne, bovina, paleta, sem gordura — cozida"},
    "479":{"name":"Carne, bovina, patinho, sem gordura — cozido"},
    "480":{"name":"Carne, bovina, patinho, sem gordura — grelhado"},
    "481":{"name":"Carne, bovina, peito, sem gordura — cozido"},
    "484":{"name":"Carne, bovina, picanha, com gordura — grelhada"},
    "486":{"name":"Carne, bovina, picanha, sem gordura — grelhada"},
    "487":{"name":"Carne, bovina, seca — cozida"},
    "489":{"name":"Coxinha de frango — frita"},
    "491":{"name":"Croquete, de carne — frito"},
    "492":{"name":"Empada de frango, pré-cozida — assada"},
    "493":{"name":"Empada de frango, pré-cozida"},
    "495":{"name":"Frango, caipira, inteiro, com pele — cozido"},
    "496":{"name":"Frango, caipira, inteiro, sem pele — cozido"},
    "498":{"name":"Frango, coração — grelhado"},
    "499":{"name":"Frango, coxa, com pele — assada"},
    "500":{"name":"Frango, coxa, com pele — cozida"},
    "501":{"name":"Frango, coxa, sem pele — cozida"},
    "503":{"name":"Frango, filé, à milanesa"},
    "505":{"name":"Frango, inteiro, sem pele — assado"},
    "506":{"name":"Frango, inteiro, sem pele — cozido"},
    "508":{"name":"Frango, peito, com pele — assado"},
    "510":{"name":"Frango, peito, sem pele — cozido"},
    "512":{"name":"Frango, peito, sem pele — grelhado"},
    "513":{"name":"Frango, sobrecoxa, com pele — assada"},
    "515":{"name":"Frango, sobrecoxa, sem pele — assada"},
    "518":{"name":"Hambúrguer, bovino — frito"},
    "519":{"name":"Hambúrguer, bovino — grelhado"},
    "520":{"name":"Linguiça, frango — frita"},
    "521":{"name":"Linguiça, frango — grelhada"},
    "523":{"name":"Linguiça, porco — frita"},
    "524":{"name":"Linguiça, porco — frita (variante)"},
    "525":{"name":"Linguiça, porco — grelhada"},
    "526":{"name":"Mortadela"},
    "527":{"name":"Peru, congelado — assado"},
    "530":{"name":"Porco, bisteca — frita"},
    "531":{"name":"Porco, bisteca — grelhada"},
    "532":{"name":"Porco, costela — assada"},
    "534":{"name":"Porco, lombo — assado"},
    "537":{"name":"Porco, pernil — assado"},
    "539":{"name":"Bebida láctea, pêssego"},
    "540":{"name":"Creme de Leite"},
    "541":{"name":"Iogurte, natural"},
    "542":{"name":"Iogurte, natural, desnatado"},
    "543":{"name":"Iogurte, sabor abacaxi"},
    "544":{"name":"Iogurte, sabor morango"},
    "545":{"name":"Iogurte, sabor pêssego"},
    "546":{"name":"Leite, condensado"},
    "547":{"name":"Leite, de cabra"},
    "548":{"name":"Leite, de vaca, achocolatado"},
    "549":{"name":"Leite, de vaca, desnatado, pó"},
    "550":{"name":"Leite, de vaca, desnatado, UHT"},
    "551":{"name":"Leite, de vaca, integral"},
    "552":{"name":"Leite, de vaca, integral, pó"},
    "553":{"name":"Leite, fermentado"},
    "554":{"name":"Queijo, minas, frescal"},
    "555":{"name":"Queijo, minas, meia cura"},
    "556":{"name":"Queijo, mozarela"},
    "557":{"name":"Queijo, parmesão"},
    "558":{"name":"Queijo, pasteurizado"},
    "559":{"name":"Queijo, petit suisse, morango"},
    "560":{"name":"Queijo, prato"},
    "561":{"name":"Queijo, requeijão, cremoso"},
    "562":{"name":"Queijo, ricota"},
    "563":{"name":"Omelete, de queijo"},
    "565":{"name":"Ovo, de galinha, clara — cozida/10minutos"},
    "566":{"name":"Ovo, de galinha, gema — cozida/10minutos"},
    "567":{"name":"Ovo, de galinha, inteiro — cozido/10minutos"},
    "569":{"name":"Ovo, de galinha, inteiro — frito"}
  };

  // ---------- Utilitários de data/plan (mantidos) ----------
  function getEaster(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month-1, day); }
  function calculateEndDate(prazoText){ if(!prazoText) return null; const now=new Date(); const year=now.getFullYear(); let prazoLower=(prazoText||'').toLowerCase(); if(prazoLower.includes('final do ano')||prazoLower.includes('fim de ano')) return new Date(year,11,31); let match=prazoLower.match(/(\d+)\s+mes(es)?/); if(match){let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d;} match=prazoLower.match(/(\d+)\s+dia(s)?/); if(match){let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d;} if(prazoLower.includes('verao')||prazoLower.includes('verão')){ const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21);} if(prazoLower.includes('natal')){ const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25);} if(prazoLower.includes('ano novo')) return new Date(year+1,0,1); if(prazoLower.includes('pascoa')||prazoLower.includes('páscoa')){ const e=getEaster(year); return now<e?e:getEaster(year+1);} return null; }
  function displayProgress(startDate,endDate){ const now=new Date(); now.setHours(0,0,0,0); const sDate=new Date(startDate); sDate.setHours(0,0,0,0); const eDate=new Date(endDate); eDate.setHours(0,0,0,0); const totalDuration=eDate.getTime()-sDate.getTime(), elapsedDuration=now.getTime()-sDate.getTime(); const daysRemaining=Math.ceil((eDate-now)/(1000*60*60*24)); let progressPercentage=(elapsedDuration/totalDuration)*100; if(progressPercentage<0)progressPercentage=0; if(progressPercentage>100)progressPercentage=100; const pb=document.getElementById('progress-bar'); if(pb) pb.style.width=`${progressPercentage}%`; const sLbl=document.getElementById('start-date-label'); const eLbl=document.getElementById('end-date-label'); if(sLbl) sLbl.textContent=sDate.toLocaleDateString('pt-BR'); if(eLbl) eLbl.textContent=eDate.toLocaleDateString('pt-BR'); const cd=document.getElementById('countdown-days'); if(cd) cd.textContent=daysRemaining>=0?daysRemaining:0; const fw=document.getElementById('form-wrapper'); const rs=document.getElementById('results-wrapper'); if(fw && rs){ fw.style.display='none'; rs.style.display='block'; } }
  function analyzeGoal(text){ const lowerText=(text||'').toLowerCase(); const emagrecerKeywords=['emagrecer','perder peso','secar','definir','perder gordura','definição','emagrecimento']; const musculoKeywords=['ganhar musculo','hipertrofia','sheipado','crescer','massa muscular','ficar forte','músculo']; const hasEmagrecer=emagrecerKeywords.some(k=>lowerText.includes(k)); const hasMusculo=musculoKeywords.some(k=>lowerText.includes(k)); if(hasEmagrecer && !hasMusculo) return 'emagrecer'; if(hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos'; }
  function reorderVideos(order){ const c=document.getElementById('video-aulas'), v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

  // ---------- PARSER CORRIGIDO E LOG DE ERROS DETALHADO ----------
  function parseCompactWithGroups(raw) {
    if(!raw || typeof raw !== 'string') throwDetailed('Código inválido (vazio ou tipo incorreto)', raw, 0);
    const code = raw.trim();
    let i = 0;
    function peek(){ return code[i]; }
    function next(){ return code[i++]; }
    function eof(){ return i >= code.length; }
    function readDigits(){ let s=''; while(!eof() && /\d/.test(peek())) s += next(); return s; }

    function throwDetailed(msg, ctxRaw, pos){
      const contextRadius = 20;
      const start = Math.max(0, pos - contextRadius);
      const end = Math.min(ctxRaw.length, pos + contextRadius);
      const contextSnippet = ctxRaw.slice(start, end);
      const pointerIndex = pos - start;
      const pointerLine = ' '.repeat(pointerIndex) + '^';
      const error = new Error(msg + '\nPosition: ' + pos + '\nContext: "' + contextSnippet + '"\n' + pointerLine);
      error.position = pos;
      error.context = contextSnippet;
      throw error;
    }

    function read_L_id_qty() {
      const ch = peek();
      if(!ch) throwDetailed('Fim inesperado ao esperar "L"', code, i);
      if(ch.toUpperCase() !== 'L') throwDetailed(`Esperado 'L' antes do item`, code, i);
      next(); // consome L
      if(eof()) throwDetailed('Fim inesperado após "L"', code, i);
      // lookahead: legacy (L<len><id><qty3>) vs modern (L<id><qty3>)
      const remaining = code.slice(i);
      const nextChar = remaining[0];
      // legacy if nextChar in [1-4] and sufficient length
      if(/^[1-4]$/.test(nextChar)) {
        const len = parseInt(nextChar,10);
        if(remaining.length < 1 + len + 3) {
          throwDetailed('Formato legacy L<len><id><qty> incompleto (faltando dígitos)', code, i);
        }
        // consume len-digit
        i++;
        const idPart = code.substr(i, len);
        if(idPart.length < len || !/^\d+$/.test(idPart)) throwDetailed('ID inválido no formato legacy', code, i);
        i += len;
        const qtyPart = code.substr(i, 3);
        if(qtyPart.length < 3 || !/^\d{3}$/.test(qtyPart)) throwDetailed('Quantidade inválida (esperado 3 dígitos) no formato legacy', code, i);
        i += 3;
        return { id: idPart.replace(/^0+/, '') || '0', qty: parseInt(qtyPart,10) };
      } else {
        // modern: read continuous digits, last 3 = qty
        const digits = readDigits();
        if(digits.length < 4) throwDetailed('Esperado L<id><qty(3)> (pelo menos 4 dígitos) após L', code, i - digits.length);
        const qtyStr = digits.slice(-3);
        const idStr = digits.slice(0, -3).replace(/^0+/, '') || '0';
        return { id: idStr, qty: parseInt(qtyStr,10) };
      }
    }

    if(eof()) throwDetailed('Código vazio', code, 0);
    const type = next(); if(eof()) throwDetailed('Código incompleto: meses ausentes', code, i);
    const monthsChar = next(); if(!/^\d$/.test(monthsChar)) throwDetailed('Número de meses inválido (posição 2)', code, i-1);
    const months = parseInt(monthsChar,10);
    if(eof()) throwDetailed('Código incompleto: tabCount ausente', code, i);
    const tabCountChar = next(); if(!/^\d$/.test(tabCountChar)) throwDetailed('Número de abas inválido (posição 3)', code, i-1);
    const tabCount = parseInt(tabCountChar,10);

    const tabs = [];
    for(let t=0; t<tabCount; t++){
      if(eof()) throwDetailed("Esperado 'B' (início de aba) mas fim do código", code, i);
      const bChar = next();
      if(bChar.toUpperCase() !== 'B') throwDetailed("Esperado 'B' no início da aba", code, i-1);
      // meses start/end/daysVar/mealsBitmap(2)
      if(eof()) throwDetailed('Código incompleto na aba: faltam dados de mês', code, i);
      const ms = next(); if(!/^\d$/.test(ms)) throwDetailed('Mês inicial inválido', code, i-1);
      const me = next(); if(!/^\d$/.test(me)) throwDetailed('Mês final inválido', code, i-1);
      const daysVarChar = next(); if(!/^\d$/.test(daysVarChar)) throwDetailed('Número de dias inválido', code, i-1);
      const monthsStart = parseInt(ms,10), monthsEnd = parseInt(me,10), daysVar = parseInt(daysVarChar,10);
      // meals bitmap: two digits
      const mb1 = next(); const mb2 = next();
      if(!/^\d$/.test(mb1) || !/^\d$/.test(mb2)) throwDetailed('Bitmap de refeições inválido (2 dígitos)', code, i-2);
      const mealsBitmap = parseInt(mb1+mb2,10);

      const days = [];
      for(let d=0; d<daysVar; d++){
        if(eof()) throwDetailed("Esperado 'd' (início de dia) mas fim do código", code, i);
        const dayChar = next();
        if(dayChar.toUpperCase() !== 'D') throwDetailed("Esperado 'd' no início do dia", code, i-1);
        const dayIdxChar = next(); if(!/^\d$/.test(dayIdxChar)) throwDetailed('Índice do dia inválido', code, i-1);
        const mealEntryCountChar = next(); if(!/^\d$/.test(mealEntryCountChar)) throwDetailed('Contagem de refeições inválida', code, i-1);
        const dayIndex = parseInt(dayIdxChar,10), mealEntryCount = parseInt(mealEntryCountChar,10);
        const slots = [];
        for(let m=0; m<mealEntryCount; m++){
          if(eof()) throwDetailed('Fim inesperado antes de ler slot da refeição', code, i);
          const mealCodeChar = next(); if(!/^\d$/.test(mealCodeChar)) throwDetailed('Código da refeição inválido', code, i-1);
          const mealCode = parseInt(mealCodeChar,10);
          const itemEntryCountChar = next(); if(!/^\d$/.test(itemEntryCountChar)) throwDetailed('Contagem de itens inválida', code, i-1);
          const itemEntryCount = parseInt(itemEntryCountChar,10);
          const entries = [];
          for(let e=0; e<itemEntryCount; e++){
            if(eof()) throwDetailed('Fim inesperado dentro de entries', code, i);
            const p = peek();
            if(!p) throwDetailed('Fim inesperado ao ler entry', code, i);
            if(p.toUpperCase() === 'G'){ // grupo
              next(); // consome 'G'
              if(eof()) throwDetailed('Fim inesperado após G', code, i);
              const groupCountChar = next(); if(!/^\d$/.test(groupCountChar)) throwDetailed('Contagem de grupos inválida após G', code, i-1);
              const groupCount = parseInt(groupCountChar,10);
              const groupItems = [];
              for(let g=0; g<groupCount; g++){
                if(eof()) throwDetailed('Fim inesperado dentro de grupo', code, i);
                const nextCh = peek();
                if(!nextCh || nextCh.toUpperCase() !== 'L') throwDetailed("Esperado 'L' antes do item do grupo", code, i);
                const it = read_L_id_qty();
                groupItems.push({ id: it.id, qty: it.qty });
              }
              entries.push({ type:'group', items: groupItems });
            } else {
              // item único - espera 'L'
              if(p.toUpperCase() !== 'L') throwDetailed("Esperado 'L' antes do item", code, i);
              const it = read_L_id_qty();
              entries.push({ type:'item', item: { id: it.id, qty: it.qty } });
            }
          }
          slots.push({ mealCode, entries });
        }
        days.push({ dayIndex, slots });
      }

      if(eof()) throwDetailed("Esperado 'E' (fim de aba) mas fim do código", code, i);
      const endChar = next();
      if(endChar.toUpperCase() !== 'E') throwDetailed("Esperado 'E' no fim da aba", code, i-1);
      tabs.push({ monthStart: monthsStart, monthEnd: monthsEnd, daysVar, mealsBitmap, days });
    }

    if(!eof()){
      const rest = code.slice(i);
      throwDetailed('Conteúdo extra após parse', code, i);
    }

    return { type, months, tabs };
  }

  // ---------- normalização & render ----------
  function normalizePlan(plan, kb){
    const fallbackPortion = 100;
    plan.tabs.forEach(tab=>{
      tab.days.forEach(day=>{
        day.slots.forEach(slot=>{
          slot.entries.forEach(entry=>{
            if(entry.type === 'group'){
              entry.items.forEach(it=>{
                const kbItem = kb[it.id] || null;
                it.kb = kbItem;
                it.used_qty = it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : fallbackPortion) : it.qty;
                it.kcal = kbItem && kbItem.kcal_per_100g ? Math.round(kbItem.kcal_per_100g * it.used_qty / 100) : null;
              });
              entry.group_kcal = entry.items.reduce((s,i)=> s + (i.kcal || 0), 0);
            } else {
              const it = entry.item;
              const kbItem = kb[it.id] || null;
              it.kb = kbItem;
              it.used_qty = it.qty === 0 ? (kbItem && kbItem.default_portion_g ? kbItem.default_portion_g : fallbackPortion) : it.qty;
              it.kcal = kbItem && kbItem.kcal_per_100g ? Math.round(kbItem.kcal_per_100g * it.used_qty / 100) : null;
            }
          });
          slot.meal_total_kcal = slot.entries.reduce((s,en)=> s + (en.type==='group' ? (en.group_kcal || 0) : (en.item.kcal || 0)), 0);
        });
      });
    });
    return plan;
  }

  function renderForm(plan, kb, container){
    container.innerHTML = '';
    const summary = document.createElement('div'); summary.style.marginBottom='10px';
    summary.innerHTML = `<strong>Plano: type=${plan.type}, months=${plan.months}, abas=${plan.tabs.length}</strong>`;
    container.appendChild(summary);
    const MEAL_NAMES = { 1:"Refeição 1 (Café da manhã)", 2:"Refeição 2 (Lanche)", 3:"Refeição 3 (Almoço)", 4:"Refeição 4 (Café da tarde)", 5:"Refeição 5 (Janta)" };
    plan.tabs.forEach((tab,tabIdx)=>{
      const tabEl = document.createElement('div'); tabEl.style.marginTop='12px';
      tabEl.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Mês ${tab.monthStart}${tab.monthStart!==tab.monthEnd?(' - '+tab.monthEnd):''} • dias: ${tab.days.length}</div>`;
      tab.days.forEach(day=>{
        const dayCard = document.createElement('div'); dayCard.style.border='1px solid rgba(255,255,255,0.03)'; dayCard.style.padding='8px'; dayCard.style.borderRadius='8px'; dayCard.style.marginBottom='8px';
        dayCard.innerHTML = `<div style="font-weight:700">Dia ${day.dayIndex}</div>`;
        day.slots.forEach(slot=>{
          const mealDiv = document.createElement('div'); mealDiv.style.marginTop='8px';
          mealDiv.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${MEAL_NAMES[slot.mealCode]||('Refeição '+slot.mealCode)} • kcal: ${slot.meal_total_kcal ?? 0}</div>`;
          slot.entries.forEach(entry=>{
            if(entry.type === 'group'){
              const g = document.createElement('div'); g.style.border='1px dashed rgba(255,255,255,0.03)'; g.style.padding='8px'; g.style.borderRadius='8px'; g.style.marginBottom='8px';
              g.innerHTML = `<div style="font-weight:700">Grupo (kcal: ${entry.group_kcal ?? 0})</div>`;
              entry.items.forEach(it=>{
                const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px';
                const name = it.kb?.name || ('ID '+it.id);
                row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id})</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
                g.appendChild(row);
              });
              mealDiv.appendChild(g);
            } else {
              const it = entry.item;
              const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px'; row.style.padding='6px'; row.style.border='1px solid rgba(255,255,255,0.02)'; row.style.borderRadius='8px';
              const name = it.kb?.name || ('ID '+it.id);
              row.innerHTML = `<div><strong>${name}</strong><div style="font-size:12px;color:#bbb">(#${it.id})</div></div><div style="text-align:right"><div style="font-weight:700">${it.used_qty} g</div><div style="font-size:12px;color:#bbb">${it.kcal ?? '—'} kcal</div></div>`;
              mealDiv.appendChild(row);
            }
          });
          dayCard.appendChild(mealDiv);
        });
        tabEl.appendChild(dayCard);
      });
      container.appendChild(tabEl);
    });
  }

  // ---------- UI wiring do parser ----------
  const compactInput = document.getElementById('compactInput');
  const runBtn = document.getElementById('runBtn');
  const clearBtn = document.getElementById('clearBtn');
  const copyBtn = document.getElementById('copyBtn');
  const compactRoot = document.getElementById('compactRoot');
  const compactError = document.getElementById('compactError');
  const kbPreview = document.getElementById('kbPreview');
  kbPreview.innerText = 'KB entries: ' + Object.keys(KB).length + ' (loaded).';

  function showErrorDetailed(err){
    compactError.style.display='block';
    if(err && err.context && err.position !== undefined){
      compactError.innerText = 'Erro ao parsear: ' + (err.message || String(err)) + '\n\nPosição: ' + err.position + '\nContexto próximo: "' + (err.context || '') + '"\n\nStack:\n' + (err.stack || '');
    } else {
      compactError.innerText = 'Erro ao parsear: ' + (err && err.message ? err.message : String(err)) + '\n\nStack:\n' + (err && err.stack ? err.stack : '—');
    }
  }
  function hideError(){ compactError.style.display='none'; compactError.innerText=''; }

  window.currentCompactPlan = null;
  runBtn.addEventListener('click', ()=>{
    hideError();
    compactRoot.innerHTML = '';
    const code = (compactInput.value||'').trim();
    if(!code){ showErrorDetailed(new Error('Cole um código compacto antes de rodar.')); return; }
    try {
      const plan = parseCompactWithGroups(code);
      normalizePlan(plan, KB);
      renderForm(plan, KB, compactRoot);
      window.currentCompactPlan = plan;
    } catch(err){
      showErrorDetailed(err);
    }
  });

  clearBtn.addEventListener('click', ()=>{
    compactInput.value = '';
    compactRoot.innerHTML = '';
    hideError();
    window.currentCompactPlan = null;
  });

  copyBtn.addEventListener('click', ()=>{
    if(window.currentCompactPlan){
      navigator.clipboard.writeText(JSON.stringify(window.currentCompactPlan, null, 2)).then(()=> alert('JSON copiado para clipboard.'));
    } else {
      alert('Nenhum plano carregado para copiar.');
    }
  });

  // ---------- Resto da sua lógica com Supabase & UI ----------
  document.addEventListener('DOMContentLoaded', () => {
    let user = null;
    const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navLinks = document.querySelectorAll('.nav-link'); const configBtn = document.getElementById('config-btn'); const logoutBtn = document.getElementById('logout-btn'); const resetBtn = document.getElementById('reset-btn');
    const switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.getElementById(tabId).classList.add('active'); navLinks.forEach(link => link.classList.remove('active')); document.querySelector(`.nav-link[data-tab="${tabId}"]`).classList.add('active'); };
    const closeMenu = () => { menuToggle.classList.remove('open'); sidebar.classList.remove('open'); overlay.classList.remove('show'); };
    menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('open'); sidebar.classList.toggle('open'); overlay.classList.toggle('show'); });
    overlay.addEventListener('click', closeMenu);
    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const tabId = link.dataset.tab; switchTab(tabId); closeMenu(); }); });
    configBtn.addEventListener('click', (e) => { e.preventDefault(); logoutBtn.classList.toggle('hidden'); resetBtn.classList.toggle('hidden'); });
    logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace('/login.html'); });
    resetBtn.addEventListener('click', async () => { if (!user) return; const { error: resetError } = await supabase.from('profiles').update({ goal_start_date: null, goal_end_date: null, goal_prompt: null, goal_type: null, }).eq('id', user.id); if (resetError) { console.error('Erro ao resetar a meta: ' + resetError.message); } else { window.location.reload(); } });

    async function initializePageData(){
      const { data } = await supabase.auth.getUser();
      if (!data.user) { window.location.replace('/login.html'); return; }
      user = data.user;
      document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;
      const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (error || !profile) { console.error('Erro ao buscar perfil:', error); await supabase.auth.signOut(); window.location.replace('/login.html'); return; }
      if (profile.goal_end_date) { displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date)); document.getElementById('prompt-output').textContent = profile.goal_prompt; if (profile.goal_type) document.getElementById('playlist-section').style.display = 'block'; } else { document.getElementById('form-wrapper').style.display = 'block'; }

      // injeta chat Dify
      function loadFreshDifyChat(){
        const difyContainer = document.getElementById('dify-container');
        if(!difyContainer) return;
        difyContainer.innerHTML = '';
        const frameWrap = document.createElement('div'); frameWrap.className = 'dify-frame';
        const iframe = document.createElement('iframe');
        const randomSessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
        const difyUrl = `https://udify.app/chatbot/${DIFY_APP_TOKEN}?user=${randomSessionId}&theme=dark&panel_background_color=%23000000&chat_background_color=%23000000&bot_message_background_color=%231A1A1A&user_message_background_color=%232B2B2B&_=${Date.now()}`;
        iframe.src = difyUrl; iframe.allow='microphone'; frameWrap.appendChild(iframe);
        const strip = document.createElement('div'); strip.className='dify-top-strip'; strip.setAttribute('aria-hidden','true');
        const badge = document.createElement('div'); badge.className='dify-top-badge'; badge.textContent='Fale com a IA';
        const label = document.createElement('span'); label.className='mvp-label'; label.textContent='MVPia';
        strip.appendChild(badge); strip.appendChild(label);
        const bottomMask = document.createElement('div'); bottomMask.className='dify-bottom-mask'; bottomMask.setAttribute('aria-hidden','true');
        frameWrap.appendChild(strip); frameWrap.appendChild(bottomMask); difyContainer.appendChild(frameWrap);
      }
      loadFreshDifyChat();

      // restante da lógica do formulário IA
      const objetivoInput = document.getElementById('objetivo'); if(objetivoInput) objetivoInput.addEventListener('input', function(){ document.getElementById('prazo-group').style.display=this.value.trim()? 'block':'none'; });
      const usoSuplementoSelect = document.getElementById('uso_suplemento'); if(usoSuplementoSelect) usoSuplementoSelect.addEventListener('change', function(){ document.getElementById('suplementos-detalhes-group').style.display=this.value==='Sim'?'block':'none'; if(this.value!=='Sim') document.getElementById('quais_suplementos').value=''; });

      const iaFitForm = document.getElementById('ia-fit-form'); if(iaFitForm) iaFitForm.addEventListener('submit', async function(event){
        event.preventDefault();
        const formElements = event.target.elements;
        const prazoText = formElements.prazo.value;
        const endDate = calculateEndDate(prazoText);
        if(!endDate){ console.error("Prazo da meta inválido."); return; }
        const startDate = new Date(); startDate.setHours(0,0,0,0);
        const objetivoText = formElements.objetivo.value;
        const goalType = analyzeGoal(objetivoText);
        const daysRemaining = Math.ceil((endDate - startDate)/(1000*60*60*24));
        const prazoOtimizado = `${daysRemaining} dias (meta: ${prazoText})`;
        const orcamentoValue = formElements.orcamento.value.replace(',', '.');
        const formData = { objetivo:objetivoText, prazo:prazoOtimizado, sexo:formElements.sexo.value, altura:formElements.altura.value, peso:formElements.peso.value, idade:formElements.idade.value, disponibilidade:formElements.disponibilidade.value, local_treino:formElements.local_treino.value, orcamento:orcamentoValue, uso_suplemento:formElements.uso_suplemento.value, quais_suplementos:formElements.quais_suplementos.value, nivel:formElements.nivel.value };
        let suplementoInfo = `Pretende usar suplementos: ${formData.uso_suplemento}.`;
        if(formData.uso_suplemento==='Sim' && formData.quais_suplementos){ suplementoInfo += ` Os suplementos são: ${formData.quais_suplementos}.` } else if(formData.uso_suplemento==='Sim'){ suplementoInfo += ` Ainda não decidi quais.`; }
        const initialMessage = `\n**GERAR PLANO DE AÇÃO COMPLETO**\n**INSTRUÇÃO:** Aja como um coach de elite e crie um plano de ação detalhado com base nos seguintes dados do utilizador:\n**- Objetivo Principal:** ${formData.objetivo}\n**- Prazo para a Meta:** ${formData.prazo}\n**- Perfil do Utilizador:**\n  - Idade: ${formData.idade} anos\n  - Sexo: ${formData.sexo}\n  - Peso: ${formData.peso} kg\n  - Altura: ${formData.altura} m\n  - Nível de Experiência: ${formData.nivel}\n**- Logística e Recursos:**\n  - Disponibilidade: ${formData.disponibilidade} dias/semana\n  - Local de Treino: ${formData.local_treino}\n  - Orçamento Mensal (Dieta/Sups): R$${formData.orcamento}\n  - ${suplementoInfo}\n**TAREFA:** Crie um plano prescritivo e completo, abordando treino, dieta e recomendações de estilo de vida para atingir a meta no prazo estipulado.`.trim();

        const { error: updateError } = await supabase.from('profiles').update({ goal_start_date: startDate.toISOString(), goal_end_date: endDate.toISOString(), goal_prompt: initialMessage, goal_type: goalType }).eq('id', user.id);
        if(updateError){ console.error("Erro ao salvar a meta: " + updateError.message); } else { document.getElementById('prompt-output').textContent = initialMessage; document.getElementById('playlist-section').style.display='block'; displayProgress(startDate, endDate); }
      });

      const playlistBtn = document.getElementById('playlist-btn'); if(playlistBtn) playlistBtn.addEventListener('click', function(){ if(!profile) return; let videoOrder; if(profile.goal_type==='emagrecer'){videoOrder=[3,2,1];} else if(profile.goal_type==='musculo'){videoOrder=[3,1,2];} else { videoOrder=[1,2,3]; } reorderVideos(videoOrder); switchTab('video-aulas'); document.getElementById('video-aulas').scrollIntoView({ behavior:'smooth' }); });

      const copyBtnMain = document.getElementById('copy-btn-main'); if(copyBtnMain) copyBtnMain.addEventListener('click', function(){ const textToCopy=document.getElementById('prompt-output').textContent; const textArea=document.createElement('textarea'); textArea.value=textToCopy; textArea.style.position='fixed'; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try{ document.execCommand('copy'); const btn=document.getElementById('copy-btn-main'); btn.textContent='Copiado!'; setTimeout(()=>{btn.textContent='Copiar Pedido';},2000);}catch(err){console.error('Erro ao copiar',err);} document.body.removeChild(textArea); });

      // paste simulation buttons
      const pasteTreino = document.getElementById('paste-treino'); const pasteDieta = document.getElementById('paste-dieta');
      function simulatePaste(buttonEl, targetTextareaId){
        const txtOutput = document.getElementById('prompt-output').textContent || '';
        const target = document.getElementById(targetTextareaId);
        const label = buttonEl.querySelector('.label');
        if(buttonEl.disabled) return;
        buttonEl.classList.remove('appearing'); void buttonEl.offsetWidth; buttonEl.classList.add('appearing');
        if(txtOutput.trim() && target) { target.value = txtOutput; } else if(target) { target.value = '[Sem conteúdo gerado ainda — gere a meta no painel IA primeiro]'; }
        if(label) label.textContent = 'Formulário pronto ✓';
        buttonEl.classList.add('pasted','done');
        buttonEl.setAttribute('aria-pressed','true'); buttonEl.disabled = true; buttonEl.setAttribute('aria-disabled','true');
        if(target){ try{ target.focus(); } catch(e){} }
      }
      if(pasteTreino) pasteTreino.addEventListener('click', ()=> simulatePaste(pasteTreino,'objetivo_treino'));
      if(pasteDieta) pasteDieta.addEventListener('click', ()=> simulatePaste(pasteDieta,'objetivo_dieta'));
    }

    initializePageData();
  });
</script>
</body>
</html>
