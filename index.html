<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // 1. CONFIGURAÇÃO
    const SUPABASE_URL = "https://edxsgmchmwtpgnoxgrkb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2. GUARDA DE AUTENTICAÇÃO
    // Esta é a parte mais importante. Ela roda antes de tudo.
    async function checkAuthAndRunApp() {
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            // Se NÃO há sessão, EXPULSA o usuário para a página de login.
            window.location.replace('/login.html');
        } else {
            // Se HÁ uma sessão, roda a aplicação principal.
            console.log('Autenticado! Rodando a aplicação...');
            runApp(session.user);
        }
    }

    // 3. O CORAÇÃO DA SUA APLICAÇÃO
    // Todo o seu código de antes agora vive dentro desta função.
    // Ela só é chamada DEPOIS que a autenticação é confirmada.
    function runApp(user) {
        // --- COLE AQUI TODAS AS FUNÇÕES E LÓGICAS DA SUA PÁGINA ---
        
        // Funções auxiliares (essencial que estejam aqui dentro)
        function calculateEndDate(prazoText) { /* ... (sua lógica original) ... */ return null; }
        function analyzeGoal(text) { /* ... (sua lógica original) ... */ return 'ambos'; }
        // ... (todas as outras funções como getEaster, displayProgress, etc.)

        // Lógica do Chat
        async function sendMessage() { /* ... */ }
        async function loadChatHistory() { /* ... */ }
        function addMessage(text, sender) { /* ... */ }

        // --- INICIALIZAÇÃO DA PÁGINA E EVENTOS ---

        // Mostra a mensagem de boas-vindas
        document.getElementById('welcome-msg').textContent = `Bem-vindo(a), ${user.email}`;

        // Lógica para mostrar formulário ou resultados
        // (Aqui você faria a busca no 'profiles' e mostraria o conteúdo correto)
        
        // Adiciona todos os event listeners
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.replace('/login.html'); // Redireciona ao sair
        });
        
        // ... (todos os outros event listeners do menu, forms, chat, etc.)

        // Finalmente, carrega os dados dinâmicos
        loadChatHistory();
        console.log("Aplicação iniciada com sucesso.");
    }

    // 4. PONTO DE ENTRADA
    // Inicia a verificação de autenticação assim que o script é lido.
    checkAuthAndRunApp();
</script>
