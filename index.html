<script type="module">
    // Importa o cliente Supabase do CDN
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ===================================================================
    // 1. CONFIGURAÇÃO E CONSTANTES GLOBAIS
    // ===================================================================
    const SUPABASE_URL = "https://edxsgmchmwtpgnoxgrkb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkeHNnbWNobXd0cGdub3hncmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjMyMjYsImV4cCI6MjA3NjAzOTIyNn0.TPM9xK6UrpQ_0IyoC-GHvCoXu9Ur4HN9IrFPdV8VEDs";
    const EDGE_URL = "https://edxsgmchmwtpgnoxgrkb.supabase.co/functions/v1/super-action";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===================================================================
    // 2. DEFINIÇÃO DE TODAS AS FUNÇÕES
    // ===================================================================
    
    // --- FUNÇÕES AUXILIARES DO FORMULÁRIO (ESTAVAM FALTANDO) ---
    function getEaster(year) { const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(year, month - 1, day); }
    function calculateEndDate(prazoText) {
        const now = new Date(); const year = now.getFullYear(); let prazoLower = prazoText.toLowerCase();
        if (prazoLower.includes('final do ano') || prazoLower.includes('fim de ano')) { return new Date(year, 11, 31); }
        let match = prazoLower.match(/(\d+)\s+mes(es)?/); if (match) { let d=new Date(); d.setMonth(d.getMonth()+parseInt(match[1],10)); return d; }
        match = prazoLower.match(/(\d+)\s+dia(s)?/); if (match) { let d=new Date(); d.setDate(d.getDate()+parseInt(match[1],10)); return d; }
        if (prazoLower.includes('verao')||prazoLower.includes('verão')) { const s=new Date(year,11,21); return now<s?s:new Date(year+1,11,21); }
        if (prazoLower.includes('natal')) { const c=new Date(year,11,25); return now<c?c:new Date(year+1,11,25); }
        if (prazoLower.includes('ano novo')) { return new Date(year+1,0,1); }
        if (prazoLower.includes('pascoa')||prazoLower.includes('páscoa')) { const e=getEaster(year); return now<e?e:getEaster(year+1); }
        return null;
    }
    function analyzeGoal(text) {
        const lowerText = text.toLowerCase();
        const emagrecerKeywords = ['emagrecer', 'perder peso', 'secar', 'definir', 'perder gordura', 'definição', 'emagrecimento'];
        const musculoKeywords = ['ganhar musculo', 'hipertrofia', 'sheipado', 'crescer', 'massa muscular', 'ficar forte', 'músculo'];
        const hasEmagrecer = emagrecerKeywords.some(keyword => lowerText.includes(keyword)); const hasMusculo = musculoKeywords.some(keyword => lowerText.includes(keyword));
        if (hasEmagrecer && !hasMusculo) return 'emagrecer'; if (hasMusculo && !hasEmagrecer) return 'musculo'; return 'ambos';
    }
    function reorderVideos(order) { const c=document.getElementById('video-aulas'),v={1:document.getElementById('video-block-1'),2:document.getElementById('video-block-2'),3:document.getElementById('video-block-3')}; if(!c || !v[1] || !v[2] || !v[3]) return; Object.values(v).forEach(b=>b.remove()); order.forEach(i=>c.appendChild(v[i])); }

    function displayProgress(startDate, endDate) {
        const progressBar = document.getElementById('progress-bar'); const startDateLabel = document.getElementById('start-date-label');
        const endDateLabel = document.getElementById('end-date-label'); const countdownDays = document.getElementById('countdown-days');
        if(!progressBar || !startDateLabel || !endDateLabel || !countdownDays) return;
        const now = new Date(); now.setHours(0, 0, 0, 0); const sDate = new Date(startDate); sDate.setHours(0, 0, 0, 0); const eDate = new Date(endDate); eDate.setHours(0, 0, 0, 0);
        const totalDuration = eDate.getTime() - sDate.getTime(); const elapsedDuration = now.getTime() - sDate.getTime();
        const daysRemaining = Math.ceil((eDate - now) / (1000 * 60 * 60 * 24)); let progressPercentage = (elapsedDuration / totalDuration) * 100;
        if (progressPercentage < 0) progressPercentage = 0; if (progressPercentage > 100) progressPercentage = 100;
        progressBar.style.width = `${progressPercentage}%`; startDateLabel.textContent = sDate.toLocaleDateString('pt-BR');
        endDateLabel.textContent = eDate.toLocaleDateString('pt-BR'); countdownDays.textContent = daysRemaining >= 0 ? daysRemaining : 0;
    }

    // Funções do Chat
    function addMessage(text, sender = "bot") { /* ... (código mantido) ... */ }
    async function loadChatHistory() { /* ... (código mantido) ... */ }
    async function sendMessage() { /* ... (código mantido) ... */ }

    // Função Principal de Inicialização da Aplicação
    async function initializePageData(user) {
        console.log("Usuário autenticado, inicializando a página...");
        const welcomeMsg = document.getElementById('welcome-msg');
        if (welcomeMsg) welcomeMsg.textContent = `Bem-vindo(a), ${user.email}`;

        const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (error || !profile) {
            console.error('Erro fatal ao buscar perfil:', error);
            if (welcomeMsg) welcomeMsg.textContent = 'Erro ao carregar seus dados.';
            return;
        }
        
        const formWrapper = document.getElementById('form-wrapper');
        const resultsWrapper = document.getElementById('results-wrapper');

        if (profile.goal_end_date) {
            displayProgress(new Date(profile.goal_start_date), new Date(profile.goal_end_date));
            document.getElementById('prompt-output').textContent = profile.goal_prompt;
            const playlistSection = document.getElementById('playlist-section');
            if (playlistSection && profile.goal_type) playlistSection.style.display = 'block';
            if(formWrapper) formWrapper.style.display = 'none'; 
            if(resultsWrapper) resultsWrapper.style.display = 'block';
        } else {
            if(formWrapper) formWrapper.style.display = 'block';
            if(resultsWrapper) resultsWrapper.style.display = 'none';
        }

        loadChatHistory();
        setupEventListeners(user, profile);
    }

    // Função para organizar todos os addEventListener
    function setupEventListeners(user, profile) {
        // Chat
        const sendChatBtn = document.getElementById("send-chat-btn");
        const chatInput = document.getElementById("chat-input");
        if (sendChatBtn) sendChatBtn.addEventListener("click", sendMessage);
        if (chatInput) chatInput.addEventListener("keydown", (event) => { if (event.key === "Enter") { event.preventDefault(); sendMessage(); } });

        // Menu
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        const configBtn = document.getElementById('config-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const resetBtn = document.getElementById('reset-btn');

        const closeMenu = () => { /* ... (código mantido) ... */ };
        if(menuToggle) menuToggle.addEventListener('click', () => { /* ... */ });
        if(overlay) overlay.addEventListener('click', closeMenu);
        navLinks.forEach(link => { link.addEventListener('click', (e) => { /* ... */ }); });
        if(configBtn) configBtn.addEventListener('click', (e) => { /* ... */ });
        if(logoutBtn) logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); });
        
        // --- LÓGICA DO FORMULÁRIO PRINCIPAL (ESTAVA FALTANDO) ---
        const iaFitForm = document.getElementById('ia-fit-form');
        if(iaFitForm) {
            iaFitForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formElements = event.target.elements;
                const prazoText = formElements.prazo.value;
                const endDate = calculateEndDate(prazoText);
                if (!endDate) { alert("Prazo da meta inválido."); return; }
                const startDate = new Date(); startDate.setHours(0,0,0,0);
                const objetivoText = formElements.objetivo.value;
                const goalType = analyzeGoal(objetivoText);
                const daysRemaining = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const prazoOtimizado = `${daysRemaining} dias (meta: ${prazoText})`;
                const orcamentoValue = formElements.orcamento.value.replace(',', '.');
                const formData={objetivo:objetivoText,prazo:prazoOtimizado,sexo:formElements.sexo.value,altura:formElements.altura.value,peso:formElements.peso.value,idade:formElements.idade.value,disponibilidade:formElements.disponibilidade.value,local_treino:formElements.local_treino.value,orcamento:orcamentoValue,uso_suplemento:formElements.uso_suplemento.value,quais_suplementos:formElements.quais_suplementos.value,nivel:formElements.nivel.value};
                let suplementoInfo=`Pretende usar suplementos: ${formData.uso_suplemento}.`;
                if(formData.uso_suplemento==='Sim'&&formData.quais_suplementos){suplementoInfo+=` Os suplementos são: ${formData.quais_suplementos}.`;}else if(formData.uso_suplemento==='Sim'){suplementoInfo+=` Ainda não decidi quais.`;}
                const initialMessage = `\n**GERAR PLANO DE AÇÃO COMPLETO**\n**INSTRUÇÃO:** Aja como um coach de elite...\n**- Objetivo Principal:** ${formData.objetivo}\n...`.trim(); // (Mensagem original abreviada)
                
                const { error: updateError } = await supabase.from('profiles').update({ goal_start_date: startDate.toISOString(), goal_end_date: endDate.toISOString(), goal_prompt: initialMessage, goal_type: goalType }).eq('id', user.id);
                if (updateError) { console.error("Erro ao salvar a meta: " + updateError.message); } 
                else { 
                    // Recarrega a página para mostrar a nova visualização
                    window.location.reload();
                }
            });
        }
    }

    // ===================================================================
    // 3. PONTO DE ENTRADA DA APLICAÇÃO
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        supabase.auth.onAuthStateChange((event, session) => {
            console.log(`Auth event: ${event}`);
            if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN') {
                if(session && session.user){
                    initializePageData(session.user);
                }
            } else if (event === 'SIGNED_OUT') {
                console.log("Sessão não encontrada, redirecionando para o login...");
                window.location.replace('/login.html');
            }
        });
    });
</script>
